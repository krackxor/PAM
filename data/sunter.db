-- TABEL 1: MASTER PELANGGAN (Gabungan MC & ARDEBT)
CREATE TABLE master_pelanggan (
    nomen TEXT PRIMARY KEY,
    nama TEXT,
    alamat TEXT,
    rayon TEXT,       -- PC / Rayon
    tarif TEXT,
    target_mc REAL DEFAULT 0,    -- Target dari File MC
    saldo_ardebt REAL DEFAULT 0, -- Tunggakan dari File ARDEBT
    periode TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index untuk mempercepat filter per Rayon
CREATE INDEX idx_master_rayon ON master_pelanggan(rayon);

-- TABEL 2: COLLECTION HARIAN (Transaksi)
CREATE TABLE collection_harian (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nomen TEXT,
    tgl_bayar TEXT,     -- Format YYYY-MM-DD
    jumlah_bayar REAL,  -- Nilai Positif
    sumber_file TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY(nomen) REFERENCES master_pelanggan(nomen) ON DELETE CASCADE
);

-- Index untuk mempercepat grafik harian
CREATE INDEX idx_coll_tgl ON collection_harian(tgl_bayar);

-- TABEL 3: OPERASIONAL (SBRS & MAINBILL)
CREATE TABLE operasional (
    nomen TEXT PRIMARY KEY,
    status_baca TEXT DEFAULT 'BELUM',
    stand_akhir INTEGER DEFAULT 0,
    tgl_baca TEXT,
    tagihan_final REAL DEFAULT 0,
    cycle TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY(nomen) REFERENCES master_pelanggan(nomen) ON DELETE CASCADE
);

-- TABEL 4: ANALISA MANUAL
CREATE TABLE analisa_manual (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nomen TEXT,
    jenis_anomali TEXT,
    catatan TEXT,
    rekomendasi TEXT,
    status TEXT DEFAULT 'Open',
    user_editor TEXT DEFAULT 'System',
    tgl_update TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY(nomen) REFERENCES master_pelanggan(nomen) ON DELETE CASCADE
);

-- TABEL 5: AUDIT LOG
CREATE TABLE audit_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    aktivitas TEXT,
    detail TEXT,
    user TEXT DEFAULT 'Admin',
    waktu TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
