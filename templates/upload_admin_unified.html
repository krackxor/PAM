{% extends "base.html" %}

{% block title %}Admin Upload Data{% endblock %}

{% block custom_styles %}
<style>
    .upload-container {
        padding: 10px;
    }
    
    .hero-header {
        background: #fff;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        margin-bottom: 30px;
        border-left: 5px solid #4e73df;
    }

    .upload-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 25px;
    }

    .upload-card {
        background: #fff;
        border-radius: 15px;
        border: 1px solid #e3e6f0;
        box-shadow: 0 0.15rem 1.5rem 0 rgba(0, 0, 0, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .upload-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.15);
    }

    .card-accent {
        height: 4px;
        width: 100%;
    }

    .upload-card-body {
        padding: 25px;
        flex-grow: 1;
    }

    .upload-card h5 {
        font-weight: 800;
        color: #3a3b45;
        margin-bottom: 5px;
        text-transform: uppercase;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }

    .upload-card .subtitle {
        font-size: 0.75rem;
        color: #858796;
        margin-bottom: 20px;
        display: block;
    }

    /* Form Elements */
    .form-label {
        font-weight: 700;
        font-size: 0.7rem;
        text-transform: uppercase;
        color: #4e73df;
        margin-bottom: 5px;
    }

    .input-custom {
        border-radius: 8px;
        border: 1px solid #d1d3e2;
        padding: 10px;
        font-size: 0.85rem;
        width: 100%;
        margin-bottom: 15px;
    }

    .input-custom:focus {
        border-color: #bac8f3;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.1);
        outline: none;
    }

    .btn-upload {
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.75rem;
        padding: 12px;
        border-radius: 10px;
        border: none;
        color: white;
        width: 100%;
        transition: all 0.3s;
        cursor: pointer;
    }

    .btn-upload:disabled { opacity: 0.7; cursor: not-allowed; }

    /* Colors per Category */
    .bg-mc { background-color: #4e73df; }
    .bg-mb { background-color: #1cc88a; }
    .bg-cid { background-color: #f6c23e; }
    .bg-sbrs { background-color: #36b9cc; }
    .bg-ardebt { background-color: #e74a3b; }

    /* Status Messages */
    .status-msg {
        margin-top: 15px;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 700;
        display: none;
    }
    .status-success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
    .status-error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }

    .date-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .date-row div { flex: 1; }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <!-- Header Section -->
    <div class="hero-header">
        <h2 class="font-weight-bold text-gray-800" style="font-size: 1.6rem;">
            <i class="fas fa-cloud-upload-alt mr-2 text-primary"></i> Manajemen Master Data
        </h2>
        <p class="text-muted mb-0 small">Unggah berkas CSV atau Excel untuk memperbarui database AB SUNTER Analytic. Pastikan format kolom sudah sesuai sebelum mengunggah.</p>
    </div>

    <div class="upload-grid">
        
        <!-- 1. Master Cetak (MC) -->
        <div class="upload-card">
            <div class="card-accent bg-mc"></div>
            <div class="upload-card-body">
                <h5>Master Cetak (MC)</h5>
                <span class="subtitle">Data piutang bulanan / lembar tagihan</span>
                <form id="formMC" class="upload-form" data-endpoint="{{ url_for('upload_mc_data') }}">
                    <div class="date-row">
                        <div>
                            <label class="form-label">Bulan (MM)</label>
                            <input type="text" name="month" class="input-custom" placeholder="01" required maxlength="2">
                        </div>
                        <div>
                            <label class="form-label">Tahun (YYYY)</label>
                            <input type="text" name="year" class="input-custom" placeholder="2025" required maxlength="4">
                        </div>
                    </div>
                    <label class="form-label">Pilih Berkas</label>
                    <input type="file" name="file" class="input-custom" accept=".csv, .xlsx, .xls" required>
                    <button type="submit" class="btn-upload bg-mc">Upload MC Data</button>
                    <div id="statusMC" class="status-msg"></div>
                </form>
            </div>
        </div>

        <!-- 2. Master Bayar (MB) -->
        <div class="upload-card">
            <div class="card-accent bg-mb"></div>
            <div class="upload-card-body">
                <h5>Master Bayar (MB)</h5>
                <span class="subtitle">Data koleksi harian (Mode: Append)</span>
                <form id="formMB" class="upload-form" data-endpoint="{{ url_for('upload_mb_data') }}">
                    <label class="form-label">Pilih Berkas</label>
                    <input type="file" name="file" class="input-custom" accept=".csv, .xlsx, .xls" required>
                    <button type="submit" class="btn-upload bg-mb">Upload MB Data</button>
                    <div id="statusMB" class="status-msg"></div>
                </form>
            </div>
        </div>

        <!-- 3. Customer Data (CID) -->
        <div class="upload-card">
            <div class="card-accent bg-cid"></div>
            <div class="upload-card-body">
                <h5>Customer Data (CID)</h5>
                <span class="subtitle">Induk Master Pelanggan (Mode: Replace)</span>
                <form id="formCID" class="upload-form" data-endpoint="{{ url_for('upload_cid_data') }}">
                    <label class="form-label">Pilih Berkas</label>
                    <input type="file" name="file" class="input-custom" accept=".csv, .xlsx, .xls" required>
                    <button type="submit" class="btn-upload bg-cid" style="color: #3a3b45;">Upload CID Data</button>
                    <div id="statusCID" class="status-msg"></div>
                </form>
            </div>
        </div>

        <!-- 4. Meter Reading (SBRS) -->
        <div class="upload-card">
            <div class="card-accent bg-sbrs"></div>
            <div class="upload-card-body">
                <h5>Meter Reading (SBRS)</h5>
                <span class="subtitle">Data pembacaan stand meter (Mode: Append)</span>
                <form id="formSBRS" class="upload-form" data-endpoint="{{ url_for('upload_sbrs_data') }}">
                    <label class="form-label">Pilih Berkas</label>
                    <input type="file" name="file" class="input-custom" accept=".csv, .xlsx, .xls" required>
                    <button type="submit" class="btn-upload bg-sbrs">Upload SBRS Data</button>
                    <div id="statusSBRS" class="status-msg"></div>
                </form>
            </div>
        </div>

        <!-- 5. Detail Tunggakan (ARDEBT) -->
        <div class="upload-card">
            <div class="card-accent bg-ardebt"></div>
            <div class="upload-card-body">
                <h5>Detail Tunggakan (AR)</h5>
                <span class="subtitle">Rincian utang per pelanggan (Per Periode)</span>
                <form id="formARDEBT" class="upload-form" data-endpoint="{{ url_for('upload_ardebt_data') }}">
                    <div class="date-row">
                        <div>
                            <label class="form-label">Bulan (MM)</label>
                            <input type="text" name="month" class="input-custom" placeholder="01" required maxlength="2">
                        </div>
                        <div>
                            <label class="form-label">Tahun (YYYY)</label>
                            <input type="text" name="year" class="input-custom" placeholder="2025" required maxlength="4">
                        </div>
                    </div>
                    <label class="form-label">Pilih Berkas</label>
                    <input type="file" name="file" class="input-custom" accept=".csv, .xlsx, .xls" required>
                    <button type="submit" class="btn-upload bg-ardebt">Upload AR Data</button>
                    <div id="statusARDEBT" class="status-msg"></div>
                </form>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const forms = document.querySelectorAll('.upload-form');

        forms.forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formId = form.id;
                const statusId = 'status' + formId.replace('form', '');
                const statusDiv = document.getElementById(statusId);
                const button = form.querySelector('button');
                const endpoint = form.dataset.endpoint;
                const originalText = button.innerHTML;

                // Reset Status
                statusDiv.style.display = 'none';
                statusDiv.className = 'status-msg';
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> MEMPROSES...';

                const formData = new FormData(form);

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (result.status === 'success') {
                        statusDiv.classList.add('status-success');
                        statusDiv.innerHTML = `<i class="fas fa-check-circle mr-2"></i> ${result.message}`;
                        form.reset();
                    } else {
                        statusDiv.classList.add('status-error');
                        statusDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> ${result.message}`;
                    }
                } catch (error) {
                    statusDiv.classList.add('status-error');
                    statusDiv.innerHTML = `<i class="fas fa-bug mr-2"></i> Terjadi kesalahan jaringan.`;
                } finally {
                    statusDiv.style.display = 'block';
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            });
        });
    });
</script>
{% endblock %}
