{% extends "base.html" %}

{% block title %}Admin Upload Data{% endblock %}

{% block custom_styles %}
/* Custom styles for the upload page */
.upload-container {
    padding: 20px;
    max-width: 1100px;
    margin: 20px auto;
    background-color: var(--background-color-light);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-medium);
}
.upload-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}
.upload-card {
    padding: 20px;
    border: 1px solid #e0e0e0;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
    transition: transform 0.2s;
}
.upload-card:hover {
    transform: translateY(-3px);
}
.upload-card h4 {
    margin-top: 0;
    color: var(--primary-color);
    border-bottom: 1px dashed #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
}
.upload-form label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}
.upload-form input[type="file"],
.upload-form select,
.upload-form input[type="text"] {
    width: 100%;
    padding: 8px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}
.upload-button {
    background-color: #28a745;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.2s;
}
.upload-button:hover {
    background-color: #1e7e34;
}
.status-message {
    margin-top: 15px;
    padding: 10px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.9rem;
}
.status-success {
    background-color: #d1e7dd;
    color: #0f5132;
    border: 1px solid #badbcc;
}
.status-error {
    background-color: #f8d7da;
    color: #842029;
    border: 1px solid #f5c2c7;
}

/* Flex untuk Grouping Bulan/Tahun */
.date-group {
    display: flex;
    gap: 10px;
}
.date-group > div {
    flex: 1;
}
.date-group input {
    margin-bottom: 0 !important; /* Override default margin */
}

{% endblock %}

{% block content %}
<div class="upload-container">
    <h2 style="color: var(--primary-color); margin-bottom: 20px;">
        <i class="fas fa-upload"></i> Admin Upload Data - Manajemen Master Data
    </h2>
    <p class="text-muted" style="margin-bottom: 30px;">
        Unggah file data master (CSV/XLSX) untuk memperbarui koleksi database. Harap perhatikan kolom kunci (NOMEN, NOTAGIHAN) dan Periode Tagihan/Tunggakan yang diperlukan untuk data historis.
    </p>

    <div class="upload-grid">
        
        <!-- 1. Master Cetak (MC) / Piutang Bulanan -->
        <div class="upload-card">
            <h4 style="border-left: 4px solid #007bff; padding-left: 10px;">Master Cetak (MC)</h4>
            <p style="font-size: 0.8rem; color: var(--secondary-color);">Data Tagihan Bulanan (Perlu Bulan/Tahun)</p>
            <form class="upload-form" id="formMC" data-endpoint="{{ url_for('upload_mc_data') }}">
                <div class="date-group">
                    <div>
                        <label for="monthMC">Bulan Tagihan (MM)</label>
                        <input type="text" id="monthMC" name="month" placeholder="contoh: 12" required maxlength="2">
                    </div>
                    <div>
                        <label for="yearMC">Tahun Tagihan (YYYY)</label>
                        <input type="text" id="yearMC" name="year" placeholder="contoh: 2025" required maxlength="4">
                    </div>
                </div>
                <label for="fileMC">Pilih File MC (.csv, .xlsx)</label>
                <input type="file" id="fileMC" name="file" accept=".csv, .xlsx, .xls" required>
                <button type="submit" class="upload-button"><i class="fas fa-database"></i> Upload MC Data</button>
                <div id="statusMC" class="status-message" style="display: none;"></div>
            </form>
        </div>
        
        <!-- 2. Master Bayar (MB) / Koleksi Harian -->
        <div class="upload-card">
            <h4 style="border-left: 4px solid #28a745; padding-left: 10px;">Master Bayar (MB)</h4>
            <p style="font-size: 0.8rem; color: var(--secondary-color);">Data Transaksi Pembayaran Harian (Mode Append)</p>
            <form class="upload-form" id="formMB" data-endpoint="{{ url_for('upload_mb_data') }}">
                <label for="fileMB">Pilih File MB (.csv, .xlsx)</label>
                <input type="file" id="fileMB" name="file" accept=".csv, .xlsx, .xls" required>
                <button type="submit" class="upload-button" style="background-color: #28a745;"><i class="fas fa-hand-holding-usd"></i> Upload MB Data</button>
                <div id="statusMB" class="status-message" style="display: none;"></div>
            </form>
        </div>
        
        <!-- 3. Customer Data (CID) / Master Pelanggan -->
        <div class="upload-card">
            <h4 style="border-left: 4px solid #ffc107; color: #343a40; padding-left: 10px;">Customer Data (CID)</h4>
            <p style="font-size: 0.8rem; color: var(--secondary-color);">Data Induk Pelanggan (Mode Replace/Historis)</p>
            <form class="upload-form" id="formCID" data-endpoint="{{ url_for('upload_cid_data') }}">
                <label for="fileCID">Pilih File CID (.csv, .xlsx)</label>
                <input type="file" id="fileCID" name="file" accept=".csv, .xlsx, .xls" required>
                <button type="submit" class="upload-button" style="background-color: #ffc107; color: var(--text-color);"><i class="fas fa-user-circle"></i> Upload CID Data</button>
                <div id="statusCID" class="status-message" style="display: none;"></div>
            </form>
        </div>

        <!-- 4. Meter Reading (SBRS) / Stand Meter -->
        <div class="upload-card">
            <h4 style="border-left: 4px solid #17a2b8; padding-left: 10px;">Meter Reading (SBRS)</h4>
            <p style="font-size: 0.8rem; color: var(--secondary-color);">Data Pembacaan Meter Lapangan (Mode Append)</p>
            <form class="upload-form" id="formSBRS" data-endpoint="{{ url_for('upload_sbrs_data') }}">
                <label for="fileSBRS">Pilih File SBRS (.csv, .xlsx)</label>
                <input type="file" id="fileSBRS" name="file" accept=".csv, .xlsx, .xls" required>
                <button type="submit" class="upload-button" style="background-color: #17a2b8;"><i class="fas fa-tint"></i> Upload SBRS Data</button>
                <div id="statusSBRS" class="status-message" style="display: none;"></div>
            </form>
        </div>

        <!-- 5. Account Receivable Debt (ARDEBT) / Detail Tunggakan -->
        <div class="upload-card">
            <h4 style="border-left: 4px solid #dc3545; padding-left: 10px;">Detail Tunggakan (ARDEBT)</h4>
            <p style="font-size: 0.8rem; color: var(--secondary-color);">Detail Piutang/Tunggakan per Pelanggan (Perlu Bulan/Tahun)</p>
            <form class="upload-form" id="formARDEBT" data-endpoint="{{ url_for('upload_ardebt_data') }}">
                <div class="date-group">
                    <div>
                        <label for="monthAR">Bulan Tunggakan (MM)</label>
                        <input type="text" id="monthAR" name="month" placeholder="contoh: 12" required maxlength="2">
                    </div>
                    <div>
                        <label for="yearAR">Tahun Tunggakan (YYYY)</label>
                        <input type="text" id="yearAR" name="year" placeholder="contoh: 2025" required maxlength="4">
                    </div>
                </div>
                <label for="fileAR">Pilih File ARDEBT (.csv, .xlsx)</label>
                <input type="file" id="fileAR" name="file" accept=".csv, .xlsx, .xls" required>
                <button type="submit" class="upload-button" style="background-color: #dc3545;"><i class="fas fa-hand-holding-usd"></i> Upload ARDEBT Data</button>
                <div id="statusARDEBT" class="status-message" style="display: none;"></div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const forms = ['formMC', 'formMB', 'formCID', 'formSBRS', 'formARDEBT'];

        forms.forEach(formId => {
            const form = document.getElementById(formId);
            if (form) {
                form.addEventListener('submit', handleUpload);
            }
        });

        async function handleUpload(e) {
            e.preventDefault();
            const form = e.target;
            const statusDiv = document.getElementById(`status${form.id.slice(4)}`);
            const button = form.querySelector('button');
            const endpoint = form.dataset.endpoint;
            
            statusDiv.style.display = 'none';
            statusDiv.classList.remove('status-success', 'status-error');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

            const formData = new FormData(form);

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData,
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    statusDiv.classList.add('status-success');
                    statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${result.message}`;
                } else {
                    statusDiv.classList.add('status-error');
                    statusDiv.innerHTML = `<i class="fas fa-times-circle"></i> ${result.message}`;
                }

            } catch (error) {
                statusDiv.classList.add('status-error');
                statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Terjadi kesalahan jaringan atau server (${error.message}).`;
                console.error('Upload error:', error);
            } finally {
                statusDiv.style.display = 'block';
                button.disabled = false;
                button.innerHTML = button.dataset.originalHtml || form.id.includes('MC') ? '<i class="fas fa-database"></i> Upload MC Data' :
                                   form.id.includes('MB') ? '<i class="fas fa-hand-holding-usd"></i> Upload MB Data' :
                                   form.id.includes('CID') ? '<i class="fas fa-user-circle"></i> Upload CID Data' :
                                   form.id.includes('SBRS') ? '<i class="fas fa-tint"></i> Upload SBRS Data' :
                                   form.id.includes('ARDEBT') ? '<i class="fas fa-hand-holding-usd"></i> Upload ARDEBT Data' : 'Upload Data';

                // Simpan original HTML button untuk penggunaan berikutnya
                if (!button.dataset.originalHtml) {
                    button.dataset.originalHtml = button.innerHTML;
                }
            }
        }
    });
</script>
{% endblock %}
