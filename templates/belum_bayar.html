{% extends "base.html" %}

{% block title %}Tunggakan - SUNTER{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Daftar Tunggakan</h1>
        <p class="page-subtitle">Monitoring pelanggan yang belum menyelesaikan pembayaran</p>
    </div>
</div>

<div class="filter-bar">
    <div class="filter-row">
        <div class="filter-item">
            <div class="filter-label">Bulan</div>
            <select class="form-select" id="bulan">
                <option value="1">Januari</option>
                <option value="2">Februari</option>
                <option value="3">Maret</option>
                <option value="4">April</option>
                <option value="5">Mei</option>
                <option value="6">Juni</option>
                <option value="7">Juli</option>
                <option value="8">Agustus</option>
                <option value="9">September</option>
                <option value="10">Oktober</option>
                <option value="11">November</option>
                <option value="12" selected>Desember</option>
            </select>
        </div>
        <div class="filter-item">
            <div class="filter-label">Tahun</div>
            <select class="form-select" id="tahun">
                <option value="2023">2023</option>
                <option value="2024" selected>2024</option>
                <option value="2025">2025</option>
            </select>
        </div>
    </div>
    <button class="btn btn-primary btn-block mt-3" id="loadDataBtn">
        <i class="fas fa-search"></i>
        <span>Tampilkan Data</span>
    </button>
</div>

<div class="card mb-4" style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger);">
    <div class="card-body">
        <div class="d-flex align-items-center gap-3">
            <i class="fas fa-exclamation-triangle text-danger" style="font-size: 24px;"></i>
            <div>
                <div class="font-bold text-danger">Peringatan Tunggakan</div>
                <div class="text-med" style="font-size: 13px;">
                    Ditemukan <span id="alertCount" class="font-bold">0</span> pelanggan belum melunasi tagihan periode ini.
                </div>
            </div>
        </div>
    </div>
</div>

<div class="kpi-container">
    <div class="kpi-card">
        <span class="kpi-label"><i class="fas fa-user-clock text-danger"></i> Total Pelanggan</span>
        <div class="kpi-value" id="kpi-total-unpaid">0</div>
        <div class="kpi-change negative">Belum Bayar</div>
    </div>
    
    <div class="kpi-card">
        <span class="kpi-label"><i class="fas fa-money-bill-wave text-danger"></i> Total Nominal</span>
        <div class="kpi-value" id="kpi-amount-unpaid" style="font-size: 1.1rem;">Rp 0</div>
        <div class="kpi-change negative" id="kpi-amount-change">Tunggakan Aktif</div>
    </div>
    
    <div class="kpi-card">
        <span class="kpi-label"><i class="fas fa-percent text-warning"></i> Rasio Tunggakan</span>
        <div class="kpi-value" id="kpi-percentage-unpaid">0%</div>
        <div class="kpi-change" id="kpi-percentage-change">Dari Total Tagihan</div>
    </div>
    
    <div class="kpi-card">
        <span class="kpi-label"><i class="fas fa-chart-bar text-info"></i> Rata-rata</span>
        <div class="kpi-value" id="kpi-avg-unpaid" style="font-size: 1.1rem;">Rp 0</div>
        <div class="kpi-change">Per Pelanggan</div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-chart-pie"></i> Distribusi per Rayon</h3>
    </div>
    <div class="card-body">
        <div class="chart-container" style="height: 250px;">
            <canvas id="unpaidChart"></canvas>
        </div>
    </div>
</div>

<div class="tabs">
    <button class="tab-item active" data-tab="list">Daftar Pelanggan</button>
    <button class="tab-item" data-tab="rayon">Analisa Rayon</button>
    <button class="tab-item" data-tab="critical">Kondisi Kritis</button>
</div>

<div id="tab-list" class="tab-pane">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-list"></i> Data Tunggakan</h3>
            <button class="btn btn-sm btn-outline" id="exportListBtn">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
        <div class="card-body p-0">
            <div class="p-3 border-bottom">
                <input type="text" id="searchInput" class="form-control" placeholder="Cari Nomen atau Nama...">
            </div>
            <div class="table-container">
                <table class="table" id="unpaidTable">
                    <thead>
                        <tr>
                            <th data-field="nomen">Nomen</th>
                            <th data-field="nama">Nama</th>
                            <th data-field="rayon">Rayon</th>
                            <th data-field="tagihan">Tagihan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer text-muted text-center" style="font-size: 11px;">
            Halaman <span id="currentPage">1</span> dari <span id="totalPages">1</span>
        </div>
    </div>
</div>

<div id="tab-rayon" class="tab-pane d-none">
    <div class="card">
        <div class="card-header"><h3 class="card-title"><i class="fas fa-map-marked-alt"></i> Ringkasan Rayon</h3></div>
        <div class="table-container">
            <table class="table" id="rayonTable">
                <thead>
                    <tr>
                        <th>Rayon</th>
                        <th>Jumlah Pelanggan</th>
                        <th>Total Nominal</th>
                        <th>Kontribusi %</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="tab-critical" class="tab-pane d-none">
    <div class="card">
        <div class="card-header"><h3 class="card-title text-danger"><i class="fas fa-exclamation-circle"></i> Pelanggan Kritis (>3 Bulan)</h3></div>
        <div class="table-container">
            <table class="table" id="criticalTable">
                <thead>
                    <tr>
                        <th>Nomen</th>
                        <th>Nama</th>
                        <th>Nominal Tunggakan</th>
                        <th>Durasi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let unpaidChart = null;
let allUnpaidData = [];

document.addEventListener('DOMContentLoaded', () => {
    loadUnpaidData();
    initTabActions();
});

function initTabActions() {
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            const target = this.getAttribute('data-tab');
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('d-none'));
            document.getElementById('tab-' + target).classList.remove('d-none');
        });
    });
}

document.getElementById('loadDataBtn').addEventListener('click', loadUnpaidData);

async function loadUnpaidData() {
    const bulan = document.getElementById('bulan').value;
    const tahun = document.getElementById('tahun').value;
    
    try {
        TableHelpers.showLoading('unpaidTable');
        const unpaidData = await App.api(`/api/belum-bayar/list?bulan=${bulan}&tahun=${tahun}`);
        allUnpaidData = unpaidData;
        
        updateKPI(unpaidData);
        renderTables(unpaidData);
        renderChart(unpaidData);
        
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

function updateKPI(data) {
    const totalUnpaid = data.length;
    const totalAmount = data.reduce((sum, item) => sum + (item.tagihan || 0), 0);
    const avgAmount = totalUnpaid > 0 ? totalAmount / totalUnpaid : 0;
    
    document.getElementById('alertCount').textContent = App.formatNumber(totalUnpaid);
    document.getElementById('kpi-total-unpaid').textContent = App.formatNumber(totalUnpaid);
    document.getElementById('kpi-amount-unpaid').textContent = App.formatRupiah(totalAmount);
    document.getElementById('kpi-avg-unpaid').textContent = App.formatRupiah(avgAmount);
}

function renderTables(data) {
    // 1. Unpaid Table
    const unpaidCols = [
        { field: 'nomen', class: 'font-semibold' },
        { field: 'nama' },
        { field: 'rayon', formatter: v => `<span class="badge badge-info">${v}</span>` },
        { field: 'tagihan', class: 'font-bold text-danger', formatter: v => App.formatRupiah(v) },
        { field: 'id', formatter: (v, row) => `<button class="btn btn-sm btn-outline" onclick="App.toast('ID: ${row.nomen}', 'info')"><i class="fas fa-eye"></i></button>` }
    ];
    TableHelpers.render('unpaidTable', data, unpaidCols, { sortable: true });

    // 2. Rayon Summary Table
    const byRayon = {};
    data.forEach(item => {
        const r = item.rayon || 'Unknown';
        if (!byRayon[r]) byRayon[r] = { rayon: r, count: 0, total: 0 };
        byRayon[r].count++;
        byRayon[r].total += (item.tagihan || 0);
    });
    
    const rayonList = Object.values(byRayon);
    const totalAll = rayonList.reduce((s, r) => s + r.total, 0);
    
    const rayonCols = [
        { field: 'rayon', class: 'font-bold' },
        { field: 'count', formatter: v => App.formatNumber(v) },
        { field: 'total', class: 'font-bold', formatter: v => App.formatRupiah(v) },
        { field: 'total', formatter: v => (totalAll > 0 ? (v/totalAll*100).toFixed(1) : 0) + '%' }
    ];
    TableHelpers.render('rayonTable', rayonList, rayonCols, { sortable: true });
}

function renderChart(data) {
    const ctx = document.getElementById('unpaidChart').getContext('2d');
    const grouped = {};
    data.forEach(i => grouped[i.rayon] = (grouped[i.rayon] || 0) + 1);

    if (unpaidChart) unpaidChart.destroy();
    
    unpaidChart = ChartHelpers.createPieChart(ctx, {
        labels: Object.keys(grouped),
        data: Object.values(grouped)
    });
}

document.getElementById('searchInput').addEventListener('input', App.debounce(function() {
    TableHelpers.filter('unpaidTable', this.value);
}, 300));

document.getElementById('exportListBtn').addEventListener('click', () => {
    TableHelpers.exportToCSV('unpaidTable', 'daftar_tunggakan.csv');
});
</script>
{% endblock %}
