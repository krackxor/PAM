<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">
            <i class="fas fa- database text-primary"></i> Data SBRS
        </h3>
        <div class="d-flex gap-2">
            <button class="btn btn-icon btn-sm btn-outline" onclick="SBRS.refresh()" title="Muat Ulang">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-icon btn-sm btn-outline" onclick="TableHelpers.exportToCSV('sbrsTable', 'data_sbrs.csv')" title="Export CSV">
                <i class="fas fa-download"></i>
            </button>
        </div>
    </div>
    
    <div class="card-body p-0">
        <div class="p-3 border-bottom bg-light">
            <div class="input-group">
                <span class="input-group-text bg-transparent border-end-0">
                    <i class="fas fa-search text-low"></i>
                </span>
                <input type="text" id="sbrsSearch" class="form-control border-start-0" placeholder="Cari Nomen, Nama, atau Alamat...">
            </div>
        </div>

        <div class="table-container" style="position: relative;">
            <table class="table" id="sbrsTable">
                <thead>
                    <tr>
                        <th style="width: 50px;" class="text-center">No</th>
                        <th data-field="nomen">Nomen</th>
                        <th data-field="nama">Nama Pelanggan</th>
                        <th data-field="rayon">Rayon</th>
                        <th data-field="stand_awal" class="text-right">Awal</th>
                        <th data-field="stand_akhir" class="text-right">Akhir</th>
                        <th data-field="volume" class="text-right">Volume</th>
                        <th data-field="readmethod">Metode</th>
                        <th class="text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="sbrsTableBody">
                    </tbody>
            </table>
        </div>
    </div>
    
    <div class="card-footer bg-white d-flex justify-content-between align-items-center">
        <div class="text-low" style="font-size: 0.75rem;">
            Menampilkan <span id="sbrs-count" class="font-bold">0</span> data
        </div>
        <div class="pagination-hint text-low" style="font-size: 0.7rem;">
            <i class="fas fa-arrows-alt-h"></i> Geser untuk lihat detail
        </div>
    </div>
</div>

<script>
/**
 * SBRS Component Logic v2.1
 * Standalone Vanilla JS integration
 */
const SBRS = {
    // Definisi Kolom
    columns: [
        { field: 'nomen', class: 'font-bold' },
        { field: 'nama', class: 'text-truncate', style: 'max-width: 150px;' },
        { field: 'rayon', formatter: v => `<span class="badge badge-info">${v}</span>` },
        { field: 'stand_awal', class: 'text-right', formatter: v => App.formatNumber(v) },
        { field: 'stand_akhir', class: 'text-right', formatter: v => App.formatNumber(v) },
        { field: 'volume', class: 'text-right font-bold', formatter: (v) => {
            const color = v > 100 ? 'text-danger' : (v === 0 ? 'text-warning' : 'text-primary');
            return `<span class="${color}">${App.formatNumber(v)} mÂ³</span>`;
        }},
        { field: 'readmethod', formatter: v => `<small class="text-muted">${v || '-'}</small>` },
        { 
            field: 'nomen', 
            class: 'text-center',
            formatter: (v) => `<button class="btn btn-sm btn-icon" onclick="App.toast('Detail ${v}', 'info')"><i class="fas fa-eye text-primary"></i></button>` 
        }
    ],

    init: function() {
        this.loadData();
        
        // Search Listener with Debounce
        document.getElementById('sbrsSearch').addEventListener('input', App.debounce((e) => {
            TableHelpers.filter('sbrsTable', e.target.value);
            const visibleCount = document.querySelectorAll('#sbrsTableBody tr:not(.d-none):not(.filter-empty)').length;
            document.getElementById('sbrs-count').textContent = visibleCount;
        }, 300));
    },

    loadData: async function() {
        TableHelpers.showLoading('sbrsTable', 8);
        try {
            // Mengambil bulan/tahun dari filter global jika ada
            const bulan = document.getElementById('bulan')?.value || new Date().getMonth() + 1;
            const tahun = document.getElementById('tahun')?.value || new Date().getFullYear();
            
            const response = await App.api(`/api/sbrs/list?bulan=${bulan}&tahun=${tahun}`);
            
            TableHelpers.render('sbrsTable', response.data || response, this.columns, {
                showRowNumber: true,
                sortable: true,
                emptyMessage: "Data SBRS periode ini belum tersedia."
            });
            
            document.getElementById('sbrs-count').textContent = (response.data || response).length;

        } catch (err) {
            console.error("SBRS Load Error:", err);
            TableHelpers.showEmpty('sbrsTable', "Gagal memuat data. Periksa koneksi internet.");
        }
    },

    refresh: function() {
        this.loadData();
    }
};

// Auto-run on load
document.addEventListener('DOMContentLoaded', () => SBRS.init());
</script>

<style>
/* SBRS Specific UI */
#sbrsTable thead th {
    white-space: nowrap;
    background: var(--bg-main);
}

.text-truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Memperjelas indikasi scroll horizontal di mobile */
@media (max-width: 768px) {
    .table-container::after {
        content: '';
        position: absolute;
        top: 0; right: 0; bottom: 0;
        width: 20px;
        background: linear-gradient(to right, transparent, rgba(0,0,0,0.03));
        pointer-events: none;
    }
}
</style>
