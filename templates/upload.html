{% extends "base.html" %}

{% block title %}Unggah Data - SUNTER{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Unggah Berkas</h1>
        <p class="page-subtitle">Unggah file MC, Collection, atau SBRS untuk memperbarui dashboard</p>
    </div>
</div>

<div id="alertContainer"></div>

<div class="card" id="uploadCard">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-file-import"></i> Pilih Berkas</h3>
    </div>
    <div class="card-body">
        <div class="upload-zone" id="uploadZone" style="border: 2px dashed var(--border-color); border-radius: var(--radius-lg); padding: 3rem 1rem; text-align: center; cursor: pointer; transition: var(--transition);">
            <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
            </div>
            <div class="font-bold text-high" style="font-size: 1.1rem;">Klik atau seret berkas ke sini</div>
            <div class="text-low" style="font-size: 0.85rem; margin-top: 0.5rem;">Mendukung: Excel (.xlsx) atau CSV (.csv)</div>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.txt" style="display: none;">
        </div>

        <div id="selectedFile" class="d-none mt-4 p-4" style="background: var(--bg-main); border-radius: var(--radius-standard); border: 1px solid var(--primary-light);">
            <div class="d-flex align-items-center gap-3">
                <i class="fas fa-file-excel text-primary" style="font-size: 2rem;"></i>
                <div style="flex: 1;">
                    <div id="fileName" class="font-bold text-high">-</div>
                    <div id="fileSize" class="text-low" style="font-size: 0.8rem;">-</div>
                </div>
                <button class="btn btn-icon text-danger" id="cancelBtn"><i class="fas fa-times"></i></button>
            </div>
            <button class="btn btn-primary btn-block mt-4" id="uploadBtn">
                <i class="fas fa-rocket"></i> Proses & Simpan Data
            </button>
        </div>
    </div>
</div>

<div id="loader" class="d-none text-center p-5">
    <div class="spinner spinner-lg mb-3"></div>
    <div class="font-bold text-high">Menganalisa Berkas...</div>
    <p class="text-low">Mohon tunggu, sistem sedang memvalidasi data Anda.</p>
</div>

<div id="resultCard" class="card d-none">
    <div class="card-body text-center p-5">
        <div class="btn-icon bg-success-light mb-4" style="width: 80px; height: 80px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; background: rgba(16, 185, 129, 0.1);">
            <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
        </div>
        <h2 class="font-bold text-high mb-2">Unggah Berhasil!</h2>
        <p id="resultSubtitle" class="text-low mb-4">-</p>

        <div class="row mb-4" id="statsGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            </div>

        <div class="d-flex gap-2">
            <a href="/" class="btn btn-primary flex-1"><i class="fas fa-home"></i> Beranda</a>
            <button class="btn btn-outline flex-1" id="uploadAnotherBtn">Lagi</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const selectedFile = document.getElementById('selectedFile');
const uploadBtn = document.getElementById('uploadBtn');
const cancelBtn = document.getElementById('cancelBtn');
const uploadCard = document.getElementById('uploadCard');
const loader = document.getElementById('loader');
const resultCard = document.getElementById('resultCard');

let currentFile = null;

// UI Interaction
uploadZone.onclick = () => fileInput.click();

uploadZone.ondragover = (e) => { e.preventDefault(); uploadZone.style.background = 'rgba(37, 99, 235, 0.05)'; };
uploadZone.ondragleave = () => { uploadZone.style.background = ''; };
uploadZone.ondrop = (e) => {
    e.preventDefault();
    uploadZone.style.background = '';
    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
};

fileInput.onchange = (e) => { if (e.target.files.length) handleFile(e.target.files[0]); };

function handleFile(file) {
    currentFile = file;
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
    selectedFile.classList.remove('d-none');
}

cancelBtn.onclick = () => {
    currentFile = null;
    fileInput.value = '';
    selectedFile.classList.add('d-none');
};

// Processing
uploadBtn.onclick = async () => {
    if (!currentFile) return;

    uploadCard.classList.add('d-none');
    loader.classList.remove('d-none');

    const formData = new FormData();
    formData.append('file', currentFile);

    try {
        const data = await App.api('/api/upload', {
            method: 'POST',
            body: formData,
            headers: {} // Let browser set multipart boundary
        });

        if (data.success) {
            showResult(data);
        }
    } catch (err) {
        uploadCard.classList.remove('d-none');
        loader.classList.add('d-none');
    }
};

function showResult(data) {
    loader.classList.add('d-none');
    resultCard.classList.remove('d-none');
    
    document.getElementById('resultSubtitle').textContent = 
        `${data.detection.file_type.toUpperCase()} | Periode: ${data.detection.periode_label}`;

    const grid = document.getElementById('statsGrid');
    grid.innerHTML = `
        <div class="p-3 bg-light rounded">
            <div class="text-low" style="font-size: 0.7rem;">DATA BARU</div>
            <div class="font-bold text-high">${data.processing.rows_inserted}</div>
        </div>
        <div class="p-3 bg-light rounded">
            <div class="text-low" style="font-size: 0.7rem;">TOTAL RECORD</div>
            <div class="font-bold text-high">${data.statistics.total_records || 'N/A'}</div>
        </div>
    `;
}

document.getElementById('uploadAnotherBtn').onclick = () => location.reload();
</script>
{% endblock %}
