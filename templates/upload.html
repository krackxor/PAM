{% extends "base.html" %}

{% block title %}Upload - SUNTER{% endblock %}

{% block content %}
<!-- Header -->
<div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
    <div class="card-body">
        <h1 style="font-size: 24px; font-weight: 700; margin: 0;">
            <i class="fas fa-cloud-upload-alt"></i> Upload Data
        </h1>
        <p style="font-size: 13px; opacity: 0.9; margin-top: var(--space-2); margin-bottom: 0;">
            Upload file Excel untuk update database
        </p>
    </div>
</div>

<!-- Upload Form -->
<div class="card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-file-excel"></i>
            Upload File Excel
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; margin: 0; cursor: pointer;">
                <input type="checkbox" id="autoDetect" checked style="margin: 0;">
                <span>Auto Detect</span>
            </label>
        </div>
    </div>
    <div class="card-body">
        <form id="uploadForm" enctype="multipart/form-data">
            <!-- File Input FIRST -->
            <div style="margin-bottom: var(--space-4);">
                <label class="filter-label">File Excel (.xlsx, .xls)</label>
                <div style="position: relative;">
                    <input 
                        type="file" 
                        id="fileInput" 
                        name="file" 
                        accept=".xlsx,.xls" 
                        required
                        style="display: none;"
                    >
                    <button 
                        type="button" 
                        class="btn btn-outline btn-block" 
                        onclick="document.getElementById('fileInput').click()"
                        style="text-align: left; position: relative;"
                    >
                        <i class="fas fa-paperclip"></i>
                        <span id="fileName">Pilih file...</span>
                    </button>
                </div>
                <div style="font-size: 11px; color: var(--text-muted); margin-top: var(--space-1);">
                    <i class="fas fa-info-circle"></i> Max 10MB, format .xlsx atau .xls
                </div>
            </div>
            
            <!-- Auto Detection Result (shown after file selected) -->
            <div id="detectionResult" style="display: none; margin-bottom: var(--space-4); padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                    <i class="fas fa-robot" style="color: var(--primary);"></i>
                    <span style="font-weight: 600;">Auto Detection</span>
                </div>
                <div style="font-size: 13px; color: var(--text-secondary);">
                    <div><strong>File Type:</strong> <span id="detectedType">-</span></div>
                    <div><strong>Periode:</strong> <span id="detectedPeriode">-</span></div>
                    <div><strong>Date Column:</strong> <span id="detectedDateCol">-</span></div>
                </div>
            </div>
            
            <!-- Manual Override (initially hidden, shown when auto-detect off or user wants to change) -->
            <div id="manualFields" style="display: none;">
                <!-- File Type Selection -->
                <div style="margin-bottom: var(--space-4);">
                    <label class="filter-label">Tipe File</label>
                    <select class="filter-select" id="fileType" name="file_type" required>
                        <option value="">-- Pilih Tipe File --</option>
                        <option value="mc">Master (MC)</option>
                        <option value="collection">Collection</option>
                        <option value="mb">Belum Bayar (MB)</option>
                        <option value="mainbill">Mainbill</option>
                        <option value="sbrs">SBRS</option>
                        <option value="ardebt">Ardebt</option>
                    </select>
                </div>
                
                <!-- Periode Selection -->
                <div class="filter-row" style="margin-bottom: var(--space-4);">
                    <div class="filter-item">
                        <label class="filter-label">Bulan</label>
                        <select class="filter-select" id="bulan" name="bulan" required>
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Maret</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Juni</option>
                            <option value="7">Juli</option>
                            <option value="8">Agustus</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12" selected>Desember</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">Tahun</label>
                        <select class="filter-select" id="tahun" name="tahun" required>
                            <option value="2023">2023</option>
                            <option value="2024" selected>2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary btn-block" id="uploadBtn">
                <i class="fas fa-upload"></i>
                <span>Upload File</span>
            </button>
        </form>
    </div>
</div>

<!-- Progress -->
<div class="card" id="progressCard" style="display: none;">
    <div class="card-body">
        <div style="text-align: center; padding: var(--space-4) 0;">
            <div class="spinner" style="width: 48px; height: 48px; border-width: 4px; margin: 0 auto var(--space-3);"></div>
            <div style="font-weight: 600; margin-bottom: var(--space-2);">Uploading...</div>
            <div style="font-size: 13px; color: var(--text-muted);" id="progressText">Memproses file...</div>
        </div>
    </div>
</div>

<!-- Format Guide -->
<div class="card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-info-circle"></i>
            Panduan Format File
        </div>
    </div>
    <div class="card-body">
        <div class="tabs">
            <button class="tab active" data-tab="master">Master</button>
            <button class="tab" data-tab="collection">Collection</button>
            <button class="tab" data-tab="sbrs">SBRS</button>
        </div>
        
        <!-- Master Format -->
        <div class="tab-content" id="tab-master">
            <div style="padding: var(--space-3); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-top: var(--space-3);">
                <div style="font-weight: 600; margin-bottom: var(--space-2);">
                    <i class="fas fa-table"></i> Format Master Pelanggan
                </div>
                <div style="font-size: 13px; color: var(--text-secondary);">
                    <strong>Kolom yang diperlukan:</strong><br>
                    • nomen (Nomor Pelanggan)<br>
                    • nama (Nama Pelanggan)<br>
                    • alamat (Alamat)<br>
                    • rayon (Kode Rayon)<br>
                    • tarif (Tarif)<br>
                    • target_mc (Target MC)
                </div>
            </div>
        </div>
        
        <!-- Collection Format -->
        <div class="tab-content" id="tab-collection" style="display: none;">
            <div style="padding: var(--space-3); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-top: var(--space-3);">
                <div style="font-weight: 600; margin-bottom: var(--space-2);">
                    <i class="fas fa-table"></i> Format Collection Harian
                </div>
                <div style="font-size: 13px; color: var(--text-secondary);">
                    <strong>Kolom yang diperlukan:</strong><br>
                    • nomen (Nomor Pelanggan)<br>
                    • volume (Volume m³)<br>
                    • current (Pembayaran Current)<br>
                    • tunggakan (Pembayaran Tunggakan)<br>
                    • total (Total Pembayaran)<br>
                    • tanggal_bayar (Tanggal Bayar)
                </div>
            </div>
        </div>
        
        <!-- SBRS Format -->
        <div class="tab-content" id="tab-sbrs" style="display: none;">
            <div style="padding: var(--space-3); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-top: var(--space-3);">
                <div style="font-weight: 600; margin-bottom: var(--space-2);">
                    <i class="fas fa-table"></i> Format SBRS
                </div>
                <div style="font-size: 13px; color: var(--text-secondary);">
                    <strong>Kolom yang diperlukan:</strong><br>
                    • rayon (Kode Rayon)<br>
                    • total_pelanggan (Total Pelanggan)<br>
                    • sudah_bayar (Sudah Bayar)<br>
                    • belum_bayar (Belum Bayar)<br>
                    • total_collection (Total Collection)
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Uploads -->
<div class="card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-history"></i>
            Upload Terakhir
        </div>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-responsive">
            <table class="table" id="recentUploads">
                <thead>
                    <tr>
                        <th>Waktu</th>
                        <th>Tipe</th>
                        <th>Periode</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="4" class="loading">
                            <div class="spinner"></div>
                            <p>Loading...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto detect state
let autoDetectEnabled = true;
let detectedData = null;

// Toggle auto detect
document.getElementById('autoDetect').addEventListener('change', function() {
    autoDetectEnabled = this.checked;
    document.getElementById('manualFields').style.display = autoDetectEnabled ? 'none' : 'block';
    
    if (!autoDetectEnabled) {
        document.getElementById('detectionResult').style.display = 'none';
    }
});

// File input change
document.getElementById('fileInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (file) {
        document.getElementById('fileName').textContent = file.name;
        
        // Auto detect if enabled
        if (autoDetectEnabled) {
            await analyzeFile(file);
        }
    }
});

async function analyzeFile(file) {
    try {
        // Show loading in detection result
        const detectionResult = document.getElementById('detectionResult');
        detectionResult.style.display = 'block';
        document.getElementById('detectedType').textContent = 'Analyzing...';
        document.getElementById('detectedPeriode').textContent = 'Analyzing...';
        document.getElementById('detectedDateCol').textContent = 'Analyzing...';
        
        // Prepare form data
        const formData = new FormData();
        formData.append('file', file);
        
        // Call detection API
        const response = await fetch('/api/upload/analyze', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Analysis failed');
        }
        
        // Store detected data
        detectedData = result.detected;
        
        // Show results
        const typeMap = {
            'mc': 'Master (MC)',
            'mb': 'Belum Bayar (MB)',
            'collection': 'Collection',
            'mainbill': 'Mainbill',
            'sbrs': 'SBRS',
            'ardebt': 'Ardebt'
        };
        
        document.getElementById('detectedType').textContent = typeMap[detectedData.file_type] || detectedData.file_type;
        document.getElementById('detectedPeriode').textContent = `${detectedData.month}/${detectedData.year}`;
        document.getElementById('detectedDateCol').textContent = detectedData.date_column || 'N/A';
        
        // Show warning if any
        if (detectedData.warning) {
            App.toast(detectedData.warning, 'warning', 5000);
        }
        
    } catch (error) {
        console.error('Analysis error:', error);
        App.toast('Auto-detect gagal. Gunakan manual mode.', 'error');
        document.getElementById('autoDetect').checked = false;
        document.getElementById('autoDetect').dispatchEvent(new Event('change'));
    }
}

// Form submit
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const uploadBtn = document.getElementById('uploadBtn');
    
    try {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        
        // Add detected data if auto-detect enabled
        if (autoDetectEnabled && detectedData) {
            formData.append('file_type', detectedData.file_type);
            formData.append('bulan', detectedData.month);
            formData.append('tahun', detectedData.year);
        }
        
        // Upload
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            App.toast('Upload berhasil! Rows: ' + result.rows_processed, 'success');
            this.reset();
            document.getElementById('fileName').textContent = 'Pilih file...';
            document.getElementById('detectionResult').style.display = 'none';
            detectedData = null;
            loadRecentUploads();
        } else {
            throw new Error(result.error || 'Upload failed');
        }
        
    } catch (error) {
        App.toast('Upload gagal: ' + error.message, 'error');
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> <span>Upload File</span>';
    }
});

// Load recent uploads
async function loadRecentUploads() {
    try {
        const response = await fetch('/api/history/uploads?limit=5');
        const data = await response.json();
        
        const tbody = document.querySelector('#recentUploads tbody');
        
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Belum ada upload</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.map(item => `
            <tr>
                <td>${item.upload_time}</td>
                <td><span class="badge badge-info">${item.file_type}</span></td>
                <td>${item.periode_bulan}/${item.periode_tahun}</td>
                <td><span class="badge badge-success">Success</span></td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading uploads:', error);
    }
}

// Load on page load
window.addEventListener('DOMContentLoaded', loadRecentUploads);
</script>
{% endblock %}
