{% extends "base.html" %}

{% block title %}Smart Upload - SUNTER{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-magic mr-2"></i>Smart Upload Center</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Sistem akan otomatis mendeteksi tipe data (SBRS, Collection, MC, dll) dan periode berdasarkan isi file Anda.</p>
                    <form id="uploadForm">
                        <div class="form-group mb-4">
                            <label class="font-weight-bold">Pilih File (Excel/CSV):</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" name="file" id="fileInput" accept=".xlsx, .xls, .csv, .txt" required>
                                <label class="custom-file-label" for="fileInput">Pilih file...</label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block shadow-sm py-2 fw-bold" id="submitBtn">
                            <i class="fas fa-play mr-1"></i> MULAI PROSES OTOMATIS
                        </button>
                    </form>

                    <div id="statusArea" class="mt-4 d-none">
                        <div class="alert alert-info border-0 shadow-sm" id="statusMessage">
                            <div class="spinner-border spinner-border-sm mr-2" role="status"></div>
                            Menganalisa struktur file...
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update nama file di label
$('.custom-file-input').on('change', function() {
    let fileName = $(this).val().split('\\').pop();
    $(this).next('.custom-file-label').addClass("selected").html(fileName);
});

$('#uploadForm').on('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const submitBtn = $('#submitBtn');
    const statusArea = $('#statusArea');
    const statusMessage = $('#statusMessage');

    submitBtn.prop('disabled', true);
    statusArea.removeClass('d-none');
    statusMessage.removeClass('alert-success alert-danger').addClass('alert-info')
                 .html('<div class="spinner-border spinner-border-sm mr-2"></div> Sedang membaca isi file dan mencocokkan periode...');

    $.ajax({
        url: '/api/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            statusMessage.removeClass('alert-info').addClass('alert-success')
                .html('<strong><i class="fas fa-check-circle mr-1"></i> Berhasil!</strong> ' + response.message);
            setTimeout(() => { window.location.href = '/'; }, 2500);
        },
        error: function(xhr) {
            let errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Gagal memproses file.';
            statusMessage.removeClass('alert-info').addClass('alert-danger')
                .html('<strong><i class="fas fa-exclamation-triangle mr-1"></i> Error:</strong> ' + errorMsg);
            submitBtn.prop('disabled', false);
        }
    });
});
</script>
{% endblock %}
