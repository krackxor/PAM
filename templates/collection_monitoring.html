{% extends "base.html" %}

{% block title %}Monitoring & Detail Koleksi{% endblock %}

{% block custom_styles %}
/* Custom CSS dari file lama, relevan untuk monitoring & detail */
.report-header { text-align: center; margin-bottom: 20px; }
.report-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
.summary-card { 
    background-color: var(--card-bg); 
    padding: 15px; 
    border-radius: var(--border-radius); 
    box-shadow: var(--shadow-light);
    text-align: center; 
    border: 1px solid #e0e0e0;
    border-left: 5px solid;
    transition: transform 0.2s;
}
.summary-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}
.summary-card h4 { margin: 0 0 5px 0; font-size: 0.9em; color: #6c757d; }
.summary-card p { margin: 0; font-size: 1.6em; font-weight: bold; }

.filter-input-group { 
    margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ddd; 
    display: flex; align-items: stretch; gap: 10px; 
}
#filterInput { 
    padding: 12px; 
    border: 1px solid #ced4da; 
    border-radius: var(--border-radius); 
    font-size: 16px; 
    flex-grow: 1; 
}
.report-table-wrapper { overflow-x: auto; margin-top: 20px; }

/* --- TABLE LAYOUT --- */
.report-table, .collection-table { 
    width: 100%; border-collapse: collapse; font-size: 14px; 
    box-shadow: var(--shadow-light); 
    border-radius: var(--border-radius);
    overflow: hidden; 
}
.report-table th, .report-table td, .collection-table th, .collection-table td { 
    border: 1px solid #f0f0f0; padding: 10px; text-align: right; white-space: nowrap; 
}
.report-table th, .collection-table th { background-color: #e9ecef; text-align: center; font-weight: 600; }
.report-table { min-width: 1000px; }
.undue-cell { font-weight: bold; color: #17a2b8 !important; }

.grand-total-row { font-weight: bold; background-color: #d0e7ff; color: var(--text-color); } 
.percentage-cell { font-weight: bold; color: var(--secondary-color); }

.no-results { text-align: center; color: #555; padding: 20px; }

/* Mobile Table Styling for collection-table */
@media screen and (max-width: 600px) {
    .collection-table thead { display: none; }
    .collection-table tr:not(.total-row) {
        display: block;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .collection-table td {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        border: none;
        border-bottom: 1px solid #eee;
        text-align: right; 
    }
    .collection-table td:before {
        content: attr(data-label); 
        font-weight: 600;
        text-align: left;
        width: 50%; 
        color: var(--text-color);
        padding-right: 10px;
    }
    .collection-table .total-row td {
        display: table-cell;
        border: 1px solid #ddd;
        text-align: center;
        font-weight: bold;
    }
    .collection-table .total-row {
        margin-top: 20px;
        display: table-row-group;
    }
    .report-table {
        min-width: 100%;
    }
}
{% endblock %}

{% block content %}
    <h2 style="text-align: left; border-bottom: none; margin-bottom: 20px; color: var(--primary-color);">
        <i class="fas fa-calendar-alt" style="margin-right: 10px;"></i> Monitoring & Detail Koleksi
    </h2>
    
    <div id="content-monitoring" class="content-section-main">
        
        <h3 style="color: #28a745;">
            <i class="fas fa-arrows-alt-h"></i> Perbandingan Koleksi Bulanan (MoM)
        </h3>
        
        <div id="momReportArea" class="content-section">
            <div id="momSummaryGrid" class="report-grid">
                <p class="no-results" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Perbandingan Bulanan...</p>
            </div>
            <div id="momChartContainer" style="max-width: 900px; margin: 30px auto;">
                <canvas id="momBarChart"></canvas>
            </div>
            <div id="momTableContainer" class="report-table-wrapper" style="margin-top: 30px;">
            </div>
        </div>
        
        <h3 style="color: #007bff; margin-top: 30px;">
            <i class="fas fa-chart-line"></i> Grafik Koleksi DtD (Hari ke Hari)
        </h3>
        
        <div id="dohComparisonArea" class="content-section">
            <div id="dohChartContainer" style="max-width: 900px; margin: 30px auto;">
                <canvas id="dohLineChart"></canvas>
            </div>
            <div id="dohTableContainer" class="report-table-wrapper" style="margin-top: 30px;">
                <p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat data DtD Comparison...</p>
            </div>
        </div>

        <h3 style="color: #dc3545;">
            <i class="fas fa-calendar-alt"></i> Monitoring Koleksi Harian (Rayon 34 & 35)
        </h3>
        
        <div id="monitoringSummaryArea" class="report-grid">
            <p class="no-results" style="grid-column: 1 / 1;"><i class="fas fa-spinner fa-spin"></i> Memuat ringkasan monitoring...</p>
        </div>

        <div id="monitoringTableArea">
        </div>
        
        <div style="text-align: right; margin-top: 10px; margin-bottom: 20px;">
            <a href="#" id="exportReportBtn" class="btn-primary" style="background-color: #6c757d; text-decoration: none;">
                <i class="fas fa-file-excel"></i> Export Monitoring Summary
            </a>
        </div>
        
        <h3 style="color: #007bff;">
            <i class="fas fa-list-alt"></i> Listing Transaksi Pembayaran (MB Detail)
        </h3>

        <div class="filter-input-group">
            <input type="text" id="filterInput" placeholder="Filter Detail (Rayon, NOMEN, Bulan_Rek, Jenis_Tagihan)...">
            <button id="searchBtn" class="btn-primary" style="background-color: var(--primary-color); color: white; padding: 12px 18px; border: none; border-radius: 4px;">
                <i class="fas fa-filter"></i> Filter Detail
            </button>
        </div>

        <div id="detailsArea">
            <p class="no-results">Memuat data transaksi...</p>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Global Variables
        let momChartInstance = null;
        let dohChartInstance = null;

        // Element Selectors
        const filterInput = document.getElementById('filterInput');
        const searchBtn = document.getElementById('searchBtn');
        const detailsArea = document.getElementById('detailsArea');
        const exportReportBtn = document.getElementById('exportReportBtn');
        const momSummaryGrid = document.getElementById('momSummaryGrid');
        const momTableContainer = document.getElementById('momTableContainer');
        const dohTableContainer = document.getElementById('dohTableContainer');
        const monitoringSummaryArea = document.getElementById('monitoringSummaryArea');
        const monitoringTableArea = document.getElementById('monitoringTableArea');


        // ========================
        // === UTILITY FUNCTIONS ===
        // ========================
        function formatRupiah(number) {
            return 'Rp ' + (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
        }
        
        function formatNumber(number) {
            return (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
        }

        function formatPercent(number) {
            return (parseFloat(number) || 0).toFixed(2) + '%';
        }
        
        const getChangeColor = (value) => value > 0 ? '#28a745' : (value < 0 ? '#dc3545' : '#6c757d');
        const getChangeIcon = (value) => value > 0 ? 'up' : (value < 0 ? 'down' : 'minus');


        // =========================================================
        // --- FUNGSI 1: MEMUAT MOM REPORT (Month over Month) ---
        // =========================================================
        async function fetchMoMReport() {
            momSummaryGrid.innerHTML = '<p class="no-results" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Perbandingan Bulanan...</p>';
            momTableContainer.innerHTML = '';
            
            try {
                const response = await fetch('{{ url_for("mom_report_api") }}'); 
                const result = await response.json();

                if (response.status !== 200 || result.status !== 'success') {
                    momSummaryGrid.innerHTML = `<p class="no-results" style="color: red; grid-column: 1 / -1;">❌ Gagal memuat report: ${result.message || 'Error Server'}</p>`;
                    return;
                }
                
                renderMoMReport(result.data);

            } catch (error) {
                momSummaryGrid.innerHTML = '<p class="no-results" style="color: red; grid-column: 1 / -1;">Gagal mengambil data MoM report dari server.</p>';
                console.error('MoM Report Error:', error);
            }
        }

        function renderMoMReport(data) {
            // 1. RENDER SUMMARY GRID
            momSummaryGrid.innerHTML = `
                <div class="summary-card" style="border-left-color: #28a745;">
                    <h4>Nominal Koleksi Bulan Ini (${data.period_current})</h4>
                    <p>${formatRupiah(data.current_nominal)}</p>
                </div>
                <div class="summary-card" style="border-left-color: ${getChangeColor(data.change_nominal)};">
                    <h4>Perubahan Nominal (MoM)</h4>
                    <p style="color: ${getChangeColor(data.change_nominal)};">
                        <i class="fas fa-caret-${getChangeIcon(data.change_nominal)}"></i> 
                        ${formatPercent(data.change_nominal)}
                    </p>
                </div>
                <div class="summary-card" style="border-left-color: #007bff;">
                    <h4>Jml Pelanggan Bulan Ini (${data.period_current})</h4>
                    <p>${formatNumber(data.current_nomen)}</p>
                </div>
                <div class="summary-card" style="border-left-color: ${getChangeColor(data.change_nomen)};">
                    <h4>Perubahan Pelanggan (MoM)</h4>
                    <p style="color: ${getChangeColor(data.change_nomen)};">
                        <i class="fas fa-caret-${getChangeIcon(data.change_nomen)}"></i> 
                        ${formatPercent(data.change_nomen)}
                    </p>
                </div>
            `;

            // 2. RENDER TABLE
            momTableContainer.innerHTML = `
                <h4 style="margin-top: 20px;">Tabel Perbandingan Koleksi Nominal dan Pelanggan</h4>
                <table class="report-table" style="min-width: 600px;">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Metrik</th>
                            <th>Bulan Lalu (${data.period_last})</th>
                            <th>Bulan Ini (${data.period_current})</th>
                            <th>Perubahan (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="text-align: left;">Total Nominal Koleksi</td>
                            <td>${formatRupiah(data.last_nominal)}</td>
                            <td>${formatRupiah(data.current_nominal)}</td>
                            <td style="color: ${getChangeColor(data.change_nominal)}; font-weight: bold;">
                                ${formatPercent(data.change_nominal)}
                            </td>
                        </tr>
                        <tr>
                            <td style="text-align: left;">Jumlah Pelanggan</td>
                            <td>${formatNumber(data.last_nomen)}</td>
                            <td>${formatNumber(data.current_nomen)}</td>
                            <td style="color: ${getChangeColor(data.change_nomen)}; font-weight: bold;">
                                ${formatPercent(data.change_nomen)}
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;
            
            // 3. RENDER BAR CHART
            renderMoMChart(data);
        }

        function renderMoMChart(data) {
            if (momChartInstance) {
                momChartInstance.destroy();
            }

            const ctx = document.getElementById('momBarChart').getContext('2d');
            
            const chartLabels = ['Nominal Koleksi', 'Jumlah Pelanggan'];
            const chartData = {
                labels: chartLabels,
                datasets: [
                    {
                        label: data.period_last,
                        data: [data.last_nominal, data.last_nomen],
                        backgroundColor: '#adb5bd', 
                        borderColor: '#adb5bd',
                        borderWidth: 1
                    },
                    {
                        label: data.period_current,
                        data: [data.current_nominal, data.current_nomen],
                        backgroundColor: '#28a745', 
                        borderColor: '#28a745',
                        borderWidth: 1
                    }
                ]
            };

            momChartInstance = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nilai (Rupiah/Count)'
                            },
                            // Custom ticks for formatting (simplified as one axis for two metrics)
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Perbandingan Koleksi Nominal & Pelanggan (DtD MoM)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    // Custom formatter based on data index (assuming index 0 is nominal)
                                    if (context.dataIndex === 0) {
                                        label += formatRupiah(context.parsed.y);
                                    } else {
                                        label += formatNumber(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // =========================================================
        // --- FUNGSI 2: MEMUAT DOH COMPARISON REPORT (DtD) ---
        // =========================================================
        async function fetchDOHComparisonReport() {
            dohTableContainer.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat data DtD Comparison...</p>';
            
            try {
                const response = await fetch('{{ url_for("doh_comparison_report_api") }}'); 
                const result = await response.json();

                if (response.status !== 200 || result.status !== 'success' || result.data.days.length === 0) {
                    dohTableContainer.innerHTML = `<p class="no-results" style="color: #dc3545;">❌ Gagal memuat report: ${result.message || 'Tidak ada data MB di kedua bulan untuk perbandingan Day-to-Date.'}</p>`;
                    if (dohChartInstance) dohChartInstance.destroy();
                    return;
                }
                
                renderDOHComparisonReport(result.data, result.periods);

            } catch (error) {
                dohTableContainer.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data DtD comparison dari server.</p>';
                console.error('DOH Report Error:', error);
            }
        }

        function renderDOHComparisonReport(data, periods) {
            
            // Helper untuk menghitung Kumulatif
            const calculateCumulative = (arr) => {
                let cumulative = [];
                let currentSum = 0;
                for (const value of arr) {
                    currentSum += value;
                    cumulative.push(currentSum);
                }
                return cumulative;
            }
            
            // Helper untuk menghitung persentase DtD
            const calculateDtDPercentage = (currentDaily, lastDaily) => {
                if (lastDaily === 0) {
                    return currentDaily > 0 ? 100 : 0;
                }
                return ((currentDaily - lastDaily) / lastDaily) * 100;
            };

            // Ambil Data Kumulatif untuk Grafik (TOTAL AB)
            const currentCumulative = calculateCumulative(data.TOTAL_AB[periods.current]);
            const lastCumulative = calculateCumulative(data.TOTAL_AB[periods.last]);

            // 1. Render Chart
            if (dohChartInstance) {
                dohChartInstance.destroy();
            }
            
            const ctx = document.getElementById('dohLineChart').getContext('2d');
            
            dohChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.days.map(d => 'Hari ke-' + d),
                    datasets: [
                        {
                            label: `Bulan Lalu (${periods.last}) - Kumulatif`,
                            data: lastCumulative,
                            borderColor: '#adb5bd', 
                            backgroundColor: '#adb5bd50',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                        },
                        {
                            label: `Bulan Ini (${periods.current}) - Kumulatif`,
                            data: currentCumulative,
                            borderColor: '#007bff', 
                            backgroundColor: '#007bff50',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nominal Kumulatif (Rp)'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tren Koleksi Kumulatif DtD (Nominal AB Sunter)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatRupiah(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // 2. Render Tabel
            
            const renderComparisonTable = (areaKey, periods, dataStructure) => {
                
                const areaDailyCurrent = dataStructure[areaKey][periods.current];
                const areaDailyLast = dataStructure[areaKey][periods.last];
                const areaCumulativeCurrent = calculateCumulative(areaDailyCurrent);
                const areaCumulativeLast = calculateCumulative(areaDailyLast);
                
                let subTableHTML = `
                    <h5 style="margin-top: 25px; color: ${areaKey === 'TOTAL_AB' ? '#dc3545' : '#17a2b8'};">
                        DETAIL AREA ${areaKey.replace('R', 'RAYON ').replace('_AB', ' SUNTER')}
                    </h5>
                    <div class="report-table-wrapper">
                    <table class="report-table" style="min-width: 600px;">
                        <thead>
                            <tr>
                                <th rowspan="2">Hari ke-</th>
                                <th colspan="2">${periods.current} (BULAN INI)</th>
                                <th colspan="2">${periods.last} (BULAN LALU)</th>
                                <th rowspan="2">Perubahan Harian (%)</th>
                            </tr>
                            <tr>
                                <th>Harian (Rp)</th>
                                <th>Kumulatif (Rp)</th>
                                <th>Harian (Rp)</th>
                                <th>Kumulatif (Rp)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.days.forEach((day, index) => {
                    const currentDaily = areaDailyCurrent[index];
                    const lastDaily = areaDailyLast[index];
                    const percentageChange = calculateDtDPercentage(currentDaily, lastDaily);
                    const changeColor = getChangeColor(percentageChange);

                    subTableHTML += `
                        <tr>
                            <td style="text-align: center;">${day}</td>
                            <td>${formatRupiah(currentDaily)}</td>
                            <td style="background-color: #f0f8ff;">${formatRupiah(areaCumulativeCurrent[index])}</td>
                            <td>${formatRupiah(lastDaily)}</td>
                            <td style="background-color: #f0f8ff;">${formatRupiah(areaCumulativeLast[index])}</td>
                            <td style="color: ${changeColor}; font-weight: bold;">
                                <i class="fas fa-caret-${getChangeIcon(percentageChange)}"></i> ${formatPercent(percentageChange)}
                            </td>
                        </tr>
                    `;
                });
                
                subTableHTML += '</tbody></table></div>';
                return subTableHTML;
            };

            let tableHTML = renderComparisonTable('TOTAL_AB', periods, data);
            tableHTML += renderComparisonTable('R34', periods, data);
            tableHTML += renderComparisonTable('R35', periods, data);


            dohTableContainer.innerHTML = tableHTML;
        }

        // =========================================================
        // --- FUNGSI 3: MEMUAT MONITORING KOLEKSI HARIAN ---
        // =========================================================
        async function fetchCollectionMonitoring() {
            monitoringSummaryArea.innerHTML = '<p class="no-results" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Memuat data monitoring...</p>';
            monitoringTableArea.innerHTML = '';
            
            try {
                // Asumsi endpoint Flask: collection_monitoring_api
                const response = await fetch('{{ url_for("collection_monitoring_api") }}');
                const result = await response.json();

                if (response.status !== 200 || result.status !== 'success') {
                    monitoringSummaryArea.innerHTML = `<p class="no-results" style="color: red; grid-column: 1 / -1;">❌ Gagal memuat monitoring: ${result.message || 'Error Server'}</p>`;
                    return;
                }
                
                renderMonitoringTable(result.monitoring_data, result.summary_top);

            } catch (error) {
                monitoringSummaryArea.innerHTML = '<p class="no-results" style="color: red; grid-column: 1 / -1;">Gagal mengambil data monitoring dari server.</p>';
                console.error('Monitoring Error:', error);
            }
        }
        
        function renderMonitoringTable(data, summary) {
            
            const globalSummary = summary.GLOBAL || {};

            // Render Summary Top (Menggunakan metrik baru sesuai aturan bisnis)
            monitoringSummaryArea.innerHTML = `
                <div class="summary-card" style="border-left-color: #ffc107;">
                    <h4>Total Piutang MC (Denominator)</h4>
                    <p>${formatRupiah(globalSummary.TotalPiutangMC)}</p>
                </div>
                <div class="summary-card" style="border-left-color: #28a745;">
                    <h4>Total UNDUE Bulan Lalu (Rp)</h4>
                    <p>${formatRupiah(globalSummary.TotalUnduePrev)}</p>
                </div>
                <div class="summary-card" style="border-left-color: var(--primary-color);">
                    <h4>CURRENT Koleksi Harian (Rp)</h4>
                    <p>${formatRupiah(globalSummary.CurrentKoleksiTotal)}</p>
                </div>
                <div class="summary-card" style="border-left-color: #dc3545;">
                    <h4>Total Koleksi (%) Hari Ini</h4>
                    <p>${formatPercent(globalSummary.TotalKoleksiPersen)}</p>
                </div>
                <div class="summary-card" style="border-left-color: #007bff;">
                    <h4>R34 Koleksi Kumulatif Harian (Rp)</h4>
                    <p>${formatRupiah(summary.R34.CURRENT)}</p>
                </div>
                <div class="summary-card" style="border-left-color: #007bff;">
                    <h4>R35 Koleksi Kumulatif Harian (Rp)</h4>
                    <p>${formatRupiah(summary.R35.CURRENT)}</p>
                </div>
            `;
            
            // Helper untuk merender tabel detail per Rayon
            const renderDetailRayonTable = (title, list) => {
                if (list.length === 0) return '';
                
                let tableHTML = `
                    <h4 style="margin-top: 20px; color: #007bff;">${title} (Rp1: Koleksi Bulan Lalu)</h4>
                    <div class="report-table-wrapper">
                    <table class="report-table" style="min-width: 800px;">
                        <thead>
                            <tr>
                                <th>TGL</th>
                                <th>CUST (MB)</th>
                                <th>Rp1 (Nominal Harian)</th>
                                <th>Rp1 Kumulatif</th>
                                <th>CUST Kumulatif</th>
                                <th>COLL Kumulatif % (Global)</th>
                                <th>COLL VAR</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                list.forEach(item => {
                    const rp1 = item.COLL_NOMINAL;
                    const rp1_kumulatif = item.Rp1_Kumulatif;
                    const cust_kumulatif = item.CUST_Kumulatif;
                    const persen = item.COLL_Kumulatif_Persen;
                    const coll_var = item.COLL_VAR;
                    
                    tableHTML += `
                        <tr>
                            <td data-label="TGL" style="text-align: left;">${item.TGL}</td>
                            <td data-label="CUST">${formatNumber(item.CUST_COUNT)}</td>
                            <td data-label="Rp1">${formatRupiah(rp1)}</td>
                            <td data-label="Rp1 Kumulatif">${formatRupiah(rp1_kumulatif)}</td>
                            <td data-label="CUST Kumulatif">${formatNumber(cust_kumulatif)}</td>
                            <td data-label="COLL %" class="percentage-cell">${formatPercent(persen)}</td>
                            <td data-label="COLL VAR">${formatPercent(coll_var)}</td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table></div>';
                return tableHTML;
            }
            
            // Render Detail Tables
            let detailHTML = '';
            detailHTML += renderDetailRayonTable("Detail Monitoring Koleksi - Rayon 34", data.R34);
            detailHTML += renderDetailRayonTable("Detail Monitoring Koleksi - Rayon 35", data.R35);
            
            monitoringTableArea.innerHTML = detailHTML;
        }

        // =========================================================
        // --- FUNGSI 4: MEMUAT DETAIL TRANSAKSIONAL (MB Detail) ---
        // =========================================================
        async function fetchCollectionDetails(query = '') {
            detailsArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Detail Transaksi...</p>';
            
            try {
                // Asumsi endpoint Flask: collection_detail_api
                const response = await fetch('{{ url_for("collection_detail_api") }}' + `?q=${query}`);
                const data = await response.json();
                
                if (response.status !== 200 || data.length === 0) {
                    detailsArea.innerHTML = '<p class="no-results">Tidak ada data koleksi yang ditemukan dengan filter tersebut.</p>';
                    return;
                }

                renderDetailTable(data);

            } catch (error) {
                detailsArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data detail dari server.</p>';
                console.error('Detail Error:', error);
            }
        }
        
        function renderDetailTable(data) {
            
            let totalNominal = 0;
            const uniqueNomen = new Set();
            
            data.forEach(item => {
                const nominal = parseFloat(item.NOMINAL || 0);
                totalNominal += nominal;
                uniqueNomen.add(item.NOMEN); 
            });

            const uniqueNomenCount = uniqueNomen.size;

            let tableHTML = `
                <h4 style="margin-top: 20px;">Listing Transaksi MB (${data.length} Transaksi)</h4>
                <div class="report-table-wrapper">
                <table class="collection-table">
                    <thead>
                        <tr>
                            <th>NOMEN</th>
                            <th>RAYON</th>
                            <th>BULAN TAGIHAN</th>
                            <th>TGL BAYAR</th>
                            <th>NOMINAL</th>
                            <th>JENIS TAGIHAN</th>
                            <th>STATUS UNDUE</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                const nominal = parseFloat(item.NOMINAL || 0);
                const statusText = item.IS_UNDUE ? 'Undue (Bulan Ini)' : 'Normal';
                const statusClass = item.IS_UNDUE ? 'undue-cell' : '';

                tableHTML += `
                    <tr>
                        <td data-label="NOMEN">${item.NOMEN}</td>
                        <td data-label="RAYON">${item.RAYON}</td>
                        <td data-label="BULAN TAGIHAN">${item.BULAN_REK || 'N/A'}</td>
                        <td data-label="TGL BAYAR">${item.PAY_DT || '-'}</td>
                        <td data-label="NOMINAL">Rp ${nominal.toLocaleString('id-ID')}</td>
                        <td data-label="JENIS TAGIHAN">${item.BILL_REASON || 'N/A'}</td>
                        <td data-label="STATUS UNDUE" class="${statusClass}">${statusText}</td>
                    </tr>
                `;
            });
            
            // Baris Ringkasan Total
            tableHTML += `
                <tr class="total-row">
                    <td colspan="4" style="text-align: left;">Total NOMINAL Terfilter</td>
                    <td style="background-color: #d0e7ff; font-weight: bold;">Rp ${totalNominal.toLocaleString('id-ID')}</td>
                    <td colspan="2" style="background-color: #d0e7ff; font-weight: bold;">-</td>
                </tr>
                <tr class="total-row">
                    <td colspan="4" style="text-align: left;">Total NOMEN Unik (Count)</td>
                    <td colspan="3" style="text-align: center; background-color: #d0e7ff; font-weight: bold;">${uniqueNomenCount.toLocaleString('id-ID')}</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            
            detailsArea.innerHTML = tableHTML;
        }


        // Event Listeners and Initial Load
        searchBtn.addEventListener('click', () => {
            fetchCollectionDetails(filterInput.value.trim());
        });
        
        filterInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBtn.click();
            }
        });

        exportReportBtn.addEventListener('click', (e) => {
            e.preventDefault();
            // Asumsi endpoint Flask: export_collection_report
            window.location.href = '{{ url_for("export_collection_report") }}'; 
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchMoMReport();
            fetchCollectionMonitoring();
            fetchCollectionDetails(''); 
            fetchDOHComparisonReport(); 
        });
    </script>
{% endblock %}
