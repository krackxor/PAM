{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Dashboard Analitik AB SUNTER</h1>
<p class="lead">Ringkasan KPI dan tren koleksi harian serta anomali pemakaian air.</p>

<!-- Peringatan Koneksi DB -->
<div id="db-warning" class="alert alert-danger d-none" role="alert">
    <strong>Koneksi Database Gagal:</strong> Dashboard tidak dapat memuat data. Mohon cek status koneksi di halaman utama.
</div>

<!-- RINGKASAN KPI UTAMA -->
<div class="row">
    <!-- Total Piutang Aktif -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-danger h-100 shadow">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <i class="fas fa-file-invoice-dollar fa-2x"></i>
                    </div>
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="font-size: 0.75em;">Total Piutang (MC)</div>
                        <div class="h5 mb-0 font-weight-bold" id="kpi-piutang" style="font-size: 1.1em;">Rp 0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Tunggakan (ARDEBT) -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-warning h-100 shadow">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                    </div>
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="font-size: 0.75em;">Total Tunggakan (ARDEBT)</div>
                        <div class="h5 mb-0 font-weight-bold" id="kpi-tunggakan" style="font-size: 1.1em;">Rp 0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Koleksi Hari Ini -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-success h-100 shadow">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <i class="fas fa-money-check-alt fa-2x"></i>
                    </div>
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="font-size: 0.75em;">Koleksi Hari Ini</div>
                        <div class="h5 mb-0 font-weight-bold" id="kpi-koleksi-today" style="font-size: 1.1em;">Rp 0</div>
                        <small id="kpi-transaksi-today" class="text-white-50">0 Transaksi</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Total Anomali SBRS -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-info h-100 shadow">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <i class="fas fa-water fa-2x"></i>
                    </div>
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="font-size: 0.75em;">Anomali SBRS (Pelanggan)</div>
                        <div class="h5 mb-0 font-weight-bold" id="kpi-anomali" style="font-size: 1.1em;">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ANALISIS GRAFIK DAN TREND -->
<div class="row">
    <!-- Tren Koleksi 7 Hari -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">Tren Koleksi Nominal 7 Hari Terakhir</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="collectionTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top 5 Rayon Piutang -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">Top 5 Rayon Piutang Aktif Terbesar</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="rayonPiutangChart"></canvas>
                </div>
                <div id="rayonPiutangTable" class="mt-3 table-responsive">
                    <!-- Data Rayon Top Piutang akan dimasukkan di sini -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ALERT KRITIS -->
<div class="card shadow mb-4">
    <div class="card-header bg-danger text-white">
        <h6><i class="fas fa-exclamation-triangle"></i> Peringatan Kritis (Volume/Tunggakan > 5 Bln)</h6>
    </div>
    <div class="card-body">
        <div id="critical-alerts-container" class="table-responsive" style="font-size: 0.8em;">
            <p>Memuat peringatan...</p>
        </div>
    </div>
</div>

<div class="text-right mb-5">
    <button id="export-dashboard-btn" class="btn btn-success"><i class="fas fa-file-excel"></i> Export Semua Data Dashboard</button>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script>
    const SUMMARY_API = "{{ url_for('dashboard_summary_api') }}";
    const RAYON_ANALYSIS_API = "{{ url_for('rayon_analysis_api') }}";
    const CRITICAL_ALERTS_API = "{{ url_for('critical_alerts_api') }}";
    
    const DB_WARNING = document.getElementById('db-warning');

    // Helper untuk memformat angka mata uang Rupiah
    const formatCurrency = (amount) => {
        if (typeof amount !== 'number') return 'Rp ' + new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(amount);
        return 'Rp ' + new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(amount);
    };
    
    // Helper untuk memformat angka dengan pemisah ribuan
    const formatNumber = (num) => {
        if (typeof num !== 'number') return '0';
        return new Intl.NumberFormat('id-ID').format(num);
    };

    // --- CHART FUNCTIONS ---
    function createTrendChart(data) {
        const labels = data.map(d => d.tanggal);
        const totals = data.map(d => d.total);
        
        const ctx = document.getElementById('collectionTrendChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Koleksi Nominal',
                    data: totals,
                    backgroundColor: 'rgba(52, 152, 219, 0.7)', /* Warna biru dinamis */
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 3, /* Sedikit lebih tebal */
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    xAxes: [{
                        scaleLabel: { display: true, labelString: 'Tanggal', fontSize: 10 },
                        ticks: { fontSize: 10 } /* Font size lebih kecil */
                    }],
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            fontSize: 10,
                            callback: function(value, index, values) {
                                return formatCurrency(value);
                            }
                        },
                        scaleLabel: { display: true, labelString: 'Nominal (Rp)', fontSize: 10 }
                    }]
                },
                legend: {
                    labels: {
                        fontSize: 11 /* Font size legend */
                    }
                },
                tooltips: {
                    callbacks: {
                        label: function(tooltipItem, data) {
                            return data.datasets[tooltipItem.datasetIndex].label + ': ' + formatCurrency(tooltipItem.yLabel);
                        }
                    }
                }
            }
        });
    }

    function createRayonPiutangChart(data) {
        const labels = data.map(d => d.rayon);
        const totals = data.map(d => d.total);
        
        const ctx = document.getElementById('rayonPiutangChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Piutang',
                    data: totals,
                    backgroundColor: 'rgba(46, 204, 113, 0.7)', /* Warna hijau dinamis */
                    borderColor: 'rgba(39, 174, 96, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    xAxes: [{
                        ticks: { fontSize: 10 } /* Font size lebih kecil */
                    }],
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            fontSize: 10,
                            callback: function(value, index, values) {
                                return formatCurrency(value);
                            }
                        },
                        scaleLabel: { display: true, labelString: 'Nominal (Rp)', fontSize: 10 }
                    }]
                },
                legend: {
                    labels: {
                        fontSize: 11
                    }
                },
                tooltips: {
                    callbacks: {
                        label: function(tooltipItem, data) {
                            return data.datasets[tooltipItem.datasetIndex].label + ': ' + formatCurrency(tooltipItem.yLabel);
                        }
                    }
                }
            }
        });
    }
    
    function updateRayonTable(data) {
        const table = document.getElementById('rayonPiutangTable');
        if (!data || data.length === 0) {
            table.innerHTML = '<p class="text-muted" style="font-size: 0.9em;">Tidak ada data rayon piutang.</p>';
            return;
        }

        let html = '<table class="table table-striped table-sm" style="font-size: 0.8em;">';
        html += '<thead><tr><th>#</th><th>Rayon</th><th>Piutang</th></tr></thead><tbody>';
        
        data.forEach((item, index) => {
            html += `<tr>
                <td>${index + 1}</td>
                <td>${item.rayon}</td>
                <td>${formatCurrency(item.total)}</td>
            </tr>`;
        });

        html += '</tbody></table>';
        table.innerHTML = html;
    }

    function updateCriticalAlerts(data) {
        const container = document.getElementById('critical-alerts-container');
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="alert alert-success" style="font-size: 0.9em;">Tidak ada peringatan kritis saat ini.</div>';
            return;
        }
        
        let html = '<table class="table table-striped table-bordered table-sm" style="font-size: 0.8em;">';
        html += '<thead><tr><th>NOMEN</th><th>Status</th><th>Rayon</th><th>Nominal (Jika Debt)</th></tr></thead><tbody>';

        data.forEach(item => {
            let nominal = item.category === 'DEBT_CRITICAL' ? formatCurrency(item.amount) : '-';
            let badgeClass = item.category === 'DEBT_CRITICAL' ? 'danger' : 'warning';
            let rayon = item.ray || 'N/A';
            
            html += `<tr>
                <td>${item.nomen}</td>
                <td><span class="badge badge-${badgeClass}">${item.status}</span></td>
                <td>${rayon}</td>
                <td>${nominal}</td>
            </tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }


    // --- FETCH DATA ---
    async function loadDashboardData() {
        try {
            // 1. Fetch Summary
            const summaryResponse = await fetch(SUMMARY_API);
            const summaryData = await summaryResponse.json();

            if (summaryData.message && summaryData.message.includes('Server tidak terhubung ke Database')) {
                DB_WARNING.classList.remove('d-none');
                return;
            }
            DB_WARNING.classList.add('d-none');
            
            document.getElementById('kpi-piutang').textContent = formatCurrency(summaryData.total_piutang);
            document.getElementById('kpi-tunggakan').textContent = formatCurrency(summaryData.total_tunggakan);
            document.getElementById('kpi-koleksi-today').textContent = formatCurrency(summaryData.koleksi_hari_ini);
            document.getElementById('kpi-transaksi-today').textContent = `${formatNumber(summaryData.transaksi_hari_ini)} Transaksi`;
            document.getElementById('kpi-anomali').textContent = formatNumber(summaryData.total_anomali);

            // 2. Tren Koleksi
            createTrendChart(summaryData.tren_koleksi_7_hari);

            // 3. Top Rayon
            createRayonPiutangChart(summaryData.top_rayon_piutang);
            updateRayonTable(summaryData.top_rayon_piutang);
            
            // 4. Critical Alerts (Ambil dari API terpisah jika perlu, tapi sudah terintegrasi di Summary)
            const alertResponse = await fetch(CRITICAL_ALERTS_API);
            const alertData = await alertResponse.json();
            updateCriticalAlerts(alertData);

        } catch (error) {
            console.error("Gagal memuat dashboard data:", error);
            DB_WARNING.classList.remove('d-none');
            DB_WARNING.textContent = "Error: Gagal memuat data dashboard. Cek koneksi server atau API.";
        }
    }

    document.getElementById('export-dashboard-btn').addEventListener('click', function() {
        window.location.href = "{{ url_for('export_dashboard_data') }}";
    });

    document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>
{% endblock %}
