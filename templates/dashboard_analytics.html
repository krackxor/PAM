{% extends "base.html" %}

{% block title %}Dashboard Analytics{% endblock %}

{% block custom_styles %}
/* Custom styles for KPI cards and charts */
.dashboard-container {
    padding: 20px;
}
.kpi-card {
    background-color: var(--card-bg);
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
    margin-bottom: 20px;
    text-align: center;
}
.kpi-card h4 {
    color: var(--secondary-color);
    font-size: 1rem;
    margin-bottom: 5px;
}
.kpi-card p {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-color);
}
.grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}
.chart-wrapper {
    background-color: var(--card-bg);
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-medium);
}
.section-title {
    color: var(--primary-color);
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 20px;
}
.trend-chart-container {
    height: 350px;
}
.rayon-card-list {
    text-align: left;
}
.rayon-item {
    padding: 8px 0;
    border-bottom: 1px dashed #eee;
    display: flex;
    justify-content: space-between;
    font-size: 0.95rem;
}
.rayon-item:last-child {
    border-bottom: none;
}
.alert-list {
    list-style: none;
    padding: 0;
    margin-top: 15px;
}
.alert-list li {
    padding: 8px;
    margin-bottom: 5px;
    border-left: 4px solid #dc3545;
    background-color: #f8d7da;
    border-radius: 4px;
    font-size: 0.85rem;
}
.alert-list li i {
    margin-right: 8px;
}

/* Responsive adjustment for chart grid */
@media (max-width: 992px) {
    .main-grid {
        grid-template-columns: 1fr;
    }
}
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h2 class="section-title">
        <i class="fas fa-tachometer-alt"></i> Dashboard Analytics KPI
    </h2>
    
    <div style="text-align: right; margin-bottom: 20px;">
        <a href="{{ url_for('export_dashboard_data') }}" class="btn" style="background-color: #28a745; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none;">
            <i class="fas fa-download"></i> Ekspor Data Dashboard
        </a>
    </div>

    <div id="loadingStatus" style="text-align: center; padding: 30px; color: #6c757d;">
        <i class="fas fa-spinner fa-spin"></i> Memuat Data KPI dan Tren...
    </div>

    <div id="dashboardContent" style="display: none;">
        <!-- KPI Cards -->
        <div class="grid-container">
            <div class="kpi-card" style="border-left: 4px solid #dc3545;">
                <h4>Total Piutang (MC Aktif)</h4>
                <p id="total_piutang">Rp 0</p>
                <small id="piutang_status" style="color: var(--secondary-color);"></small>
            </div>
            <div class="kpi-card" style="border-left: 4px solid #ffc107;">
                <h4>Total Tunggakan (ARDEBT)</h4>
                <p id="total_tunggakan">Rp 0</p>
                <small id="tunggakan_status" style="color: #842029;">0 Pelanggan</small>
            </div>
            <div class="kpi-card" style="background-color: #d1e7dd; border-left: 4px solid #0f5132;">
                <h4>Koleksi Nominal Bulan Ini</h4>
                <p id="koleksi_bulan_ini" style="color: #0f5132;">Rp 0</p>
                <small id="koleksi_persentase" style="color: #0f5132; font-weight: bold;">0.00% dari Piutang</small>
            </div>
            <div class="kpi-card" style="border-left: 4px solid #007bff;">
                <h4>Total Pelanggan Aktif</h4>
                <p id="total_pelanggan">0</p>
                <small>Total Nomen di Master Data</small>
            </div>
        </div>

        <!-- Charts and Lists -->
        <div class="grid-container main-grid" style="grid-template-columns: 2fr 1fr;">
            <!-- 1. Koleksi Trend Chart -->
            <div class="chart-wrapper">
                <h3 style="margin-top: 0;">Tren Koleksi 7 Hari Terakhir</h3>
                <div class="trend-chart-container">
                    <canvas id="collectionTrendChart"></canvas>
                </div>
            </div>
            
            <!-- 2. Top Rayon Piutang -->
            <div class="chart-wrapper">
                <h3 style="margin-top: 0;">Top 5 Rayon Piutang Terbesar</h3>
                <div class="rayon-card-list" id="topRayonList">
                    <!-- Data akan dimasukkan di sini -->
                    <p style="text-align: center; color: var(--secondary-color);">Memuat data...</p>
                </div>
            </div>
        </div>
        
        <!-- 3. Anomaly Summary and Critical Alerts -->
        <div class="grid-container" style="grid-template-columns: 1fr 1fr;">
            <!-- Anomaly Summary Chart -->
            <div class="chart-wrapper">
                <h3 style="margin-top: 0;">Anomali Meter Reading Breakdown</h3>
                <div style="height: 300px;">
                    <canvas id="anomalyBreakdownChart"></canvas>
                </div>
                <p style="text-align: center; margin-top: 15px;">Total Anomali: <strong id="totalAnomaliCount">0</strong></p>
            </div>
            
            <!-- Critical Alerts -->
            <div class="chart-wrapper">
                <h3 style="margin-top: 0; color: #dc3545;">Peringatan Kritis (Alerts)</h3>
                <ul class="alert-list" id="criticalAlertsList">
                    <li style="border-left-color: #dc3545; background-color: #f8d7da;"><i class="fas fa-exclamation-triangle"></i> Memuat peringatan...</li>
                </ul>
                <div style="text-align: right; margin-top: 10px;">
                    <a href="{{ url_for('export_anomalies_data') }}" style="color: var(--primary-color); font-size: 0.9rem;">
                        Ekspor Data Anomali <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    const API_SUMMARY = "{{ url_for('dashboard_summary_api') }}";
    const API_ALERTS = "{{ url_for('critical_alerts_api') }}";
    
    // --- Utility Formatting ---
    function formatRupiah(number) {
        return 'Rp ' + (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
    }
    function formatNumber(number) {
         return (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
    }
    
    // Fungsi Utama untuk Fetch Data
    async function fetchDashboardData() {
        try {
            const [summaryResponse, alertsResponse] = await Promise.all([
                fetch(API_SUMMARY),
                fetch(API_ALERTS)
            ]);

            const summaryData = await summaryResponse.json();
            const alertsData = await alertsResponse.json();

            if (summaryData.message && summaryData.message.includes('Gagal')) {
                document.getElementById('loadingStatus').innerHTML = `<p class="alert danger">❌ Error Summary: ${summaryData.message}</p>`;
                return;
            }

            // 1. Update KPI Cards
            document.getElementById('total_piutang').innerText = formatRupiah(summaryData.total_piutang);
            document.getElementById('piutang_status').innerText = `Dari ${formatNumber(summaryData.jumlah_tagihan)} Tagihan MC`;
            
            document.getElementById('total_tunggakan').innerText = formatRupiah(summaryData.total_tunggakan);
            document.getElementById('tunggakan_status').innerText = `${formatNumber(summaryData.pelanggan_dengan_tunggakan)} Pelanggan Tunggakan`;

            document.getElementById('koleksi_bulan_ini').innerText = formatRupiah(summaryData.koleksi_bulan_ini);
            document.getElementById('koleksi_persentase').innerText = `${summaryData.persentase_koleksi.toFixed(2)}% dari Piutang`;

            document.getElementById('total_pelanggan').innerText = formatNumber(summaryData.total_pelanggan);
            document.getElementById('totalAnomaliCount').innerText = formatNumber(summaryData.total_anomali);


            // 2. Render Tren Koleksi Chart
            renderCollectionTrend(summaryData.tren_koleksi_7_hari);

            // 3. Render Top Rayon List
            renderTopRayonList(summaryData.top_rayon_piutang);
            
            // 4. Render Anomaly Breakdown Chart
            renderAnomalyChart(summaryData.anomali_breakdown.kategori);

            // 5. Render Critical Alerts
            renderCriticalAlerts(alertsData);

            document.getElementById('loadingStatus').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

        } catch (error) {
            document.getElementById('loadingStatus').innerHTML = `<p class="alert danger">❌ Gagal memuat data dari server atau koneksi terputus.</p>`;
            console.error('Fetch Error:', error);
        }
    }

    // Fungsi untuk membuat Chart Tren Koleksi
    function renderCollectionTrend(trendData) {
        const ctx = document.getElementById('collectionTrendChart').getContext('2d');
        
        const sortedData = trendData.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

        const labels = sortedData.map(item => {
            const date = new Date(item.tanggal);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
        });
        
        const nominalData = sortedData.map(item => item.total);

        // Hancurkan instance chart yang ada (jika ada)
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
            existingChart.destroy();
        }

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Koleksi Nominal (Rp)',
                    data: nominalData,
                    borderColor: 'var(--primary-color)',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => 'Koleksi: ' + formatRupiah(context.parsed.y)
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, ticks) {
                                if (Math.abs(value) >= 1000000) {
                                    return (value / 1000000).toFixed(1) + ' Jt';
                                }
                                return formatRupiah(value);
                            }
                        }
                    }
                }
            }
        });
    }

    // Fungsi untuk menampilkan Top Rayon
    function renderTopRayonList(rayonData) {
        const listContainer = document.getElementById('topRayonList');
        if (!rayonData || rayonData.length === 0) {
            listContainer.innerHTML = '<p style="text-align: center; color: var(--secondary-color);">Tidak ada data Rayon.</p>';
            return;
        }

        listContainer.innerHTML = rayonData.map((item, index) => `
            <div class="rayon-item">
                <span style="font-weight: 700;">${index + 1}. Rayon ${item.rayon}</span>
                <span>${formatRupiah(item.total)}</span>
            </div>
        `).join('');
    }
    
    // Fungsi untuk membuat Chart Breakdown Anomali
    function renderAnomalyChart(kategori) {
        const ctx = document.getElementById('anomalyBreakdownChart').getContext('2d');
        
        const labels = [];
        const data = [];
        const colors = [];

        const categoryMap = {
            'KENAIKAN_SIGNIFIKAN': {label: 'Naik/Ekstrim', color: '#ffc107'},
            'PENURUNAN_SIGNIFIKAN': {label: 'Turun Signifikan', color: '#17a2b8'},
            'ZERO_USAGE': {label: 'Zero Usage', color: '#dc3545'}
        };
        
        Object.keys(kategori).forEach(key => {
            if (kategori[key].jumlah > 0 && categoryMap[key]) {
                labels.push(categoryMap[key].label);
                data.push(kategori[key].jumlah);
                colors.push(categoryMap[key].color);
            }
        });
        
        // Hancurkan instance chart yang ada
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
            existingChart.destroy();
        }

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: { display: false }
                }
            }
        });
    }
    
    // Fungsi untuk menampilkan Peringatan Kritis
    function renderCriticalAlerts(alertsData) {
        const listContainer = document.getElementById('criticalAlertsList');
        
        if (!alertsData || alertsData.length === 0) {
            listContainer.innerHTML = '<li style="border-left-color: #28a745; background-color: #d1e7dd;"><i class="fas fa-check-circle"></i> Tidak ada peringatan kritis saat ini.</li>';
            return;
        }
        
        listContainer.innerHTML = alertsData.map(alert => {
            let icon = alert.category === 'DEBT_CRITICAL' ? 'fas fa-dollar-sign' : 'fas fa-water';
            let message = '';
            
            if (alert.category === 'DEBT_CRITICAL') {
                message = `${alert.nomen} (${alert.status}) - Nominal: ${formatRupiah(alert.amount)}`;
            } else {
                message = `${alert.nomen} (Rayon ${alert.ray}) - ${alert.status}`;
            }
            
            return `<li style="border-left-color: #dc3545; background-color: #f8d7da;"><i class="${icon}"></i> ${message}</li>`;
        }).join('');
    }


    document.addEventListener('DOMContentLoaded', fetchDashboardData);
</script>
{% endblock %}
