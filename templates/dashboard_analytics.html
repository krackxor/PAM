{% extends "base.html" %}

{% block title %}Dashboard Analytics Terpadu{% endblock %}

{% block custom_styles %}
/* CSS Khusus untuk Dashboard */
.dashboard-grid {
    display: grid;
    /* Tetap responsif, biarkan browser yang memutuskan berapa banyak kolom yang pas */
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
    gap: 20px;
    margin-bottom: 30px;
    animation: fadeIn 0.5s ease-out; /* Animasi saat grid muncul */
}

/* Summary Card (KPI) - Dinamis */
.summary-card-dash {
    background-color: var(--card-bg);
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
    border-left: 5px solid; /* Border color akan diset oleh class .text-X */
    transition: all 0.3s ease; /* Transisi untuk animasi hover */
}
.summary-card-dash:hover {
    transform: translateY(-5px); /* Efek angkat/lift */
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}
.summary-card-dash h4 { margin: 0 0 5px 0; font-size: 0.9em; text-transform: uppercase; color: #6c757d; }
.summary-card-dash p { margin: 0; font-size: 1.8em; font-weight: bold; }

/* Warna dan Border Accent */
.text-danger { color: #dc3545; border-color: #dc3545 !important; }
.text-success { color: var(--secondary-color); border-color: var(--secondary-color) !important; }
.text-warning { color: var(--accent-color); border-color: var(--accent-color) !important; }

/* Chart and Table Sections - Dinamis */
.chart-section, .table-section {
    background-color: var(--card-bg);
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-medium);
    margin-bottom: 30px;
    transition: box-shadow 0.3s;
}
.chart-section:hover, .table-section:hover {
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
}

/* Grid Lebar Penuh (Chart dan Top Rayon) */
.full-width-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
}

/* Simple Table Styling (Top Rayon Table) */
.data-table-simple-wrapper {
    overflow-x: auto; /* Memastikan scroll horizontal jika kolom terlalu banyak */
}
.data-table-simple {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    min-width: 300px; /* Minimal width untuk tabel kecil */
}
.data-table-simple th, .data-table-simple td {
    padding: 10px;
    border-bottom: 1px solid #eee;
    text-align: left;
}
.data-table-simple th {
    background-color: #f8f9fa;
}
.data-table-simple tr:last-child td {
    border-bottom: none;
}

/* --- MEDIA QUERY UNTUK LAYAR HP --- */
@media (max-width: 900px) {
    /* Grid besar menumpuk (stack) di bawah 900px */
    .full-width-grid {
        grid-template-columns: 1fr;
    }
}
@media (max-width: 600px) {
    /* Summary Card (KPI) akan dipaksa menumpuk 1 kolom di HP */
    .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    .summary-card-dash { 
        padding: 15px;
        transform: none; /* Nonaktifkan efek angkat di HP */
    }
    .summary-card-dash p { 
        font-size: 1.5em; 
    }
    .chart-section, .table-section {
        padding: 15px; /* Kurangi padding di HP */
    }
}
{% endblock %}

{% block content %}
    <h2 style="text-align: left; border-bottom: none; margin-bottom: 10px; color: var(--primary-color);">
        <i class="fas fa-tachometer-alt" style="margin-right: 10px;"></i> Dashboard Analytics Terpadu
    </h2>
    
    <div style="text-align: right; margin-bottom: 20px;">
        <a href="{{ url_for('export_dashboard_data') }}" class="btn-primary" style="background-color: var(--secondary-color); text-decoration: none;">
            <i class="fas fa-file-excel"></i> Export Laporan ke Excel
        </a>
    </div>

    <div id="loadingStatus" style="text-align: center; padding: 30px; color: #6c757d;">
        <i class="fas fa-spinner fa-spin"></i> Memuat data dashboard...
    </div>

    <div id="dashboardContent" style="display: none;">
        
        <h3 style="color: var(--primary-color);">Ringkasan Utama</h3>
        <div class="dashboard-grid" id="summaryGrid">
        </div>

        <div class="full-width-grid">
            
            <div class="chart-section">
                <h3 style="margin-top: 0; color: #2c3e50;">Tren Koleksi Nominal (7 Hari Terakhir)</h3>
                <canvas id="collectionTrendChart"></canvas>
            </div>

            <div class="table-section">
                <h3 style="margin-top: 0; color: #2c3e50;">Top 5 Rayon (Piutang Terbesar)</h3>
                <div id="topRayonTable"></div>
            </div>

        </div>

        <div class="chart-section">
            <h3 style="margin-top: 0; color: #2c3e50;">Ringkasan Anomali Pemakaian Air</h3>
            <div id="anomalySummary"></div>
        </div>
        
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

    <script>
        const summaryGrid = document.getElementById('summaryGrid');
        const anomalySummary = document.getElementById('anomalySummary');
        const topRayonTable = document.getElementById('topRayonTable');
        const loadingStatus = document.getElementById('loadingStatus');
        const dashboardContent = document.getElementById('dashboardContent');
        const alertBadge = document.getElementById('criticalAlertBadge');
        
        function formatRupiah(number) {
            return 'Rp ' + (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
        }
        
        function formatPercent(number) {
            return (parseFloat(number) || 0).toFixed(2) + '%';
        }

        function determineCardColor(key, value) {
            if (key.includes('tunggakan') || (key.includes('anomali') && value > 0)) return 'text-danger';
            if (key.includes('koleksi') || key.includes('pelanggan')) return 'text-success';
            if (key.includes('piutang')) return 'text-warning';
            return 'border-left: 5px solid var(--primary-color)';
        }
        
        function renderSummaryCards(data) {
            summaryGrid.innerHTML = '';
            
            const cardData = [
                { title: "Total Pelanggan (CID)", key: 'total_pelanggan', value: data.total_pelanggan.toLocaleString('id-ID'), color: 'text-success' },
                { title: "Total Piutang Bulanan (MC)", key: 'total_piutang', value: formatRupiah(data.total_piutang), color: 'text-warning' },
                { title: "Total Tunggakan (ARDEBT)", key: 'total_tunggakan', value: formatRupiah(data.total_tunggakan), color: 'text-danger' },
                { title: "Pelanggan Tunggakan Unik", key: 'pelanggan_dengan_tunggakan', value: data.pelanggan_dengan_tunggakan.toLocaleString('id-ID'), color: 'text-danger' },
                { title: "Koleksi Hari Ini", key: 'koleksi_hari_ini', value: formatRupiah(data.koleksi_hari_ini), color: 'text-success' },
                { title: "Koleksi Bulan Ini", key: 'koleksi_bulan_ini', value: formatRupiah(data.koleksi_bulan_ini), color: 'text-success' },
                { title: "Persentase Koleksi (vs Piutang)", key: 'persentase_koleksi', value: formatPercent(data.persentase_koleksi), color: 'text-success' },
                { title: "Total Anomali Pemakaian", key: 'total_anomali', value: data.total_anomali.toLocaleString('id-ID'), color: data.total_anomali > 0 ? 'text-danger' : 'text-success' },
            ];
            
            cardData.forEach(item => {
                const card = `
                    <div class="summary-card-dash ${item.color}">
                        <h4>${item.title}</h4>
                        <p>${item.value}</p>
                    </div>
                `;
                summaryGrid.innerHTML += card;
            });
        }
        
        function renderTopRayon(data) {
            // Membungkus tabel dengan div responsif
            let tableHTML = '<div class="data-table-simple-wrapper"><table class="data-table-simple"><thead><tr><th>Rayon</th><th style="text-align: right;">Piutang (Rp)</th></tr></thead><tbody>';
            
            data.forEach(item => {
                tableHTML += `
                    <tr>
                        <td>${item.rayon || 'N/A'}</td>
                        <td style="text-align: right;">${formatRupiah(item.total)}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table></div>';
            topRayonTable.innerHTML = tableHTML;
        }
        
        function renderAnomalyBreakdown(data) {
            let html = '';
            
            Object.keys(data.kategori).forEach(key => {
                const category = data.kategori[key];
                const title = key.replace(/_/g, ' ').toUpperCase();
                // Menggunakan variabel CSS untuk warna
                const color = key.includes('ekstrim') || key.includes('zero') ? '#dc3545' : '#ffc107';
                
                if (category.jumlah > 0) {
                    html += `
                        <div class="card" style="margin-top: 15px; border-left: 5px solid ${color};">
                             <h4 style="margin-top: 0; color: ${color};">${title} (${category.jumlah} Pelanggan)</h4>
                             <ul style="list-style-type: none; padding: 0;">
                        `;
                    // Hanya menampilkan 5 data teratas untuk ringkasan
                    category.data.slice(0, 5).forEach(item => {
                        html += `<li style="margin-bottom: 5px; border-bottom: 1px dotted #eee; padding-bottom: 5px;">
                                <strong>${item.NOMEN}</strong> - ${item.NAMA} (${item.STATUS_PEMAKAIAN})
                            </li>`;
                    });
                    if (category.jumlah > 5) {
                        html += `<li style="font-size: 0.9em; margin-top: 5px; color: #6c757d;">... dan ${category.jumlah - 5} lainnya.</li>`;
                    }
                    html += `</ul></div>`;
                }
            });
            
            if (!html) {
                html = '<p style="text-align: center; color: var(--secondary-color);">Tidak ada anomali pemakaian air signifikan yang terdeteksi.</p>';
            }
            
            anomalySummary.innerHTML = html;
        }

        function renderCollectionTrendChart(data) {
            const labels = data.map(item => new Date(item.tanggal).toLocaleDateString('id-ID', { month: 'short', day: 'numeric' }));
            const trendData = data.map(item => item.total);

            // Destroy existing chart instance if it exists
            const existingChart = Chart.getChart("collectionTrendChart");
            if (existingChart) {
                existingChart.destroy();
            }

            new Chart(document.getElementById('collectionTrendChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Koleksi Nominal (Rp)',
                        data: trendData,
                        borderColor: 'var(--primary-color)',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, ticks) {
                                    if (Math.abs(value) >= 1000000) {
                                        return 'Rp ' + (value / 1000000).toFixed(0) + ' Jt';
                                    }
                                    return formatRupiah(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        async function fetchDashboardData() {
            loadingStatus.style.display = 'block';
            dashboardContent.style.display = 'none';
            
            try {
                const response = await fetch('{{ url_for("dashboard_summary_api") }}');
                const data = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (response.status !== 200) {
                    loadingStatus.innerHTML = `<span style="color: #dc3545;">❌ Error: ${data.message || 'Gagal memuat data ringkasan.'}</span>`;
                    return;
                }

                renderSummaryCards(data);
                renderTopRayon(data.top_rayon_piutang);
                renderCollectionTrendChart(data.tren_koleksi_7_hari);
                renderAnomalyBreakdown(data.anomali_breakdown);

                loadingStatus.style.display = 'none';
                dashboardContent.style.display = 'block';

            } catch (error) {
                loadingStatus.innerHTML = `<span style="color: #dc3545;">❌ Gagal terhubung ke server.</span>`;
                console.error('Fetch Error:', error);
            }
        }
        
        // Fungsi Critical Alert (Diambil dari base.html)
        async function checkCriticalAlerts() {
            // Memastikan alertBadge ada sebelum fetch
            if (!alertBadge) return; 
            try {
                const response = await fetch('{{ url_for("critical_alerts_api") }}');
                const alerts = await response.json();
                
                if (alerts.length > 0) {
                    alertBadge.textContent = alerts.length;
                    alertBadge.style.display = 'inline-block';
                } else {
                    alertBadge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking alerts:', error);
                alertBadge.style.display = 'none';
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
             fetchDashboardData(); 
             checkCriticalAlerts(); // Cek pertama kali
             // Check setiap 5 menit (300000 ms)
             setInterval(checkCriticalAlerts, 300000); 
        });
    </script>
{% endblock %}
