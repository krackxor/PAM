{% extends "base.html" %}{% block title %}Laporan Piutang & Koleksi{% endblock %}{% block custom_styles %}<style>.summary-container { padding: 20px; }.kpi-card {background-color: #fff; padding: 20px; border-radius: 8px;box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);margin-bottom: 20px; text-align: center; border: 1px solid #e3e6f0;transition: all 0.3s ease;}.kpi-card:hover { transform: translateY(-5px); border-color: #4e73df; }.kpi-card h4 { color: #5a5c69; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; }.kpi-card p { font-size: 1.4rem; font-weight: 700; color: #4e73df; margin: 0; }.grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }

.section-card {
    background-color: #fff; padding: 18px; border-radius: 10px;
    box-shadow: 0 0.15rem 1.5rem 0 rgba(0, 0, 0, 0.05);
    margin-bottom: 25px; border: 1px solid #e3e6f0;
    display: flex; flex-direction: column; height: 100%;
}
.section-title-text { color: #4e73df; font-weight: 800; border-bottom: 2px solid #f8f9fc; padding-bottom: 8px; margin-bottom: 15px; font-size: 1rem; }

.chart-container { height: 200px; position: relative; margin-bottom: 15px; }
.scrollable-table { max-height: 220px; overflow-y: auto; border: 1px solid #eaecf4; border-radius: 5px; margin-bottom: 15px; }
.table-details { font-size: 0.7rem; width: 100%; margin-bottom: 0; }
.table-details th { background-color: #f8f9fc; color: #4e73df; text-transform: uppercase; font-size: 0.6rem; position: sticky; top: 0; z-index: 2; padding: 8px; }
.table-details td { padding: 8px; vertical-align: middle; border-bottom: 1px solid #f2f2f2; }

.insight-box {
    background-color: #f8f9fc; border-left: 4px solid #4e73df;
    padding: 12px; border-radius: 4px; font-size: 0.72rem; color: #5a5c69; margin-top: auto;
}
.insight-box strong { color: #4e73df; display: block; margin-bottom: 4px; text-transform: uppercase; font-size: 0.65rem; }

.btn-group-filter .btn { font-size: 0.6rem; font-weight: 700; padding: 2px 6px; border-radius: 4px !important; }
.btn-group-filter .btn.active { background-color: #4e73df; color: white; border-color: #4e73df; }

.nav-pills .nav-link { font-weight: bold; color: #5a5c69; font-size: 0.85rem; padding: 10px 20px; }
.nav-pills .nav-link.active { background-color: #4e73df; box-shadow: 0 4px 12px rgba(78, 115, 223, 0.2); }

.text-xs { font-size: 0.6rem; color: #858796; }
</style>{% endblock %}{% block content %}<div class="summary-container"><!-- Header: Filter & Download --><div class="d-flex justify-content-between align-items-center mb-4 flex-wrap"><h2 class="mb-0 font-weight-bold text-gray-800" style="font-size: 1.5rem;"><i class="fas fa-chart-pie mr-2 text-primary"></i> Laporan Novak Analytic Smart</h2><div class="d-flex align-items-center mt-2 mt-md-0"><a href="{{ url_for('bp_collection.download_summary_csv', period=period) }}" class="btn btn-sm btn-success shadow-sm mr-3 px-3"><i class="fas fa-file-excel mr-1"></i> Export Data</a><form class="form-inline" method="get"><input type="month" class="form-control form-control-sm mr-2 shadow-sm" name="period" value="{{ period }}"><button type="submit" class="btn btn-sm btn-primary shadow-sm px-3 font-weight-bold">Update</button></form></div></div><!-- Tab Navigasi -->
<ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm border" id="pills-tab" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-toggle="pill" href="#pills-piutang">Piutang Aktif (MC)</a></li>
    <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-tunggakan">Tunggakan (AR)</a></li>
    <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-collection">Pencapaian Koleksi (MB)</a></li>
</ul>

<div class="tab-content">
    {% for cat in ['piutang', 'tunggakan', 'collection'] %}
    <div class="tab-pane fade {% if cat == 'piutang' %}show active{% endif %}" id="pills-{{ cat }}">
        
        <!-- KPI Cards Row -->
        <div class="grid-container">
            <div class="kpi-card" style="border-left: 4px solid #4e73df;">
                <h4>Jumlah Nomen</h4>
                <p id="count-{{ cat }}"><i class="fas fa-spinner fa-spin text-muted"></i></p>
            </div>
            <div class="kpi-card" style="border-left: 4px solid #1cc88a;">
                <h4>Total Kubikasi Air</h4>
                <p id="usage-{{ cat }}"><i class="fas fa-spinner fa-spin text-muted"></i></p>
            </div>
            <div class="kpi-card" style="border-left: 4px solid #f6c23e;">
                <h4>Total Nominal (Rp)</h4>
                <p id="nominal-{{ cat }}"><i class="fas fa-spinner fa-spin text-muted"></i></p>
            </div>
        </div>

        <!-- Kontainer Grid Kontributor -->
        <div id="container-data-{{ cat }}">
            <div class="row">
                {# Removed EZ and BLOCK, added MERK and READ_METHOD #}
                {% for type, label in [('rayon', 'Rayon'), ('pcez', 'PCEZ'), ('pc', 'Petugas (PC)'), ('tarif', 'Tarif'), ('merk', 'Merk Meter'), ('read_method', 'Read Method')] %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="section-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="m-0 section-title-text">{{ label }}</h6>
                            <div class="btn-group btn-group-toggle btn-group-filter">
                                <button class="btn btn-outline-primary btn-sm active" onclick="updateFilter('{{ cat }}', '{{ type }}', 'ALL', this)">ALL</button>
                                <button class="btn btn-outline-primary btn-sm" onclick="updateFilter('{{ cat }}', '{{ type }}', '34', this)">34</button>
                                <button class="btn btn-outline-primary btn-sm" onclick="updateFilter('{{ cat }}', '{{ type }}', '35', this)">35</button>
                            </div>
                        </div>
                        
                        <!-- Grafik -->
                        <div class="chart-container">
                            <canvas id="chart-{{ type }}-{{ cat }}"></canvas>
                        </div>

                        <!-- Tabel Seluruh Data -->
                        <div class="scrollable-table">
                            <table class="table table-sm table-hover table-details" id="table-{{ type }}-{{ cat }}">
                                <thead>
                                    <tr>
                                        <th>{{ label }}</th>
                                        <th class="text-right">Nomen</th>
                                        <th class="text-right">m³</th>
                                        <th class="text-right">Rp</th>
                                        <th class="text-right">%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="5" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Smart Insight -->
                        <div class="insight-box" id="insight-{{ type }}-{{ cat }}">
                            <strong><i class="fas fa-lightbulb mr-1"></i> Smart Insight</strong>
                            <span class="insight-text">Menunggu sinkronisasi data...</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-{{ cat }}" style="display:none;" class="alert alert-light text-center p-5 border shadow-sm">
            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
            <h4 class="text-gray-800">Data Tidak Ditemukan</h4>
            <p class="text-muted">Tidak ada rekaman data ditemukan untuk periode <b>{{ period }}</b></p>
            <a href="{{ url_for('index') }}" class="btn btn-primary btn-sm">Kembali ke Dashboard</a>
        </div>
    </div>
    {% endfor %}
</div>
</div><script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script><script>const currentPeriod = "{{ period }}";const rawStore = {};const chartInstances = {};function formatIDR(val) {
    return new Intl.NumberFormat(&#39;id-ID&#39;).format(val || 0);
}

// Load Overall KPI from comprehensive stats
async function loadKPI() {
    try {
        // Using the correct blueprint path
        const res = await fetch(`{{ url_for(&#39;bp_collection.get_stats_summary_api&#39;) }}?period=${currentPeriod}`);
        const data = await res.json();
        
        // Assuming data structure matches the tabs: piutang, tunggakan, collection
        // We&#39;ll map the comprehensive stats to our UI
        const mapping = {
            &#39;piutang&#39;: {
                count: data.jumlah_tagihan,
                usage: data.total_kubikasi_piutang || 0, // Fallback if not specifically in stats
                nominal: data.total_piutang
            },
            &#39;tunggakan&#39;: {
                count: data.pelanggan_dengan_tunggakan,
                usage: data.total_kubikasi_tunggakan || 0,
                nominal: data.total_tunggakan
            },
            &#39;collection&#39;: {
                count: data.jumlah_nomen_koleksi || 0,
                usage: data.total_kubikasi_koleksi || 0,
                nominal: data.koleksi_bulan_ini
            }
        };

        [&#39;piutang&#39;, &#39;tunggakan&#39;, &#39;collection&#39;].forEach(c =&gt; {
            const s = mapping[c];
            if (s &amp;&amp; s.count &gt; 0) {
                document.getElementById(`count-${c}`).innerText = formatIDR(s.count);
                document.getElementById(`usage-${c}`).innerText = formatIDR(s.usage) + &#39; m³&#39;;
                document.getElementById(`nominal-${c}`).innerText = &#39;Rp &#39; + formatIDR(s.nominal);
            } else if (c === &#39;piutang&#39; &amp;&amp; s.count === 0) {
                 // If no main piutang data, show empty state
                 document.getElementById(`container-data-${c}`).style.display = &#39;none&#39;;
                 document.getElementById(`empty-${c}`).style.display = &#39;block&#39;;
            }
        });
    } catch (e) { console.error(&quot;KPI Error:&quot;, e); }
}

async function loadData(cat, type) {
    try {
        const res = await fetch(`{{ url_for(&#39;bp_collection.category_distribution_api&#39;, category=&#39;&#39;) }}${type}?period=${currentPeriod}`);
        const json = await res.json();
        
        if(!rawStore[cat]) rawStore[cat] = {};
        rawStore[cat][type] = json.data;
        rawStore[cat][`${type}_field`] = json.category;

        renderUI(cat, type, &#39;ALL&#39;);
    } catch (e) { console.error(`Data Error (${type}):`, e); }
}

function renderUI(cat, type, filter) {
    const fullData = rawStore[cat][type] || [];
    
    // Use rayon_origin for filtering 34/35/ALL
    let filtered = fullData;
    if (filter !== &#39;ALL&#39;) {
        filtered = fullData.filter(item =&gt; item.rayon_origin === filter);
    }

    // 1. Update Table
    const tableBody = document.querySelector(`#table-${type}-${cat} tbody`);
    if(filtered.length === 0) {
        tableBody.innerHTML = &#39;&lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;text-center text-muted py-4&quot;&gt;Data Kosong&lt;/td&gt;&lt;/tr&gt;&#39;;
    } else {
        tableBody.innerHTML = filtered.map(item =&gt; `
            &lt;tr&gt;
                &lt;td class=&quot;font-weight-bold&quot;&gt;#${item.id_value || &#39;N/A&#39;}&lt;/td&gt;
                &lt;td class=&quot;text-right&quot;&gt;${formatIDR(item.total_nomen)}&lt;/td&gt;
                &lt;td class=&quot;text-right&quot;&gt;${formatIDR(item.total_kubikasi)}&lt;/td&gt;
                &lt;td class=&quot;text-right font-weight-bold text-primary&quot;&gt;${formatIDR(item.total_piutang)}&lt;/td&gt;
                &lt;td class=&quot;text-right text-xs text-info&quot;&gt;${(item.pct_piutang || 0).toFixed(1)}%&lt;/td&gt;
            &lt;/tr&gt;
        `).join(&#39;&#39;);
    }

    // 2. Update Chart (Top 10 sorted by value)
    const ctx = document.getElementById(`chart-${type}-${cat}`).getContext(&#39;2d&#39;);
    const chartId = `${type}-${cat}`;
    if (chartInstances[chartId]) chartInstances[chartId].destroy();

    const chartData = [...filtered].sort((a,b) =&gt; b.total_piutang - a.total_piutang).slice(0, 10);
    
    chartInstances[chartId] = new Chart(ctx, {
        type: &#39;bar&#39;,
        data: {
            labels: chartData.map(d =&gt; d.id_value || &#39;N/A&#39;),
            datasets: [{
                label: &#39;Piutang (Rp)&#39;,
                data: chartData.map(d =&gt; d.total_piutang),
                backgroundColor: filter === &#39;34&#39; ? &#39;#1cc88a&#39; : (filter === &#39;35&#39; ? &#39;#f6c23e&#39; : &#39;#4e73df&#39;),
                borderRadius: 5,
                barThickness: 15
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { drawBorder: false, color: &#39;#f2f2f2&#39; },
                    ticks: { font: { size: 9 }, callback: v =&gt; v &gt;= 1000000 ? (v/1000000).toFixed(1) + &#39;jt&#39; : formatIDR(v) } 
                },
                x: { grid: { display: false }, ticks: { font: { size: 9 } } }
            }
        }
    });

    // 3. Generate Smart Insight
    generateInsight(cat, type, filter, filtered);
}

function generateInsight(cat, type, filter, data) {
    const box = document.querySelector(`#insight-${type}-${cat} .insight-text`);
    if(!data || data.length === 0) {
        box.innerText = &quot;Data tidak tersedia untuk dianalisa.&quot;;
        return;
    }

    const top = [...data].sort((a,b) =&gt; b.total_piutang - a.total_piutang)[0];
    const context = cat === &#39;piutang&#39; ? &#39;Piutang Aktif&#39; : (cat === &#39;tunggakan&#39; ? &#39;Resiko Tunggakan&#39; : &#39;Pencapaian Koleksi&#39;);
    
    let msg = `Kontribusi ${context} tertinggi pada ${type.toUpperCase()} &lt;b&gt;${top.id_value}&lt;/b&gt; dengan kontribusi &lt;b&gt;${(top.pct_piutang || 0).toFixed(1)}%&lt;/b&gt;.`;
    
    let saran = &quot;&quot;;
    if (cat === &#39;piutang&#39;) {
        saran = &quot; Fokuskan penagihan pada cluster ini guna meminimalisir penunggakan.&quot;;
    } else if (cat === &#39;tunggakan&#39;) {
        saran = &quot; Diperlukan strategi khusus penyelesaian piutang di zona ini.&quot;;
    } else {
        saran = &quot; Efisiensi di zona ini cukup baik, pertahankan performa.&quot;;
    }

    box.innerHTML = `${msg}${saran}`;
}

function updateFilter(cat, type, mode, btn) {
    const parent = btn.parentElement;
    parent.querySelectorAll(&#39;button&#39;).forEach(b =&gt; b.classList.remove(&#39;active&#39;));
    btn.classList.add(&#39;active&#39;);
    renderUI(cat, type, mode);
}

document.addEventListener(&#39;DOMContentLoaded&#39;, () =&gt; {
    loadKPI();
    const types = [&#39;rayon&#39;, &#39;pcez&#39;, &#39;pc&#39;, &#39;tarif&#39;, &#39;merk&#39;, &#39;read_method&#39;];
    const categories = [&#39;piutang&#39;, &#39;tunggakan&#39;, &#39;collection&#39;];
    
    categories.forEach(c =&gt; {
        types.forEach(t =&gt; loadData(c, t));
    });
});
</script>{% endblock %}
