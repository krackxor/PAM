{% extends "base.html" %}

{% block title %}Laporan Piutang & Koleksi{% endblock %}

{% block custom_styles %}
.summary-container { padding: 20px; }
.kpi-card {
    background-color: #fff; padding: 20px; border-radius: 8px;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    margin-bottom: 20px; text-align: center; border: 1px solid #e3e6f0;
}
.kpi-card h4 { color: #5a5c69; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; }
.kpi-card p { font-size: 1.5rem; font-weight: 700; color: #4e73df; margin: 0; }
.grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }

.section-card {
    background-color: #fff; padding: 20px; border-radius: 8px;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    margin-bottom: 30px; border: 1px solid #e3e6f0;
}
.section-title { color: #4e73df; font-weight: 800; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }

.chart-container { height: 250px; position: relative; margin-bottom: 15px; }
.scrollable-table { max-height: 250px; overflow-y: auto; border: 1px solid #eaecf4; border-radius: 5px; }
.table-details { font-size: 0.8rem; width: 100%; margin-bottom: 0; }
.table-details th { background-color: #f8f9fc; color: #4e73df; text-transform: uppercase; font-size: 0.7rem; position: sticky; top: 0; z-index: 2; }

.nav-pills .nav-link { font-weight: bold; color: #5a5c69; }
.nav-pills .nav-link.active { background-color: #4e73df; }

.btn-group-filter .btn { font-size: 0.7rem; font-weight: 700; padding: 2px 10px; }
.btn-group-filter .btn.active { background-color: #4e73df; color: white; border-color: #4e73df; }

.loading-placeholder { color: #858796; font-style: italic; }
{% endblock %}

{% block content %}
<div class="summary-container">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="section-title border-0 mb-0"><i class="fas fa-chart-line mr-2"></i> Laporan Piutang & Koleksi</h2>
        <div class="d-flex align-items-center">
            <a href="{{ url_for('bp_collection.download_summary_csv', period=period) }}" class="btn btn-sm btn-success shadow-sm mr-3">
                <i class="fas fa-file-excel mr-1"></i> Download CSV
            </a>
            <form class="form-inline" method="get">
                <input type="month" class="form-control form-control-sm mr-2 shadow-sm" name="period" value="{{ period }}">
                <button type="submit" class="btn btn-sm btn-primary shadow-sm px-3">Filter Periode</button>
            </form>
        </div>
    </div>

    <!-- Navigasi Tabs -->
    <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm border" id="pills-tab" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-toggle="pill" href="#pills-piutang">Piutang (MC)</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-tunggakan">Tunggakan (AR)</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-collection">Koleksi (MB)</a></li>
    </ul>

    <div class="tab-content">
        {% for cat in ['piutang', 'tunggakan', 'collection'] %}
        <div class="tab-pane fade {% if cat == 'piutang' %}show active{% endif %}" id="pills-{{ cat }}">
            
            <!-- KPI Cards -->
            <div class="grid-container">
                <div class="kpi-card" style="border-left: 4px solid #4e73df;">
                    <h4>Jumlah Nomen</h4>
                    <p id="count-{{ cat }}"><i class="fas fa-spinner fa-spin loading-placeholder"></i></p>
                </div>
                <div class="kpi-card" style="border-left: 4px solid #1cc88a;">
                    <h4>Total Pemakaian</h4>
                    <p id="usage-{{ cat }}"><i class="fas fa-spinner fa-spin loading-placeholder"></i></p>
                </div>
                <div class="kpi-card" style="border-left: 4px solid #f6c23e;">
                    <h4>Total Nominal</h4>
                    <p id="nominal-{{ cat }}"><i class="fas fa-spinner fa-spin loading-placeholder"></i></p>
                </div>
            </div>

            <div id="container-data-{{ cat }}">
                <!-- Loop Kontributor -->
                <div class="row">
                    {% for type, label in [('rayon', 'Rayon'), ('pc', 'Petugas (PC)'), ('pcez', 'PCEZ'), ('tarif', 'Tarif'), ('merk', 'Merk Meter')] %}
                    <div class="col-lg-6 col-xl-4 mb-4">
                        <div class="section-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="m-0 font-weight-bold text-primary">{{ label }}</h6>
                                <div class="btn-group btn-group-toggle btn-group-filter" data-toggle="buttons">
                                    <button class="btn btn-outline-primary active btn-sm" onclick="filterData('{{ cat }}', '{{ type }}', 'ALL', this)">ALL</button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="filterData('{{ cat }}', '{{ type }}', '34', this)">34</button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="filterData('{{ cat }}', '{{ type }}', '35', this)">35</button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="chart-{{ type }}-{{ cat }}"></canvas>
                            </div>
                            <div class="scrollable-table">
                                <table class="table table-sm table-hover table-details" id="table-{{ type }}-{{ cat }}">
                                    <thead><tr><th>{{ label }}</th><th class="text-right">Rp</th></tr></thead>
                                    <tbody><tr><td colspan="2" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div id="empty-{{ cat }}" style="display:none;" class="alert alert-warning text-center p-5">
                <h4><i class="fas fa-exclamation-triangle"></i> Data Tidak Ditemukan</h4>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

<script>
    const period = "{{ period }}";
    const rawDataStore = {}; // Tempat menyimpan data murni dari API
    const chartInstances = {};

    function formatIDR(val) {
        return new Intl.NumberFormat('id-ID').format(val || 0);
    }

    // Fungsi utama pemuatan data KPI
    async function loadStats() {
        try {
            const res = await fetch(`/collection/api/stats_summary?period=${period}`);
            const data = await res.json();
            ['piutang', 'tunggakan', 'collection'].forEach(c => {
                const s = data[c];
                if (s && s.totals && s.totals.count > 0) {
                    document.getElementById(`count-${c}`).innerText = formatIDR(s.totals.count);
                    document.getElementById(`usage-${c}`).innerText = formatIDR(s.totals.total_usage) + ' mÂ³';
                    document.getElementById(`nominal-${c}`).innerText = 'Rp ' + formatIDR(s.totals.total_nominal);
                } else {
                    document.getElementById(`container-data-${c}`).style.display = 'none';
                    document.getElementById(`empty-${c}`).style.display = 'block';
                }
            });
        } catch (e) { console.error(e); }
    }

    // Fungsi memuat data distribusi dan inisialisasi awal
    async function loadDist(cat, type) {
        try {
            const res = await fetch(`/collection/api/distribution/${type}?period=${period}`);
            const json = await res.json();
            
            // Simpan data ke memori agar filter ALL/34/35 cepat (tidak panggil server lagi)
            if(!rawDataStore[cat]) rawDataStore[cat] = {};
            rawDataStore[cat][type] = json.data;
            rawDataStore[cat][`${type}_field`] = json.category;

            renderUI(cat, type, 'ALL');
        } catch (e) { console.error(e); }
    }

    // Fungsi Render Chart dan Table berdasarkan filter
    function renderUI(cat, type, filter) {
        const fullData = rawDataStore[cat][type];
        const field = rawDataStore[cat][`${type}_field`];
        
        // Logika Filter: Jika 34/35, cari yang field Rayon-nya mulai dengan angka tersebut
        // Catatan: Jika type adalah 'rayon', kita filter langsung. Jika PC/Tarif, kita filter berdasarkan relasi data (asumsi data sudah include Rayon atau field id memiliki prefix)
        // Karena di aggregation kita hanya group by satu field, filter 34/35 paling akurat diaplikasikan pada category 'rayon' atau jika field-nya mengandung info rayon.
        let filtered = fullData;
        if (filter !== 'ALL') {
            filtered = fullData.filter(item => {
                const val = String(item[field] || '');
                return val.startsWith(filter);
            });
        }

        // 1. Update Table
        const tableBody = document.querySelector(`#table-${type}-${cat} tbody`);
        if(filtered.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Tidak ada data</td></tr>';
        } else {
            tableBody.innerHTML = filtered.map(item => `
                <tr>
                    <td><strong>${item[field] || 'N/A'}</strong></td>
                    <td class="text-right font-weight-bold">${formatIDR(item.total_piutang)}</td>
                </tr>
            `).join('');
        }

        // 2. Update Chart
        const ctx = document.getElementById(`chart-${type}-${cat}`).getContext('2d');
        const chartId = `${type}-${cat}`;
        
        if (chartInstances[chartId]) chartInstances[chartId].destroy();

        // Ambil Top 10 saja untuk grafik agar tidak sumpek, tapi tabel tetap ALL
        const chartData = filtered.slice(0, 10);

        chartInstances[chartId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.map(d => d[field] || 'N/A'),
                datasets: [{
                    label: 'Nominal Rp',
                    data: chartData.map(d => d.total_piutang),
                    backgroundColor: '#4e73df',
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: v => v >= 1000000 ? (v/1000000).toFixed(1) + 'jt' : formatIDR(v) } },
                    x: { ticks: { font: { size: 9 } } }
                }
            }
        });
    }

    // Fungsi Trigger Tombol Filter
    function filterData(cat, type, mode, btn) {
        // Toggle class active pada tombol
        const parent = btn.parentElement;
        parent.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        renderUI(cat, type, mode);
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        const categories = ['piutang', 'tunggakan', 'collection'];
        const types = ['rayon', 'pc', 'pcez', 'tarif', 'merk'];
        
        categories.forEach(c => {
            types.forEach(t => loadDist(c, t));
        });
    });
</script>
{% endblock %}
