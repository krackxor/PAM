{% extends "base.html" %}

{% block title %}Laporan Piutang & Koleksi{% endblock %}

{% block custom_styles %}
/* Gaya Desain Dashboard */
.summary-container { padding: 20px; }
.kpi-card {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    margin-bottom: 20px;
    text-align: center;
    border: 1px solid #e3e6f0;
}
.kpi-card h4 { color: #5a5c69; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; }
.kpi-card p { font-size: 1.5rem; font-weight: 700; color: #4e73df; margin: 0; }
.grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
.chart-wrapper { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); margin-bottom: 25px; border: 1px solid #e3e6f0; }
.section-title { color: #4e73df; font-weight: 800; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
.nav-pills .nav-link { font-weight: bold; color: #5a5c69; }
.nav-pills .nav-link.active { background-color: #4e73df; }

/* Tabel Detail & Scroll */
.table-details { font-size: 0.82rem; width: 100%; }
.table-details th { background-color: #f8f9fc; color: #4e73df; text-transform: uppercase; font-size: 0.7rem; position: sticky; top: 0; z-index: 2; }
.scrollable-table { max-height: 350px; overflow-y: auto; border: 1px solid #eaecf4; border-radius: 5px; }

.btn-download-excel { background-color: #1cc88a; color: white; border: none; font-weight: bold; }
.btn-download-excel:hover { background-color: #17a673; color: white; }

.loading-placeholder { color: #858796; font-style: italic; }
{% endblock %}

{% block content %}
<div class="summary-container">
    <!-- Header: Judul & Filter -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="section-title mb-0 border-0 text-primary">
            <i class="fas fa-chart-line mr-2"></i> Laporan Piutang & Koleksi
        </h2>
        
        <div class="d-flex mt-2 mt-md-0 align-items-center">
            <a href="{{ url_for('bp_collection.download_summary_csv', period=period) }}" class="btn btn-sm btn-download-excel shadow-sm mr-3">
                <i class="fas fa-file-download mr-1"></i> Download All Data (CSV)
            </a>
            <form class="form-inline" method="get">
                <input type="month" class="form-control form-control-sm mr-2 shadow-sm" name="period" value="{{ period }}">
                <button type="submit" class="btn btn-sm btn-primary shadow-sm px-3">Tampilkan</button>
            </form>
        </div>
    </div>

    <!-- Navigasi Tabs -->
    <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm border" id="pills-tab" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-toggle="pill" href="#pills-piutang">Piutang (MC)</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-tunggakan">Tunggakan (AR)</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-collection">Koleksi (MB)</a></li>
    </ul>

    <div class="tab-content">
        {% for cat in ['piutang', 'tunggakan', 'collection'] %}
        <div class="tab-pane fade {% if cat == 'piutang' %}show active{% endif %}" id="pills-{{ cat }}">
            
            <!-- KPI Cards Row -->
            <div class="grid-container">
                <div class="kpi-card" style="border-left: 4px solid #4e73df;">
                    <h4>Jumlah Nomen</h4>
                    <p id="count-{{ cat }}"><i class="fas fa-spinner fa-spin loading-placeholder"></i></p>
                </div>
                <div class="kpi-card" style="border-left: 4px solid #1cc88a;">
                    <h4>Total Pemakaian</h4>
                    <p id="usage-{{ cat }}"><i class="fas fa-spinner fa-spin loading-placeholder"></i></p>
                </div>
                <div class="kpi-card" style="border-left: 4px solid #f6c23e;">
                    <h4>Total Nominal</h4>
                    <p id="nominal-{{ cat }}"><i class="fas fa-spinner fa-spin loading-placeholder"></i></p>
                </div>
            </div>

            <!-- Tabel Distribusi LENGKAP -->
            <div class="row" id="container-data-{{ cat }}">
                <div class="col-lg-6 mb-4">
                    <div class="chart-wrapper">
                        <h6 class="m-0 font-weight-bold text-primary mb-3">Kontributor Rayon (Lengkap)</h6>
                        <div class="scrollable-table">
                            <table class="table table-sm table-hover table-details mb-0" id="table-rayon-{{ cat }}">
                                <thead><tr><th>Rayon</th><th class="text-right">Nomen</th><th class="text-right">Nominal (Rp)</th></tr></thead>
                                <tbody><tr><td colspan="3" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Memuat Data...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-wrapper">
                        <h6 class="m-0 font-weight-bold text-primary mb-3">Kontributor Petugas (PC)</h6>
                        <div class="scrollable-table">
                            <table class="table table-sm table-hover table-details mb-0" id="table-pc-{{ cat }}">
                                <thead><tr><th>PC</th><th class="text-right">Nomen</th><th class="text-right">Nominal (Rp)</th></tr></thead>
                                <tbody><tr><td colspan="3" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="chart-wrapper">
                        <h6 class="m-0 font-weight-bold text-primary mb-3">Distribusi PCEZ</h6>
                        <div class="scrollable-table">
                            <table class="table table-sm table-hover table-details mb-0" id="table-pcez-{{ cat }}">
                                <thead><tr><th>PCEZ</th><th class="text-right">Nominal</th></tr></thead>
                                <tbody><tr><td colspan="2" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="chart-wrapper">
                        <h6 class="m-0 font-weight-bold text-primary mb-3">Distribusi Tarif</h6>
                        <div class="scrollable-table">
                            <table class="table table-sm table-hover table-details mb-0" id="table-tarif-{{ cat }}">
                                <thead><tr><th>Tarif</th><th class="text-right">Nominal</th></tr></thead>
                                <tbody><tr><td colspan="2" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="chart-wrapper">
                        <h6 class="m-0 font-weight-bold text-primary mb-3">Distribusi Merk Meter</h6>
                        <div class="scrollable-table">
                            <table class="table table-sm table-hover table-details mb-0" id="table-merk-{{ cat }}">
                                <thead><tr><th>Merk</th><th class="text-right">Nominal</th></tr></thead>
                                <tbody><tr><td colspan="2" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pesan Jika Data Kosong -->
            <div id="empty-{{ cat }}" style="display:none;" class="alert alert-warning text-center p-5 border-left-warning shadow-sm">
                <h4 class="font-weight-bold"><i class="fas fa-exclamation-circle"></i> Data Tidak Ditemukan</h4>
                <p>Tidak ada transaksi atau tagihan yang ditemukan untuk periode <strong>{{ period }}</strong>.</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    const currentPeriod = "{{ period }}";

    function formatIDR(val) {
        return new Intl.NumberFormat('id-ID').format(val || 0);
    }

    // 1. Memuat Statistik KPI (Arus Kas / Piutang / Koleksi)
    async function fetchStats() {
        try {
            const response = await fetch(`/collection/api/stats_summary?period=${currentPeriod}`);
            const data = await response.json();
            
            ['piutang', 'tunggakan', 'collection'].forEach(c => {
                const s = data[c];
                if (s && s.totals && s.totals.count > 0) {
                    document.getElementById(`count-${c}`).innerText = formatIDR(s.totals.count);
                    document.getElementById(`usage-${c}`).innerText = formatIDR(s.totals.total_usage) + ' m³';
                    document.getElementById(`nominal-${c}`).innerText = 'Rp ' + formatIDR(s.totals.total_nominal);
                } else {
                    // Jika data benar-benar nol dari API
                    document.getElementById(`container-data-${c}`).style.display = 'none';
                    document.getElementById(`empty-${c}`).style.display = 'block';
                    document.getElementById(`count-${c}`).innerText = '0';
                    document.getElementById(`usage-${c}`).innerText = '0 m³';
                    document.getElementById(`nominal-${c}`).innerText = 'Rp 0';
                }
            });
        } catch (e) {
            console.error("Gagal memuat KPI:", e);
        }
    }

    // 2. Memuat Detail Distribusi (Rayon, PC, dll)
    async function fetchDistribution(cat, type) {
        try {
            const response = await fetch(`/collection/api/distribution/${type}?period=${currentPeriod}`);
            const json = await response.json();
            const tableBody = document.querySelector(`#table-${type}-${cat} tbody`);
            
            if (!json.data || json.data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Data Kosong</td></tr>';
                return;
            }

            tableBody.innerHTML = json.data.map(item => `
                <tr>
                    <td><span class="font-weight-bold text-dark">${item[json.category] || 'N/A'}</span></td>
                    <td class="text-right text-muted">${formatIDR(item.total_nomen)}</td>
                    <td class="text-right font-weight-bold text-primary">${formatIDR(item.total_piutang)}</td>
                </tr>
            `).join('');
        } catch (e) {
            console.error(`Gagal memuat detail ${type}:`, e);
        }
    }

    // Jalankan pemuatan saat halaman siap
    document.addEventListener('DOMContentLoaded', () => {
        fetchStats();
        ['piutang', 'tunggakan', 'collection'].forEach(c => {
            ['rayon', 'pc', 'pcez', 'tarif', 'merk'].forEach(t => fetchDistribution(c, t));
        });
    });
</script>
{% endblock %}
