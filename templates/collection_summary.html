{% extends "base.html" %}

{% block title %}Laporan Piutang & Koleksi{% endblock %}

{% block custom_styles %}
<style>
    .summary-container { padding: 20px; }
    .kpi-card {
        background-color: #fff; padding: 18px; border-radius: 8px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(0, 0, 0, 0.05);
        margin-bottom: 20px; text-align: center; border: 1px solid #e3e6f0;
        transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-3px); border-color: #4e73df; }
    .kpi-card h4 { color: #858796; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
    .kpi-card p { font-size: 1.3rem; font-weight: 700; color: #4e73df; margin: 0; }
    
    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 25px; }

    .section-card {
        background-color: #fff; padding: 18px; border-radius: 10px;
        box-shadow: 0 0.15rem 1.5rem 0 rgba(0, 0, 0, 0.05);
        margin-bottom: 25px; border: 1px solid #e3e6f0;
        display: flex; flex-direction: column; height: 100%;
    }
    .section-title-text { color: #4e73df; font-weight: 800; border-bottom: 2px solid #f8f9fc; padding-bottom: 8px; margin-bottom: 15px; font-size: 0.9rem; }

    .chart-container { height: 190px; position: relative; margin-bottom: 12px; }
    .scrollable-table { max-height: 200px; overflow-y: auto; border: 1px solid #f2f2f2; border-radius: 5px; margin-bottom: 12px; }
    .table-details { font-size: 0.7rem; width: 100%; margin-bottom: 0; }
    .table-details th { background-color: #f8f9fc; color: #4e73df; text-transform: uppercase; font-size: 0.6rem; position: sticky; top: 0; z-index: 2; padding: 6px; }
    .table-details td { padding: 6px; vertical-align: middle; border-bottom: 1px solid #f9f9f9; }

    .insight-box {
        background-color: #f8f9fc; border-left: 4px solid #4e73df;
        padding: 10px; border-radius: 4px; font-size: 0.68rem; color: #5a5c69; margin-top: auto;
    }
    .insight-box strong { color: #4e73df; display: block; margin-bottom: 3px; text-transform: uppercase; font-size: 0.62rem; }

    .btn-group-filter .btn { font-size: 0.6rem; font-weight: 700; padding: 2px 8px; }
    .nav-pills .nav-link { font-weight: bold; font-size: 0.8rem; color: #5a5c69; }
    .nav-pills .nav-link.active { background-color: #4e73df; }
</style>
{% endblock %}

{% block content %}
<div class="summary-container">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h3 class="mb-0 font-weight-bold text-gray-800"><i class="fas fa-chart-pie mr-2 text-primary"></i> Laporan Novak Analytic Smart</h3>
        <div class="d-flex align-items-center">
            <a href="{{ url_for('bp_collection.download_summary_csv', period=period) }}" class="btn btn-sm btn-success shadow-sm mr-3">
                <i class="fas fa-file-excel mr-1"></i> Export Data
            </a>
            <form class="form-inline" method="get">
                <input type="month" class="form-control form-control-sm mr-2" name="period" value="{{ period }}">
                <button type="submit" class="btn btn-sm btn-primary px-3">Update</button>
            </form>
        </div>
    </div>

    <ul class="nav nav-pills mb-4 bg-white p-2 rounded border shadow-sm" id="pills-tab">
        <li class="nav-item"><a class="nav-link active" data-toggle="pill" href="#pills-piutang" onclick="setActiveTab('piutang')">Piutang Aktif (MC)</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-tunggakan" onclick="setActiveTab('tunggakan')">Tunggakan (AR)</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-collection" onclick="setActiveTab('collection')">Pencapaian Koleksi (MB)</a></li>
    </ul>

    <div class="tab-content">
        {% for cat in ['piutang', 'tunggakan', 'collection'] %}
        <div class="tab-pane fade {% if cat == 'piutang' %}show active{% endif %}" id="pills-{{ cat }}">
            <div class="grid-container">
                <div class="kpi-card" style="border-left: 4px solid #4e73df;">
                    <h4>Jumlah Nomen</h4>
                    <p id="count-{{ cat }}"><i class="fas fa-spinner fa-spin text-muted"></i></p>
                </div>
                <div class="kpi-card" style="border-left: 4px solid #1cc88a;">
                    <h4>Total Kubikasi Air</h4>
                    <p id="usage-{{ cat }}"><i class="fas fa-spinner fa-spin text-muted"></i></p>
                </div>
                <div class="kpi-card" style="border-left: 4px solid #f6c23e;">
                    <h4>Total Nominal</h4>
                    <p id="nominal-{{ cat }}"><i class="fas fa-spinner fa-spin text-muted"></i></p>
                </div>
            </div>

            <div class="row">
                {% for type, label in [('rayon', 'Rayon'), ('pcez', 'PCEZ'), ('pc', 'Petugas (PC)'), ('tarif', 'Tarif'), ('merk', 'Merk Meter'), ('read_method', 'Read Method')] %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="section-card shadow-sm">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="m-0 section-title-text">{{ label }}</h6>
                            <div class="btn-group btn-group-toggle btn-group-filter">
                                <button class="btn btn-outline-primary btn-sm active" onclick="updateFilter('{{ cat }}', '{{ type }}', 'ALL', this)">ALL</button>
                                <button class="btn btn-outline-primary btn-sm" onclick="updateFilter('{{ cat }}', '{{ type }}', '34', this)">34</button>
                                <button class="btn btn-outline-primary btn-sm" onclick="updateFilter('{{ cat }}', '{{ type }}', '35', this)">35</button>
                            </div>
                        </div>
                        
                        <div class="chart-container"><canvas id="chart-{{ type }}-{{ cat }}"></canvas></div>

                        <div class="scrollable-table">
                            <table class="table table-sm table-hover table-details" id="table-{{ type }}-{{ cat }}">
                                <thead>
                                    <tr>
                                        <th>Grup</th>
                                        <th class="text-right">Nomen</th>
                                        <th class="text-right">Rp</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="3" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Memuat...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="insight-box" id="insight-{{ type }}-{{ cat }}">
                            <strong><i class="fas fa-lightbulb mr-1"></i> Smart Insight</strong>
                            <span class="insight-text text-muted">Menganalisa data...</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    const currentPeriod = "{{ period }}";
    const rawStore = {}; 
    const chartInstances = {};
    let activeTab = 'piutang';

    function formatIDR(v) { return new Intl.NumberFormat('id-ID').format(v || 0); }
    function formatShort(v) {
        if (v >= 1000000) return (v/1000000).toFixed(1) + 'jt';
        return formatIDR(v);
    }

    async function loadKPI() {
        try {
            const res = await fetch("{{ url_for('bp_collection.get_stats_summary_api') }}?period=" + currentPeriod);
            const data = await res.json();
            
            ['piutang', 'tunggakan', 'collection'].forEach(c => {
                const s = data[c] || {count:0, usage:0, nominal:0};
                document.getElementById(`count-${c}`).innerText = formatIDR(s.count);
                document.getElementById(`usage-${c}`).innerText = formatIDR(s.usage) + ' mÂ³';
                document.getElementById(`nominal-${c}`).innerText = 'Rp ' + formatIDR(s.nominal);
            });
        } catch (e) { console.error("KPI Err:", e); }
    }

    async function loadData(cat, type) {
        try {
            const res = await fetch("{{ url_for('bp_collection.category_distribution_api', category='') }}" + type + "?period=" + currentPeriod + "&type=" + cat.toUpperCase());
            const json = await res.json();
            if(!rawStore[cat]) rawStore[cat] = {};
            rawStore[cat][type] = json.data || [];
            renderUI(cat, type, 'ALL');
        } catch (e) { console.error(`Data Err (${type}):`, e); }
    }

    function renderUI(cat, type, filter) {
        const full = (rawStore[cat] && rawStore[cat][type]) ? rawStore[cat][type] : [];
        let processed = [];

        if (filter === 'ALL') {
            // Gabungkan data dari rayon 34 dan 35 jika filter ALL dipilih
            const map = new Map();
            full.forEach(item => {
                const k = item.id_value || 'N/A';
                if (!map.has(k)) {
                    map.set(k, { ...item });
                } else {
                    const ex = map.get(k);
                    ex.total_piutang += item.total_piutang;
                    ex.total_nomen += item.total_nomen;
                    ex.total_kubikasi += item.total_kubikasi;
                }
            });
            processed = Array.from(map.values());
        } else {
            processed = full.filter(item => item.rayon_origin === filter);
        }

        processed.sort((a,b) => b.total_piutang - a.total_piutang);

        // Update Tabel
        const tbody = document.querySelector(`#table-${type}-${cat} tbody`);
        if (processed.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-muted">Data Kosong</td></tr>';
        } else {
            tbody.innerHTML = processed.map(i => `
                <tr>
                    <td><strong>${i.id_value}</strong></td>
                    <td class="text-right text-muted">${formatIDR(i.total_nomen)}</td>
                    <td class="text-right text-primary font-weight-bold">${formatShort(i.total_piutang)}</td>
                </tr>
            `).join('');
        }

        // Update Grafik
        const chartId = `${type}-${cat}`;
        if (chartInstances[chartId]) chartInstances[chartId].destroy();
        const top = processed.slice(0, 10);
        const ctx = document.getElementById(`chart-${type}-${cat}`).getContext('2d');
        
        chartInstances[chartId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top.map(d => d.id_value),
                datasets: [{
                    data: top.map(d => d.total_piutang),
                    backgroundColor: filter === '34' ? '#1cc88a' : (filter === '35' ? '#f6c23e' : '#4e73df'),
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, ticks: { font: {size:8}, callback: v => formatShort(v) } },
                    x: { ticks: { font: {size:8} } }
                }
            }
        });

        // Insight sederhana
        const box = document.querySelector(`#insight-${type}-${cat} .insight-text`);
        if(processed.length > 0) {
            const topVal = processed[0];
            box.innerHTML = `Kontribusi tertinggi: <b>${topVal.id_value}</b> (${formatShort(topVal.total_piutang)})`;
        } else {
            box.innerText = "Tidak ada data.";
        }
    }

    function updateFilter(cat, type, mode, btn) {
        btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderUI(cat, type, mode);
    }

    function setActiveTab(tab) {
        activeTab = tab;
        const types = ['rayon', 'pcez', 'pc', 'tarif', 'merk', 'read_method'];
        types.forEach(t => loadData(tab, t));
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadKPI();
        setActiveTab('piutang');
    });
</script>
{% endblock %}
