{% extends "base.html" %}

{% block title %}Pencarian Pelanggan Terintegrasi{% endblock %}

{% block custom_styles %}
/* Custom styles for the search page */
.search-container {
    padding: 20px;
    max-width: 1000px;
    margin: 20px auto;
    background-color: var(--background-color-light);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-medium);
}
.search-form {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
}
.search-input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: var(--border-radius);
    font-size: 1rem;
}
.search-button {
    background-color: var(--primary-color);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: background-color 0.2s;
}
.search-button:hover {
    background-color: #0056b3;
}
.loading-message {
    text-align: center;
    color: var(--secondary-color);
    padding: 20px;
}
.result-section {
    margin-top: 25px;
    border-top: 1px solid #eee;
    padding-top: 25px;
}
.result-header {
    color: var(--primary-color);
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
    font-size: 1.2rem;
    font-weight: 600;
}
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.info-item {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: var(--border-radius);
    border-left: 4px solid var(--primary-color);
}
.info-item label {
    font-size: 0.85rem;
    color: var(--secondary-color);
    display: block;
    margin-bottom: 2px;
}
.info-item p {
    font-weight: 600;
    margin: 0;
    color: var(--text-color);
    word-wrap: break-word; /* Memastikan teks panjang pecah */
}
.alert-card {
    padding: 15px;
    border-radius: var(--border-radius);
    font-weight: 700;
    margin-bottom: 20px;
}
.alert-success {
    background-color: #d1e7dd;
    color: #0f5132;
    border-left: 5px solid #0f5132;
}
.alert-danger {
    background-color: #f8d7da;
    color: #842029;
    border-left: 5px solid #842029;
}

/* Tabel Riwayat */
.history-table-wrapper {
    overflow-x: auto;
    margin-top: 15px;
    box-shadow: var(--shadow-light);
    border-radius: var(--border-radius);
    overflow: hidden;
}
.history-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 700px;
    font-size: 0.85rem;
}
.history-table th, .history-table td {
    padding: 10px;
    border: 1px solid #eee;
    text-align: left;
}
.history-table th {
    background-color: #f1f1f1;
    font-weight: 600;
}
.history-table tr:nth-child(even) {
    background-color: #fafafa;
}

/* Mobile adjustments */
@media (max-width: 600px) {
    .search-container {
        padding: 15px;
        margin: 10px;
    }
    .search-form {
        flex-direction: column;
    }
    .info-grid {
        grid-template-columns: 1fr;
    }
}
{% endblock %}

{% block content %}
<div class="search-container">
    <h2 style="color: var(--primary-color); margin-bottom: 20px;">
        <i class="fas fa-search"></i> Pencarian Pelanggan Terintegrasi
    </h2>

    <form id="searchForm" class="search-form">
        <input type="text" id="nomenInput" class="search-input" placeholder="Masukkan NOMEN (Nomor Pelanggan)" required>
        <button type="submit" class="search-button" id="searchButton">
            Cari <i class="fas fa-arrow-right"></i>
        </button>
    </form>

    <div id="searchStatus" class="loading-message" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> Memuat data, mohon tunggu...
    </div>

    <div id="searchResults" style="display: none;">
        <!-- Ringkasan Kesehatan -->
        <div class="result-section">
            <h3 class="result-header">Ringkasan Kesehatan Pelanggan <span id="nomenDisplay"></span></h3>
            <div id="healthSummary" class="alert-card alert-success"></div>
            
            <div class="info-grid">
                <div class="info-item" style="border-left-color: #dc3545;">
                    <label>Status Keuangan</label>
                    <p id="statusFinansial"></p>
                </div>
                <div class="info-item" style="border-left-color: #ffc107;">
                    <label>Total Kewajiban (Piutang + Tunggakan)</label>
                    <p id="totalKewajiban"></p>
                </div>
                <div class="info-item" style="border-left-color: #17a2b8;">
                    <label>Status Pemakaian Meter</label>
                    <p id="statusPemakaian"></p>
                </div>
                <div class="info-item" style="border-left-color: #28a745;">
                    <label>Pembayaran Terakhir</label>
                    <p id="pembayaranTerakhir"></p>
                </div>
            </div>
        </div>

        <!-- Detail Profil Pelanggan -->
        <div class="result-section">
            <h3 class="result-header">Detail Profil Pelanggan</h3>
            <div class="info-grid" id="profileDetails">
                <!-- Detail Profil akan diisi di sini -->
            </div>
        </div>

        <!-- Riwayat Piutang (MC) -->
        <div class="result-section">
            <h3 class="result-header">Riwayat Piutang Master Cetak (MC)</h3>
            <div id="mcHistory" class="history-table-wrapper">
                <!-- Data MC akan diisi di sini -->
                <p class="loading-message">Tidak ada data MC.</p>
            </div>
        </div>
        
        <!-- Riwayat Baca Meter (SBRS) -->
        <div class="result-section">
            <h3 class="result-header">Riwayat Baca Meter (SBRS)</h3>
            <div id="sbrsHistory" class="history-table-wrapper">
                <!-- Data SBRS akan diisi di sini -->
                <p class="loading-message">Tidak ada data SBRS.</p>
            </div>
        </div>
    </div>
</div>

<script>
    const searchForm = document.getElementById('searchForm');
    const nomenInput = document.getElementById('nomenInput');
    const searchStatus = document.getElementById('searchStatus');
    const searchResults = document.getElementById('searchResults');
    const nomenDisplay = document.getElementById('nomenDisplay');
    const healthSummary = document.getElementById('healthSummary');
    const profileDetails = document.getElementById('profileDetails');
    const mcHistoryDiv = document.getElementById('mcHistory');
    const sbrsHistoryDiv = document.getElementById('sbrsHistory');

    // --- Utility Formatting ---
    function formatRupiah(number) {
        // Memastikan input adalah angka dan memformat sebagai Rupiah
        return 'Rp ' + (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
    }
    function formatNumber(number) {
         return (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
    }
    function formatText(text) {
        return (text === null || text === undefined || String(text).trim() === '' || String(text).toUpperCase() === 'N/A') ? 'N/A' : String(text);
    }
    
    // --- Render Functions ---
    
    // Render Ringkasan Kesehatan
    function renderHealthSummary(summary) {
        document.getElementById('statusFinansial').innerText = formatText(summary.STATUS_FINANSIAL);
        document.getElementById('totalKewajiban').innerText = formatRupiah(summary.TOTAL_KEWAJIBAN_NOMINAL);
        document.getElementById('statusPemakaian').innerText = formatText(summary.STATUS_PEMAKAIAN);
        document.getElementById('pembayaranTerakhir').innerText = formatText(summary.PEMBAYARAN_TERAKHIR);

        let statusClass = 'alert-success';
        if (summary.STATUS_FINANSIAL.includes('TUNGGAKAN') || summary.STATUS_PEMAKAIAN.includes('EKSTRIM') || summary.STATUS_PEMAKAIAN.includes('ZERO')) {
            statusClass = 'alert-danger';
        }

        healthSummary.className = `alert-card ${statusClass}`;
        healthSummary.innerHTML = `<strong>Status Global:</strong> ${statusClass.includes('danger') ? '⚠️ PERHATIAN KRITIS' : '✅ NORMAL'}`;
    }

    // Render Detail Profil
    function renderProfileDetails(profile) {
        profileDetails.innerHTML = ''; // Clear previous content

        const fields = [
            { label: 'Nama Pelanggan', key: 'NAMA_PEL' },
            { label: 'Alamat', key: 'ALAMAT' },
            { label: 'Rayon / PCEZ', key: 'RAYON', subKey: 'PCEZ' },
            { label: 'Tarif', key: 'TARIF' },
            { label: 'Tipe Pelanggan', key: 'TIPEPLGGN' },
            { label: 'Merk Meter / Serial', key: 'MERK', subKey: 'SERIAL' },
            { label: 'Kubikasi Tagihan Terakhir (m³)', key: 'KUBIK', format: 'number', unit: 'm³' },
            { label: 'Nominal Tagihan Terakhir', key: 'NOMINAL_MC', format: 'currency' },
            { label: 'Stand Terakhir di CID', key: 'STAND', format: 'text' },
            { label: 'Metode Baca', key: 'READ_METHOD', format: 'text' },
            { label: 'Pencatat / Hari Baca', key: 'PENCATET', subKey: 'HARI' }
        ];

        fields.forEach(field => {
            const div = document.createElement('div');
            div.className = 'info-item';
            
            let value = formatText(profile[field.key]);
            
            if (field.subKey && profile[field.subKey] !== 'N/A') {
                value += ` (${formatText(profile[field.subKey])})`;
            }

            if (field.format === 'currency') {
                value = formatRupiah(profile[field.key]);
            } else if (field.format === 'number') {
                value = formatNumber(profile[field.key]) + (field.unit ? ` ${field.unit}` : '');
            }

            div.innerHTML = `<label>${field.label}</label><p>${value}</p>`;
            profileDetails.appendChild(div);
        });
    }

    // Render Riwayat dalam format Tabel
    function renderHistoryTable(data, containerDiv, columns) {
        if (!data || data.length === 0) {
            containerDiv.innerHTML = '<p class="loading-message">Tidak ada data riwayat ditemukan.</p>';
            return;
        }

        let tableHTML = '<table class="history-table"><thead><tr>';
        columns.forEach(col => {
            tableHTML += `<th>${col.label}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';

        data.forEach(item => {
            tableHTML += '<tr>';
            columns.forEach(col => {
                let value = formatText(item[col.key]);
                if (col.format === 'currency') {
                    value = formatRupiah(item[col.key]);
                } else if (col.format === 'number') {
                     value = formatNumber(item[col.key]) + (col.unit ? ` ${col.unit}` : '');
                } else if (col.format === 'percent') {
                     value = (parseFloat(item[col.key]) || 0).toFixed(2) + '%';
                }
                tableHTML += `<td>${value}</td>`;
            });
            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';
        containerDiv.innerHTML = tableHTML;
    }


    // --- Main Fetch Logic ---
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nomen = nomenInput.value.trim();

        if (!nomen) return;

        searchStatus.style.display = 'block';
        searchResults.style.display = 'none';

        try {
            const response = await fetch(`/api/search?nomen=${nomen}`);
            const result = await response.json();

            searchStatus.style.display = 'none';

            if (result.status === 'not_found' || result.status === 'fail') {
                searchResults.style.display = 'block';
                searchResults.innerHTML = `<div class="alert-card alert-danger">
                    <i class="fas fa-times-circle"></i> ${result.message}
                </div>`;
                return;
            }

            // 1. Update NOMEN Display
            nomenDisplay.innerText = nomen;
            
            // 2. Render Ringkasan Kesehatan
            renderHealthSummary(result.summary);

            // 3. Render Detail Profil
            renderProfileDetails(result.profile_pelanggan);
            
            // 4. Render Riwayat MC
            const mcColumns = [
                { label: 'Bulan Tagihan', key: 'BULAN_TAGIHAN', format: 'text' },
                { label: 'Nominal', key: 'NOMINAL', format: 'currency' },
                { label: 'Kubikasi (m³)', key: 'KUBIK', format: 'number', unit: 'm³' },
                { label: 'Status', key: 'STATUS', format: 'text' },
                { label: 'Rayon', key: 'RAYON', format: 'text' },
                { label: 'Tarif', key: 'TARIF', format: 'text' },
            ];
            renderHistoryTable(result.mc_data, mcHistoryDiv, mcColumns);

            // 5. Render Riwayat SBRS (Pencatatan)
            const sbrsColumns = [
                { label: 'Status Anomali', key: 'STATUS_PEMAKAIAN', format: 'text' },
                { label: 'Kubik Sekarang (m³)', key: 'KUBIK_TERBARU', format: 'number', unit: 'm³' },
                { label: 'Kubik Sebelumnya (m³)', key: 'KUBIK_SEBELUMNYA', format: 'number', unit: 'm³' },
                { label: 'Selisih (%)', key: 'PERSEN_SELISIH', format: 'percent' },
                { label: 'Rayon', key: 'RAYON', format: 'text' },
                { label: 'Tarif', key: 'TARIF', format: 'text' },
                { label: 'Merek', key: 'MERK', format: 'text' },
            ];
            // Mengambil SBRS data dari respons (diambil dari sub-field yang kaya data SBRS)
            // NOTE: Karena API search tidak mengembalikan SBRS data secara utuh, kita akan menggunakan SBRS history yang mungkin sudah diperkaya data.
            renderHistoryTable(result.sbrs_data, sbrsHistoryDiv, sbrsColumns);


            searchResults.style.display = 'block';

        } catch (error) {
            searchStatus.style.display = 'none';
            searchResults.style.display = 'block';
            searchResults.innerHTML = `<div class="alert-card alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Terjadi kesalahan saat berkomunikasi dengan server.
            </div>`;
            console.error('Fetch error:', error);
        }
    });

    // Panggil fungsi sekali saat load untuk memberi status awal jika perlu
    document.addEventListener('DOMContentLoaded', () => {
        if (nomenInput.value.trim() !== '') {
             // Jika ada nilai di input, coba cari otomatis (misal setelah refresh)
        }
        document.getElementById('searchStatus').innerHTML = 'Masukkan Nomor Pelanggan (NOMEN) di atas untuk memulai pencarian.';
        document.getElementById('searchStatus').style.display = 'block';
    });
</script>
{% endblock %}
