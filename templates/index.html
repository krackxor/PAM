<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUNTER DASHBOARD - Admin Mode</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f4f6f9; padding-top: 155px; font-family: 'Segoe UI', sans-serif; }
        .global-header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            background: #ffffff; border-bottom: 4px solid #0d6efd;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 15px 25px;
        }
        .nav-tabs .nav-link { color: #555; border: none; font-weight: 500; }
        .nav-tabs .nav-link.active { border-bottom: 3px solid #0d6efd; color: #0d6efd; font-weight: bold; background: transparent;}
        .tab-content { background: #fff; padding: 30px; min-height: 500px; border-radius: 0 0 12px 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);}
        .card-kpi { border: none; border-left: 5px solid #ccc; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .badge-rayon { background-color: #6610f2; color: white; }
    </style>
</head>
<body>

<header class="global-header">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center">
            <div class="bg-primary text-white rounded p-2 me-2"><i class="fas fa-compass fa-lg"></i></div>
            <div>
                <h4 class="fw-bold text-primary m-0" style="line-height: 1;">SUNTER DASHBOARD</h4>
                <small class="text-muted">Monitoring Rayon 34 & 35</small>
            </div>
        </div>
        <div>
            <span class="badge bg-success me-1"><i class="fas fa-wifi"></i> Online</span>
            <button class="btn btn-sm btn-success fw-bold shadow-sm px-3 py-2" data-bs-toggle="modal" data-bs-target="#modalUpload">
                <i class="fas fa-cloud-upload-alt me-1"></i> Upload Data
            </button>
        </div>
    </div>
    
    <div class="row g-2 align-items-center">
        <div class="col-md-3">
            <select class="form-select form-select-sm fw-bold border-primary text-primary" id="filterArea">
                <option value="SUNTER" selected>üåç ALL AREA (34 + 35)</option>
                <option value="34">üè¢ Rayon 34</option>
                <option value="35">üè¢ Rayon 35</option>
            </select>
        </div>
        <div class="col-md-5">
             <div class="alert alert-primary py-1 px-3 mb-0 small text-center fw-bold">
                <i class="fas fa-calendar-alt"></i> Data Pembayaran Bulan: <span id="labelPeriode">-</span>
             </div>
        </div>
        <div class="col-md-4">
            <div class="input-group input-group-sm shadow-sm">
                <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                <input type="text" class="form-control" id="globalSearch" placeholder="Cari Nomen / Nama...">
                <button class="btn btn-primary" onclick="cariPelanggan()">Analisa</button>
            </div>
        </div>
    </div>
</header>

<div class="container-fluid px-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show mt-2 shadow-sm">
                    {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <ul class="nav nav-tabs nav-fill bg-white shadow-sm rounded-top" id="mainTab" role="tablist">
        <li class="nav-item"><button class="nav-link active py-3" data-bs-toggle="tab" data-bs-target="#tab-ringkasan">1Ô∏è‚É£ Ringkasan</button></li>
        <li class="nav-item"><button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#tab-collection">2Ô∏è‚É£ Collection (Full Data)</button></li>
        <li class="nav-item"><button class="nav-link py-3 text-danger fw-bold" data-bs-toggle="tab" data-bs-target="#tab-analisa">5Ô∏è‚É£ Analisa Manual</button></li>
    </ul>

    <div class="tab-content shadow-sm">
        
        <div class="tab-pane fade show active" id="tab-ringkasan">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card card-kpi p-3 border-primary h-100">
                        <small class="text-muted fw-bold">TOTAL PELANGGAN</small>
                        <h3 class="fw-bold text-primary mb-0" id="kpi-cust">0</h3>
                        <small class="text-muted">Master</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-kpi p-3 border-success h-100">
                        <small class="text-muted fw-bold">COLLECTION (BULAN INI)</small>
                        <h3 class="fw-bold text-success mb-0" id="kpi-coll">Rp 0</h3>
                        <small class="text-success fw-bold" id="kpi-persen">0%</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-kpi p-3 border-warning h-100">
                        <small class="text-muted fw-bold">ANOMALI OPEN</small>
                        <h3 class="fw-bold text-warning mb-0" id="kpi-anomali">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-collection">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-primary fw-bold">Data Transaksi (Semua Data Bulan Terbaru)</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadCollectionData()"><i class="fas fa-sync"></i> Refresh</button>
            </div>
            <table id="tableColl" class="table table-striped table-bordered w-100 align-middle" style="font-size: 0.85rem;">
                <thead class="table-dark text-center">
                    <tr>
                        <th>Tgl Bayar</th>
                        <th>Rayon</th>
                        <th>PC/EZ</th>
                        <th>Nomen</th>
                        <th>Nama Pelanggan</th>
                        <th>Target (Rp)</th>
                        <th>Bayar (Rp)</th>
                        <th>%</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="tab-analisa">
            <div class="row">
                <div class="col-md-4 border-end">
                    <h6 class="fw-bold text-danger mb-3">üìù Form Analisa</h6>
                    <form id="formAnalisa">
                        <div class="mb-2"><label>Nomen</label><input type="text" class="form-control" name="nomen" id="inputNomen" required></div>
                        <div class="mb-2"><label>Jenis Anomali</label>
                            <select class="form-select" name="jenis_anomali"><option>Zero Usage</option><option>Extreme Usage</option><option>Stand Negatif</option><option>Lainnya</option></select>
                        </div>
                        <div class="mb-2"><label>Analisa Tim</label><textarea class="form-control" name="analisa_tim" rows="2" required></textarea></div>
                        <div class="mb-2"><label>Kesimpulan</label><input type="text" class="form-control" name="kesimpulan"></div>
                        <div class="mb-2"><label>Rekomendasi</label><select class="form-select" name="rekomendasi"><option>Monitoring</option><option>Ganti Meter</option><option>Cabut</option></select></div>
                        <div class="mb-3"><label>Status</label><select class="form-select bg-warning bg-opacity-10" name="status"><option>Open</option><option>Progress</option><option>Closed</option></select></div>
                        <button type="submit" class="btn btn-danger w-100 fw-bold">SIMPAN</button>
                    </form>
                </div>
                <div class="col-md-8"><div class="alert alert-info">Pilih pelanggan dari tabel Collection untuk dianalisa.</div></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalUpload" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form action="/upload" method="POST" enctype="multipart/form-data" class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title">Upload Data</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card border-primary bg-light h-100 p-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipe_upload" id="upMaster" value="master" checked>
                                <label class="form-check-label fw-bold text-primary" for="upMaster">MASTER (TARGET)</label>
                            </div>
                            <small class="d-block mt-2 text-muted">Upload file <b>MC...csv</b> (yang ada Nama Pelanggan) untuk update Target & Nama.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success bg-light h-100 p-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipe_upload" id="upColl" value="collection">
                                <label class="form-check-label fw-bold text-success" for="upColl">COLLECTION (HARIAN)</label>
                            </div>
                            <small class="d-block mt-2 text-muted">Upload file pembayaran harian untuk menambah data realisasi.</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <input type="file" name="file" class="form-control" required>
                </div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary fw-bold">Upload</button></div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
    function updateKPI() {
        $.get('/api/kpi_data', function(data) {
            $('#kpi-cust').text(new Intl.NumberFormat('id-ID').format(data.cust));
            $('#kpi-coll').text('Rp ' + new Intl.NumberFormat('id-ID').format(data.coll));
            $('#kpi-persen').text(data.persen + '%');
            $('#kpi-anomali').text(data.anomali);
            $('#labelPeriode').text(data.periode);
        });
    }

    let table;
    function loadCollectionData() {
        if ($.fn.DataTable.isDataTable('#tableColl')) {
            $('#tableColl').DataTable().ajax.reload();
            updateKPI();
            return;
        }

        table = $('#tableColl').DataTable({
            ajax: { url: '/api/collection_data', dataSrc: '' },
            pageLength: 25, // Default tampil 25 baris per halaman
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Semua"]], // Opsi tampilkan SEMUA
            language: { search: "Cari:", lengthMenu: "Tampil _MENU_", info: "_START_ - _END_ dari _TOTAL_ data" },
            columns: [
                { data: 'tgl_bayar' },
                { data: 'rayon', render: d => d ? `<span class="badge badge-rayon">${d}</span>` : '-' },
                { data: 'pcez', render: d => d ? `<span class="badge bg-secondary">${d}</span>` : '-' },
                { data: 'nomen' },
                { data: 'nama', defaultContent: '<i>Tanpa Nama</i>' },
                { data: 'target_mc', render: $.fn.dataTable.render.number('.', ',', 0, 'Rp ') },
                { data: 'jumlah_bayar', render: $.fn.dataTable.render.number('.', ',', 0, 'Rp '), className: 'fw-bold text-success' },
                { 
                    data: null, render: function(d) {
                        if(!d.target_mc) return '-';
                        let pct = Math.round((d.jumlah_bayar / d.target_mc)*100);
                        let cls = pct >= 100 ? 'success' : 'warning';
                        return `<span class="badge bg-${cls}">${pct}%</span>`;
                    }
                },
                { data: 'nomen', render: d => `<button class="btn btn-sm btn-outline-danger" onclick="bukaAnalisa('${d}')">Analisa</button>` }
            ]
        });
        updateKPI();
    }

    function bukaAnalisa(nomen) {
        bootstrap.Tab.getInstance(document.querySelector('button[data-bs-target="#tab-analisa"]')).show();
        $('#inputNomen').val(nomen).focus();
    }
    
    function cariPelanggan() {
        let val = $('#globalSearch').val();
        if(val) bukaAnalisa(val);
    }

    $('#formAnalisa').on('submit', function(e) {
        e.preventDefault();
        $.post('/simpan_analisa', $(this).serialize(), function(r) {
            alert(r.msg);
            if(r.status === 'success') $('#formAnalisa')[0].reset();
        });
    });

    $(document).ready(function() {
        loadCollectionData();
    });
</script>

</body>
</html>
