<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUNTER DASHBOARD - Admin Mode</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    
    <style>
        body { 
            background-color: #f0f2f5; 
            padding-top: 155px; /* Memberi ruang agar Header tidak menutupi konten */
        }
        
        /* Header yang selalu nempel di atas */
        .global-header {
            position: fixed; 
            top: 0; left: 0; right: 0; z-index: 1000;
            background: #fff; 
            border-bottom: 4px solid #0d6efd;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            padding: 15px 20px;
        }

        /* Styling Tab Navigasi */
        .nav-tabs .nav-link { color: #666; border: none; font-weight: 500; }
        .nav-tabs .nav-link.active { 
            border-bottom: 3px solid #0d6efd; 
            color: #0d6efd; 
            font-weight: bold; 
            background: transparent;
        }
        
        /* Kontainer Isi Tab */
        .tab-content { 
            background: #fff; 
            padding: 25px; 
            min-height: 500px; 
            border-radius: 0 0 10px 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Kartu KPI */
        .card-kpi { 
            border:none; 
            border-left: 5px solid #ccc; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            transition: transform 0.2s;
        }
        .card-kpi:hover { transform: translateY(-3px); }
    </style>
</head>
<body>

<header class="global-header">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="fw-bold text-primary m-0">üß≠ SUNTER DASHBOARD</h4>
        
        <div>
            <span class="badge bg-success me-1">System Online üü¢</span>
            <span class="badge bg-secondary me-2">üë§ Admin Mode</span>
            
            <button class="btn btn-sm btn-success fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#modalUpload">
                üì• Upload Data Excel
            </button>
        </div>
    </div>
    
    <div class="row g-2 align-items-center">
        <div class="col-md-2">
            <select class="form-select form-select-sm fw-bold bg-primary text-white" id="filterArea">
                <option value="SUNTER">AREA: SUNTER (34+35)</option>
                <option value="34">Rayon 34</option>
                <option value="35">Rayon 35</option>
            </select>
        </div>
        
        <div class="col-md-4">
            <div class="btn-group btn-group-sm w-100 shadow-sm">
                <button class="btn btn-outline-secondary">Filter PC</button>
                <button class="btn btn-outline-secondary">Tarif</button>
                <button class="btn btn-outline-secondary">Periode: <b id="lblPeriode">Bulan Ini</b></button>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="input-group input-group-sm shadow-sm">
                <span class="input-group-text bg-light">üîç</span>
                <input type="text" class="form-control" id="globalSearch" placeholder="Cari Nomen / Pelanggan...">
                <button class="btn btn-primary" onclick="cariPelanggan()">Buka Analisa</button>
            </div>
        </div>
    </div>
</header>

<div class="container-fluid px-4">
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show mt-2 shadow-sm" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <ul class="nav nav-tabs nav-fill bg-white shadow-sm rounded-top" id="mainTab" role="tablist">
        <li class="nav-item"><button class="nav-link active py-3" data-bs-toggle="tab" data-bs-target="#tab-ringkasan">1Ô∏è‚É£ Ringkasan</button></li>
        <li class="nav-item"><button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#tab-collection">2Ô∏è‚É£ Collection (Excel)</button></li>
        <li class="nav-item"><button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#tab-meter">3Ô∏è‚É£ Meter</button></li>
        <li class="nav-item"><button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#tab-history">4Ô∏è‚É£ History</button></li>
        <li class="nav-item"><button class="nav-link py-3 text-danger fw-bold" data-bs-toggle="tab" data-bs-target="#tab-analisa">5Ô∏è‚É£ Analisa Manual üõ†Ô∏è</button></li>
        <li class="nav-item"><button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#tab-top">6Ô∏è‚É£ TOP</button></li>
        <li class="nav-item"><button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#tab-alert">7Ô∏è‚É£ Alert</button></li>
        <li class="nav-item"><button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#tab-laporan">8Ô∏è‚É£ Laporan</button></li>
    </ul>

    <div class="tab-content shadow-sm">
        
        <div class="tab-pane fade show active" id="tab-ringkasan">
            <h5 class="mb-4 pb-2 border-bottom">üìä Gambaran Umum Operasional</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card card-kpi p-3 border-primary h-100">
                        <small class="text-muted fw-bold text-uppercase">Total Pelanggan</small>
                        <h2 class="fw-bold text-primary mb-0">{{ "{:,}".format(kpi['cust']) }}</h2>
                        <small class="text-success" style="font-size: 0.8rem">Data Master Terdaftar</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-kpi p-3 border-success h-100">
                        <small class="text-muted fw-bold text-uppercase">Total Collection (Rp)</small>
                        <h2 class="fw-bold text-success mb-0">Rp {{ "{:,.0f}".format(kpi['coll']).replace(',', '.') }}</h2>
                        <small class="text-muted" style="font-size: 0.8rem">Realisasi Pembayaran</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-kpi p-3 border-warning h-100">
                        <small class="text-muted fw-bold text-uppercase">Anomali Open</small>
                        <h2 class="fw-bold text-warning mb-0">{{ kpi['anomali'] }}</h2>
                        <small class="text-muted" style="font-size: 0.8rem">Perlu Tindak Lanjut</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-kpi p-3 border-danger h-100">
                        <small class="text-muted fw-bold text-uppercase">Tunggakan (Est)</small>
                        <h2 class="fw-bold text-danger mb-0">Rp 0</h2>
                        <small class="text-muted" style="font-size: 0.8rem">Belum tersedia</small>
                    </div>
                </div>
            </div>

            <div class="card mt-4 border-0 shadow-sm">
                <div class="card-header bg-white fw-bold text-primary">üìà Tren Collection Mingguan</div>
                <div class="card-body">
                    <canvas id="chartCollection" style="max-height: 280px;"></canvas>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-collection">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-primary fw-bold">üìÖ Data Transaksi Harian</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadCollectionData()">üîÑ Refresh Data</button>
            </div>
            
            <div class="table-responsive">
                <table id="tableColl" class="table table-striped table-bordered table-hover w-100" style="font-size: 0.9rem;">
                    <thead class="table-dark text-center">
                        <tr>
                            <th>Tanggal</th>
                            <th>Rayon</th>
                            <th>Nomen</th>
                            <th>Nama Pelanggan</th>
                            <th>Target MC (Rp)</th>
                            <th>Bayar (Rp)</th>
                            <th>% Capai</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-analisa">
            <div class="row">
                <div class="col-md-4 border-end">
                    <h6 class="fw-bold text-danger border-bottom pb-2 mb-3">üìù Form Input Analisa</h6>
                    <form id="formAnalisa">
                        <div class="mb-2">
                            <label class="fw-bold small">Nomen Pelanggan</label>
                            <input type="text" class="form-control" name="nomen" id="inputNomen" placeholder="Contoh: 6012345" required>
                        </div>
                        <div class="mb-2">
                            <label class="fw-bold small">Jenis Anomali</label>
                            <select class="form-select" name="jenis_anomali">
                                <option value="Zero Usage">Zero Usage (0 Meter)</option>
                                <option value="Extreme Usage">Extreme Usage (Lonjakan)</option>
                                <option value="Stand Negatif">Stand Negatif</option>
                                <option value="Tunggakan Macet">Tunggakan Macet</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="fw-bold small">Analisa Tim / Lapangan</label>
                            <textarea class="form-control" name="analisa_tim" rows="2" placeholder="Hasil cek lapangan..." required></textarea>
                        </div>
                        <div class="mb-2">
                            <label class="fw-bold small">Kesimpulan</label>
                            <input type="text" class="form-control" name="kesimpulan" placeholder="Kesimpulan singkat">
                        </div>
                        <div class="mb-2">
                            <label class="fw-bold small">Rekomendasi</label>
                            <select class="form-select" name="rekomendasi">
                                <option value="Monitoring">Lanjutkan Monitoring</option>
                                <option value="Ganti Meter">Ganti Water Meter</option>
                                <option value="Tagihan Susulan">Buat Tagihan Susulan</option>
                                <option value="Cabut">Cabut Dinas</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="fw-bold small">Status Pengerjaan</label>
                            <select class="form-select bg-warning bg-opacity-10 fw-bold" name="status">
                                <option value="Open">üìÇ Open (Baru)</option>
                                <option value="Progress">üöß On Progress</option>
                                <option value="Closed">‚úÖ Closed (Selesai)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-danger w-100 fw-bold shadow-sm">üíæ SIMPAN HASIL ANALISA</button>
                    </form>
                </div>
                
                <div class="col-md-8">
                    <h6 class="fw-bold text-muted border-bottom pb-2 mb-3">üìÇ History & Profil Pelanggan</h6>
                    <div class="alert alert-info d-flex align-items-center">
                        <span class="fs-4 me-3">‚ÑπÔ∏è</span>
                        <div>
                            <strong>Mode Input Analisa</strong><br>
                            Silakan masukkan Nomen pelanggan di sebelah kiri, atau klik tombol <b>"üõ†Ô∏è Analisa"</b> dari tab Collection untuk mengisi otomatis.
                        </div>
                    </div>
                    <div class="text-center text-muted mt-5 opacity-50">
                        <img src="https://cdn-icons-png.flaticon.com/512/2921/2921222.png" width="80" class="mb-3">
                        <p>Detail History Pelanggan akan muncul di sini.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-meter"><div class="p-5 text-center text-muted">üöß Modul <b>Meter</b> sedang dalam pengembangan.</div></div>
        <div class="tab-pane fade" id="tab-history"><div class="p-5 text-center text-muted">üöß Modul <b>History</b> sedang dalam pengembangan.</div></div>
        <div class="tab-pane fade" id="tab-top"><div class="p-5 text-center text-muted">üöß Modul <b>TOP 100</b> sedang dalam pengembangan.</div></div>
        <div class="tab-pane fade" id="tab-alert"><div class="p-5 text-center text-muted">üöß Modul <b>Alert System</b> sedang dalam pengembangan.</div></div>
        <div class="tab-pane fade" id="tab-laporan"><div class="p-5 text-center text-muted">üöß Modul <b>Laporan</b> sedang dalam pengembangan.</div></div>

    </div>
</div>

<div class="modal fade" id="modalUpload" tabindex="-1">
    <div class="modal-dialog">
        <form action="/upload" method="POST" enctype="multipart/form-data" class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">üì§ Upload Data Excel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning small">
                    <strong>Perhatian:</strong> Pastikan header kolom Excel sesuai standar sistem.
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Tipe Data</label>
                    <select name="tipe_upload" class="form-select">
                        <option value="collection">üìÇ Data Collection (Transaksi Harian)</option>
                        <option value="master">üìÇ Master Pelanggan (Database Pusat)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Pilih File (.xlsx)</label>
                    <input type="file" name="file" class="form-control" accept=".xlsx, .xls" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="submit" class="btn btn-success fw-bold">Mulai Upload</button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    /**
     * 1. CHART DASHBOARD (Dummy Data & Interaksi)
     */
    const ctx = document.getElementById('chartCollection');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],
                datasets: [{ 
                    label: 'Collection Harian (Juta Rp)', 
                    data: [15, 22, 18, 25, 30, 45, 10], // Data Dummy Visual
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    /**
     * 2. DATATABLES COLLECTION (AJAX LOAD)
     */
    let table;
    function loadCollectionData() {
        // Jika tabel sudah ada, reload saja datanya
        if ($.fn.DataTable.isDataTable('#tableColl')) {
            $('#tableColl').DataTable().ajax.reload();
            return;
        }

        // Inisialisasi DataTable Pertama Kali
        table = $('#tableColl').DataTable({
            ajax: { 
                url: '/api/collection_data', // Ambil data dari Python
                dataSrc: '' 
            },
            language: {
                search: "Cari Data:",
                lengthMenu: "Tampil _MENU_",
                info: "Menampilkan _START_-_END_ dari _TOTAL_",
                paginate: { next: "‚û°Ô∏è", previous: "‚¨ÖÔ∏è" }
            },
            columns: [
                { data: 'tgl_bayar' },
                { data: 'rayon' },
                { data: 'nomen' },
                { data: 'nama', defaultContent: "<em>Tanpa Nama</em>" },
                { 
                    data: 'target_mc', 
                    render: $.fn.dataTable.render.number('.', ',', 0, 'Rp ') 
                },
                { 
                    data: 'jumlah_bayar', 
                    render: $.fn.dataTable.render.number('.', ',', 0, 'Rp ') 
                },
                { 
                    // Kolom Persentase (Hitung Otomatis)
                    data: null, 
                    render: function(data) {
                        if(data.target_mc == 0 || !data.target_mc) return '<span class="badge bg-secondary">N/A</span>';
                        let pct = Math.round((data.jumlah_bayar / data.target_mc) * 100);
                        let color = pct >= 90 ? 'success' : (pct >= 50 ? 'warning' : 'danger');
                        return `<span class="badge bg-${color}">${pct}%</span>`;
                    }
                },
                {
                    // Tombol Aksi Analisa
                    data: 'nomen',
                    render: function(data) {
                        return `<button class="btn btn-sm btn-outline-danger py-0" onclick="bukaAnalisa('${data}')">üõ†Ô∏è Analisa</button>`;
                    }
                }
            ]
        });
    }

    /**
     * 3. FUNGSI PINDAH TAB & ISI FORM ANALISA
     */
    function bukaAnalisa(nomen) {
        // Aktifkan Tab Analisa (Index 4 / ID tab-analisa)
        const triggerEl = document.querySelector('button[data-bs-target="#tab-analisa"]');
        bootstrap.Tab.getInstance(triggerEl).show();
        
        // Isi Form Nomen
        $('#inputNomen').val(nomen);
        
        // Animasi Focus
        setTimeout(() => {
            $('#inputNomen').focus().addClass('bg-warning bg-opacity-25');
            setTimeout(() => $('#inputNomen').removeClass('bg-warning bg-opacity-25'), 500);
        }, 200);
    }
    
    // Fungsi Search Global di Header
    function cariPelanggan() {
        let val = $('#globalSearch').val();
        if(val) bukaAnalisa(val);
        else alert("Masukkan Nomen atau Nama pelanggan terlebih dahulu!");
    }

    /**
     * 4. SUBMIT FORM ANALISA (AJAX)
     */
    $('#formAnalisa').on('submit', function(e) {
        e.preventDefault(); // Mencegah reload halaman
        
        // Kirim data ke Python
        $.post('/simpan_analisa', $(this).serialize(), function(resp) {
            if(resp.status === 'success') {
                alert("‚úÖ " + resp.msg);
                $('#formAnalisa')[0].reset(); // Kosongkan form setelah sukses
            } else {
                alert("‚ùå Gagal menyimpan: " + resp.msg);
            }
        });
    });

    /**
     * 5. RUN ON LOAD
     */
    $(document).ready(function() {
        loadCollectionData(); // Load tabel saat web dibuka
    });

</script>

</body>
</html>
