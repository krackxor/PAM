{% extends 'base.html' %}

{% block title %}Dashboard Utama - SUNTER{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Ringkasan Kinerja</h1>
        <p class="page-subtitle">Overview pembayaran dan pencapaian collection periode ini</p>
    </div>
    <div class="periode-selector">
        <label for="periodeSelect"><i class="fas fa-calendar-alt"></i></label>
        <select id="periodeSelect" class="form-select">
            <option value="">Memuat periode...</option>
        </select>
    </div>
</div>

<div id="statsContainer">
    <div class="kpi-container">
        <div class="kpi-card">
            <span class="kpi-label"><i class="fas fa-users"></i> Total Pelanggan</span>
            <div class="kpi-value" id="totalPelanggan">-</div>
            <div class="kpi-change positive"><i class="fas fa-check"></i> Terdata</div>
        </div>
        
        <div class="kpi-card">
            <span class="kpi-label"><i class="fas fa-check-double"></i> Sudah Bayar</span>
            <div class="kpi-value text-success" id="sudahBayar">-</div>
            <div class="kpi-change positive" id="pctBayar">0% dari total</div>
        </div>

        <div class="kpi-card">
            <span class="kpi-label"><i class="fas fa-clock"></i> Belum Bayar</span>
            <div class="kpi-value text-danger" id="belumBayar">-</div>
            <div class="kpi-change negative" id="pctBelum">0% dari total</div>
        </div>

        <div class="kpi-card">
            <span class="kpi-label"><i class="fas fa-wallet"></i> Realisasi</span>
            <div class="kpi-value" id="totalRealisasi" style="font-size: 1.2rem;">-</div>
            <div class="progress-bar mt-2">
                <div class="progress-fill" id="progressRealisasi" style="width: 0%"></div>
            </div>
            <div class="kpi-change mt-1" id="pctRealisasi">0% dari target</div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-area"></i> Tren Penagihan</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="collectionTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-map-marked-alt"></i> Performa per Rayon</h3>
            <button class="btn btn-sm btn-outline" onclick="App.exportTableToCSV('rayonTable', 'performa_rayon.csv')">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
        <div class="table-container">
            <table class="table" id="rayonTable">
                <thead>
                    <tr>
                        <th data-field="rayon">Rayon</th>
                        <th data-field="total" class="text-right">Total</th>
                        <th data-field="sudah_bayar" class="text-right">Bayar</th>
                        <th data-field="belum_bayar" class="text-right">Sisa</th>
                        <th data-field="pct_bayar" class="text-right">%</th>
                        <th data-field="target" class="text-right">Target</th>
                        <th data-field="realisasi" class="text-right">Realisasi</th>
                        <th data-field="pct_realisasi" class="text-right">% Capaian</th>
                    </tr>
                </thead>
                <tbody id="rayonTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="emptyState" class="card d-none">
    <div class="empty-state">
        <i class="fas fa-file-invoice-dollar empty-icon"></i>
        <h3>Data Belum Tersedia</h3>
        <p>Silahkan unggah file Master Pelanggan (MC) untuk memulai analisa.</p>
        <a href="/upload" class="btn btn-primary mt-4"><i class="fas fa-upload"></i> Unggah Sekarang</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let trendChart = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadPeriodes();
        
        // Listener untuk perubahan periode
        document.getElementById('periodeSelect').addEventListener('change', (e) => {
            const [bulan, tahun] = e.target.value.split(',').map(Number);
            refreshDashboard(bulan, tahun);
        });
    });

    async function loadPeriodes() {
        try {
            const data = await App.api('/api/history/periodes'); // Sesuaikan endpoint API Anda
            const select = document.getElementById('periodeSelect');
            select.innerHTML = '';

            if (data && data.length > 0) {
                data.forEach(p => {
                    const option = document.createElement('option');
                    option.value = `${p.bulan},${p.tahun}`;
                    option.textContent = p.label;
                    select.appendChild(option);
                });
                const [b, t] = select.value.split(',').map(Number);
                refreshDashboard(b, t);
            } else {
                toggleState('empty');
            }
        } catch (e) {
            toggleState('empty');
        }
    }

    async function refreshDashboard(bulan, tahun) {
        try {
            TableHelpers.showLoading('rayonTable');
            const data = await App.api(`/api/kpi?bulan=${bulan}&tahun=${tahun}`);
            
            updateStats(data);
            renderRayonTable(data.by_rayon);
            renderTrendChart(bulan, tahun);
        } catch (e) {
            App.toast("Gagal memuat data dashboard", "error");
        }
    }

    function updateStats(data) {
        toggleState('data');
        document.getElementById('totalPelanggan').textContent = App.formatNumber(data.total_pelanggan);
        document.getElementById('sudahBayar').textContent = App.formatNumber(data.sudah_bayar);
        document.getElementById('belumBayar').textContent = App.formatNumber(data.total_pelanggan - data.sudah_bayar);
        
        const pct = ((data.sudah_bayar / data.total_pelanggan) * 100).toFixed(1);
        document.getElementById('pctBayar').textContent = `${pct}% dari total`;
        document.getElementById('pctBelum').textContent = `${(100 - pct).toFixed(1)}% dari total`;

        document.getElementById('totalRealisasi').textContent = App.formatRupiah(data.total_realisasi);
        document.getElementById('pctRealisasi').textContent = `${data.pct_realisasi}% dari target`;
        document.getElementById('progressRealisasi').style.width = `${data.pct_realisasi}%`;
    }

    function renderRayonTable(rayonData) {
        const columns = [
            { field: 'rayon', class: 'font-semibold' },
            { field: 'total', class: 'text-right', formatter: v => App.formatNumber(v) },
            { field: 'sudah_bayar', class: 'text-right', formatter: v => App.formatNumber(v) },
            { field: 'belum_bayar', class: 'text-right text-danger', formatter: (v, row) => App.formatNumber(row.total - row.sudah_bayar) },
            { field: 'pct_bayar', class: 'text-right', formatter: (v, row) => ((row.sudah_bayar/row.total)*100).toFixed(1) + '%' },
            { field: 'target', class: 'text-right', formatter: v => App.formatRupiah(v) },
            { field: 'realisasi', class: 'text-right text-success', formatter: v => App.formatRupiah(v) },
            { field: 'pct_realisasi', class: 'text-right font-bold', formatter: v => v + '%' }
        ];

        TableHelpers.render('rayonTable', rayonData, columns, { sortable: true });
    }

    async function renderTrendChart(bulan, tahun) {
        const trendData = await App.api('/api/kpi/trend');
        const ctx = document.getElementById('collectionTrendChart').getContext('2d');
        
        if(trendChart) trendChart.destroy();
        
        trendChart = ChartHelpers.createLineChart(ctx, {
            labels: trendData.map(d => d.periode),
            datasets: [
                { label: 'Realisasi', data: trendData.map(d => d.collection), color: '#2563eb' },
                { label: 'Target', data: trendData.map(d => d.target_mc), color: '#94a3b8', fill: false }
            ]
        });
    }

    function toggleState(state) {
        document.getElementById('statsContainer').classList.toggle('d-none', state === 'empty');
        document.getElementById('emptyState').classList.toggle('d-none', state === 'data');
    }
</script>
{% endblock %}
