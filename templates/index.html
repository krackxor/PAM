{% extends "base.html" %}

{% block title %}Dashboard Utama{% endblock %}

{% block custom_styles %}
<style>
    .search-section {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        padding: 40px 20px;
        border-radius: 15px;
        color: white;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.75rem;
        text-transform: uppercase;
    }
    .result-card {
        border: none;
        border-radius: 12px;
        transition: transform 0.2s;
    }
    .data-label {
        font-size: 0.75rem;
        color: #858796;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 2px;
    }
    .data-value {
        font-weight: 700;
        color: #4e73df;
    }
    .table-sm-custom {
        font-size: 0.8rem;
    }
    .table-sm-custom thead th {
        background-color: #f8f9fc;
        border-top: none;
        color: #4e73df;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header Dashboard -->
<div class="row align-items-center mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-0 text-gray-800 font-weight-bold">Dashboard Utama</h1>
        <p class="text-muted mb-0">Pencarian data pelanggan terintegrasi AB SUNTER Analytic.</p>
    </div>
    <div class="col-md-4 text-md-right mt-3 mt-md-0">
        <div id="db-status-container">
            <span id="db-status-badge" class="badge badge-secondary py-2 px-3">
                <i id="db-status-icon" class="fas fa-spinner fa-spin mr-1"></i> 
                <span id="db-status-text">Mengecek Koneksi...</span>
            </span>
        </div>
    </div>
</div>

<!-- Section Pencarian -->
<div class="search-section text-center">
    <h2 class="font-weight-bold mb-3">Cari Pelanggan</h2>
    <p class="mb-4 opacity-75">Masukkan nomor NOMEN untuk melihat profil, piutang, dan riwayat pemakaian air.</p>
    <div class="row justify-content-center">
        <div class="col-lg-7">
            <form id="search-form">
                <div class="input-group input-group-lg shadow">
                    <input type="text" id="nomen-input" class="form-control border-0" style="border-radius: 10px 0 0 10px;" placeholder="Contoh: 01000001" required>
                    <div class="input-group-append">
                        <button class="btn btn-warning font-weight-bold px-4" style="border-radius: 0 10px 10px 0;" type="submit" id="search-button">
                            <i class="fas fa-search"></i> CARI
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading State -->
<div id="search-loading" class="text-center my-5 d-none">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <h5 class="mt-3 text-gray-600 font-weight-bold">Menyinkronkan data dari berbagai modul...</h5>
</div>

<!-- Hasil Pencarian -->
<div id="search-results">
    <!-- Area ini akan diisi oleh JavaScript -->
</div>

{% endblock %}

{% block scripts %}
<script>
    const NOMEN_INPUT = document.getElementById('nomen-input');
    const SEARCH_FORM = document.getElementById('search-form');
    const SEARCH_LOADING = document.getElementById('search-loading');
    const SEARCH_RESULTS = document.getElementById('search-results');
    
    // Formatting Helpers
    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(amount || 0);
    };

    const formatNumber = (num) => {
        return new Intl.NumberFormat('id-ID').format(num || 0);
    };

    // 1. Cek Status Database
    async function checkDbStatus() {
        const badge = document.getElementById('db-status-badge');
        const icon = document.getElementById('db-status-icon');
        const text = document.getElementById('db-status-text');

        try {
            const response = await fetch('/api/dashboard/summary');
            const data = await response.json();

            if (data.status === 'error' || (data.message && data.message.includes('tidak terhubung'))) {
                badge.className = 'badge badge-danger py-2 px-3 shadow-sm';
                icon.className = 'fas fa-times-circle mr-1';
                text.textContent = 'Database Offline';
            } else {
                badge.className = 'badge badge-success py-2 px-3 shadow-sm';
                icon.className = 'fas fa-check-circle mr-1';
                text.textContent = 'Sistem Terkoneksi';
            }
        } catch (error) {
            badge.className = 'badge badge-warning py-2 px-3 shadow-sm';
            icon.className = 'fas fa-exclamation-triangle mr-1';
            text.textContent = 'API Error';
        }
    }

    // 2. Tampilkan Hasil
    function renderSearchResults(data) {
        SEARCH_RESULTS.innerHTML = '';

        if (data.status === 'not_found' || data.status === 'fail') {
            SEARCH_RESULTS.innerHTML = `
                <div class="alert alert-light border-left-danger shadow-sm text-center py-4">
                    <i class="fas fa-user-slash fa-3x text-danger mb-3"></i>
                    <h5 class="font-weight-bold text-gray-800">${data.message}</h5>
                    <p class="text-muted">Pastikan nomor NOMEN yang Anda masukkan sudah benar.</p>
                </div>
            `;
            return;
        }

        const { summary, profile_pelanggan: profile, mc_data, ardebt_data, sbrs_data } = data;

        // --- Layout Hasil Pencarian ---
        SEARCH_RESULTS.innerHTML = `
            <!-- Baris 1: Ringkasan & Profil -->
            <div class="row">
                <div class="col-xl-4 col-lg-5 mb-4">
                    <div class="card shadow result-card h-100 border-left-primary">
                        <div class="card-body">
                            <h6 class="font-weight-bold text-primary mb-3"><i class="fas fa-id-badge mr-2"></i> Profil Pelanggan</h6>
                            <div class="mb-3">
                                <div class="data-label">Nama Lengkap</div>
                                <div class="h5 font-weight-bold text-gray-800">${profile.NAMA_PEL}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <div class="data-label">NOMEN</div>
                                    <div class="data-value">${profile.NOMEN}</div>
                                </div>
                                <div class="col-6">
                                    <div class="data-label">Rayon</div>
                                    <div class="data-value">${profile.RAYON}</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="data-label">Alamat</div>
                                <div class="small text-gray-700">${profile.ALAMAT}</div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="data-label">Tarif</div>
                                    <div class="badge badge-info">${profile.TARIF}</div>
                                </div>
                                <div class="col-6">
                                    <div class="data-label">Merk Meter</div>
                                    <div class="small font-weight-bold text-gray-800">${profile.MERK || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-8 col-lg-7 mb-4">
                    <div class="card shadow result-card h-100 border-left-success">
                        <div class="card-body">
                            <h6 class="font-weight-bold text-success mb-3"><i class="fas fa-chart-line mr-2"></i> Ringkasan Status & Finansial</h6>
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card bg-light border-0 p-3">
                                        <div class="data-label">Status Finansial</div>
                                        <span class="badge badge-${summary.STATUS_FINANSIAL.includes('TUNGGAKAN') ? 'danger' : 'success'} p-2">
                                            ${summary.STATUS_FINANSIAL}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card bg-light border-0 p-3">
                                        <div class="data-label">Total Kewajiban Piutang</div>
                                        <div class="h4 font-weight-bold text-danger mb-0">${formatCurrency(summary.TOTAL_KEWAJIBAN_NOMINAL)}</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card bg-light border-0 p-3">
                                        <div class="data-label">Status Pemakaian Air</div>
                                        <span class="badge badge-${summary.STATUS_PEMAKAIAN.includes('ANOMALI') ? 'warning' : 'primary'} p-2">
                                            ${summary.STATUS_PEMAKAIAN}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card bg-light border-0 p-3">
                                        <div class="data-label">Transaksi Terakhir</div>
                                        <div class="small font-weight-bold text-gray-800">${summary.PEMBAYARAN_TERAKHIR}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Baris 2: Riwayat Baca Meter (SBRS) -->
            <div class="card shadow result-card mb-4 border-left-info">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-info"><i class="fas fa-history mr-2"></i> Riwayat Baca Meter (SBRS)</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover table-sm-custom">
                            <thead>
                                <tr>
                                    <th>Tgl Baca</th>
                                    <th class="text-right">Kubik Baru</th>
                                    <th class="text-right">Kubik Lama</th>
                                    <th class="text-right">Konsumsi (m³)</th>
                                    <th>Status Anomali</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sbrs_data.length > 0 ? sbrs_data.map(d => `
                                    <tr>
                                        <td>${d.CMR_RD_DATE || 'N/A'}</td>
                                        <td class="text-right">${formatNumber(d.KUBIK_TERBARU)}</td>
                                        <td class="text-right">${formatNumber(d.KUBIK_SEBELUMNYA)}</td>
                                        <td class="text-right font-weight-bold">${formatNumber(d.SELISIH_KUBIK)}</td>
                                        <td><span class="badge badge-${d.STATUS_PEMAKAIAN.includes('NORMAL') ? 'success' : 'warning'}">${d.STATUS_PEMAKAIAN}</span></td>
                                    </tr>
                                `).join('') : '<tr><td colspan="5" class="text-center py-3">Data tidak ditemukan</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Baris 3: Riwayat Piutang (MC) -->
            <div class="card shadow result-card mb-4 border-left-warning">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-warning"><i class="fas fa-file-invoice-dollar mr-2"></i> Riwayat Tagihan & Piutang (MC)</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover table-sm-custom">
                            <thead>
                                <tr>
                                    <th>Periode Tagihan</th>
                                    <th class="text-right">Nominal (Rp)</th>
                                    <th class="text-right">Kubikasi (m³)</th>
                                    <th>Status Pembayaran</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${mc_data.length > 0 ? mc_data.map(d => `
                                    <tr>
                                        <td>${d.BULAN_TAGIHAN}</td>
                                        <td class="text-right font-weight-bold text-primary">${formatCurrency(d.NOMINAL)}</td>
                                        <td class="text-right">${formatNumber(d.KUBIK)}</td>
                                        <td><span class="badge badge-${d.STATUS === 'PAYMENT' ? 'success' : 'danger'}">${d.STATUS}</span></td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4" class="text-center py-3">Data tidak ditemukan</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    // 3. Event Search
    SEARCH_FORM.addEventListener('submit', async function(e) {
        e.preventDefault();
        const nomen = NOMEN_INPUT.value.trim();
        
        SEARCH_LOADING.classList.remove('d-none');
        SEARCH_RESULTS.innerHTML = '';
        
        try {
            const response = await fetch(`/api/search?nomen=${nomen}`);
            const data = await response.json();
            renderSearchResults(data);
        } catch (error) {
            SEARCH_RESULTS.innerHTML = `<div class="alert alert-danger shadow-sm">Terjadi kesalahan koneksi ke API server.</div>`;
        } finally {
            SEARCH_LOADING.classList.add('d-none');
        }
    });

    document.addEventListener('DOMContentLoaded', checkDbStatus);
</script>
{% endblock %}
