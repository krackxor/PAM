{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Dashboard Utama & Pencarian Pelanggan</h1>
<p class="lead">Gunakan fitur pencarian terintegrasi di bawah ini untuk melihat profil lengkap, riwayat piutang, dan status anomali pemakaian air dari NOMEN pelanggan tertentu.</p>

<!-- Bagian Status DB -->
<div class="row mb-4">
    <div class="col-md-12">
        <div id="db-status-alert" class="alert alert-secondary d-flex align-items-center" role="alert">
            <div id="db-status-icon" class="spinner-border spinner-border-sm text-primary mr-3" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <span id="db-status-message">Memeriksa status koneksi database...</span>
        </div>
    </div>
</div>

<!-- Bagian Pencarian NOMEN -->
<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
        <h5><i class="fas fa-search"></i> Cari Pelanggan Berdasarkan NOMEN</h5>
    </div>
    <div class="card-body">
        <form id="search-form">
            <div class="input-group mb-3">
                <input type="text" id="nomen-input" class="form-control form-control-lg" placeholder="Masukkan NOMEN Pelanggan (Contoh: 01000001)" required>
                <div class="input-group-append">
                    <button class="btn btn-primary btn-lg" type="submit" id="search-button">
                        <i class="fas fa-search"></i> Cari
                    </button>
                </div>
            </div>
        </form>
        <div id="search-loading" class="text-center mt-3 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2">Mencari data terintegrasi...</p>
        </div>
        <div id="search-results" class="mt-4">
            <!-- Hasil pencarian akan ditampilkan di sini -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const NOMEN_INPUT = document.getElementById('nomen-input');
    const SEARCH_FORM = document.getElementById('search-form');
    const SEARCH_LOADING = document.getElementById('search-loading');
    const SEARCH_RESULTS = document.getElementById('search-results');
    const DB_STATUS_ALERT = document.getElementById('db-status-alert');
    const DB_STATUS_ICON = document.getElementById('db-status-icon');
    const DB_STATUS_MESSAGE = document.getElementById('db-status-message');

    // Helper untuk memformat angka mata uang Rupiah
    const formatCurrency = (amount) => {
        if (typeof amount !== 'number') return 'N/A';
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(amount);
    };

    // Helper untuk memformat angka dengan pemisah ribuan
    const formatNumber = (num) => {
        if (typeof num !== 'number') return 'N/A';
        return new Intl.NumberFormat('id-ID').format(num);
    };

    // Fungsi untuk mendapatkan status DB
    async function checkDbStatus() {
        try {
            const response = await fetch('/api/dashboard/summary');
            const data = await response.json();

            if (data.message && data.message.includes('Server tidak terhubung ke Database')) {
                DB_STATUS_ALERT.classList.remove('alert-secondary', 'alert-success');
                DB_STATUS_ALERT.classList.add('alert-danger');
                DB_STATUS_ICON.classList.remove('spinner-border', 'text-primary', 'd-none');
                DB_STATUS_ICON.classList.add('fas', 'fa-times-circle');
                DB_STATUS_MESSAGE.textContent = 'KRITIS: Koneksi MongoDB Gagal. Fitur analitik tidak dapat diakses.';
            } else {
                DB_STATUS_ALERT.classList.remove('alert-secondary', 'alert-danger');
                DB_STATUS_ALERT.classList.add('alert-success');
                DB_STATUS_ICON.classList.remove('spinner-border', 'text-primary');
                DB_STATUS_ICON.classList.add('fas', 'fa-check-circle');
                DB_STATUS_MESSAGE.textContent = 'Koneksi Database Berhasil. Data analitik siap diakses.';
            }
        } catch (error) {
            console.error("Failed to fetch DB status:", error);
            DB_STATUS_ALERT.classList.remove('alert-secondary', 'alert-success');
            DB_STATUS_ALERT.classList.add('alert-warning');
            DB_STATUS_ICON.classList.remove('spinner-border', 'text-primary');
            DB_STATUS_ICON.classList.add('fas', 'fa-exclamation-triangle');
            DB_STATUS_MESSAGE.textContent = 'Peringatan: Gagal memverifikasi status DB API. Coba muat ulang halaman.';
        }
    }


    // Fungsi untuk menampilkan hasil pencarian NOMEN
    function displayResults(data) {
        SEARCH_RESULTS.innerHTML = '';

        if (data.status === 'not_found' || data.status === 'fail') {
            SEARCH_RESULTS.innerHTML = `
                <div class="alert alert-warning">${data.message}</div>
            `;
            return;
        }

        const summary = data.summary;
        const profile = data.profile_pelanggan;
        const mcData = data.mc_data;
        const ardebtData = data.ardebt_data;
        const sbrsData = data.sbrs_data;

        // --- Kartu Ringkasan (Summary Card) ---
        let summaryHtml = `
            <div class="card shadow-lg mb-4 bg-light">
                <div class="card-body">
                    <h4 class="card-title text-primary"><i class="fas fa-user-check"></i> Ringkasan Status Pelanggan: ${summary.NAMA}</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <span class="font-weight-bold">Status Finansial:</span> 
                            <span class="badge badge-${summary.STATUS_FINANSIAL.includes('TUNGGAKAN') ? 'danger' : summary.TOTAL_KEWAJIBAN_NOMINAL > 0 ? 'warning' : 'success'}">${summary.STATUS_FINANSIAL}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <span class="font-weight-bold">Total Kewajiban:</span> 
                            <span class="text-danger font-weight-bold">${formatCurrency(summary.TOTAL_KEWAJIBAN_NOMINAL)}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <span class="font-weight-bold">Status Pemakaian:</span> 
                            <span class="badge badge-${summary.STATUS_PEMAKAIAN.includes('EKSTRIM') || summary.STATUS_PEMAKAIAN.includes('ZERO') ? 'danger' : summary.STATUS_PEMAKAIAN.includes('TURUN') ? 'warning' : 'info'}">${summary.STATUS_PEMAKAIAN}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <span class="font-weight-bold">Pembayaran Terakhir:</span> 
                            <span class="text-muted">${summary.PEMBAYARAN_TERAKHIR}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // --- Detail Profil ---
        let profileHtml = `
            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white">
                    <h6><i class="fas fa-id-card"></i> Detail Profil Pelanggan</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6"><p><strong>NOMEN:</strong> ${profile.NOMEN}</p></div>
                        <div class="col-md-6"><p><strong>NAMA:</strong> ${profile.NAMA_PEL}</p></div>
                        <div class="col-md-6"><p><strong>ALAMAT:</strong> ${profile.ALAMAT}</p></div>
                        <div class="col-md-6"><p><strong>RAYON:</strong> ${profile.RAYON}</p></div>
                        <div class="col-md-6"><p><strong>TARIF:</strong> ${profile.TARIF}</p></div>
                        <div class="col-md-6"><p><strong>MERK/SERIAL METER:</strong> ${profile.MERK} / ${profile.SERIAL}</p></div>
                        <div class="col-md-6"><p><strong>METODE BACA:</strong> ${profile.READ_METHOD}</p></div>
                    </div>
                </div>
            </div>
        `;

        // --- Riwayat Baca Meter (SBRS) ---
        let sbrsHtml = `
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">
                    <h6><i class="fas fa-history"></i> Riwayat Baca Meter (SBRS) Terakhir</h6>
                </div>
                <div class="card-body">
                    ${sbrsData.length > 0 ? `
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Tgl Baca</th>
                                    <th>Kubikasi Baru (m続)</th>
                                    <th>Kubikasi Lama (m続)</th>
                                    <th>Selisih (m続)</th>
                                    <th>Status Anomali</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sbrsData.map(d => `
                                    <tr>
                                        <td>${d.CMR_RD_DATE || 'N/A'}</td>
                                        <td>${formatNumber(d.KUBIK_TERBARU)}</td>
                                        <td>${formatNumber(d.KUBIK_SEBELUMNYA)}</td>
                                        <td>${formatNumber(d.SELISIH_KUBIK)}</td>
                                        <td><span class="badge badge-${d.STATUS_PEMAKAIAN.includes('EKSTRIM') || d.STATUS_PEMAKAIAN.includes('ZERO') ? 'danger' : d.STATUS_PEMAKAIAN.includes('NAIK') || d.STATUS_PEMAKAIAN.includes('TURUN') ? 'warning' : 'success'}">${d.STATUS_PEMAKAIAN}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<div class="alert alert-secondary">Tidak ada riwayat baca meter (SBRS) yang ditemukan.</div>'}
                </div>
            </div>
        `;

        // --- Riwayat Piutang (MC) ---
        let mcHtml = `
            <div class="card shadow mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6><i class="fas fa-file-alt"></i> Riwayat Tagihan & Piutang (MC)</h6>
                </div>
                <div class="card-body">
                    ${mcData.length > 0 ? `
                        <p class="text-info font-weight-bold">Total Piutang Aktif (termasuk bulan berjalan): ${formatCurrency(mcData.reduce((sum, item) => sum + (item.NOMINAL || 0), 0))}</p>
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Bulan Tagihan</th>
                                    <th>Nominal (Rp)</th>
                                    <th>Kubikasi (m続)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${mcData.slice(0, 10).map(d => `
                                    <tr>
                                        <td>${d.BULAN_TAGIHAN || 'N/A'}</td>
                                        <td>${formatCurrency(d.NOMINAL)}</td>
                                        <td>${formatNumber(d.KUBIK)}</td>
                                        <td><span class="badge badge-${d.STATUS === 'PAYMENT' ? 'success' : 'danger'}">${d.STATUS || 'N/A'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <small class="text-muted">Menampilkan 10 data tagihan terakhir.</small>
                    ` : '<div class="alert alert-secondary">Tidak ada riwayat tagihan (MC) yang ditemukan.</div>'}
                </div>
            </div>
        `;

        // --- Riwayat Tunggakan Detail (ARDEBT) ---
        let ardebtHtml = `
            <div class="card shadow mb-4">
                <div class="card-header bg-danger text-white">
                    <h6><i class="fas fa-exclamation-circle"></i> Riwayat Tunggakan Detail (ARDEBT)</h6>
                </div>
                <div class="card-body">
                    ${ardebtData.length > 0 ? `
                        <p class="text-warning font-weight-bold">Total Tunggakan: ${formatCurrency(ardebtData.reduce((sum, item) => sum + (item.JUMLAH || 0), 0))}</p>
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Periode Bill</th>
                                    <th>Nominal Tunggakan (Rp)</th>
                                    <th>Rayon</th>
                                    <th>Status Pelanggan</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ardebtData.slice(0, 10).map(d => `
                                    <tr>
                                        <td>${d.PERIODE_BILL || 'N/A'}</td>
                                        <td>${formatCurrency(d.JUMLAH)}</td>
                                        <td>${d.RAYON || 'N/A'}</td>
                                        <td>${d.STATUS_PELANGGAN || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <small class="text-muted">Menampilkan 10 data tunggakan terakhir.</small>
                    ` : '<div class="alert alert-secondary">Tidak ada riwayat tunggakan (ARDEBT) yang ditemukan.</div>'}
                </div>
            </div>
        `;

        SEARCH_RESULTS.innerHTML = summaryHtml + profileHtml + sbrsHtml + mcHtml + ardebtHtml;
    }

    // Event Listener untuk form submission
    SEARCH_FORM.addEventListener('submit', async function(event) {
        event.preventDefault();
        const nomen = NOMEN_INPUT.value.trim();
        if (!nomen) {
            SEARCH_RESULTS.innerHTML = '<div class="alert alert-danger">Harap masukkan NOMEN pelanggan.</div>';
            return;
        }

        SEARCH_LOADING.classList.remove('d-none');
        SEARCH_RESULTS.innerHTML = '';
        
        try {
            const response = await fetch(`/api/search?nomen=${nomen}`);
            const data = await response.json();
            
            if (response.status === 200) {
                displayResults(data);
            } else {
                displayResults(data);
            }
        } catch (error) {
            SEARCH_RESULTS.innerHTML = `<div class="alert alert-danger">Terjadi kesalahan saat berkomunikasi dengan server API.</div>`;
            console.error('Error during search:', error);
        } finally {
            SEARCH_LOADING.classList.add('d-none');
        }
    });

    // Panggil fungsi status DB saat halaman dimuat
    document.addEventListener('DOMContentLoaded', checkDbStatus);

</script>
{% endblock %}
