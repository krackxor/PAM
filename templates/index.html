{% extends "base.html" %}

{% block title %}Pencarian Data{% endblock %}

{% block custom_styles %}
/* Custom CSS Khusus untuk Halaman Pencarian */
.input-group { 
    margin-bottom: 20px; 
    display: flex; 
    flex-direction: column; 
}
label { 
    font-weight: 600; 
    margin-bottom: 8px; 
}
#nomenInput { 
    padding: 12px 15px; 
    border: 1px solid #ced4da; 
    border-radius: var(--border-radius); /* Menggunakan variabel dari base.html */
    font-size: 16px; 
    width: 100%; 
    box-sizing: border-box; 
    transition: border-color 0.3s, box-shadow 0.3s;
}
#nomenInput:focus { 
    border-color: var(--primary-color); 
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); 
    outline: none; 
}

#hasilPencarian { 
    margin-top: 30px; 
    transition: opacity 0.5s ease-in-out; 
}
.result-card { 
    background-color: #f1f8ff; 
    border-left: 5px solid var(--primary-color); 
    padding: 15px; 
    border-radius: var(--border-radius); 
    margin-bottom: 15px; 
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
}
/* Grid untuk Detail Data */
.result-detail { 
    display: grid; 
    grid-template-columns: 1fr 2fr; 
    gap: 5px 15px; 
    font-size: 15px; 
}
.detail-key { 
    font-weight: 600; 
    color: var(--text-color); 
}
.detail-value {
    color: #555;
}
.no-result { 
    color: #dc3545; 
    padding: 15px; 
    border: 1px dashed #dc3545; 
    border-radius: var(--border-radius); 
    text-align: center; 
}
{% endblock %}

{% block content %}
    <h2 style="text-align: left; border-bottom: none; margin-bottom: 20px; color: var(--primary-color);">
        <i class="fas fa-search" style="margin-right: 10px;"></i> Pencarian Data Pelanggan
    </h2>
    
    <div class="input-group">
        <label for="nomenInput">Masukkan NOMEN (ID Pelanggan):</label>
        <input type="text" id="nomenInput" placeholder="Ketik NOMEN di sini, misalnya: 60139500">
    </div>
    
    <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">
    
    <div id="hasilPencarian">
        <p style="color: gray; text-align: center;">Mulai mengetik NOMEN.</p>
    </div>

    <script>
        const inputElement = document.getElementById('nomenInput');
        const hasilElement = document.getElementById('hasilPencarian');

        async function cariDataNomen() {
            const query = inputElement.value.trim();
            hasilElement.innerHTML = '';
            
            if (query === "") {
                hasilElement.innerHTML = '<p style="color: gray; text-align: center;">Mulai mengetik NOMEN di atas untuk melihat data.</p>';
                return;
            }

            hasilElement.innerHTML = '<p style="text-align: center; color: var(--primary-color);">Mencari data...</p>';

            try {
                const response = await fetch(`/api/search?nomen=${query}`);
                const hasilFilter = await response.json();
                
                if (response.status === 401) {
                    // Jika sesi habis
                    window.location.href = '/login'; 
                    return;
                }
                
                if (response.status !== 200) {
                     hasilElement.innerHTML = `<p class="no-result">❌ ${hasilFilter.message || 'Gagal terhubung ke API pencarian.'}</p>`;
                     return;
                }

                if (hasilFilter.length > 0) {
                    let cardsHTML = '';
                    
                    hasilFilter.forEach((data, index) => {
                        let detailHTML = '<div class="result-detail">';
                        const headers = Object.keys(data); 
                        
                        headers.forEach(header => {
                             detailHTML += `
                                <div class="detail-key">${header.replace(/_/g, ' ')}</div> 
                                <div class="detail-value">${data[header]}</div>
                            `;
                        });
                        
                        detailHTML += '</div>';
                        
                        const cardTitle = data['NAMA_PEL'] ? data['NAMA_PEL'] : `Detail Hasil ${index + 1}`;

                        cardsHTML += `
                            <div class="result-card">
                                <h3 style="color: var(--secondary-color); margin-top: 0;">${cardTitle}</h3>
                                ${detailHTML}
                            </div>
                        `;
                    });
                    
                    hasilElement.innerHTML = cardsHTML;
                } else {
                    hasilElement.innerHTML = `<p class="no-result">❌ Data untuk NOMEN: <strong>${query}</strong> tidak ditemukan.</p>`;
                }

            } catch (error) {
                hasilElement.innerHTML = `<p class="no-result">❌ Terjadi kesalahan saat mencari data. Cek koneksi server/DB.</p>`;
                console.error('Pencarian Error:', error);
            }
        }

        inputElement.addEventListener('input', cariDataNomen);
    </script>
{% endblock %}
