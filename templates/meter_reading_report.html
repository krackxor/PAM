{% extends "base.html" %}

{% block title %}Laporan Pembacaan Meter{% endblock %}

{% block custom_styles %}
<style>
    .summary-container { padding: 15px; }
    
    /* KPI Cards Modern Style */
    .kpi-card {
        background-color: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        margin-bottom: 25px;
        text-align: center;
        transition: transform 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        border: 1px solid #e3e6f0;
    }
    .kpi-card:hover { transform: translateY(-5px); }
    .kpi-card h4 { 
        color: #858796; 
        font-size: 0.75rem; 
        margin-bottom: 10px; 
        text-transform: uppercase; 
        letter-spacing: 1px; 
        font-weight: 800;
    }
    .kpi-card p { 
        font-size: 1.8rem; 
        font-weight: 800; 
        margin-bottom: 5px;
    }
    .kpi-card small { font-weight: 600; color: #b7b9cc; font-size: 0.7rem; }

    .grid-container { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
        gap: 20px; 
        margin-bottom: 30px; 
    }

    /* Section Cards */
    .chart-wrapper { 
        background-color: #fff; 
        padding: 25px; 
        border-radius: 15px; 
        box-shadow: 0 0.15rem 1.5rem 0 rgba(0, 0, 0, 0.05);
        border: 1px solid #e3e6f0;
    }
    .section-title { 
        color: #4e73df; 
        font-weight: 800;
        border-bottom: 2px solid #f8f9fc; 
        padding-bottom: 15px; 
        margin-bottom: 30px;
    }
    
    .anomaly-chart-container { height: 350px; position: relative; }
</style>
{% endblock %}

{% block content %}
<div class="summary-container">
    <h2 class="section-title">
        <i class="fas fa-tachometer-alt mr-2 text-primary"></i> Laporan Pembacaan Meter
    </h2>
    
    <!-- Loading State -->
    <div id="loadingStatus" class="text-center py-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <p class="mt-3 text-gray-600 font-weight-bold">Sinkronisasi data anomali AB SUNTER...</p>
    </div>

    <div id="meterReadingContent" style="display: none;">
        
        <!-- KPI Anomali -->
        <div class="grid-container">
            <div class="kpi-card" style="border-left: 5px solid #e74a3b;">
                <h4>Total Anomali</h4>
                <p id="total_anomali" style="color: #e74a3b;">0</p>
                <small>Lonjakan, Penurunan & Zero</small>
            </div>
            <div class="kpi-card" style="border-left: 5px solid #6f42c1;">
                <h4>Zero Usage</h4>
                <p id="anomali_zero" style="color: #6f42c1;">0</p>
                <small>Perlu Verifikasi Lapangan</small>
            </div>
            <div class="kpi-card" style="border-left: 5px solid #f6c23e;">
                <h4>Kenaikan Signifikan</h4>
                <p id="anomali_naik" style="color: #f6c23e;">0</p>
                <small>Termasuk Pemakaian Ekstrim</small>
            </div>
            <div class="kpi-card" style="border-left: 5px solid #4e73df;">
                <h4>Total Pelanggan</h4>
                <p id="total_pelanggan" style="color: #4e73df;">0</p>
                <small>Master Data Nomen</small>
            </div>
        </div>

        <!-- Distribusi Chart -->
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="chart-wrapper">
                    <h5 class="font-weight-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-pie mr-2 text-info"></i> Breakdown Kategori Anomali
                    </h5>
                    <div class="anomaly-chart-container">
                        <canvas id="anomalyBreakdownChart"></canvas>
                    </div>
                    <div class="text-center mt-4">
                        <a href="{{ url_for('bp_meter_reading.meter_reading_analysis_view') }}" class="btn btn-sm btn-outline-primary px-4 shadow-sm font-weight-bold">
                            LIHAT DETAIL ANALISIS <i class="fas fa-arrow-right ml-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    // Endpoints API
    const API_ANOMALY = "{{ url_for('anomaly_summary_api') }}";
    const API_SUMMARY = "{{ url_for('dashboard_summary_api') }}";
    
    function formatNumber(num) {
        return (parseInt(num) || 0).toLocaleString('id-ID');
    }
    
    async function fetchMeterReadingSummary() {
        try {
            const [resAnomaly, resSummary] = await Promise.all([
                fetch(API_ANOMALY),
                fetch(API_SUMMARY)
            ]);
            
            const anomalyData = await resAnomaly.json();
            const summaryData = await resSummary.json();

            if (anomalyData.status === 'error' || summaryData.status === 'error') {
                 document.getElementById('loadingStatus').innerHTML = `
                    <div class="alert alert-danger shadow-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i> Gagal memuat data: Database Offline
                    </div>`;
                 return;
            }

            // 1. Update KPI Cards
            document.getElementById('total_anomali').innerText = formatNumber(anomalyData.total_anomali);
            document.getElementById('anomali_zero').innerText = formatNumber(anomalyData.kategori.zero.jumlah);
            
            const naik_ekstrim = (anomalyData.kategori.ekstrim.jumlah || 0) + (anomalyData.kategori.naik_signifikan.jumlah || 0);
            document.getElementById('anomali_naik').innerText = formatNumber(naik_ekstrim);

            document.getElementById('total_pelanggan').innerText = formatNumber(summaryData.total_pelanggan);

            // 2. Render Chart
            renderAnomalyChart(anomalyData.kategori);

            document.getElementById('loadingStatus').style.display = 'none';
            document.getElementById('meterReadingContent').style.display = 'block';

        } catch (error) {
            document.getElementById('loadingStatus').innerHTML = `
                <div class="alert alert-warning shadow-sm">
                    <i class="fas fa-times-circle mr-2"></i> Gagal terhubung ke API server.
                </div>`;
            console.error('Fetch Error:', error);
        }
    }

    function renderAnomalyChart(kategori) {
        const ctx = document.getElementById('anomalyBreakdownChart').getContext('2d');
        
        const categoryMap = [
            { key: 'ekstrim', label: 'Ekstrim (>150mÂ³)', color: '#e74a3b' },
            { key: 'naik_signifikan', label: 'Naik Signifikan', color: '#f6c23e' },
            { key: 'turun_signifikan', label: 'Turun Signifikan', color: '#36b9cc' },
            { key: 'zero', label: 'Zero Usage', color: '#6f42c1' }
        ];

        const labels = categoryMap.map(c => c.label);
        const dataValues = categoryMap.map(c => kategori[c.key].jumlah || 0);
        const colors = categoryMap.map(c => c.color);
        
        const existingChart = Chart.getChart(ctx);
        if (existingChart) existingChart.destroy();

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: dataValues,
                    backgroundColor: colors,
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                    borderWidth: 5,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: { weight: 'bold', size: 11 }
                        }
                    },
                    tooltip: {
                        backgroundColor: "rgb(255,255,255)",
                        bodyColor: "#858796",
                        borderColor: '#dddfeb',
                        borderWidth: 1,
                        xPadding: 15,
                        yPadding: 15,
                        displayColors: false,
                        caretPadding: 10,
                    }
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', fetchMeterReadingSummary);
</script>
{% endblock %}
