{% extends "base.html" %}

{% block title %}Analisis Anomali SBRS{% endblock %}

{% block custom_styles %}
<style>
    .analysis-container { padding: 15px; }
    
    /* Hero Section */
    .hero-card {
        background-color: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        margin-bottom: 25px;
        border-left: 5px solid #4e73df;
    }

    /* Card Styling */
    .section-card {
        background-color: #fff;
        border-radius: 12px;
        border: 1px solid #e3e6f0;
        box-shadow: 0 0.15rem 1.5rem 0 rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
        height: 100%;
    }
    .card-header-custom {
        padding: 15px 20px;
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .card-header-custom h6 {
        margin: 0;
        font-weight: 700;
        color: #4e73df;
    }

    /* Chart Container */
    .chart-box {
        position: relative;
        height: 350px;
        width: 100%;
        padding: 15px;
    }

    /* Responsive Table with labels for mobile */
    .table-responsive-custom { width: 100%; overflow-x: auto; }
    .table-sm-custom { font-size: 0.82rem; margin-bottom: 0; }
    .table-sm-custom thead th {
        background: #f8f9fc;
        color: #4e73df;
        text-transform: uppercase;
        font-size: 0.7rem;
        font-weight: 800;
        border-top: none;
        padding: 12px 10px;
    }
    .table-sm-custom tbody td { vertical-align: middle; padding: 10px; }

    /* Badge Styles */
    .badge-status { font-weight: 800; padding: 5px 10px; border-radius: 20px; font-size: 0.65rem; }

    @media (max-width: 768px) {
        .table-sm-custom thead { display: none; }
        .table-sm-custom tr { 
            display: block; 
            border: 1px solid #eee; 
            margin: 15px; 
            border-radius: 10px; 
            background: #fbfcfe;
        }
        .table-sm-custom td {
            display: flex;
            justify-content: space-between;
            text-align: right;
            border: none;
            border-bottom: 1px solid #f2f2f2;
        }
        .table-sm-custom td:before {
            content: attr(data-label);
            font-weight: 800;
            text-align: left;
            color: #4e73df;
            font-size: 0.7rem;
            text-transform: uppercase;
            width: 50%;
        }
        .table-sm-custom td:last-child { border-bottom: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- Hero Header -->
    <div class="hero-card">
        <h2 class="font-weight-bold text-gray-800" style="font-size: 1.6rem;">
            <i class="fas fa-exclamation-triangle mr-2 text-warning"></i> Analisis Anomali SBRS
        </h2>
        <p class="text-muted mb-0">Identifikasi pelanggan dengan pola pemakaian air tidak wajar (Ekstrim, Turun Drastis, atau Zero Usage).</p>
    </div>

    <!-- Peringatan Koneksi -->
    <div id="db-warning" class="alert alert-danger shadow-sm d-none" role="alert">
        <i class="fas fa-database mr-2"></i> <strong>Koneksi MongoDB Terputus:</strong> Data gagal dimuat. Pastikan koneksi database aktif.
    </div>

    <div class="row">
        <!-- Navigation Card -->
        <div class="col-lg-5 mb-4">
            <div class="section-card shadow">
                <div class="card-header-custom">
                    <h6><i class="fas fa-compass mr-2"></i> Navigasi & Insight</h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted">Lihat tren bulanan dan ringkasan performa pembacaan meter melalui halaman laporan utama.</p>
                    <a href="{{ url_for('bp_meter_reading.meter_reading_report_view') }}" class="btn btn-outline-primary btn-block shadow-sm font-weight-bold">
                        <i class="fas fa-tachometer-alt mr-1"></i> LIHAT LAPORAN UTAMA
                    </a>
                    
                    <div class="dropdown-divider my-4"></div>
                    
                    <h6 class="font-weight-bold text-gray-700 small mb-3">Terapkan Filter Status:</h6>
                    <form id="anomaly-filter-form">
                        <div class="form-group mb-3">
                            <select id="filter-status" class="form-control form-control-sm font-weight-bold shadow-sm">
                                <option value="">Semua Anomali</option>
                                <option value="EKSTRIM">ðŸš€ Kubikasi Ekstrim (>150 mÂ³)</option>
                                <option value="NAIK">ðŸ“ˆ Naik Signifikan</option>
                                <option value="TURUN">ðŸ“‰ Turun Drastis</option>
                                <option value="ZERO">â­• Zero / Nol</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-danger btn-block shadow-sm font-weight-bold">
                            <i class="fas fa-filter mr-1"></i> TERAPKAN FILTER
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Result Stats & Chart -->
        <div class="col-lg-7 mb-4">
            <div class="section-card shadow">
                <div class="card-header-custom">
                    <h6><i class="fas fa-chart-bar mr-2"></i> Visualisasi Anomali</h6>
                    <span class="badge badge-primary px-3 py-2" id="anomaly-count-badge">0 Data Terdeteksi</span>
                </div>
                <div class="chart-box">
                    <canvas id="anomalyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table Section -->
    <div class="section-card shadow mb-5 border-left-info">
        <div class="card-header-custom bg-white">
            <h6 class="text-info"><i class="fas fa-table mr-2"></i> Rincian Detail Pelanggan Terdampak</h6>
            <button class="btn btn-sm btn-light border shadow-sm" onclick="location.reload()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
        <div class="card-body p-0">
            <div id="anomaly-loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted font-weight-bold">Menganalisis data SBRS terbaru...</p>
            </div>
            
            <div id="anomaly-table-container" class="table-responsive-custom">
                <!-- Tabel dimuat via JavaScript -->
            </div>
            
            <div id="anomaly-error-message" class="alert alert-light text-center m-4 d-none"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

<script>
    const API_ENDPOINT = "{{ url_for('bp_meter_reading.get_anomalies_api') }}";
    const ANOMALY_LOADING = document.getElementById('anomaly-loading');
    const ANOMALY_TABLE_CONTAINER = document.getElementById('anomaly-table-container');
    const ANOMALY_ERROR_MESSAGE = document.getElementById('anomaly-error-message');
    const ANOMALY_COUNT_BADGE = document.getElementById('anomaly-count-badge');
    const ANOMALY_FILTER_FORM = document.getElementById('anomaly-filter-form');
    const FILTER_STATUS = document.getElementById('filter-status');
    const CHART_CONTEXT = document.getElementById('anomalyChart').getContext('2d');
    const DB_WARNING = document.getElementById('db-warning');
    
    let allAnomalies = [];
    let chartInstance = null;

    const formatNum = (v) => (parseFloat(v) || 0).toLocaleString('id-ID');

    function createDataTable(data, schema) {
        if (!data || data.length === 0) {
            return '<div class="text-center py-5"><i class="fas fa-search fa-2x text-muted mb-3"></i><p class="text-muted">Tidak ada data anomali ditemukan untuk filter ini.</p></div>';
        }

        let html = '<table class="table table-hover table-sm-custom">';
        html += '<thead><tr>';
        schema.forEach(col => html += `<th>${col.label}</th>`);
        html += '</tr></thead><tbody>';

        data.forEach(row => {
            html += '<tr>';
            schema.forEach(col => {
                let cellValue = row[col.key] || '-';
                if (col.type === 'integer') cellValue = formatNum(cellValue);
                if (col.type === 'percent') cellValue = formatNum(cellValue) + '%';
                
                if (col.key === 'STATUS_PEMAKAIAN') {
                    let color = 'secondary';
                    if (cellValue.includes('EKSTRIM')) color = 'danger';
                    else if (cellValue.includes('ZERO')) color = 'dark';
                    else if (cellValue.includes('NAIK') || cellValue.includes('TURUN')) color = 'warning';
                    cellValue = `<span class="badge badge-${color} badge-status">${cellValue}</span>`;
                }

                html += `<td data-label="${col.label}">${cellValue}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        return html;
    }

    function renderChart(data) {
        if (chartInstance) chartInstance.destroy();

        const top10 = data.slice(0, 10);
        const labels = top10.map(d => d.chart_label);
        const values = top10.map(d => d.chart_data_kubik);

        chartInstance = new Chart(CHART_CONTEXT, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Kubikasi Terbaru',
                    data: values,
                    backgroundColor: '#4e73df',
                    borderRadius: 5,
                    barThickness: 25
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    title: { display: true, text: 'Top 10 Anomali Berdasarkan Konsumsi Air', color: '#4e73df', font: { weight: 'bold' } }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                    y: { beginAtZero: true, ticks: { font: { size: 10 } } }
                }
            }
        });
    }

    async function loadAnomalyData(filter = '') {
        ANOMALY_LOADING.classList.remove('d-none');
        ANOMALY_TABLE_CONTAINER.innerHTML = '';
        
        try {
            const res = await fetch(API_ENDPOINT);
            const json = await res.json();

            if (json.status !== 'success') {
                DB_WARNING.classList.remove('d-none');
                throw new Error(json.message);
            }

            DB_WARNING.classList.add('d-none');
            allAnomalies = json.data || [];
            
            let filtered = allAnomalies;
            if (filter) {
                filtered = allAnomalies.filter(d => d.STATUS_PEMAKAIAN && d.STATUS_PEMAKAIAN.includes(filter.toUpperCase()));
            }

            ANOMALY_COUNT_BADGE.innerText = `${filtered.length} Data Terdeteksi`;
            filtered.sort((a, b) => b.KUBIK_TERBARU - a.KUBIK_TERBARU);

            ANOMALY_TABLE_CONTAINER.innerHTML = createDataTable(filtered, json.schema);
            renderChart(filtered);

        } catch (err) {
            ANOMALY_ERROR_MESSAGE.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> ${err.message}`;
            ANOMALY_ERROR_MESSAGE.classList.remove('d-none');
        } finally {
            ANOMALY_LOADING.classList.add('d-none');
        }
    }

    ANOMALY_FILTER_FORM.addEventListener('submit', (e) => {
        e.preventDefault();
        loadAnomalyData(FILTER_STATUS.value);
    });

    document.addEventListener('DOMContentLoaded', () => loadAnomalyData());
</script>
{% endblock %}
