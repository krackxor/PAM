{% extends "base.html" %}

{% block title %}Laporan Koleksi & Piutang Terpadu{% endblock %}

{% block custom_styles %}
/* Custom CSS untuk Tampilan Report/Detail yang Responsif */
.report-header { text-align: center; margin-bottom: 20px; }
.report-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Minmax ditingkatkan */
    gap: 20px;
    margin-bottom: 30px;
}
.summary-card { 
    background-color: var(--card-bg); 
    padding: 15px; 
    border-radius: var(--border-radius); 
    box-shadow: var(--shadow-light);
    text-align: center; 
    border: 1px solid #e0e0e0;
    border-left: 5px solid;
    transition: transform 0.2s;
}
.summary-card:hover {
     transform: translateY(-2px);
     box-shadow: var(--shadow-medium);
}
.summary-card h4 { margin: 0 0 5px 0; font-size: 0.9em; color: #6c757d; }
.summary-card p { margin: 0; font-size: 1.6em; font-weight: bold; }

.filter-input-group { 
    margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ddd; 
    display: flex; align-items: stretch; gap: 10px; 
}
#filterInput { 
    padding: 12px; 
    border: 1px solid #ced4da; 
    border-radius: var(--border-radius); 
    font-size: 16px; 
    flex-grow: 1; 
}
.report-table-wrapper { overflow-x: auto; margin-top: 20px; }

/* --- TABLE LAYOUT --- */
.report-table, .collection-table { 
    width: 100%; border-collapse: collapse; font-size: 14px; 
    box-shadow: var(--shadow-light); 
    border-radius: var(--border-radius);
    overflow: hidden; 
}
.report-table th, .report-table td, .collection-table th, .collection-table td { 
    border: 1px solid #f0f0f0; padding: 10px; text-align: right; white-space: nowrap; 
}
.report-table th, .collection-table th { background-color: #e9ecef; text-align: center; font-weight: 600; }
.report-table { min-width: 1000px; }
.undue-cell { font-weight: bold; color: #17a2b8 !important; }

.grand-total-row { font-weight: bold; background-color: #d0e7ff; color: var(--text-color); } 
.percentage-cell { font-weight: bold; color: var(--secondary-color); }

.no-results { text-align: center; color: #555; padding: 20px; }

/* Styling untuk kelompok tabel kustom (AB Sunter) */
.breakdown-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
    gap: 20px;
    margin-top: 15px;
    margin-bottom: 30px;
}
.breakdown-table-container {
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
}

/* --- NEW TAB STYLES --- */
.tab-menu {
    border-bottom: 2px solid #ddd;
    margin-bottom: 20px;
    display: flex;
    overflow-x: auto; 
    white-space: nowrap;
}
.tab-button {
    padding: 10px 20px;
    cursor: pointer;
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-bottom: none;
    border-radius: 5px 5px 0 0;
    font-weight: 600;
    color: #555;
    transition: all 0.3s;
    flex-shrink: 0; 
}
.tab-button.active {
    background-color: white;
    border-color: var(--primary-color);
    border-bottom: 2px solid white; 
    color: var(--primary-color);
}
.tab-content-tab {
    padding: 10px 0;
    border: none;
}
.tab-content-tab h3 {
    margin-top: 30px;
    color: var(--primary-color);
    border-top: 1px solid #e0e0e0;
    padding-top: 20px;
}
.tab-content-tab h3:first-child {
    margin-top: 0;
    border-top: none;
    padding-top: 0;
}
/* ------------------------------------------- */

/* CSS for the new Analysis Menu Grid (Card Style) */
.report-grid-menu {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: 20px;
    margin-top: 20px;
    margin-bottom: 30px; 
}

.report-card-link {
    text-decoration: none;
    color: inherit;
}

.report-card-aggr {
    background-color: var(--card-bg);
    border: 1px solid #e0e0e0; 
    border-radius: var(--border-radius);
    padding: 25px 20px; 
    box-shadow: var(--shadow-light);
    transition: all 0.3s ease;
    text-align: center;
    min-height: 150px; 
    cursor: pointer;
}

.report-card-aggr:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 123, 255, 0.2); 
    border-color: var(--primary-color);
}

.report-card-aggr i {
    font-size: 3em; 
    color: var(--primary-color);
    margin-bottom: 10px;
}

.report-card-aggr h3 {
    margin: 10px 0 5px 0;
    color: var(--text-color);
    font-size: 1.1em;
}

.report-card-aggr p {
    font-size: 0.9em;
    color: #6c757d; 
}


/* -------------------------------------------------------------------------- */
/* --- ROMBAK TOTAL UI: LAYOUT MOBILE (LIST TRANSAKSI) --- */
/* -------------------------------------------------------------------------- */
@media screen and (max-width: 600px) {
    
    .collection-table thead, .report-table thead {
        display: none;
    }

    .collection-table tr:not(.total-row) {
        display: block;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .collection-table td {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        border: none;
        border-bottom: 1px solid #eee;
        position: relative;
        text-align: right; 
    }

    .collection-table td:before {
        content: attr(data-label); 
        font-weight: 600;
        text-align: left;
        width: 50%; 
        color: var(--text-color);
        padding-right: 10px;
    }
    
    .collection-table .total-row td {
        display: table-cell;
        border: 1px solid #ddd;
        text-align: center;
        font-weight: bold;
    }
    .collection-table .total-row {
        margin-top: 20px;
        display: table-row-group;
    }
    
    .report-table {
        min-width: 100%;
    }
}
{% endblock %}

{% block content %}
    <h2 style="text-align: left; border-bottom: none; margin-bottom: 20px; color: var(--primary-color);">
        <i class="fas fa-chart-bar" style="margin-right: 10px;"></i> Laporan Koleksi & Piutang Terpadu
    </h2>
    
    <div class="tab-menu">
        <button class="tab-button active" onclick="showTabCollection('summary')" id="tab-summary">
            <i class="fas fa-list-alt"></i> Ringkasan & Piutang Utama
        </button>
        <button class="tab-button" onclick="showTabCollection('monitoring')" id="tab-monitoring">
            <i class="fas fa-calendar-alt"></i> Monitoring & Detail Koleksi
        </button>
        <button class="tab-button" onclick="showTabCollection('analysis')" id="tab-analysis">
            <i class="fas fa-layer-group"></i> Analisis Agregasi
        </button>
    </div>

    <div id="content-summary" class="tab-content-tab">
        <div id="reportArea">
            <p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Ringkas...</p>
        </div>
    </div>

    <div id="content-monitoring" class="tab-content-tab" style="display: none;">
        
        <h3 style="color: #28a745;">
            <i class="fas fa-arrows-alt-h"></i> Perbandingan Koleksi Bulanan (MoM)
        </h3>
        
        <div id="momReportArea" class="content-section">
            <div id="momSummaryGrid" class="report-grid">
                </div>
            <div id="momChartContainer" style="max-width: 900px; margin: 30px auto;">
                <canvas id="momBarChart"></canvas>
            </div>
            <div id="momTableContainer" class="report-table-wrapper" style="margin-top: 30px;">
                </div>
        </div>
        
        <h3 style="color: #007bff; margin-top: 30px;">
            <i class="fas fa-chart-line"></i> Grafik Koleksi DtD (Hari ke Hari)
        </h3>
        
        <div id="dohComparisonArea" class="content-section">
            <div id="dohChartContainer" style="max-width: 900px; margin: 30px auto;">
                <canvas id="dohLineChart"></canvas>
            </div>
            <div id="dohTableContainer" class="report-table-wrapper" style="margin-top: 30px;">
                <p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat data DtD Comparison...</p>
            </div>
        </div>
        <h3 style="color: #dc3545;">
            <i class="fas fa-calendar-alt"></i> Monitoring Koleksi Harian (Rayon 34 & 35)
        </h3>
        
        <div id="monitoringSummaryArea" class="report-grid">
            <p class="no-results" style="grid-column: 1 / 1;"><i class="fas fa-spinner fa-spin"></i> Memuat ringkasan monitoring...</p>
        </div>

        <div id="monitoringTableArea">
        </div>
        
        <div style="text-align: right; margin-top: 10px; margin-bottom: 20px;">
            <a href="#" id="exportReportBtn" class="btn-primary" style="background-color: #6c757d; text-decoration: none;">
                <i class="fas fa-file-excel"></i> Export Summary
            </a>
        </div>
        
        <h3 style="color: #007bff;">
            <i class="fas fa-list-alt"></i> Listing Transaksi Pembayaran (MB Detail)
        </h3>

        <div class="filter-input-group">
            <input type="text" id="filterInput" placeholder="Filter Detail (Rayon, NOMEN, Bulan_Rek, Jenis_Tagihan)...">
            <button id="searchBtn" class="btn-primary" style="background-color: var(--primary-color); color: white; padding: 12px 18px; border: none; border-radius: 4px;">
                <i class="fas fa-filter"></i> Filter Detail
            </button>
        </div>

        <div id="detailsArea">
            <p class="no-results">Memuat data transaksi...</p>
        </div>
    </div>
    
    <div id="content-analysis" class="tab-content-tab" style="display: none;">
        
        <h3 style="color: #17a2b8;">
            <i class="fas fa-list-ol"></i> Distribusi Pelanggan Berdasarkan TARIF (Rayon 34 & 35 Reguler)
        </h3>
        
        <div id="tariffChartArea" style="max-width: 450px; margin: 20px auto;">
            <canvas id="tarifBreakdownChart"></canvas>
        </div>
        <div id="tarifBreakdownArea">
            <p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat data breakdown tarif...</p>
        </div>

        <h3 style="color: var(--primary-color);">
            <i class="fas fa-chart-pie"></i> Laporan Agregasi Khusus (Pilih salah satu kartu untuk memuat)
        </h3>
        
        <div class="report-grid-menu">
        
            <a href="javascript:void(0);" onclick="fetchCustomReport();" class="report-card-link">
                <div class="report-card-aggr" style="border-left-color: #dc3545;">
                    <i class="fas fa-layer-group" style="color: #dc3545;"></i>
                    <h3>Grouping MC: AB Sunter</h3>
                    <p>Agregasi Nomen, Kubik, dan Nominal berdasarkan Tarif, Merek, dan Metode Baca untuk R34/R35.</p>
                </div>
            </a>
            
            <a href="javascript:void(0);" onclick="fetchBasicVolumeReport();" class="report-card-link">
                <div class="report-card-aggr" style="border-left-color: var(--secondary-color);">
                    <i class="fas fa-water" style="color: var(--secondary-color);"></i>
                    <h3>Laporan Volume Dasar</h3>
                    <p>Riwayat volume KUBIK bulanan dari seluruh data Master Cetak (MC) secara historis.</p>
                </div>
            </a>
            
            <a href="javascript:void(0);" onclick="fetchTopLists();" class="report-card-link">
                <div class="report-card-aggr" style="border-left-color: var(--primary-color);">
                    <i class="fas fa-medal" style="color: var(--primary-color);"></i>
                    <h3>Daftar Konsumen Top</h3>
                    <p>Top 500 Tunggakan, Top 500 Premium, serta Daftar Lunas dan Belum Bayar (Snapshot Terbaru).</p>
                </div>
            </a>
            
            <a href="javascript:void(0);" onclick="fetchAgingReport();" class="report-card-link">
                <div class="report-card-aggr" style="border-left-color: var(--accent-color);">
                    <i class="fas fa-clock" style="color: var(--accent-color);"></i>
                    <h3>Analisis Umur Piutang (Aging)</h3>
                    <p>Melihat daftar piutang lama (> 1 bulan) yang masih aktif berdasarkan data Master Cetak.</p>
                </div>
            </a>
            
        </div>
        
        <hr style="margin: 40px 0; border-style: dotted;">

        <h3 style="color: #dc3545;">
            <i class="fas fa-layer-group"></i> Hasil Laporan AB Sunter
        </h3>
        <div id="customReportArea">
            <p class="no-results">Tekan kartu "Grouping MC: AB Sunter" di atas untuk memuat hasilnya.</p>
        </div>
        
        <h3 style="color: #ffc107;">
            <i class="fas fa-clock"></i> Hasil Laporan Umur Piutang (Aging)
        </h3>
        <div id="agingReportArea">
            <p class="no-results">Tekan kartu "Analisis Umur Piutang (Aging)" di atas untuk memuat hasilnya.</p>
        </div>

        <h3 style="color: #28a745;">
            <i class="fas fa-water"></i> Hasil Laporan Volume Dasar
        </h3>
        <div id="basicVolumeReportArea">
            <p class="no-results">Tekan kartu "Laporan Volume Dasar" di atas untuk memuat hasilnya.</p>
        </div>

        <h3 style="color: var(--primary-color);">
            <i class="fas fa-list-alt"></i> Hasil Daftar Konsumen Spesifik
        </h3>
        <div id="topListsArea">
            <p class="no-results">Tekan kartu "Daftar Konsumen Top" di atas untuk memuat hasilnya.</p>
        </div>
        
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Memastikan Chart.js dimuat dari CDN (tambahan untuk memastikan ketersediaan)
        if (typeof Chart === 'undefined') {
             console.error("Chart.js belum dimuat.");
        }

        const reportArea = document.getElementById('reportArea');
        const filterInput = document.getElementById('filterInput');
        const searchBtn = document.getElementById('searchBtn');
        const detailsArea = document.getElementById('detailsArea');
        const exportReportBtn = document.getElementById('exportReportBtn');
        const customReportArea = document.getElementById('customReportArea');
        const tarifBreakdownArea = document.getElementById('tarifBreakdownArea');
        
        const monitoringSummaryArea = document.getElementById('monitoringSummaryArea');
        const monitoringTableArea = document.getElementById('monitoringTableArea');
        
        const topListsArea = document.getElementById('topListsArea');
        const basicVolumeReportArea = document.getElementById('basicVolumeReportArea');
        
        const agingReportArea = document.getElementById('agingReportArea');
        const tariffChartArea = document.getElementById('tariffChartArea');

        // MoM Variables
        const momSummaryGrid = document.getElementById('momSummaryGrid');
        const momTableContainer = document.getElementById('momTableContainer');
        let momChartInstance = null;
        let tariffChartInstance = null;
        let dohChartInstance = null; // DOH Chart Instance

        function formatRupiah(number) {
            return 'Rp ' + (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
        }
        
        function formatNumber(number) {
            return (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
        }

        function formatPercent(number) {
            return (parseFloat(number) || 0).toFixed(2) + '%';
        }
        
        // Helper untuk menentukan warna dan ikon (Naik/Turun/Netral)
        const getChangeColor = (value) => value > 0 ? '#28a745' : (value < 0 ? '#dc3545' : '#6c757d');
        const getChangeIcon = (value) => value > 0 ? 'up' : (value < 0 ? 'down' : 'minus');


        // --- FUNGSI UTILITY UNTUK TAB ---
        function showTabCollection(tabName) {
            // Sembunyikan semua konten tab
            document.querySelectorAll('.tab-content-tab').forEach(div => div.style.display = 'none');
            
            // Hapus kelas aktif dari semua tombol
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            // Tampilkan konten tab yang dipilih
            const contentId = `content-${tabName}`;
            if (document.getElementById(contentId)) {
                document.getElementById(contentId).style.display = 'block';
            }

            // Set tombol menjadi aktif
            const tabButton = document.getElementById(`tab-${tabName}`);
            if (tabButton) {
                tabButton.classList.add('active');
            }

            // --- PANGGIL FUNGSI LOAD DATA BERDASARKAN TAB ---
            if (tabName === 'summary') {
                fetchCollectionReport(); 
            } else if (tabName === 'monitoring') {
                fetchMoMReport(); 
                fetchCollectionMonitoring();
                fetchCollectionDetails(''); 
                fetchDOHComparisonReport(); // Memuat DtD Comparison
            } else if (tabName === 'analysis') {
                 fetchTarifBreakdown(); // Load tarif breakdown otomatis
            }
        }
        // --- END FUNGSI UTILITY UNTUK TAB ---
        
        // =========================================================
        // --- FUNGSI BARU: MEMUAT MOM REPORT ---
        // =========================================================
        async function fetchMoMReport() {
            momSummaryGrid.innerHTML = '<p class="no-results" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Perbandingan Bulanan...</p>';
            momTableContainer.innerHTML = '';
            
            try {
                const response = await fetch('{{ url_for("mom_report_api") }}'); 
                const result = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }

                if (result.status !== 'success') {
                     momSummaryGrid.innerHTML = `<p class="no-results" style="color: red; grid-column: 1 / -1;">❌ Gagal memuat report: ${result.message || 'Error Server'}</p>`;
                     return;
                }
                
                renderMoMReport(result.data);

            } catch (error) {
                momSummaryGrid.innerHTML = '<p class="no-results" style="color: red; grid-column: 1 / -1;">Gagal mengambil data MoM report dari server.</p>';
                console.error('MoM Report Error:', error);
            }
        }

        function renderMoMReport(data) {
            
            // --- 1. RENDER SUMMARY GRID ---
            
            momSummaryGrid.innerHTML = `
                <div class="summary-card" style="border-left-color: #28a745;">
                    <h4>Nominal Koleksi Bulan Ini (${data.period_current})</h4>
                    <p>${formatRupiah(data.current_nominal)}</p>
                </div>
                <div class="summary-card" style="border-left-color: ${getChangeColor(data.change_nominal)};">
                    <h4>Perubahan Nominal (MoM)</h4>
                    <p style="color: ${getChangeColor(data.change_nominal)};">
                        <i class="fas fa-caret-${getChangeIcon(data.change_nominal)}"></i> 
                        ${formatPercent(data.change_nominal)}
                    </p>
                </div>
                <div class="summary-card" style="border-left-color: #007bff;">
                    <h4>Jml Pelanggan Bulan Ini (${data.period_current})</h4>
                    <p>${formatNumber(data.current_nomen)}</p>
                </div>
                <div class="summary-card" style="border-left-color: ${getChangeColor(data.change_nomen)};">
                    <h4>Perubahan Pelanggan (MoM)</h4>
                    <p style="color: ${getChangeColor(data.change_nomen)};">
                        <i class="fas fa-caret-${getChangeIcon(data.change_nomen)}"></i> 
                        ${formatPercent(data.change_nomen)}
                    </p>
                </div>
            `;

            // --- 2. RENDER TABLE ---
            momTableContainer.innerHTML = `
                <h4 style="margin-top: 20px;">Tabel Perbandingan Koleksi Nominal dan Pelanggan</h4>
                <table class="report-table" style="min-width: 600px;">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Metrik</th>
                            <th>Bulan Lalu (${data.period_last})</th>
                            <th>Bulan Ini (${data.period_current})</th>
                            <th>Perubahan (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="text-align: left;">Total Nominal Koleksi</td>
                            <td>${formatRupiah(data.last_nominal)}</td>
                            <td>${formatRupiah(data.current_nominal)}</td>
                            <td style="color: ${getChangeColor(data.change_nominal)}; font-weight: bold;">
                                 ${formatPercent(data.change_nominal)}
                            </td>
                        </tr>
                        <tr>
                            <td style="text-align: left;">Jumlah Pelanggan</td>
                            <td>${formatNumber(data.last_nomen)}</td>
                            <td>${formatNumber(data.current_nomen)}</td>
                            <td style="color: ${getChangeColor(data.change_nomen)}; font-weight: bold;">
                                 ${formatPercent(data.change_nomen)}
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;
            
            // --- 3. RENDER BAR CHART ---
            renderMoMChart(data);
        }

        function renderMoMChart(data) {
            if (momChartInstance) {
                momChartInstance.destroy();
            }

            const ctx = document.getElementById('momBarChart').getContext('2d');
            
            // Data untuk Chart.js
            const chartLabels = ['Nominal Koleksi', 'Jumlah Pelanggan'];
            const chartData = {
                labels: chartLabels,
                datasets: [
                    {
                        label: data.period_last,
                        data: [data.last_nominal, data.last_nomen],
                        backgroundColor: '#adb5bd', // Abu-abu terang
                        borderColor: '#adb5bd',
                        borderWidth: 1
                    },
                    {
                        label: data.period_current,
                        data: [data.current_nominal, data.current_nomen],
                        backgroundColor: '#28a745', // Hijau
                        borderColor: '#28a745',
                        borderWidth: 1
                    }
                ]
            };

            momChartInstance = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nilai (Rupiah/Count)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Perbandingan Koleksi Nominal & Pelanggan (DtD MoM)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataIndex === 0) {
                                        label += formatRupiah(context.parsed.y);
                                    } else {
                                        label += formatNumber(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // =========================================================
        // --- FUNGSI BARU: MEMUAT DOH COMPARISON REPORT (DtD) ---
        // =========================================================
        async function fetchDOHComparisonReport() {
            const dohTableContainer = document.getElementById('dohTableContainer');
            dohTableContainer.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat data DtD Comparison...</p>';
            
            try {
                const response = await fetch('{{ url_for("doh_comparison_report_api") }}'); 
                const result = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }

                if (result.status !== 'success' || result.data.days.length === 0) {
                     dohTableContainer.innerHTML = `<p class="no-results" style="color: #dc3545;">❌ Gagal memuat report: ${result.message || 'Tidak ada data MB di kedua bulan untuk perbandingan Day-to-Date.'}</p>`;
                     if (dohChartInstance) dohChartInstance.destroy();
                     return;
                }
                
                renderDOHComparisonReport(result.data, result.periods);

            } catch (error) {
                dohTableContainer.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data DtD comparison dari server.</p>';
                console.error('DOH Report Error:', error);
            }
        }

        function renderDOHComparisonReport(data, periods) {
            
            // Helper untuk menghitung Kumulatif
            const calculateCumulative = (arr) => {
                let cumulative = [];
                let currentSum = 0;
                for (const value of arr) {
                    currentSum += value;
                    cumulative.push(currentSum);
                }
                return cumulative;
            }
            
            // Helper untuk menghitung persentase DtD
            const calculateDtDPercentage = (currentDaily, lastDaily) => {
                if (lastDaily === 0) {
                    return currentDaily > 0 ? 100 : 0;
                }
                return ((currentDaily - lastDaily) / lastDaily) * 100;
            };

            // Ambil Data Kumulatif untuk Grafik (TOTAL AB)
            const currentCumulative = calculateCumulative(data.TOTAL_AB[periods.current]);
            const lastCumulative = calculateCumulative(data.TOTAL_AB[periods.last]);

            // 1. Render Chart
            if (dohChartInstance) {
                dohChartInstance.destroy();
            }
            
            const ctx = document.getElementById('dohLineChart').getContext('2d');
            
            dohChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.days.map(d => 'Hari ke-' + d),
                    datasets: [
                        {
                            label: `Bulan Lalu (${periods.last}) - Kumulatif`,
                            data: lastCumulative,
                            borderColor: '#adb5bd', 
                            backgroundColor: '#adb5bd50',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                        },
                        {
                            label: `Bulan Ini (${periods.current}) - Kumulatif`,
                            data: currentCumulative,
                            borderColor: '#007bff', 
                            backgroundColor: '#007bff50',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nominal Kumulatif (Rp)'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tren Koleksi Kumulatif DtD (Nominal AB Sunter)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatRupiah(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // 2. Render Tabel
            
            // Helper function untuk merender sub-tabel (Rayon atau Total)
            const renderComparisonTable = (areaKey, periods, dataStructure) => {
                
                // MENGATASI ISU MAPPING RAYON: 
                // areaKey di JS: 'R34', 'R35', 'TOTAL_AB'
                // Kunci data yang diterima: 'R34', 'R35', 'TOTAL_AB'
                const areaDailyCurrent = dataStructure[areaKey][periods.current];
                const areaDailyLast = dataStructure[areaKey][periods.last];
                const areaCumulativeCurrent = calculateCumulative(areaDailyCurrent);
                const areaCumulativeLast = calculateCumulative(areaDailyLast);
                
                let subTableHTML = `
                    <h5 style="margin-top: 25px; color: ${areaKey === 'TOTAL_AB' ? '#dc3545' : '#17a2b8'};">
                        DETAIL AREA ${areaKey.replace('R', 'RAYON ').replace('_AB', ' SUNTER')}
                    </h5>
                    <div class="report-table-wrapper">
                    <table class="report-table" style="min-width: 600px;">
                        <thead>
                            <tr>
                                <th rowspan="2">Hari ke-</th>
                                <th colspan="2">${periods.current} (BULAN INI)</th>
                                <th colspan="2">${periods.last} (BULAN LALU)</th>
                                <th rowspan="2">Perubahan Harian (%)</th>
                            </tr>
                            <tr>
                                <th>Harian (Rp)</th>
                                <th>Kumulatif (Rp)</th>
                                <th>Harian (Rp)</th>
                                <th>Kumulatif (Rp)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.days.forEach((day, index) => {
                    const currentDaily = areaDailyCurrent[index];
                    const lastDaily = areaDailyLast[index];
                    const percentageChange = calculateDtDPercentage(currentDaily, lastDaily);
                    const changeColor = getChangeColor(percentageChange);

                    subTableHTML += `
                        <tr>
                            <td style="text-align: center;">${day}</td>
                            <td>${formatRupiah(currentDaily)}</td>
                            <td style="background-color: #f0f8ff;">${formatRupiah(areaCumulativeCurrent[index])}</td>
                            <td>${formatRupiah(lastDaily)}</td>
                            <td style="background-color: #f0f8ff;">${formatRupiah(areaCumulativeLast[index])}</td>
                            <td style="color: ${changeColor}; font-weight: bold;">
                                 <i class="fas fa-caret-${getChangeIcon(percentageChange)}"></i> ${formatPercent(percentageChange)}
                            </td>
                        </tr>
                    `;
                });
                
                subTableHTML += '</tbody></table></div>';
                return subTableHTML;
            };

            let tableHTML = renderComparisonTable('TOTAL_AB', periods, data);
            tableHTML += renderComparisonTable('R34', periods, data);
            tableHTML += renderComparisonTable('R35', periods, data);


            dohTableContainer.innerHTML = tableHTML;
        }

        // --- FUNGSI AGING REPORT, BREAKDOWN TARIF, DLL. ---
        
        // --- FUNGSI BARU: MEMUAT AGING REPORT ---
        async function fetchAgingReport() {
            agingReportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Umur Piutang...</p>';
            
            try {
                const response = await fetch('{{ url_for("aging_report_api") }}'); 
                const result = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (result.status !== 'success' || result.data.length === 0) {
                     agingReportArea.innerHTML = `<p class="no-results" style="color: #dc3545;">❌ ${result.message || 'Tidak ada data piutang lama ditemukan.'}</p>`;
                     return;
                }
                
                renderAgingReport(result.data);

            } catch (error) {
                agingReportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data aging report dari server.</p>';
                console.error('Aging Report Error:', error);
            }
        }
        
        function renderAgingReport(data) {
             const headers = Object.keys(data[0]);
             let tableHTML = `
                 <h4 style="margin-top: 20px;">Daftar Pelanggan dengan Piutang > 1 Bulan (${data.length} Data)</h4>
                 <div class="report-table-wrapper">
                 <table class="report-table">
                     <thead><tr>
                         ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ')}</th>`).join('')}
                     </tr></thead><tbody>
             `;
             
             data.forEach(item => {
                 tableHTML += '<tr>';
                 headers.forEach(h => {
                     let cellValue = item[h];
                     let align = 'right';
                     
                     if (h.includes('NOMEN') || h.includes('NAMA') || h.includes('RAYON')) {
                         align = 'left';
                     }
                     
                     if (h.includes('PiutangLama')) {
                         cellValue = formatRupiah(cellValue);
                     } else if (h.includes('Bulan_Tagihan')) {
                         align = 'center';
                     }
                     tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${align};">${cellValue}</td>`;
                 });
                 tableHTML += '</tr>';
             });
             
             tableHTML += '</tbody></table></div>';
             agingReportArea.innerHTML = tableHTML;
        }


        // --- FUNGSI BARU: RENDER PIE CHART TARIF ---
        function renderTariffBreakdownChart(data) {
            const chartData = {};
            
            if (tariffChartInstance) {
                tariffChartInstance.destroy();
            }

            // Agregat berdasarkan TARIF di semua Rayon 34/35
            data.forEach(item => {
                const tarif = item.TARIF || 'N/A';
                const count = item.JumlahPelanggan;
                chartData[tarif] = (chartData[tarif] || 0) + count;
            });

            const labels = Object.keys(chartData);
            const counts = Object.values(chartData);
            
            // Hasilkan warna berbeda secara dinamis
            const backgroundColors = labels.map((_, index) => {
                // Skema warna yang lebih menarik
                const colors = [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', 
                    '#6c757d', '#343a40', '#6f42c1', '#fd7e14'
                ];
                return colors[index % colors.length];
            });

            tariffChartInstance = new Chart(document.getElementById('tarifBreakdownChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors,
                        hoverOffset: 10,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Pelanggan Berdasarkan Tarif (Count Nomen)'
                        }
                    }
                }
            });
        }
        // --- END FUNGSI BARU: RENDER PIE CHART TARIF ---


        // --- FUNGSI BARU: MEMUAT BREAKDOWN TARIF (MEMANGGIL CHART) ---
        async function fetchTarifBreakdown() {
            tarifBreakdownArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Breakdown Tarif...</p>';
            
            try {
                // Panggil API baru untuk breakdown tarif
                const response = await fetch('{{ url_for("analyze_mc_tarif_breakdown_api") }}'); 
                const data = await response.json();
                
                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (response.status !== 200 || data.length === 0) {
                     tarifBreakdownArea.innerHTML = `<p class="no-results" style="color: #6c757d;">Tidak ada data pelanggan yang cocok dengan kriteria kustom (Rayon 34/35 Reguler).</p>`;
                     const existingChart = Chart.getChart("tarifBreakdownChart");
                     if (existingChart) { existingChart.destroy(); }
                     return;
                }
                
                renderTarifBreakdownTable(data);
                renderTariffBreakdownChart(data); // <-- Panggil fungsi render chart

            } catch (error) {
                tarifBreakdownArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data breakdown tarif dari server.</p>';
                console.error('Tarif Breakdown Error:', error);
            }
        }
        
        function renderTarifBreakdownTable(data) {
            let totalPelanggan = data.reduce((sum, item) => sum + item.JumlahPelanggan, 0);

            // Perbesar lebar untuk kolom Rayon
            let tableHTML = `
                <div class="report-table-wrapper" style="max-width: 600px; margin-left: 0;"> 
                <h4 style="margin-top: 10px;">Detail Distribusi Tarif per Rayon (Count)</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">RAYON</th>
                            <th style="text-align: left;">TARIF</th>
                            <th>JML Pelanggan</th>
                            <th>Persentase (%)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                const percentage = (item.JumlahPelanggan / totalPelanggan) * 100;
                tableHTML += `
                    <tr>
                        <td data-label="RAYON" style="text-align: left;">${item.RAYON}</td>
                        <td data-label="TARIF" style="text-align: left;">${item.TARIF}</td>
                        <td data-label="JML Pelanggan">${formatNumber(item.JumlahPelanggan)}</td>
                        <td data-label="Persentase">${formatPercent(percentage)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                <tr class="grand-total-row">
                    <td style="text-align: left;">TOTAL</td>
                    <td>-</td> 
                    <td>${formatNumber(totalPelanggan)}</td>
                    <td>100.00%</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            tarifBreakdownArea.innerHTML = tableHTML;
        }

        // --- FUNGSI 1: MEMUAT REPORT RINGKAS ---
        async function fetchCollectionReport() {
            if (reportArea.querySelector('.report-grid') && 
                reportArea.querySelector('.report-grid').children.length > 0 && 
                !reportArea.querySelector('.report-grid').querySelector('.no-results')) {
                return; 
            }
            reportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Ringkas...</p>';

            try {
                const response = await fetch('{{ url_for("collection_report_api") }}');
                const result = await response.json();
                
                const customSummaryResponse = await fetch('{{ url_for("analyze_mc_grouping_summary_api") }}');
                const customSummaryResult = await customSummaryResponse.json();

                if (response.status !== 200) {
                     reportArea.innerHTML = `<p class="no-results" style="color: red;">❌ Gagal memuat report: ${result.message || 'Error Server'}</p>`;
                     return;
                }
                
                result.grand_total.TotalPiutangKustomNominal = customSummaryResult.TotalPiutangKustomNominal || 0;
                result.grand_total.TotalPiutangKustomKubik = customSummaryResult.TotalPiutangKustomKubik || 0;
                result.grand_total.TotalNomenKustom = customSummaryResult.TotalNomenKustom || 0;

                renderReport(result.report_data, result.grand_total);

            } catch (error) {
                reportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data report dari server.</p>';
                console.error('Report Error:', error);
            }
        }
        
        function renderReport(data, grandTotal) {
            let summaryHTML = `
                <div class="report-header">
                    <h3 style="color: var(--primary-color); border-top: none;">Ringkasan Total Aplikasi (MC, MB, CID)</h3>
                </div>
                <div class="report-grid">
                    <div class="summary-card" style="border-left-color: #007bff;">
                        <h4>Total Pelanggan (CID)</h4>
                        <p>${grandTotal.TotalPelanggan.toLocaleString('id-ID')}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: var(--primary-color);">
                        <h4>Total Pelanggan MC (Count Nomen)</h4>
                        <p>${formatNumber(grandTotal.MC_TotalNomen)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #ffc107;">
                        <h4>Total Piutang MC (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MC_TotalNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Total Piutang MC (Kubik)</h4>
                        <p>${formatNumber(grandTotal.MC_TotalKubik)} m³</p>
                    </div>
                    
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Piutang Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatRupiah(grandTotal.TotalPiutangKustomNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Kubik Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatNumber(grandTotal.TotalPiutangKustomKubik)} m³</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Nomen Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatNumber(grandTotal.TotalNomenKustom)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #28a745;">
                        <h4>Total Koleksi MC (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MC_CollectedNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #17a2b8;">
                        <h4>MB "Undue" Koleksi (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MB_UndueNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #0056b3;">
                        <h4>MB "Undue" (Nominal %)</h4>
                        <p>${formatPercent(grandTotal.UnduePercentNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #6c757d;">
                        <h4>MC Koleksi (Nominal %)</h4>
                        <p>${formatPercent(grandTotal.PercentNominal)}</p>
                    </div>
                </div>
            `;
            
            let tableHTML = `
                <h3 style="margin-top: 30px; color: var(--primary-color);">Detail Perbandingan MC (Piutang) vs MB (Koleksi Undue) per Rayon / PCEZ</h3>
                <div class="report-table-wrapper">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th rowspan="2">RAYON</th>
                            <th rowspan="2">PCEZ</th>
                            <th colspan="2" style="background-color: #ffeeba;">MC (PIUTANG)</th>
                            <th colspan="2" style="background-color: #d4edda;">MC (KOLEKSI)</th>
                            <th colspan="2" style="background-color: #d1ecf1;">MB ("UNDUE")</th>
                            <th colspan="2" rowspan="2">PERSENTASE (%)</th>
                        </tr>
                        <tr>
                            <th style="background-color: #ffeeba;">NOMINAL</th>
                            <th style="background-color: #ffeeba;">KUBIK (m³)</th>
                            <th style="background-color: #d4edda;">NOMINAL</th>
                            <th style="background-color: #d4edda;">KUBIK (m³)</th>
                            <th style="background-color: #d1ecf1;">NOMINAL</th>
                            <th style="background-color: #d1ecf1;">KUBIK (m³)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                tableHTML += `
                    <tr>
                        <td data-label="Rayon">${item.RAYON}</td>
                        <td data-label="PCEZ">${item.PCEZ}</td>
                        <td data-label="MC Piutang Nom">${formatRupiah(item.MC_TotalNominal)}</td>
                        <td data-label="MC Piutang Kubik">${formatNumber(item.MC_TotalKubik)}</td>
                        <td data-label="MC Koleksi Nom">${formatRupiah(item.MC_CollectedNominal)}</td>
                        <td data-label="MC Koleksi Kubik">${formatNumber(item.MC_CollectedKubik)}</td>
                        <td data-label="MB Undue Nom" class="undue-cell">${formatRupiah(item.MB_UndueNominal)}</td>
                        <td data-label="MB Undue Kubik" class="undue-cell">${formatNumber(item.MB_UndueKubik)}</td>
                        <td data-label="% Nom" class="percentage-cell">${formatPercent(item.PercentNominal)}</td>
                        <td data-label="% Undue" class="undue-cell">${formatPercent(item.UnduePercentNominal)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                <tr class="grand-total-row">
                    <td>GRAND TOTAL</td>
                    <td>-</td>
                    <td>${formatRupiah(grandTotal.MC_TotalNominal)}</td>
                    <td>${formatNumber(grandTotal.MC_TotalKubik)}</td>
                    <td>${formatRupiah(grandTotal.MC_CollectedNominal)}</td>
                    <td>${formatNumber(grandTotal.MC_CollectedKubik)}</td>
                    <td>${formatRupiah(grandTotal.MB_UndueNominal)}</td>
                    <td>${formatNumber(grandTotal.MB_UndueKubik)}</td>
                    <td class="percentage-cell">${formatPercent(grandTotal.PercentNominal)}</td>
                    <td class="undue-cell">${formatPercent(grandTotal.UnduePercentNominal)}</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            
            reportArea.innerHTML = summaryHTML + tableHTML;
        }

        // --- FUNGSI 2: MEMUAT DETAIL TRANSAKSIONAL ---
        async function fetchCollectionDetails(query = '') {
            detailsArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Detail Transaksi...</p>';
            
            try {
                const response = await fetch('{{ url_for("collection_detail_api") }}' + `?q=${query}`);
                const data = await response.json();
                
                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (data.length === 0) {
                    detailsArea.innerHTML = '<p class="no-results">Tidak ada data koleksi yang ditemukan dengan filter tersebut.</p>';
                    return;
                }

                renderDetailTable(data);

            } catch (error) {
                detailsArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data detail dari server.</p>';
                console.error('Detail Error:', error);
            }
        }
        
        function renderDetailTable(data) {
            
            let totalNominal = 0;
            let totalKubik = 0; 
            const uniqueNomen = new Set();
            
            data.forEach(item => {
                const nominal = parseFloat(item.NOMINAL || 0);
                const kubik = parseFloat(item.KUBIKBAYAR || 0); 
                totalNominal += nominal;
                totalKubik += kubik; 
                uniqueNomen.add(item.NOMEN); 
            });

            const uniqueNomenCount = uniqueNomen.size;

            let tableHTML = `
                <h4 style="margin-top: 20px;">Listing Transaksi MB (${data.length} Transaksi)</h4>
                <div class="report-table-wrapper">
                <table class="collection-table">
                    <thead>
                        <tr>
                            <th>NOMEN</th>
                            <th>RAYON</th>
                            <th>BULAN TAGIHAN</th>
                            <th>TGL BAYAR</th>
                            <th>NOMINAL</th>
                            <th>JENIS TAGIHAN</th>
                            <th>STATUS UNDUE</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                const nominal = parseFloat(item.NOMINAL || 0);
                const statusText = item.IS_UNDUE ? 'Undue (Bulan Ini)' : 'Normal';
                const statusClass = item.IS_UNDUE ? 'undue-cell' : '';

                tableHTML += `
                    <tr>
                        <td data-label="NOMEN">${item.NOMEN}</td>
                        <td data-label="RAYON">${item.RAYON}</td>
                        <td data-label="BULAN TAGIHAN">${item.BULAN_REK || 'N/A'}</td>
                        <td data-label="TGL BAYAR">${item.PAY_DT || '-'}</td>
                        <td data-label="NOMINAL">Rp ${nominal.toLocaleString('id-ID')}</td>
                        <td data-label="JENIS TAGIHAN">${item.BILL_REASON || 'N/A'}</td>
                        <td data-label="STATUS UNDUE" class="${statusClass}">${statusText}</td>
                    </tr>
                `;
            });
            
            // Baris Ringkasan Total
            tableHTML += `
                <tr class="total-row">
                    <td colspan="4" style="text-align: left;">Total NOMINAL Terfilter</td>
                    <td>Rp ${totalNominal.toLocaleString('id-ID')}</td>
                    <td colspan="2">-</td>
                </tr>
                <tr class="total-row">
                    <td colspan="4" style="text-align: left;">Total NOMEN Unik (Count)</td>
                    <td colspan="3">${uniqueNomenCount.toLocaleString('id-ID')}</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            
            detailsArea.innerHTML = tableHTML;
        }

        // --- FUNGSI 3: FUNGSI UNTUK RENDER LAPORAN AB SUNTER (Grouping MC Kustom) ---
        async function fetchCustomReport() {
            customReportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Menghubungkan ke MongoDB untuk Laporan AB Sunter...</p>';
            
            try {
                const response = await fetch('{{ url_for("analyze_mc_grouping_api") }}'); 
                const data = await response.json();
                
                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (data.status !== 'success') {
                     customReportArea.innerHTML = `<p class="no-results" style="color: red;">❌ Gagal memuat report: ${data.message || 'Tidak ada data kustom ditemukan.'}</p>`;
                     return;
                }
                
                renderCustomReportTable(data);

            } catch (error) {
                customReportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data report kustom dari server.</p>';
                console.error('Custom Report Error:', error);
            }
        }
        
        // Fungsi rendering yang dirombak total menjadi format tabel yang dinamis dan bersih
        function renderCustomReportTable(data) {
            const customArea = document.getElementById('customReportArea');
            if (data.status !== 'success') {
                 customArea.innerHTML = `<p class="no-results" style="color: red;">❌ ${data.message || 'Gagal memuat laporan kustom.'}</p>`;
                 return;
            }

            const totals = data.totals;
            const breakdowns = data.breakdowns;
            
            
            // -------------------------------------------------------------------------
            // 1. RENDER RINGKASAN TOTAL
            // -------------------------------------------------------------------------
            
            let totalSummaryHTML = `
                <h4 style="color: #dc3545; margin-bottom: 15px;">Ringkasan Nomen, Nominal, dan Kubikasi (Reguler R34/R35)</h4>
                <div class="report-table-wrapper" style="max-width: 800px; margin-left: auto; margin-right: auto;">
                    <table class="report-table" style="min-width: 100%;">
                        <thead>
                            <tr style="background-color: #f8d7da; color: #721c24;">
                                <th style="text-align: left;">AREA</th>
                                <th>Nomen Count</th>
                                <th>Total Nominal</th>
                                <th>Total Kubik (m³)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align: left; font-weight: bold;">AB SUNTER (Total R34 + R35)</td>
                                <td>${formatNumber(totals.TOTAL_34_35.CountOfNOMEN)}</td>
                                <td>${formatRupiah(totals.TOTAL_34_35.SumOfNOMINAL)}</td>
                                <td>${formatNumber(totals.TOTAL_34_35.SumOfKUBIK)}</td>
                            </tr>
                            <tr>
                                <td style="text-align: left; font-weight: 600;">Rayon 34</td>
                                <td>${formatNumber(totals[34].CountOfNOMEN)}</td>
                                <td>${formatRupiah(totals[34].SumOfNOMINAL)}</td>
                                <td>${formatNumber(totals[34].SumOfKUBIK)}</td>
                            </tr>
                            <tr>
                                <td style="text-align: left; font-weight: 600;">Rayon 35</td>
                                <td>${formatNumber(totals[35].CountOfNOMEN)}</td>
                                <td>${formatRupiah(totals[35].SumOfNOMINAL)}</td>
                                <td>${formatNumber(totals[35].SumOfKUBIK)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h4 style="color: var(--primary-color); margin-top: 30px;">Detail Breakdown Per Dimensi</h4>
            `;

            // Helper function to create a single breakdown table (for one area: Total, R34, or R35)
            function createSingleBreakdownTable(title, dataArray, dimensionKey) {
                let tableHTML = `
                    <div class="breakdown-table-container">
                        <h5 style="margin-top: 0; color: #17a2b8;">${title}</h5>
                        <div class="report-table-wrapper" style="margin-top: 10px;">
                            <table class="report-table" style="min-width: 100%;">
                                <thead>
                                    <tr style="background-color: #f0f8ff;">
                                        <th style="text-align: left; width: 40%;">${dimensionKey.replace(/_/g, ' ').toUpperCase()}</th>
                                        <th>Nomen Count</th>
                                        <th>Nominal</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                dataArray.forEach(item => {
                    const dimValue = item[dimensionKey] || 'N/A';
                    const nomenCount = formatNumber(item.CountOfNOMEN);
                    const nominal = formatRupiah(item.SumOfNOMINAL);
                    
                    tableHTML += `
                        <tr>
                            <td style="text-align: left;" data-label="${dimensionKey.toUpperCase()}">${dimValue}</td>
                            <td data-label="Nomen Count">${nomenCount}</td>
                            <td data-label="Nominal">${nominal}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return tableHTML;
            }

            // Function to render the entire group of 3 tables for a dimension
            function renderDimensionGroup(dimensionName, dimensionKey, breakdownData) {
                let groupHTML = `
                    <h5 style="color: #007bff; margin-top: 25px; border-bottom: 1px dashed #ddd; padding-bottom: 5px;">Breakdown Berdasarkan: ${dimensionName}</h5>
                    <div class="breakdown-group">
                        ${createSingleBreakdownTable(`AB SUNTER (Total)`, breakdownData.TOTAL_34_35, dimensionKey)}
                        ${createSingleBreakdownTable(`Rayon 34`, breakdownData[34], dimensionKey)}
                        ${createSingleBreakdownTable(`Rayon 35`, breakdownData[35], dimensionKey)}
                    </div>
                `;
                return groupHTML;
            }

            // Gabungkan semua output
            let breakdownHTML = '';
            breakdownHTML += renderDimensionGroup('Jenis TARIF', 'TARIF', breakdowns.TARIF);
            breakdownHTML += renderDimensionGroup('Merek Meter', 'MERK', breakdowns.MERK);
            breakdownHTML += renderDimensionGroup('Metode Baca', 'READ_METHOD', breakdowns.READ_METHOD);

            customReportArea.innerHTML = totalSummaryHTML + breakdownHTML;
        }

        // --- FUNGSI 4: MEMUAT LAPORAN VOLUME DASAR (HISTORIS MC) ---
        async function fetchBasicVolumeReport() {
            basicVolumeReportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Volume Dasar...</p>';
            
            try {
                const response = await fetch('{{ url_for("basic_volume_report_api") }}'); 
                const data = await response.json();
                
                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }

                if (response.status !== 200 || data.status !== 'success' || data.basic_volume_report.length === 0) {
                     basicVolumeReportArea.innerHTML = `<p class="no-results" style="color: #dc3545;">❌ Gagal memuat laporan atau tidak ada data historis yang valid.</p>`;
                     return;
                }
                
                renderBasicVolumeReport(data.basic_volume_report);

            } catch (error) {
                basicVolumeReportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data volume dasar dari server.</p>';
                console.error('Basic Volume Error:', error);
            }
        }
        
        function renderBasicVolumeReport(data) {
            const dataArea = document.getElementById('basicVolumeReportArea');
            if (data.length === 0) {
                dataArea.innerHTML = `<p class="no-results">Tidak ada data volume historis ditemukan.</p>`;
                return;
            }

            // Gunakan kunci dari baris pertama (termasuk kolom bulan yang di-pivot)
            const headers = Object.keys(data[0]);
            
            let tableHTML = `
                <div class="report-table-wrapper">
                <h4 style="margin-top: 10px;">Riwayat Volume Kubik Bulanan per Rayon</h4>
                <table class="report-table">
                    <thead><tr>
                        ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ').toUpperCase()}</th>`).join('')}
                    </tr></thead><tbody>
            `;
            
            data.forEach(item => {
                const isTotalRow = item.RAYON === 'TOTAL';
                const rowClass = isTotalRow ? 'grand-total-row' : '';
                
                tableHTML += `<tr class="${rowClass}">`;
                headers.forEach(h => {
                    let cellValue = item[h];
                    let alignment = 'right';
                    
                    if (h === 'RAYON') {
                        alignment = 'left';
                    } else {
                        // Format angka besar
                        cellValue = formatNumber(cellValue); 
                    }
                    
                    tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${alignment};">${cellValue}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table></div>';
            dataArea.innerHTML = tableHTML;
        }


        // --- FUNGSI 5: MEMUAT MONITORING KOLEKSI HARIAN ---
        async function fetchCollectionMonitoring() {
            monitoringSummaryArea.innerHTML = '<p class="no-results" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Memuat data monitoring...</p>';
            monitoringTableArea.innerHTML = '';
            
            try {
                const response = await fetch('{{ url_for("collection_monitoring_api") }}');
                const result = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (response.status !== 200) {
                     monitoringSummaryArea.innerHTML = `<p class="no-results" style="color: red; grid-column: 1 / -1;">❌ Gagal memuat monitoring: ${result.message || 'Error Server'}</p>`;
                     return;
                }
                
                renderMonitoringTable(result.monitoring_data, result.summary_top);

            } catch (error) {
                monitoringSummaryArea.innerHTML = '<p class="no-results" style="color: red; grid-column: 1 / -1;">Gagal mengambil data monitoring dari server.</p>';
                console.error('Monitoring Error:', error);
            }
        }
        
        function renderMonitoringTable(data, summary) {
            
            // Helper untuk merender tabel detail per Rayon
            const renderDetailRayonTable = (title, list) => {
                if (list.length === 0) return '';
                
                let tableHTML = `
                    <h4 style="margin-top: 20px; color: #007bff;">${title}</h4>
                    <div class="report-table-wrapper">
                    <table class="report-table" style="min-width: 800px;">
                        <thead>
                            <tr>
                                <th>TGL</th>
                                <th>CUST</th>
                                <th>Rp1</th>
                                <th>Rp1 Kumulatif</th>
                                <th>CUST Kumulatif</th>
                                <th>COLL Kumulatif %</th>
                                <th>COLL VAR</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                list.forEach(item => {
                    const rp1 = item.COLL_NOMINAL;
                    const rp1_kumulatif = item.Rp1_Kumulatif;
                    const cust_kumulatif = item.CUST_Kumulatif;
                    const persen = item.COLL_Kumulatif_Persen;
                    const coll_var = item.COLL_VAR;
                    
                    tableHTML += `
                        <tr>
                            <td data-label="TGL" style="text-align: left;">${item.TGL}</td>
                            <td data-label="CUST">${formatNumber(item.CUST_COUNT)}</td>
                            <td data-label="Rp1">${formatRupiah(rp1)}</td>
                            <td data-label="Rp1 Kumulatif">${formatRupiah(rp1_kumulatif)}</td>
                            <td data-label="CUST Kumulatif">${formatNumber(cust_kumulatif)}</td>
                            <td data-label="COLL %" class="percentage-cell">${formatPercent(persen)}</td>
                            <td data-label="COLL VAR">${formatPercent(coll_var)}</td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table></div>';
                return tableHTML;
            }

            // Render Summary Top
            monitoringSummaryArea.innerHTML = `
                <div class="summary-card" style="border-left-color: #007bff;">
                    <h4>R34 Total Piutang (MC)</h4>
                    <p>${formatRupiah(summary.R34.MC1125)}</p>
                </div>
                <div class="summary-card" style="border-left-color: #ffc107;">
                    <h4>R34 Koleksi Hari Ini (%)</h4>
                    <p>${data.R34.length > 0 ? formatPercent(data.R34[data.R34.length - 1].COLL_Kumulatif_Persen) : '0.00%'}</p>
                </div>
                <div class="summary-card" style="border-left-color: #007bff;">
                    <h4>R35 Total Piutang (MC)</h4>
                    <p>${formatRupiah(summary.R35.MC1125)}</p>
                </div>
                <div class="summary-card" style="border-left-color: #ffc107;">
                    <h4>R35 Koleksi Hari Ini (%)</h4>
                    <p>${data.R35.length > 0 ? formatPercent(data.R35[data.R35.length - 1].COLL_Kumulatif_Persen) : '0.00%'}</p>
                </div>
            `;
            
            // Render Detail Tables
            let detailHTML = '';
            detailHTML += renderDetailRayonTable("Detail Monitoring Koleksi - Rayon 34", data.R34);
            detailHTML += renderDetailRayonTable("Detail Monitoring Koleksi - Rayon 35", data.R35);
            
            monitoringTableArea.innerHTML = detailHTML;
        }


        // --- FUNGSI 6: MEMUAT DAFTAR TOP 500 DAN STATUS BAYAR ---
        async function fetchTopLists() {
            topListsArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat daftar top 500 dan status konsumen...</p>';
            
            try {
                const response = await fetch('{{ url_for("report_top_lists_api") }}'); 
                const data = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (response.status !== 200 || data.status !== 'success') {
                     topListsArea.innerHTML = `<p class="no-results" style="color: red;">❌ Gagal memuat daftar: ${data.message || 'Error Server'}</p>`;
                     return;
                }
                
                renderTopLists(data);

            } catch (error) {
                topListsArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data top list dari server.</p>';
                console.error('Top Lists Error:', error);
            }
        }
        
        // Fungsi untuk me-render tabel (Sama seperti yang di Aging Report)
        function renderTopLists(data) {
             let html = '';
             
             // Helper function to render a list table
             const renderListTable = (title, list) => {
                 if (!list || list.length === 0) {
                     return `<h4 style="margin-top: 20px; color: #2c3e50;">${title}</h4><p class="no-results" style="color: #6c757d;">Tidak ada data ditemukan.</p>`;
                 }
                 
                 const headers = Object.keys(list[0]);
                 let tableHTML = `
                     <h4 style="margin-top: 20px; color: #2c3e50; border-bottom: 1px dotted #ccc; padding-bottom: 5px;">${title} (${list.length} Data)</h4>
                     <div class="report-table-wrapper">
                     <table class="report-table">
                         <thead><tr>
                             ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ')}</th>`).join('')}
                         </tr></thead><tbody>
                 `;
                 
                 list.forEach(item => {
                     tableHTML += '<tr>';
                     headers.forEach(h => {
                         let cellValue = item[h];
                         
                         let align = 'right';
                         if (h.includes('NOMEN') || h.includes('NAMA') || h.includes('RAYON')) {
                             align = 'left';
                         }
                         
                         if (h.includes('NOMINAL') || h.includes('KEWAJIBAN') || h.includes('ARDEBT')) {
                             cellValue = formatRupiah(cellValue);
                         } else if (h.includes('KUBIK')) {
                             cellValue = formatNumber(cellValue) + ' m³';
                         } else if (h.includes('STATUS')) {
                             align = 'center';
                         }
                         tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${align};">${cellValue}</td>`;
                     });
                     tableHTML += '</tr>';
                 });
                 
                 tableHTML += '</tbody></table></div>';
                 return tableHTML;
             }
             
             // 1. TOP 500 BELUM BAYAR (DEBT)
             html += renderListTable("TOP 500 Konsumen Belum Bayar (Piutang & Tunggakan Total)", data.top_debt);

             // 2. TOP 500 PREMIUM (HIGH VOLUME)
             html += renderListTable("TOP 500 Konsumen Premium (Berdasarkan Volume MC Tertinggi)", data.top_premium);
             
             // 3. KONSUMEN BELUM BAYAR (MC STATUS UNPAID)
             html += renderListTable("Daftar Konsumen Belum Bayar (Snapshot MC Terbaru)", data.unpaid_list);

             // 4. KONSUMEN SUDAH BAYAR (MC STATUS PAID)
             html += renderListTable("Daftar Konsumen Sudah Bayar (Snapshot MC Terbaru)", data.paid_list);

             topListsArea.innerHTML = html;
        }


        // Export button handler
        exportReportBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = '{{ url_for("export_collection_report") }}'; 
        });

        // Event Listeners
        searchBtn.addEventListener('click', () => {
            fetchCollectionDetails(filterInput.value.trim());
        });
        
        filterInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBtn.click();
            }
        });
        
        // --- FUNGSI AGING REPORT, BREAKDOWN TARIF, DLL. (Lanjutan) ---
        
        // --- FUNGSI BARU: MEMUAT AGING REPORT ---
        async function fetchAgingReport() {
            agingReportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Umur Piutang...</p>';
            
            try {
                const response = await fetch('{{ url_for("aging_report_api") }}'); 
                const result = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (result.status !== 'success' || result.data.length === 0) {
                     agingReportArea.innerHTML = `<p class="no-results" style="color: #dc3545;">❌ ${result.message || 'Tidak ada data piutang lama ditemukan.'}</p>`;
                     return;
                }
                
                renderAgingReport(result.data);

            } catch (error) {
                agingReportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data aging report dari server.</p>';
                console.error('Aging Report Error:', error);
            }
        }
        
        function renderAgingReport(data) {
             const headers = Object.keys(data[0]);
             let tableHTML = `
                 <h4 style="margin-top: 20px;">Daftar Pelanggan dengan Piutang > 1 Bulan (${data.length} Data)</h4>
                 <div class="report-table-wrapper">
                 <table class="report-table">
                     <thead><tr>
                         ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ')}</th>`).join('')}
                     </tr></thead><tbody>
             `;
             
             data.forEach(item => {
                 tableHTML += '<tr>';
                 headers.forEach(h => {
                     let cellValue = item[h];
                     let align = 'right';
                     
                     if (h.includes('NOMEN') || h.includes('NAMA') || h.includes('RAYON')) {
                         align = 'left';
                     }
                     
                     if (h.includes('PiutangLama')) {
                         cellValue = formatRupiah(cellValue);
                     } else if (h.includes('Bulan_Tagihan')) {
                         align = 'center';
                     }
                     tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${align};">${cellValue}</td>`;
                 });
                 tableHTML += '</tr>';
             });
             
             tableHTML += '</tbody></table></div>';
             agingReportArea.innerHTML = tableHTML;
        }


        // --- FUNGSI BARU: RENDER PIE CHART TARIF ---
        function renderTariffBreakdownChart(data) {
            const chartData = {};
            
            if (tariffChartInstance) {
                tariffChartInstance.destroy();
            }

            // Agregat berdasarkan TARIF di semua Rayon 34/35
            data.forEach(item => {
                const tarif = item.TARIF || 'N/A';
                const count = item.JumlahPelanggan;
                chartData[tarif] = (chartData[tarif] || 0) + count;
            });

            const labels = Object.keys(chartData);
            const counts = Object.values(chartData);
            
            // Hasilkan warna berbeda secara dinamis
            const backgroundColors = labels.map((_, index) => {
                // Skema warna yang lebih menarik
                const colors = [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', 
                    '#6c757d', '#343a40', '#6f42c1', '#fd7e14'
                ];
                return colors[index % colors.length];
            });

            tariffChartInstance = new Chart(document.getElementById('tarifBreakdownChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors,
                        hoverOffset: 10,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Pelanggan Berdasarkan Tarif (Count Nomen)'
                        }
                    }
                }
            });
        }
        // --- END FUNGSI BARU: RENDER PIE CHART TARIF ---


        // --- FUNGSI BARU: MEMUAT BREAKDOWN TARIF (MEMANGGIL CHART) ---
        async function fetchTarifBreakdown() {
            tarifBreakdownArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Breakdown Tarif...</p>';
            
            try {
                // Panggil API baru untuk breakdown tarif
                const response = await fetch('{{ url_for("analyze_mc_tarif_breakdown_api") }}'); 
                const data = await response.json();
                
                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (response.status !== 200 || data.length === 0) {
                     tarifBreakdownArea.innerHTML = `<p class="no-results" style="color: #6c757d;">Tidak ada data pelanggan yang cocok dengan kriteria kustom (Rayon 34/35 Reguler).</p>`;
                     const existingChart = Chart.getChart("tarifBreakdownChart");
                     if (existingChart) { existingChart.destroy(); }
                     return;
                }
                
                renderTarifBreakdownTable(data);
                renderTariffBreakdownChart(data); // <-- Panggil fungsi render chart

            } catch (error) {
                tarifBreakdownArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data breakdown tarif dari server.</p>';
                console.error('Tarif Breakdown Error:', error);
            }
        }
        
        function renderTarifBreakdownTable(data) {
            let totalPelanggan = data.reduce((sum, item) => sum + item.JumlahPelanggan, 0);

            // Perbesar lebar untuk kolom Rayon
            let tableHTML = `
                <div class="report-table-wrapper" style="max-width: 600px; margin-left: 0;"> 
                <h4 style="margin-top: 10px;">Detail Distribusi Tarif per Rayon (Count)</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">RAYON</th>
                            <th style="text-align: left;">TARIF</th>
                            <th>JML Pelanggan</th>
                            <th>Persentase (%)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                const percentage = (item.JumlahPelanggan / totalPelanggan) * 100;
                tableHTML += `
                    <tr>
                        <td data-label="RAYON" style="text-align: left;">${item.RAYON}</td>
                        <td data-label="TARIF" style="text-align: left;">${item.TARIF}</td>
                        <td data-label="JML Pelanggan">${formatNumber(item.JumlahPelanggan)}</td>
                        <td data-label="Persentase">${formatPercent(percentage)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                <tr class="grand-total-row">
                    <td style="text-align: left;">TOTAL</td>
                    <td>-</td> 
                    <td>${formatNumber(totalPelanggan)}</td>
                    <td>100.00%</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            tarifBreakdownArea.innerHTML = tableHTML;
        }

        // --- FUNGSI 1: MEMUAT REPORT RINGKAS ---
        async function fetchCollectionReport() {
            if (reportArea.querySelector('.report-grid') && 
                reportArea.querySelector('.report-grid').children.length > 0 && 
                !reportArea.querySelector('.report-grid').querySelector('.no-results')) {
                return; 
            }
            reportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Ringkas...</p>';

            try {
                const response = await fetch('{{ url_for("collection_report_api") }}');
                const result = await response.json();
                
                const customSummaryResponse = await fetch('{{ url_for("analyze_mc_grouping_summary_api") }}');
                const customSummaryResult = await customSummaryResponse.json();

                if (response.status !== 200) {
                     reportArea.innerHTML = `<p class="no-results" style="color: red;">❌ Gagal memuat report: ${result.message || 'Error Server'}</p>`;
                     return;
                }
                
                result.grand_total.TotalPiutangKustomNominal = customSummaryResult.TotalPiutangKustomNominal || 0;
                result.grand_total.TotalPiutangKustomKubik = customSummaryResult.TotalPiutangKustomKubik || 0;
                result.grand_total.TotalNomenKustom = customSummaryResult.TotalNomenKustom || 0;

                renderReport(result.report_data, result.grand_total);

            } catch (error) {
                reportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data report dari server.</p>';
                console.error('Report Error:', error);
            }
        }
        
        function renderReport(data, grandTotal) {
            let summaryHTML = `
                <div class="report-header">
                    <h3 style="color: var(--primary-color); border-top: none;">Ringkasan Total Aplikasi (MC, MB, CID)</h3>
                </div>
                <div class="report-grid">
                    <div class="summary-card" style="border-left-color: #007bff;">
                        <h4>Total Pelanggan (CID)</h4>
                        <p>${grandTotal.TotalPelanggan.toLocaleString('id-ID')}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: var(--primary-color);">
                        <h4>Total Pelanggan MC (Count Nomen)</h4>
                        <p>${formatNumber(grandTotal.MC_TotalNomen)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #ffc107;">
                        <h4>Total Piutang MC (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MC_TotalNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Total Piutang MC (Kubik)</h4>
                        <p>${formatNumber(grandTotal.MC_TotalKubik)} m³</p>
                    </div>
                    
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Piutang Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatRupiah(grandTotal.TotalPiutangKustomNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Kubik Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatNumber(grandTotal.TotalPiutangKustomKubik)} m³</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Nomen Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatNumber(grandTotal.TotalNomenKustom)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #28a745;">
                        <h4>Total Koleksi MC (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MC_CollectedNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #17a2b8;">
                        <h4>MB "Undue" Koleksi (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MB_UndueNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #0056b3;">
                        <h4>MB "Undue" (Nominal %)</h4>
                        <p>${formatPercent(grandTotal.UnduePercentNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #6c757d;">
                        <h4>MC Koleksi (Nominal %)</h4>
                        <p>${formatPercent(grandTotal.PercentNominal)}</p>
                    </div>
                </div>
            `;
            
            let tableHTML = `
                <h3 style="margin-top: 30px; color: var(--primary-color);">Detail Perbandingan MC (Piutang) vs MB (Koleksi Undue) per Rayon / PCEZ</h3>
                <div class="report-table-wrapper">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th rowspan="2">RAYON</th>
                            <th rowspan="2">PCEZ</th>
                            <th colspan="2" style="background-color: #ffeeba;">MC (PIUTANG)</th>
                            <th colspan="2" style="background-color: #d4edda;">MC (KOLEKSI)</th>
                            <th colspan="2" style="background-color: #d1ecf1;">MB ("UNDUE")</th>
                            <th colspan="2" rowspan="2">PERSENTASE (%)</th>
                        </tr>
                        <tr>
                            <th style="background-color: #ffeeba;">NOMINAL</th>
                            <th style="background-color: #ffeeba;">KUBIK (m³)</th>
                            <th style="background-color: #d4edda;">NOMINAL</th>
                            <th style="background-color: #d4edda;">KUBIK (m³)</th>
                            <th style="background-color: #d1ecf1;">NOMINAL</th>
                            <th style="background-color: #d1ecf1;">KUBIK (m³)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                tableHTML += `
                    <tr>
                        <td data-label="Rayon">${item.RAYON}</td>
                        <td data-label="PCEZ">${item.PCEZ}</td>
                        <td data-label="MC Piutang Nom">${formatRupiah(item.MC_TotalNominal)}</td>
                        <td data-label="MC Piutang Kubik">${formatNumber(item.MC_TotalKubik)}</td>
                        <td data-label="MC Koleksi Nom">${formatRupiah(item.MC_CollectedNominal)}</td>
                        <td data-label="MC Koleksi Kubik">${formatNumber(item.MC_CollectedKubik)}</td>
                        <td data-label="MB Undue Nom" class="undue-cell">${formatRupiah(item.MB_UndueNominal)}</td>
                        <td data-label="MB Undue Kubik" class="undue-cell">${formatNumber(item.MB_UndueKubik)}</td>
                        <td data-label="% Nom" class="percentage-cell">${formatPercent(item.PercentNominal)}</td>
                        <td data-label="% Undue" class="undue-cell">${formatPercent(item.UnduePercentNominal)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                <tr class="grand-total-row">
                    <td>GRAND TOTAL</td>
                    <td>-</td>
                    <td>${formatRupiah(grandTotal.MC_TotalNominal)}</td>
                    <td>${formatNumber(grandTotal.MC_TotalKubik)}</td>
                    <td>${formatRupiah(grandTotal.MC_CollectedNominal)}</td>
                    <td>${formatNumber(grandTotal.MC_CollectedKubik)}</td>
                    <td>${formatRupiah(grandTotal.MB_UndueNominal)}</td>
                    <td>${formatNumber(grandTotal.MB_UndueKubik)}</td>
                    <td class="percentage-cell">${formatPercent(grandTotal.PercentNominal)}</td>
                    <td class="undue-cell">${formatPercent(grandTotal.UnduePercentNominal)}</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            
            reportArea.innerHTML = summaryHTML + tableHTML;
        }

        // --- FUNGSI 6: MEMUAT DAFTAR TOP 500 DAN STATUS BAYAR ---
        async function fetchTopLists() {
            topListsArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat daftar top 500 dan status konsumen...</p>';
            
            try {
                const response = await fetch('{{ url_for("report_top_lists_api") }}'); 
                const data = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (response.status !== 200 || data.status !== 'success') {
                     topListsArea.innerHTML = `<p class="no-results" style="color: red;">❌ Gagal memuat daftar: ${data.message || 'Error Server'}</p>`;
                     return;
                }
                
                renderTopLists(data);

            } catch (error) {
                topListsArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data top list dari server.</p>';
                console.error('Top Lists Error:', error);
            }
        }
        
        // Fungsi untuk me-render tabel (Sama seperti yang di Aging Report)
        function renderTopLists(data) {
             let html = '';
             
             // Helper function to render a list table
             const renderListTable = (title, list) => {
                 if (!list || list.length === 0) {
                     return `<h4 style="margin-top: 20px; color: #2c3e50;">${title}</h4><p class="no-results" style="color: #6c757d;">Tidak ada data ditemukan.</p>`;
                 }
                 
                 const headers = Object.keys(list[0]);
                 let tableHTML = `
                     <h4 style="margin-top: 20px; color: #2c3e50; border-bottom: 1px dotted #ccc; padding-bottom: 5px;">${title} (${list.length} Data)</h4>
                     <div class="report-table-wrapper">
                     <table class="report-table">
                         <thead><tr>
                             ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ')}</th>`).join('')}
                         </tr></thead><tbody>
                 `;
                 
                 list.forEach(item => {
                     tableHTML += '<tr>';
                     headers.forEach(h => {
                         let cellValue = item[h];
                         
                         let align = 'right';
                         if (h.includes('NOMEN') || h.includes('NAMA') || h.includes('RAYON')) {
                             align = 'left';
                         }
                         
                         if (h.includes('NOMINAL') || h.includes('KEWAJIBAN') || h.includes('ARDEBT')) {
                             cellValue = formatRupiah(cellValue);
                         } else if (h.includes('KUBIK')) {
                             cellValue = formatNumber(cellValue) + ' m³';
                         } else if (h.includes('STATUS')) {
                             align = 'center';
                         }
                         tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${align};">${cellValue}</td>`;
                     });
                     tableHTML += '</tr>';
                 });
                 
                 tableHTML += '</tbody></table></div>';
                 return tableHTML;
             }
             
             // 1. TOP 500 BELUM BAYAR (DEBT)
             html += renderListTable("TOP 500 Konsumen Belum Bayar (Piutang & Tunggakan Total)", data.top_debt);

             // 2. TOP 500 PREMIUM (HIGH VOLUME)
             html += renderListTable("TOP 500 Konsumen Premium (Berdasarkan Volume MC Tertinggi)", data.top_premium);
             
             // 3. KONSUMEN BELUM BAYAR (MC STATUS UNPAID)
             html += renderListTable("Daftar Konsumen Belum Bayar (Snapshot MC Terbaru)", data.unpaid_list);

             // 4. KONSUMEN SUDAH BAYAR (MC STATUS PAID)
             html += renderListTable("Daftar Konsumen Sudah Bayar (Snapshot MC Terbaru)", data.paid_list);

             topListsArea.innerHTML = html;
        }


        // Export button handler
        exportReportBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = '{{ url_for("export_collection_report") }}'; 
        });

        // Event Listeners
        searchBtn.addEventListener('click', () => {
            fetchCollectionDetails(filterInput.value.trim());
        });
        
        filterInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBtn.click();
            }
        });
        
        // --- FUNGSI AGING REPORT, BREAKDOWN TARIF, DLL. (Lanjutan) ---
        
        // --- FUNGSI BARU: MEMUAT AGING REPORT ---
        async function fetchAgingReport() {
            agingReportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Umur Piutang...</p>';
            
            try {
                const response = await fetch('{{ url_for("aging_report_api") }}'); 
                const result = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (result.status !== 'success' || result.data.length === 0) {
                     agingReportArea.innerHTML = `<p class="no-results" style="color: #dc3545;">❌ ${result.message || 'Tidak ada data piutang lama ditemukan.'}</p>`;
                     return;
                }
                
                renderAgingReport(result.data);

            } catch (error) {
                agingReportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data aging report dari server.</p>';
                console.error('Aging Report Error:', error);
            }
        }
        
        function renderAgingReport(data) {
             const headers = Object.keys(data[0]);
             let tableHTML = `
                 <h4 style="margin-top: 20px;">Daftar Pelanggan dengan Piutang > 1 Bulan (${data.length} Data)</h4>
                 <div class="report-table-wrapper">
                 <table class="report-table">
                     <thead><tr>
                         ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ')}</th>`).join('')}
                     </tr></thead><tbody>
             `;
             
             data.forEach(item => {
                 tableHTML += '<tr>';
                 headers.forEach(h => {
                     let cellValue = item[h];
                     let align = 'right';
                     
                     if (h.includes('NOMEN') || h.includes('NAMA') || h.includes('RAYON')) {
                         align = 'left';
                     }
                     
                     if (h.includes('PiutangLama')) {
                         cellValue = formatRupiah(cellValue);
                     } else if (h.includes('Bulan_Tagihan')) {
                         align = 'center';
                     }
                     tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${align};">${cellValue}</td>`;
                 });
                 tableHTML += '</tr>';
             });
             
             tableHTML += '</tbody></table></div>';
             agingReportArea.innerHTML = tableHTML;
        }


        // --- FUNGSI BARU: RENDER PIE CHART TARIF ---
        function renderTariffBreakdownChart(data) {
            const chartData = {};
            
            if (tariffChartInstance) {
                tariffChartInstance.destroy();
            }

            // Agregat berdasarkan TARIF di semua Rayon 34/35
            data.forEach(item => {
                const tarif = item.TARIF || 'N/A';
                const count = item.JumlahPelanggan;
                chartData[tarif] = (chartData[tarif] || 0) + count;
            });

            const labels = Object.keys(chartData);
            const counts = Object.values(chartData);
            
            // Hasilkan warna berbeda secara dinamis
            const backgroundColors = labels.map((_, index) => {
                // Skema warna yang lebih menarik
                const colors = [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', 
                    '#6c757d', '#343a40', '#6f42c1', '#fd7e14'
                ];
                return colors[index % colors.length];
            });

            tariffChartInstance = new Chart(document.getElementById('tarifBreakdownChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors,
                        hoverOffset: 10,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Pelanggan Berdasarkan Tarif (Count Nomen)'
                        }
                    }
                }
            });
        }
        // --- END FUNGSI BARU: RENDER PIE CHART TARIF ---


        // --- FUNGSI BARU: MEMUAT BREAKDOWN TARIF (MEMANGGIL CHART) ---
        async function fetchTarifBreakdown() {
            tarifBreakdownArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Breakdown Tarif...</p>';
            
            try {
                // Panggil API baru untuk breakdown tarif
                const response = await fetch('{{ url_for("analyze_mc_tarif_breakdown_api") }}'); 
                const data = await response.json();
                
                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (response.status !== 200 || data.length === 0) {
                     tarifBreakdownArea.innerHTML = `<p class="no-results" style="color: #6c757d;">Tidak ada data pelanggan yang cocok dengan kriteria kustom (Rayon 34/35 Reguler).</p>`;
                     const existingChart = Chart.getChart("tarifBreakdownChart");
                     if (existingChart) { existingChart.destroy(); }
                     return;
                }
                
                renderTarifBreakdownTable(data);
                renderTariffBreakdownChart(data); // <-- Panggil fungsi render chart

            } catch (error) {
                tarifBreakdownArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data breakdown tarif dari server.</p>';
                console.error('Tarif Breakdown Error:', error);
            }
        }
        
        function renderTarifBreakdownTable(data) {
            let totalPelanggan = data.reduce((sum, item) => sum + item.JumlahPelanggan, 0);

            // Perbesar lebar untuk kolom Rayon
            let tableHTML = `
                <div class="report-table-wrapper" style="max-width: 600px; margin-left: 0;"> 
                <h4 style="margin-top: 10px;">Detail Distribusi Tarif per Rayon (Count)</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">RAYON</th>
                            <th style="text-align: left;">TARIF</th>
                            <th>JML Pelanggan</th>
                            <th>Persentase (%)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                const percentage = (item.JumlahPelanggan / totalPelanggan) * 100;
                tableHTML += `
                    <tr>
                        <td data-label="RAYON" style="text-align: left;">${item.RAYON}</td>
                        <td data-label="TARIF" style="text-align: left;">${item.TARIF}</td>
                        <td data-label="JML Pelanggan">${formatNumber(item.JumlahPelanggan)}</td>
                        <td data-label="Persentase">${formatPercent(percentage)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                <tr class="grand-total-row">
                    <td style="text-align: left;">TOTAL</td>
                    <td>-</td> 
                    <td>${formatNumber(totalPelanggan)}</td>
                    <td>100.00%</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            tarifBreakdownArea.innerHTML = tableHTML;
        }

        // --- FUNGSI 1: MEMUAT REPORT RINGKAS ---
        async function fetchCollectionReport() {
            if (reportArea.querySelector('.report-grid') && 
                reportArea.querySelector('.report-grid').children.length > 0 && 
                !reportArea.querySelector('.report-grid').querySelector('.no-results')) {
                return; 
            }
            reportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Ringkas...</p>';

            try {
                const response = await fetch('{{ url_for("collection_report_api") }}');
                const result = await response.json();
                
                const customSummaryResponse = await fetch('{{ url_for("analyze_mc_grouping_summary_api") }}');
                const customSummaryResult = await customSummaryResponse.json();

                if (response.status !== 200) {
                     reportArea.innerHTML = `<p class="no-results" style="color: red;">❌ Gagal memuat report: ${result.message || 'Error Server'}</p>`;
                     return;
                }
                
                result.grand_total.TotalPiutangKustomNominal = customSummaryResult.TotalPiutangKustomNominal || 0;
                result.grand_total.TotalPiutangKustomKubik = customSummaryResult.TotalPiutangKustomKubik || 0;
                result.grand_total.TotalNomenKustom = customSummaryResult.TotalNomenKustom || 0;

                renderReport(result.report_data, result.grand_total);

            } catch (error) {
                reportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data report dari server.</p>';
                console.error('Report Error:', error);
            }
        }
        
        function renderReport(data, grandTotal) {
            let summaryHTML = `
                <div class="report-header">
                    <h3 style="color: var(--primary-color); border-top: none;">Ringkasan Total Aplikasi (MC, MB, CID)</h3>
                </div>
                <div class="report-grid">
                    <div class="summary-card" style="border-left-color: #007bff;">
                        <h4>Total Pelanggan (CID)</h4>
                        <p>${grandTotal.TotalPelanggan.toLocaleString('id-ID')}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: var(--primary-color);">
                        <h4>Total Pelanggan MC (Count Nomen)</h4>
                        <p>${formatNumber(grandTotal.MC_TotalNomen)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #ffc107;">
                        <h4>Total Piutang MC (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MC_TotalNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Total Piutang MC (Kubik)</h4>
                        <p>${formatNumber(grandTotal.MC_TotalKubik)} m³</p>
                    </div>
                    
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Piutang Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatRupiah(grandTotal.TotalPiutangKustomNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Kubik Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatNumber(grandTotal.TotalPiutangKustomKubik)} m³</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Nomen Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatNumber(grandTotal.TotalNomenKustom)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #28a745;">
                        <h4>Total Koleksi MC (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MC_CollectedNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #17a2b8;">
                        <h4>MB "Undue" Koleksi (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MB_UndueNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #0056b3;">
                        <h4>MB "Undue" (Nominal %)</h4>
                        <p>${formatPercent(grandTotal.UnduePercentNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #6c757d;">
                        <h4>MC Koleksi (Nominal %)</h4>
                        <p>${formatPercent(grandTotal.PercentNominal)}</p>
                    </div>
                </div>
            `;
            
            let tableHTML = `
                <h3 style="margin-top: 30px; color: var(--primary-color);">Detail Perbandingan MC (Piutang) vs MB (Koleksi Undue) per Rayon / PCEZ</h3>
                <div class="report-table-wrapper">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th rowspan="2">RAYON</th>
                            <th rowspan="2">PCEZ</th>
                            <th colspan="2" style="background-color: #ffeeba;">MC (PIUTANG)</th>
                            <th colspan="2" style="background-color: #d4edda;">MC (KOLEKSI)</th>
                            <th colspan="2" style="background-color: #d1ecf1;">MB ("UNDUE")</th>
                            <th colspan="2" rowspan="2">PERSENTASE (%)</th>
                        </tr>
                        <tr>
                            <th style="background-color: #ffeeba;">NOMINAL</th>
                            <th style="background-color: #ffeeba;">KUBIK (m³)</th>
                            <th style="background-color: #d4edda;">NOMINAL</th>
                            <th style="background-color: #d4edda;">KUBIK (m³)</th>
                            <th style="background-color: #d1ecf1;">NOMINAL</th>
                            <th style="background-color: #d1ecf1;">KUBIK (m³)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                tableHTML += `
                    <tr>
                        <td data-label="Rayon">${item.RAYON}</td>
                        <td data-label="PCEZ">${item.PCEZ}</td>
                        <td data-label="MC Piutang Nom">${formatRupiah(item.MC_TotalNominal)}</td>
                        <td data-label="MC Piutang Kubik">${formatNumber(item.MC_TotalKubik)}</td>
                        <td data-label="MC Koleksi Nom">${formatRupiah(item.MC_CollectedNominal)}</td>
                        <td data-label="MC Koleksi Kubik">${formatNumber(item.MC_CollectedKubik)}</td>
                        <td data-label="MB Undue Nom" class="undue-cell">${formatRupiah(item.MB_UndueNominal)}</td>
                        <td data-label="MB Undue Kubik" class="undue-cell">${formatNumber(item.MB_UndueKubik)}</td>
                        <td data-label="% Nom" class="percentage-cell">${formatPercent(item.PercentNominal)}</td>
                        <td data-label="% Undue" class="undue-cell">${formatPercent(item.UnduePercentNominal)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                <tr class="grand-total-row">
                    <td>GRAND TOTAL</td>
                    <td>-</td>
                    <td>${formatRupiah(grandTotal.MC_TotalNominal)}</td>
                    <td>${formatNumber(grandTotal.MC_TotalKubik)}</td>
                    <td>${formatRupiah(grandTotal.MC_CollectedNominal)}</td>
                    <td>${formatNumber(grandTotal.MC_CollectedKubik)}</td>
                    <td>${formatRupiah(grandTotal.MB_UndueNominal)}</td>
                    <td>${formatNumber(grandTotal.MB_UndueKubik)}</td>
                    <td class="percentage-cell">${formatPercent(grandTotal.PercentNominal)}</td>
                    <td class="undue-cell">${formatPercent(grandTotal.UnduePercentNominal)}</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            
            reportArea.innerHTML = summaryHTML + tableHTML;
        }

        // --- FUNGSI 6: MEMUAT DAFTAR TOP 500 DAN STATUS BAYAR ---
        async function fetchTopLists() {
            topListsArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat daftar top 500 dan status konsumen...</p>';
            
            try {
                const response = await fetch('{{ url_for("report_top_lists_api") }}'); 
                const data = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (response.status !== 200 || data.status !== 'success') {
                     topListsArea.innerHTML = `<p class="no-results" style="color: red;">❌ Gagal memuat daftar: ${data.message || 'Error Server'}</p>`;
                     return;
                }
                
                renderTopLists(data);

            } catch (error) {
                topListsArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data top list dari server.</p>';
                console.error('Top Lists Error:', error);
            }
        }
        
        // Fungsi untuk me-render tabel (Sama seperti yang di Aging Report)
        function renderTopLists(data) {
             let html = '';
             
             // Helper function to render a list table
             const renderListTable = (title, list) => {
                 if (!list || list.length === 0) {
                     return `<h4 style="margin-top: 20px; color: #2c3e50;">${title}</h4><p class="no-results" style="color: #6c757d;">Tidak ada data ditemukan.</p>`;
                 }
                 
                 const headers = Object.keys(list[0]);
                 let tableHTML = `
                     <h4 style="margin-top: 20px; color: #2c3e50; border-bottom: 1px dotted #ccc; padding-bottom: 5px;">${title} (${list.length} Data)</h4>
                     <div class="report-table-wrapper">
                     <table class="report-table">
                         <thead><tr>
                             ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ')}</th>`).join('')}
                         </tr></thead><tbody>
                 `;
                 
                 list.forEach(item => {
                     tableHTML += '<tr>';
                     headers.forEach(h => {
                         let cellValue = item[h];
                         
                         let align = 'right';
                         if (h.includes('NOMEN') || h.includes('NAMA') || h.includes('RAYON')) {
                             align = 'left';
                         }
                         
                         if (h.includes('NOMINAL') || h.includes('KEWAJIBAN') || h.includes('ARDEBT')) {
                             cellValue = formatRupiah(cellValue);
                         } else if (h.includes('KUBIK')) {
                             cellValue = formatNumber(cellValue) + ' m³';
                         } else if (h.includes('STATUS')) {
                             align = 'center';
                         }
                         tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${align};">${cellValue}</td>`;
                     });
                     tableHTML += '</tr>';
                 });
                 
                 tableHTML += '</tbody></table></div>';
                 return tableHTML;
             }
             
             // 1. TOP 500 BELUM BAYAR (DEBT)
             html += renderListTable("TOP 500 Konsumen Belum Bayar (Piutang & Tunggakan Total)", data.top_debt);

             // 2. TOP 500 PREMIUM (HIGH VOLUME)
             html += renderListTable("TOP 500 Konsumen Premium (Berdasarkan Volume MC Tertinggi)", data.top_premium);
             
             // 3. KONSUMEN BELUM BAYAR (MC STATUS UNPAID)
             html += renderListTable("Daftar Konsumen Belum Bayar (Snapshot MC Terbaru)", data.unpaid_list);

             // 4. KONSUMEN SUDAH BAYAR (MC STATUS PAID)
             html += renderListTable("Daftar Konsumen Sudah Bayar (Snapshot MC Terbaru)", data.paid_list);

             topListsArea.innerHTML = html;
        }


        // Export button handler
        exportReportBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = '{{ url_for("export_collection_report") }}'; 
        });

        // Event Listeners
        searchBtn.addEventListener('click', () => {
            fetchCollectionDetails(filterInput.value.trim());
        });
        
        filterInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBtn.click();
            }
        });
        
        // --- FUNGSI AGING REPORT, BREAKDOWN TARIF, DLL. (Lanjutan) ---
        
        // --- FUNGSI BARU: MEMUAT AGING REPORT ---
        async function fetchAgingReport() {
            agingReportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Umur Piutang...</p>';
            
            try {
                const response = await fetch('{{ url_for("aging_report_api") }}'); 
                const result = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (result.status !== 'success' || result.data.length === 0) {
                     agingReportArea.innerHTML = `<p class="no-results" style="color: #dc3545;">❌ ${result.message || 'Tidak ada data piutang lama ditemukan.'}</p>`;
                     return;
                }
                
                renderAgingReport(result.data);

            } catch (error) {
                agingReportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data aging report dari server.</p>';
                console.error('Aging Report Error:', error);
            }
        }
        
        function renderAgingReport(data) {
             const headers = Object.keys(data[0]);
             let tableHTML = `
                 <h4 style="margin-top: 20px;">Daftar Pelanggan dengan Piutang > 1 Bulan (${data.length} Data)</h4>
                 <div class="report-table-wrapper">
                 <table class="report-table">
                     <thead><tr>
                         ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ')}</th>`).join('')}
                     </tr></thead><tbody>
             `;
             
             data.forEach(item => {
                 tableHTML += '<tr>';
                 headers.forEach(h => {
                     let cellValue = item[h];
                     let align = 'right';
                     
                     if (h.includes('NOMEN') || h.includes('NAMA') || h.includes('RAYON')) {
                         align = 'left';
                     }
                     
                     if (h.includes('PiutangLama')) {
                         cellValue = formatRupiah(cellValue);
                     } else if (h.includes('Bulan_Tagihan')) {
                         align = 'center';
                     }
                     tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${align};">${cellValue}</td>`;
                 });
                 tableHTML += '</tr>';
             });
             
             tableHTML += '</tbody></table></div>';
             agingReportArea.innerHTML = tableHTML;
        }


        // --- FUNGSI BARU: RENDER PIE CHART TARIF ---
        function renderTariffBreakdownChart(data) {
            const chartData = {};
            
            if (tariffChartInstance) {
                tariffChartInstance.destroy();
            }

            // Agregat berdasarkan TARIF di semua Rayon 34/35
            data.forEach(item => {
                const tarif = item.TARIF || 'N/A';
                const count = item.JumlahPelanggan;
                chartData[tarif] = (chartData[tarif] || 0) + count;
            });

            const labels = Object.keys(chartData);
            const counts = Object.values(chartData);
            
            // Hasilkan warna berbeda secara dinamis
            const backgroundColors = labels.map((_, index) => {
                // Skema warna yang lebih menarik
                const colors = [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', 
                    '#6c757d', '#343a40', '#6f42c1', '#fd7e14'
                ];
                return colors[index % colors.length];
            });

            tariffChartInstance = new Chart(document.getElementById('tarifBreakdownChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors,
                        hoverOffset: 10,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Pelanggan Berdasarkan Tarif (Count Nomen)'
                        }
                    }
                }
            });
        }
        // --- END FUNGSI BARU: RENDER PIE CHART TARIF ---


        // --- FUNGSI BARU: MEMUAT BREAKDOWN TARIF (MEMANGGIL CHART) ---
        async function fetchTarifBreakdown() {
            tarifBreakdownArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Breakdown Tarif...</p>';
            
            try {
                // Panggil API baru untuk breakdown tarif
                const response = await fetch('{{ url_for("analyze_mc_tarif_breakdown_api") }}'); 
                const data = await response.json();
                
                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (response.status !== 200 || data.length === 0) {
                     tarifBreakdownArea.innerHTML = `<p class="no-results" style="color: #6c757d;">Tidak ada data pelanggan yang cocok dengan kriteria kustom (Rayon 34/35 Reguler).</p>`;
                     const existingChart = Chart.getChart("tarifBreakdownChart");
                     if (existingChart) { existingChart.destroy(); }
                     return;
                }
                
                renderTarifBreakdownTable(data);
                renderTariffBreakdownChart(data); // <-- Panggil fungsi render chart

            } catch (error) {
                tarifBreakdownArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data breakdown tarif dari server.</p>';
                console.error('Tarif Breakdown Error:', error);
            }
        }
        
        function renderTarifBreakdownTable(data) {
            let totalPelanggan = data.reduce((sum, item) => sum + item.JumlahPelanggan, 0);

            // Perbesar lebar untuk kolom Rayon
            let tableHTML = `
                <div class="report-table-wrapper" style="max-width: 600px; margin-left: 0;"> 
                <h4 style="margin-top: 10px;">Detail Distribusi Tarif per Rayon (Count)</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">RAYON</th>
                            <th style="text-align: left;">TARIF</th>
                            <th>JML Pelanggan</th>
                            <th>Persentase (%)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                const percentage = (item.JumlahPelanggan / totalPelanggan) * 100;
                tableHTML += `
                    <tr>
                        <td data-label="RAYON" style="text-align: left;">${item.RAYON}</td>
                        <td data-label="TARIF" style="text-align: left;">${item.TARIF}</td>
                        <td data-label="JML Pelanggan">${formatNumber(item.JumlahPelanggan)}</td>
                        <td data-label="Persentase">${formatPercent(percentage)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                <tr class="grand-total-row">
                    <td style="text-align: left;">TOTAL</td>
                    <td>-</td> 
                    <td>${formatNumber(totalPelanggan)}</td>
                    <td>100.00%</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            tarifBreakdownArea.innerHTML = tableHTML;
        }

        // --- FUNGSI 1: MEMUAT REPORT RINGKAS ---
        async function fetchCollectionReport() {
            if (reportArea.querySelector('.report-grid') && 
                reportArea.querySelector('.report-grid').children.length > 0 && 
                !reportArea.querySelector('.report-grid').querySelector('.no-results')) {
                return; 
            }
            reportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Ringkas...</p>';

            try {
                const response = await fetch('{{ url_for("collection_report_api") }}');
                const result = await response.json();
                
                const customSummaryResponse = await fetch('{{ url_for("analyze_mc_grouping_summary_api") }}');
                const customSummaryResult = await customSummaryResponse.json();

                if (response.status !== 200) {
                     reportArea.innerHTML = `<p class="no-results" style="color: red;">❌ Gagal memuat report: ${result.message || 'Error Server'}</p>`;
                     return;
                }
                
                result.grand_total.TotalPiutangKustomNominal = customSummaryResult.TotalPiutangKustomNominal || 0;
                result.grand_total.TotalPiutangKustomKubik = customSummaryResult.TotalPiutangKustomKubik || 0;
                result.grand_total.TotalNomenKustom = customSummaryResult.TotalNomenKustom || 0;

                renderReport(result.report_data, result.grand_total);

            } catch (error) {
                reportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data report dari server.</p>';
                console.error('Report Error:', error);
            }
        }
        
        function renderReport(data, grandTotal) {
            let summaryHTML = `
                <div class="report-header">
                    <h3 style="color: var(--primary-color); border-top: none;">Ringkasan Total Aplikasi (MC, MB, CID)</h3>
                </div>
                <div class="report-grid">
                    <div class="summary-card" style="border-left-color: #007bff;">
                        <h4>Total Pelanggan (CID)</h4>
                        <p>${grandTotal.TotalPelanggan.toLocaleString('id-ID')}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: var(--primary-color);">
                        <h4>Total Pelanggan MC (Count Nomen)</h4>
                        <p>${formatNumber(grandTotal.MC_TotalNomen)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #ffc107;">
                        <h4>Total Piutang MC (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MC_TotalNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Total Piutang MC (Kubik)</h4>
                        <p>${formatNumber(grandTotal.MC_TotalKubik)} m³</p>
                    </div>
                    
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Piutang Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatRupiah(grandTotal.TotalPiutangKustomNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Kubik Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatNumber(grandTotal.TotalPiutangKustomKubik)} m³</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #dc3545;">
                        <h4>Nomen Kustom (Rayon 34/35 Reg)</h4>
                        <p>${formatNumber(grandTotal.TotalNomenKustom)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #28a745;">
                        <h4>Total Koleksi MC (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MC_CollectedNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #17a2b8;">
                        <h4>MB "Undue" Koleksi (Nominal)</h4>
                        <p>${formatRupiah(grandTotal.MB_UndueNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #0056b3;">
                        <h4>MB "Undue" (Nominal %)</h4>
                        <p>${formatPercent(grandTotal.UnduePercentNominal)}</p>
                    </div>
                    <div class="summary-card" style="border-left-color: #6c757d;">
                        <h4>MC Koleksi (Nominal %)</h4>
                        <p>${formatPercent(grandTotal.PercentNominal)}</p>
                    </div>
                </div>
            `;
            
            let tableHTML = `
                <h3 style="margin-top: 30px; color: var(--primary-color);">Detail Perbandingan MC (Piutang) vs MB (Koleksi Undue) per Rayon / PCEZ</h3>
                <div class="report-table-wrapper">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th rowspan="2">RAYON</th>
                            <th rowspan="2">PCEZ</th>
                            <th colspan="2" style="background-color: #ffeeba;">MC (PIUTANG)</th>
                            <th colspan="2" style="background-color: #d4edda;">MC (KOLEKSI)</th>
                            <th colspan="2" style="background-color: #d1ecf1;">MB ("UNDUE")</th>
                            <th colspan="2" rowspan="2">PERSENTASE (%)</th>
                        </tr>
                        <tr>
                            <th style="background-color: #ffeeba;">NOMINAL</th>
                            <th style="background-color: #ffeeba;">KUBIK (m³)</th>
                            <th style="background-color: #d4edda;">NOMINAL</th>
                            <th style="background-color: #d4edda;">KUBIK (m³)</th>
                            <th style="background-color: #d1ecf1;">NOMINAL</th>
                            <th style="background-color: #d1ecf1;">KUBIK (m³)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                tableHTML += `
                    <tr>
                        <td data-label="Rayon">${item.RAYON}</td>
                        <td data-label="PCEZ">${item.PCEZ}</td>
                        <td data-label="MC Piutang Nom">${formatRupiah(item.MC_TotalNominal)}</td>
                        <td data-label="MC Piutang Kubik">${formatNumber(item.MC_TotalKubik)}</td>
                        <td data-label="MC Koleksi Nom">${formatRupiah(item.MC_CollectedNominal)}</td>
                        <td data-label="MC Koleksi Kubik">${formatNumber(item.MC_CollectedKubik)}</td>
                        <td data-label="MB Undue Nom" class="undue-cell">${formatRupiah(item.MB_UndueNominal)}</td>
                        <td data-label="MB Undue Kubik" class="undue-cell">${formatNumber(item.MB_UndueKubik)}</td>
                        <td data-label="% Nom" class="percentage-cell">${formatPercent(item.PercentNominal)}</td>
                        <td data-label="% Undue" class="undue-cell">${formatPercent(item.UnduePercentNominal)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                <tr class="grand-total-row">
                    <td>GRAND TOTAL</td>
                    <td>-</td>
                    <td>${formatRupiah(grandTotal.MC_TotalNominal)}</td>
                    <td>${formatNumber(grandTotal.MC_TotalKubik)}</td>
                    <td>${formatRupiah(grandTotal.MC_CollectedNominal)}</td>
                    <td>${formatNumber(grandTotal.MC_CollectedKubik)}</td>
                    <td>${formatRupiah(grandTotal.MB_UndueNominal)}</td>
                    <td>${formatNumber(grandTotal.MB_UndueKubik)}</td>
                    <td class="percentage-cell">${formatPercent(grandTotal.PercentNominal)}</td>
                    <td class="undue-cell">${formatPercent(grandTotal.UnduePercentNominal)}</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            
            reportArea.innerHTML = summaryHTML + tableHTML;
        }
        
        // Muat semua bagian saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
             // Default: Tampilkan Tab Ringkasan dan load datanya
             showTabCollection('summary'); 
        });

    </script>
{% endblock %}
