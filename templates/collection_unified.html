{% extends "base.html" %}

{% block title %}Laporan Koleksi & Piutang Terpadu{% endblock %}

{% block custom_styles %}
/* Custom CSS untuk Tampilan Report/Detail yang Responsif */
.report-header { text-align: center; margin-bottom: 20px; }
.report-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Minmax ditingkatkan */
    gap: 20px;
    margin-bottom: 30px;
}
.summary-card { 
    background-color: var(--card-bg); 
    padding: 15px; 
    border-radius: var(--border-radius); 
    box-shadow: var(--shadow-light);
    text-align: center; 
    border: 1px solid #e0e0e0;
    border-left: 5px solid;
    transition: transform 0.2s;
}
.summary-card:hover {
     transform: translateY(-2px);
     box-shadow: var(--shadow-medium);
}
.summary-card h4 { margin: 0 0 5px 0; font-size: 0.9em; color: #6c757d; }
.summary-card p { margin: 0; font-size: 1.6em; font-weight: bold; }

.filter-input-group { 
    margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ddd; 
    display: flex; align-items: stretch; gap: 10px; 
}
#filterInput { 
    padding: 12px; 
    border: 1px solid #ced4da; 
    border-radius: var(--border-radius); 
    font-size: 16px; 
    flex-grow: 1; 
}
.report-table-wrapper { overflow-x: auto; margin-top: 20px; }

/* --- TABLE LAYOUT --- */
.report-table, .collection-table { 
    width: 100%; border-collapse: collapse; font-size: 14px; 
    box-shadow: var(--shadow-light); 
    border-radius: var(--border-radius);
    overflow: hidden; 
}
.report-table th, .report-table td, .collection-table th, .collection-table td { 
    border: 1px solid #f0f0f0; padding: 10px; text-align: right; white-space: nowrap; 
}
.report-table th, .collection-table th { background-color: #e9ecef; text-align: center; font-weight: 600; }
.report-table { min-width: 1000px; }
.undue-cell { font-weight: bold; color: #17a2b8 !important; }

.grand-total-row { font-weight: bold; background-color: #d0e7ff; color: var(--text-color); } 
.percentage-cell { font-weight: bold; color: var(--secondary-color); }

.no-results { text-align: center; color: #555; padding: 20px; }

/* Styling untuk kelompok tabel kustom (AB Sunter) */
.breakdown-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
    gap: 20px;
    margin-top: 15px;
    margin-bottom: 30px;
}
.breakdown-table-container {
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
}

/* --- NEW TAB STYLES --- */
.tab-menu {
    border-bottom: 2px solid #ddd;
    margin-bottom: 20px;
    display: flex;
    overflow-x: auto; 
    white-space: nowrap;
}
.tab-button {
    padding: 10px 20px;
    cursor: pointer;
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-bottom: none;
    border-radius: 5px 5px 0 0;
    font-weight: 600;
    color: #555;
    transition: all 0.3s;
    flex-shrink: 0; 
}
.tab-button.active {
    background-color: white;
    border-color: var(--primary-color);
    border-bottom: 2px solid white; 
    color: var(--primary-color);
}
.tab-content-tab {
    padding: 10px 0;
    border: none;
}
.tab-content-tab h3 {
    margin-top: 30px;
    color: var(--primary-color);
    border-top: 1px solid #e0e0e0;
    padding-top: 20px;
}
.tab-content-tab h3:first-child {
    margin-top: 0;
    border-top: none;
    padding-top: 0;
}
/* ------------------------------------------- */

/* CSS for the new Analysis Menu Grid (Card Style) */
.report-grid-menu {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: 20px;
    margin-top: 20px;
    margin-bottom: 30px; 
}

.report-card-link {
    text-decoration: none;
    color: inherit;
}

.report-card-aggr {
    background-color: var(--card-bg);
    border: 1px solid #e0e0e0; 
    border-radius: var(--border-radius);
    padding: 25px 20px; 
    box-shadow: var(--shadow-light);
    transition: all 0.3s ease;
    text-align: center;
    min-height: 150px; 
    cursor: pointer;
}

.report-card-aggr:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 123, 255, 0.2); 
    border-color: var(--primary-color);
}

.report-card-aggr i {
    font-size: 3em; 
    color: var(--primary-color);
    margin-bottom: 10px;
}

.report-card-aggr h3 {
    margin: 10px 0 5px 0;
    color: var(--text-color);
    font-size: 1.1em;
}

.report-card-aggr p {
    font-size: 0.9em;
    color: #6c757d; 
}


/* -------------------------------------------------------------------------- */
/* --- ROMBAK TOTAL UI: LAYOUT MOBILE (LIST TRANSAKSI) --- */
/* -------------------------------------------------------------------------- */
@media screen and (max-width: 600px) {
    
    .collection-table thead, .report-table thead {
        display: none;
    }

    .collection-table tr:not(.total-row) {
        display: block;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .collection-table td {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        border: none;
        border-bottom: 1px solid #eee;
        position: relative;
        text-align: right; 
    }

    .collection-table td:before {
        content: attr(data-label); 
        font-weight: 600;
        text-align: left;
        width: 50%; 
        color: var(--text-color);
        padding-right: 10px;
    }
    
    .collection-table .total-row td {
        display: table-cell;
        border: 1px solid #ddd;
        text-align: center;
        font-weight: bold;
    }
    .collection-table .total-row {
        margin-top: 20px;
        display: table-row-group;
    }
    
    .report-table {
        min-width: 100%;
    }
}
{% endblock %}

{% block content %}
    <h2 style="text-align: left; border-bottom: none; margin-bottom: 20px; color: var(--primary-color);">
        <i class="fas fa-chart-bar" style="margin-right: 10px;"></i> Laporan Koleksi & Piutang Terpadu
    </h2>
    
    <div class="tab-menu">
        <button class="tab-button active" onclick="showTabCollection('summary')" id="tab-summary">
            <i class="fas fa-list-alt"></i> Ringkasan & Piutang Utama
        </button>
        <button class="tab-button" onclick="showTabCollection('monitoring')" id="tab-monitoring">
            <i class="fas fa-calendar-alt"></i> Monitoring & Detail Koleksi
        </button>
        <button class="tab-button" onclick="showTabCollection('analysis')" id="tab-analysis">
            <i class="fas fa-layer-group"></i> Analisis Agregasi
        </button>
    </div>

    <div id="content-summary" class="tab-content-tab">
        <div id="reportArea">
            <p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Ringkas...</p>
        </div>
    </div>

    <div id="content-monitoring" class="tab-content-tab" style="display: none;">
        
        <h3 style="color: #28a745;">
            <i class="fas fa-arrows-alt-h"></i> Perbandingan Koleksi Bulanan (MoM)
        </h3>
        
        <div id="momReportArea" class="content-section">
            <div id="momSummaryGrid" class="report-grid">
                </div>
            <div id="momChartContainer" style="max-width: 900px; margin: 30px auto;">
                <canvas id="momBarChart"></canvas>
            </div>
            <div id="momTableContainer" class="report-table-wrapper" style="margin-top: 30px;">
                </div>
        </div>
        
        <h3 style="color: #007bff; margin-top: 30px;">
            <i class="fas fa-chart-line"></i> Grafik Koleksi DtD (Hari ke Hari)
        </h3>
        
        <div id="dohComparisonArea" class="content-section">
            <div id="dohChartContainer" style="max-width: 900px; margin: 30px auto;">
                <canvas id="dohLineChart"></canvas>
            </div>
            <div id="dohTableContainer" class="report-table-wrapper" style="margin-top: 30px;">
                <p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat data DtD Comparison...</p>
            </div>
        </div>
        <h3 style="color: #dc3545;">
            <i class="fas fa-calendar-alt"></i> Monitoring Koleksi Harian (Rayon 34 & 35)
        </h3>
        
        <div id="monitoringSummaryArea" class="report-grid">
            <p class="no-results" style="grid-column: 1 / 1;"><i class="fas fa-spinner fa-spin"></i> Memuat ringkasan monitoring...</p>
        </div>

        <div id="monitoringTableArea">
        </div>
        
        <div style="text-align: right; margin-top: 10px; margin-bottom: 20px;">
            <a href="#" id="exportReportBtn" class="btn-primary" style="background-color: #6c757d; text-decoration: none;">
                <i class="fas fa-file-excel"></i> Export Summary
            </a>
        </div>
        
        <h3 style="color: #007bff;">
            <i class="fas fa-list-alt"></i> Listing Transaksi Pembayaran (MB Detail)
        </h3>

        <div class="filter-input-group">
            <input type="text" id="filterInput" placeholder="Filter Detail (Rayon, NOMEN, Bulan_Rek, Jenis_Tagihan)...">
            <button id="searchBtn" class="btn-primary" style="background-color: var(--primary-color); color: white; padding: 12px 18px; border: none; border-radius: 4px;">
                <i class="fas fa-filter"></i> Filter Detail
            </button>
        </div>

        <div id="detailsArea">
            <p class="no-results">Memuat data transaksi...</p>
        </div>
    </div>
    
    <div id="content-analysis" class="tab-content-tab" style="display: none;">
        
        <h3 style="color: #17a2b8;">
            <i class="fas fa-list-ol"></i> Distribusi Pelanggan Berdasarkan TARIF (Rayon 34/35 Reguler)
        </h3>
        
        <div id="tariffChartArea" style="max-width: 450px; margin: 20px auto;">
            <canvas id="tarifBreakdownChart"></canvas>
        </div>
        <div id="tarifBreakdownArea">
            <p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat data breakdown tarif...</p>
        </div>

        <h3 style="color: var(--primary-color);">
            <i class="fas fa-chart-pie"></i> Laporan Agregasi Khusus (Pilih salah satu kartu untuk memuat)
        </h3>
        
        <div class="report-grid-menu">
        
            <a href="javascript:void(0);" onclick="fetchCustomReport();" class="report-card-link">
                <div class="report-card-aggr" style="border-left-color: #dc3545;">
                    <i class="fas fa-layer-group" style="color: #dc3545;"></i>
                    <h3>Grouping MC: AB Sunter</h3>
                    <p>Agregasi Nomen, Kubik, dan Nominal berdasarkan Tarif, Merek, dan Metode Baca untuk R34/R35.</p>
                </div>
            </a>
            
            <a href="javascript:void(0);" onclick="fetchBasicVolumeReport();" class="report-card-link">
                <div class="report-card-aggr" style="border-left-color: var(--secondary-color);">
                    <i class="fas fa-water" style="color: var(--secondary-color);"></i>
                    <h3>Laporan Volume Dasar</h3>
                    <p>Riwayat volume KUBIK bulanan dari seluruh data Master Cetak (MC) secara historis.</p>
                </div>
            </a>
            
            <a href="javascript:void(0);" onclick="fetchTopLists();" class="report-card-link">
                <div class="report-card-aggr" style="border-left-color: var(--primary-color);">
                    <i class="fas fa-medal" style="color: var(--primary-color);"></i>
                    <h3>Daftar Konsumen Top</h3>
                    <p>Top 500 Tunggakan, Top 500 Premium, serta Daftar Lunas dan Belum Bayar (Snapshot Terbaru).</p>
                </div>
            </a>
            
            <a href="javascript:void(0);" onclick="fetchAgingReport();" class="report-card-link">
                <div class="report-card-aggr" style="border-left-color: var(--accent-color);">
                    <i class="fas fa-clock" style="color: var(--accent-color);"></i>
                    <h3>Analisis Umur Piutang (Aging)</h3>
                    <p>Melihat daftar piutang lama (> 1 bulan) yang masih aktif berdasarkan data Master Cetak.</p>
                </div>
            </a>
            
        </div>
        
        <hr style="margin: 40px 0; border-style: dotted;">

        <h3 style="color: #dc3545;">
            <i class="fas fa-layer-group"></i> Hasil Laporan AB Sunter
        </h3>
        <div id="customReportArea">
            <p class="no-results">Tekan kartu "Grouping MC: AB Sunter" di atas untuk memuat hasilnya.</p>
        </div>
        
        <h3 style="color: #ffc107;">
            <i class="fas fa-clock"></i> Hasil Laporan Umur Piutang (Aging)
        </h3>
        <div id="agingReportArea">
            <p class="no-results">Tekan kartu "Analisis Umur Piutang (Aging)" di atas untuk memuat hasilnya.</p>
        </div>

        <h3 style="color: #28a745;">
            <i class="fas fa-water"></i> Hasil Laporan Volume Dasar
        </h3>
        <div id="basicVolumeReportArea">
            <p class="no-results">Tekan kartu "Laporan Volume Dasar" di atas untuk memuat hasilnya.</p>
        </div>

        <h3 style="color: var(--primary-color);">
            <i class="fas fa-list-alt"></i> Hasil Daftar Konsumen Spesifik
        </h3>
        <div id="topListsArea">
            <p class="no-results">Tekan kartu "Daftar Konsumen Top" di atas untuk memuat hasilnya.</p>
        </div>
        
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Memastikan Chart.js dimuat dari CDN (tambahan untuk memastikan ketersediaan)
        if (typeof Chart === 'undefined') {
             console.error("Chart.js belum dimuat.");
        }

        const reportArea = document.getElementById('reportArea');
        const filterInput = document.getElementById('filterInput');
        const searchBtn = document.getElementById('searchBtn');
        const detailsArea = document.getElementById('detailsArea');
        const exportReportBtn = document.getElementById('exportReportBtn');
        const customReportArea = document.getElementById('customReportArea');
        const tarifBreakdownArea = document.getElementById('tarifBreakdownArea');
        
        const monitoringSummaryArea = document.getElementById('monitoringSummaryArea');
        const monitoringTableArea = document.getElementById('monitoringTableArea');
        
        const topListsArea = document.getElementById('topListsArea');
        const basicVolumeReportArea = document.getElementById('basicVolumeReportArea');
        
        const agingReportArea = document.getElementById('agingReportArea');
        const tariffChartArea = document.getElementById('tariffChartArea');

        // MoM Variables
        const momSummaryGrid = document.getElementById('momSummaryGrid');
        const momTableContainer = document.getElementById('momTableContainer');
        let momChartInstance = null;
        let tariffChartInstance = null;
        let dohChartInstance = null; // DOH Chart Instance

        function formatRupiah(number) {
            return 'Rp ' + (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
        }
        
        function formatNumber(number) {
            return (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
        }

        function formatPercent(number) {
            return (parseFloat(number) || 0).toFixed(2) + '%';
        }

        // --- FUNGSI UTILITY UNTUK TAB ---
        function showTabCollection(tabName) {
            // Sembunyikan semua konten tab
            document.querySelectorAll('.tab-content-tab').forEach(div => div.style.display = 'none');
            
            // Hapus kelas aktif dari semua tombol
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            // Tampilkan konten tab yang dipilih
            const contentId = `content-${tabName}`;
            document.getElementById(contentId).style.display = 'block';

            // Set tombol menjadi aktif
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // --- PANGGIL FUNGSI LOAD DATA BERDASARKAN TAB ---
            if (tabName === 'summary') {
                fetchCollectionReport(); 
            } else if (tabName === 'monitoring') {
                fetchMoMReport(); 
                fetchCollectionMonitoring();
                fetchCollectionDetails(''); 
                fetchDOHComparisonReport(); // Memuat DtD Comparison
            } else if (tabName === 'analysis') {
                 fetchTarifBreakdown(); // Load tarif breakdown otomatis
            }
        }
        // --- END FUNGSI UTILITY UNTUK TAB ---
        
        // =========================================================
        // --- FUNGSI BARU: MEMUAT MOM REPORT ---
        // =========================================================
        async function fetchMoMReport() {
            momSummaryGrid.innerHTML = '<p class="no-results" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Perbandingan Bulanan...</p>';
            momTableContainer.innerHTML = '';
            
            try {
                const response = await fetch('{{ url_for("mom_report_api") }}'); 
                const result = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }

                if (result.status !== 'success') {
                     momSummaryGrid.innerHTML = `<p class="no-results" style="color: red; grid-column: 1 / -1;">❌ Gagal memuat report: ${result.message || 'Error Server'}</p>`;
                     return;
                }
                
                renderMoMReport(result.data);

            } catch (error) {
                momSummaryGrid.innerHTML = '<p class="no-results" style="color: red; grid-column: 1 / -1;">Gagal mengambil data MoM report dari server.</p>';
                console.error('MoM Report Error:', error);
            }
        }

        function renderMoMReport(data) {
            
            // Helper untuk menentukan warna dan ikon (Naik/Turun/Netral)
            const getChangeColor = (value) => value > 0 ? '#28a745' : (value < 0 ? '#dc3545' : '#6c757d');
            const getChangeIcon = (value) => value > 0 ? 'up' : (value < 0 ? 'down' : 'minus');
            
            // --- 1. RENDER SUMMARY GRID ---
            
            momSummaryGrid.innerHTML = `
                <div class="summary-card" style="border-left-color: #28a745;">
                    <h4>Nominal Koleksi Bulan Ini (${data.period_current})</h4>
                    <p>${formatRupiah(data.current_nominal)}</p>
                </div>
                <div class="summary-card" style="border-left-color: ${getChangeColor(data.change_nominal)};">
                    <h4>Perubahan Nominal (MoM)</h4>
                    <p style="color: ${getChangeColor(data.change_nominal)};">
                        <i class="fas fa-caret-${getChangeIcon(data.change_nominal)}"></i> 
                        ${formatPercent(data.change_nominal)}
                    </p>
                </div>
                <div class="summary-card" style="border-left-color: #007bff;">
                    <h4>Jml Pelanggan Bulan Ini (${data.period_current})</h4>
                    <p>${formatNumber(data.current_nomen)}</p>
                </div>
                <div class="summary-card" style="border-left-color: ${getChangeColor(data.change_nomen)};">
                    <h4>Perubahan Pelanggan (MoM)</h4>
                    <p style="color: ${getChangeColor(data.change_nomen)};">
                        <i class="fas fa-caret-${getChangeIcon(data.change_nomen)}"></i> 
                        ${formatPercent(data.change_nomen)}
                    </p>
                </div>
            `;

            // --- 2. RENDER TABLE ---
            momTableContainer.innerHTML = `
                <h4 style="margin-top: 20px;">Tabel Perbandingan Koleksi Nominal dan Pelanggan</h4>
                <table class="report-table" style="min-width: 600px;">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Metrik</th>
                            <th>Bulan Lalu (${data.period_last})</th>
                            <th>Bulan Ini (${data.period_current})</th>
                            <th>Perubahan (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="text-align: left;">Total Nominal Koleksi</td>
                            <td>${formatRupiah(data.last_nominal)}</td>
                            <td>${formatRupiah(data.current_nominal)}</td>
                            <td style="color: ${getChangeColor(data.change_nominal)}; font-weight: bold;">
                                 ${formatPercent(data.change_nominal)}
                            </td>
                        </tr>
                        <tr>
                            <td style="text-align: left;">Jumlah Pelanggan</td>
                            <td>${formatNumber(data.last_nomen)}</td>
                            <td>${formatNumber(data.current_nomen)}</td>
                            <td style="color: ${getChangeColor(data.change_nomen)}; font-weight: bold;">
                                 ${formatPercent(data.change_nomen)}
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;
            
            // --- 3. RENDER BAR CHART ---
            renderMoMChart(data);
        }

        function renderMoMChart(data) {
            if (momChartInstance) {
                momChartInstance.destroy();
            }

            const ctx = document.getElementById('momBarChart').getContext('2d');
            
            // Data untuk Chart.js
            const chartLabels = ['Nominal Koleksi', 'Jumlah Pelanggan'];
            const chartData = {
                labels: chartLabels,
                datasets: [
                    {
                        label: data.period_last,
                        data: [data.last_nominal, data.last_nomen],
                        backgroundColor: '#adb5bd', // Abu-abu terang
                        borderColor: '#adb5bd',
                        borderWidth: 1
                    },
                    {
                        label: data.period_current,
                        data: [data.current_nominal, data.current_nomen],
                        backgroundColor: '#28a745', // Hijau
                        borderColor: '#28a745',
                        borderWidth: 1
                    }
                ]
            };

            momChartInstance = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nilai (Rupiah/Count)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Perbandingan Koleksi Nominal & Pelanggan (DtD MoM)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataIndex === 0) {
                                        label += formatRupiah(context.parsed.y);
                                    } else {
                                        label += formatNumber(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // =========================================================
        // --- FUNGSI BARU: MEMUAT DOH COMPARISON REPORT (DtD) ---
        // =========================================================
        async function fetchDOHComparisonReport() {
            const dohTableContainer = document.getElementById('dohTableContainer');
            dohTableContainer.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat data DtD Comparison...</p>';
            
            try {
                const response = await fetch('{{ url_for("doh_comparison_report_api") }}'); 
                const result = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }

                if (result.status !== 'success' || result.data.days.length === 0) {
                     dohTableContainer.innerHTML = `<p class="no-results" style="color: #dc3545;">❌ Gagal memuat report: ${result.message || 'Tidak ada data MB di kedua bulan untuk perbandingan Day-to-Date.'}</p>`;
                     if (dohChartInstance) dohChartInstance.destroy();
                     return;
                }
                
                renderDOHComparisonReport(result.data, result.periods);

            } catch (error) {
                dohTableContainer.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data DtD comparison dari server.</p>';
                console.error('DOH Report Error:', error);
            }
        }

        function renderDOHComparisonReport(data, periods) {
            
            // Helper untuk menghitung Kumulatif
            const calculateCumulative = (arr) => {
                let cumulative = [];
                let currentSum = 0;
                for (const value of arr) {
                    currentSum += value;
                    cumulative.push(currentSum);
                }
                return cumulative;
            }
            
            // Helper untuk menghitung persentase DtD
            const calculateDtDPercentage = (currentDaily, lastDaily) => {
                if (lastDaily === 0) {
                    return currentDaily > 0 ? 100 : 0;
                }
                return ((currentDaily - lastDaily) / lastDaily) * 100;
            };
            
            // Helper untuk menentukan warna dan ikon (Naik/Turun/Netral)
            const getChangeColor = (value) => value > 0 ? '#28a745' : (value < 0 ? '#dc3545' : '#6c757d');
            const getChangeIcon = (value) => value > 0 ? 'up' : (value < 0 ? 'down' : 'minus');


            // Ambil Data Kumulatif untuk Grafik (TOTAL AB)
            const currentCumulative = calculateCumulative(data.TOTAL_AB[periods.current]);
            const lastCumulative = calculateCumulative(data.TOTAL_AB[periods.last]);

            // 1. Render Chart
            if (dohChartInstance) {
                dohChartInstance.destroy();
            }
            
            const ctx = document.getElementById('dohLineChart').getContext('2d');
            
            dohChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.days.map(d => 'Hari ke-' + d),
                    datasets: [
                        {
                            label: `Bulan Lalu (${periods.last}) - Kumulatif`,
                            data: lastCumulative,
                            borderColor: '#adb5bd', 
                            backgroundColor: '#adb5bd50',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                        },
                        {
                            label: `Bulan Ini (${periods.current}) - Kumulatif`,
                            data: currentCumulative,
                            borderColor: '#007bff', 
                            backgroundColor: '#007bff50',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nominal Kumulatif (Rp)'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tren Koleksi Kumulatif DtD (Nominal AB Sunter)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatRupiah(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // --------------------------------------------------------
            // 2. Render Tabel
            // --------------------------------------------------------
            
            // Helper function untuk merender sub-tabel (Rayon atau Total)
            const renderComparisonTable = (area, periods, dataStructure) => {
                const areaDailyCurrent = dataStructure[area][periods.current];
                const areaDailyLast = dataStructure[area][periods.last];
                const areaCumulativeCurrent = calculateCumulative(areaDailyCurrent);
                const areaCumulativeLast = calculateCumulative(areaDailyLast);
                
                let subTableHTML = `
                    <h5 style="margin-top: 25px; color: ${area === 'TOTAL_AB' ? '#dc3545' : '#17a2b8'};">
                        DETAIL AREA ${area === 'TOTAL_AB' ? 'AB SUNTER' : 'RAYON ' + area.replace('R', '')}
                    </h5>
                    <table class="report-table" style="min-width: 600px;">
                        <thead>
                            <tr>
                                <th rowspan="2">Hari ke-</th>
                                <th colspan="2">${periods.current} (BULAN INI)</th>
                                <th colspan="2">${periods.last} (BULAN LALU)</th>
                                <th rowspan="2">Perubahan Harian (%)</th>
                            </tr>
                            <tr>
                                <th>Harian (Rp)</th>
                                <th>Kumulatif (Rp)</th>
                                <th>Harian (Rp)</th>
                                <th>Kumulatif (Rp)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.days.forEach((day, index) => {
                    const currentDaily = areaDailyCurrent[index];
                    const lastDaily = areaDailyLast[index];
                    const percentageChange = calculateDtDPercentage(currentDaily, lastDaily);
                    const changeColor = getChangeColor(percentageChange);

                    subTableHTML += `
                        <tr>
                            <td style="text-align: center;">${day}</td>
                            <td>${formatRupiah(currentDaily)}</td>
                            <td style="background-color: #f0f8ff;">${formatRupiah(areaCumulativeCurrent[index])}</td>
                            <td>${formatRupiah(lastDaily)}</td>
                            <td style="background-color: #f0f8ff;">${formatRupiah(areaCumulativeLast[index])}</td>
                            <td style="color: ${changeColor}; font-weight: bold;">
                                 <i class="fas fa-caret-${getChangeIcon(percentageChange)}"></i> ${formatPercent(percentageChange)}
                            </td>
                        </tr>
                    `;
                });
                
                subTableHTML += '</tbody></table>';
                return subTableHTML;
            };

            let tableHTML = renderComparisonTable('TOTAL_AB', periods, data);
            tableHTML += renderComparisonTable('R34', periods, data);
            tableHTML += renderComparisonTable('R35', periods, data);


            dohTableContainer.innerHTML = tableHTML;
        }

        // --- FUNGSI AGING REPORT, BREAKDOWN TARIF, DLL. (Lanjutan) ---
        
        // --- FUNGSI BARU: MEMUAT AGING REPORT ---
        async function fetchAgingReport() {
            agingReportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Umur Piutang...</p>';
            
            try {
                const response = await fetch('{{ url_for("aging_report_api") }}'); 
                const result = await response.json();

                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (result.status !== 'success' || result.data.length === 0) {
                     agingReportArea.innerHTML = `<p class="no-results" style="color: #dc3545;">❌ ${result.message || 'Tidak ada data piutang lama ditemukan.'}</p>`;
                     return;
                }
                
                renderAgingReport(result.data);

            } catch (error) {
                agingReportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data aging report dari server.</p>';
                console.error('Aging Report Error:', error);
            }
        }
        
        function renderAgingReport(data) {
             const headers = Object.keys(data[0]);
             let tableHTML = `
                 <h4 style="margin-top: 20px;">Daftar Pelanggan dengan Piutang > 1 Bulan (${data.length} Data)</h4>
                 <div class="report-table-wrapper">
                 <table class="report-table">
                     <thead><tr>
                         ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ')}</th>`).join('')}
                     </tr></thead><tbody>
             `;
             
             data.forEach(item => {
                 tableHTML += '<tr>';
                 headers.forEach(h => {
                     let cellValue = item[h];
                     let align = 'right';
                     
                     if (h.includes('NOMEN') || h.includes('NAMA') || h.includes('RAYON')) {
                         align = 'left';
                     }
                     
                     if (h.includes('PiutangLama')) {
                         cellValue = formatRupiah(cellValue);
                     } else if (h.includes('Bulan_Tagihan')) {
                         align = 'center';
                     }
                     tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${align};">${cellValue}</td>`;
                 });
                 tableHTML += '</tr>';
             });
             
             tableHTML += '</tbody></table></div>';
             agingReportArea.innerHTML = tableHTML;
        }


        // --- FUNGSI BARU: RENDER PIE CHART TARIF ---
        function renderTariffBreakdownChart(data) {
            const chartData = {};
            
            if (tariffChartInstance) {
                tariffChartInstance.destroy();
            }

            // Agregat berdasarkan TARIF di semua Rayon 34/35
            data.forEach(item => {
                const tarif = item.TARIF || 'N/A';
                const count = item.JumlahPelanggan;
                chartData[tarif] = (chartData[tarif] || 0) + count;
            });

            const labels = Object.keys(chartData);
            const counts = Object.values(chartData);
            
            // Hasilkan warna berbeda secara dinamis
            const backgroundColors = labels.map((_, index) => {
                // Skema warna yang lebih menarik
                const colors = [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', 
                    '#6c757d', '#343a40', '#6f42c1', '#fd7e14'
                ];
                return colors[index % colors.length];
            });

            tariffChartInstance = new Chart(document.getElementById('tarifBreakdownChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors,
                        hoverOffset: 10,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Pelanggan Berdasarkan Tarif (Count Nomen)'
                        }
                    }
                }
            });
        }
        // --- END FUNGSI BARU: RENDER PIE CHART TARIF ---


        // --- FUNGSI BARU: MEMUAT BREAKDOWN TARIF (MEMANGGIL CHART) ---
        async function fetchTarifBreakdown() {
            tarifBreakdownArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Breakdown Tarif...</p>';
            
            try {
                // Panggil API baru untuk breakdown tarif
                const response = await fetch('{{ url_for("analyze_mc_tarif_breakdown_api") }}'); 
                const data = await response.json();
                
                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (response.status !== 200 || data.length === 0) {
                     tarifBreakdownArea.innerHTML = `<p class="no-results" style="color: #6c757d;">Tidak ada data pelanggan yang cocok dengan kriteria kustom (Rayon 34/35 Reguler).</p>`;
                     const existingChart = Chart.getChart("tarifBreakdownChart");
                     if (existingChart) { existingChart.destroy(); }
                     return;
                }
                
                renderTarifBreakdownTable(data);
                renderTariffBreakdownChart(data); // <-- Panggil fungsi render chart

            } catch (error) {
                tarifBreakdownArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data breakdown tarif dari server.</p>';
                console.error('Tarif Breakdown Error:', error);
            }
        }
        
        function renderTarifBreakdownTable(data) {
            let totalPelanggan = data.reduce((sum, item) => sum + item.JumlahPelanggan, 0);

            // Perbesar lebar untuk kolom Rayon
            let tableHTML = `
                <div class="report-table-wrapper" style="max-width: 600px; margin-left: 0;"> 
                <h4 style="margin-top: 10px;">Detail Distribusi Tarif per Rayon (Count)</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">RAYON</th>
                            <th style="text-align: left;">TARIF</th>
                            <th>JML Pelanggan</th>
                            <th>Persentase (%)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                const percentage = (item.JumlahPelanggan / totalPelanggan) * 100;
                tableHTML += `
                    <tr>
                        <td data-label="RAYON" style="text-align: left;">${item.RAYON}</td>
                        <td data-label="TARIF" style="text-align: left;">${item.TARIF}</td>
                        <td data-label="JML Pelanggan">${formatNumber(item.JumlahPelanggan)}</td>
                        <td data-label="Persentase">${formatPercent(percentage)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                <tr class="grand-total-row">
                    <td style="text-align: left;">TOTAL</td>
                    <td>-</td> 
                    <td>${formatNumber(totalPelanggan)}</td>
                    <td>100.00%</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            tarifBreakdownArea.innerHTML = tableHTML;
        }
        
        // Muat semua bagian saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
             // Default: Tampilkan Tab Ringkasan dan load datanya
             showTabCollection('summary'); 
        });

    </script>
{% endblock %}
