<div class="tab-pane fade" id="tab-analisa">
    
    <!-- Header with Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3 col-6 mb-3">
            <div class="kpi-card border-start border-primary border-4">
                <small class="text-muted d-block">Total Analisa</small>
                <h3 class="fw-bold mb-0 text-primary" id="analisa-total">0</h3>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="kpi-card border-start border-warning border-4">
                <small class="text-muted d-block">Pending</small>
                <h3 class="fw-bold mb-0 text-warning" id="analisa-pending">0</h3>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="kpi-card border-start border-info border-4">
                <small class="text-muted d-block">In Progress</small>
                <h3 class="fw-bold mb-0 text-info" id="analisa-progress">0</h3>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="kpi-card border-start border-success border-4">
                <small class="text-muted d-block">Completed</small>
                <h3 class="fw-bold mb-0 text-success" id="analisa-completed">0</h3>
            </div>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="kpi-card mb-4">
        <div class="row align-items-center">
            <div class="col-md-4 mb-2 mb-md-0">
                <button class="btn btn-modern btn-gradient-primary w-100" onclick="createAnalisa()">
                    <i class="fas fa-plus me-2"></i>Buat Analisa Baru
                </button>
            </div>
            <div class="col-md-4 mb-2 mb-md-0">
                <select class="form-select filter-select" id="filterStatus" onchange="filterAnalisaByStatus()">
                    <option value="all">Semua Status</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>
            <div class="col-md-4">
                <select class="form-select filter-select" id="filterJenis" onchange="filterAnalisaByJenis()">
                    <option value="all">Semua Jenis</option>
                    <option value="extreme">Extreme</option>
                    <option value="zero">Zero</option>
                    <option value="negatif">Negatif</option>
                    <option value="salah_catat">Salah Catat</option>
                    <option value="rebill">Rebill</option>
                    <option value="estimasi">Estimasi</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Analisa List (Kanban Style) -->
    <div class="row" id="analisaKanban">
        
        <!-- Column: Pending -->
        <div class="col-md-4 mb-3">
            <div class="kpi-card" style="min-height: 400px;">
                <h6 class="fw-bold text-warning mb-3">
                    <i class="fas fa-clock me-2"></i>PENDING
                    <span class="badge bg-warning ms-2" id="badge-pending">0</span>
                </h6>
                <div class="analisa-column" id="column-pending" style="max-height: 500px; overflow-y: auto;">
                    <!-- Cards will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Column: In Progress -->
        <div class="col-md-4 mb-3">
            <div class="kpi-card" style="min-height: 400px;">
                <h6 class="fw-bold text-info mb-3">
                    <i class="fas fa-spinner me-2"></i>IN PROGRESS
                    <span class="badge bg-info ms-2" id="badge-progress">0</span>
                </h6>
                <div class="analisa-column" id="column-in_progress" style="max-height: 500px; overflow-y: auto;">
                    <!-- Cards will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Column: Completed -->
        <div class="col-md-4 mb-3">
            <div class="kpi-card" style="min-height: 400px;">
                <h6 class="fw-bold text-success mb-3">
                    <i class="fas fa-check-circle me-2"></i>COMPLETED
                    <span class="badge bg-success ms-2" id="badge-completed">0</span>
                </h6>
                <div class="analisa-column" id="column-completed" style="max-height: 500px; overflow-y: auto;">
                    <!-- Cards will be inserted here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Alternative: Table View (Hidden by default) -->
    <div class="kpi-card" id="analisaTableView" style="display: none;">
        <div class="d-flex justify-content-between mb-3">
            <h5 class="fw-bold">Daftar Analisa</h5>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleView()">
                <i class="fas fa-columns me-1"></i>Kanban View
            </button>
        </div>
        <table id="tableAnalisa" class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nomen</th>
                    <th>Nama</th>
                    <th>Jenis</th>
                    <th>Status</th>
                    <th>Assigned To</th>
                    <th>Created</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- View Toggle Button -->
    <div class="text-center mt-3">
        <button class="btn btn-modern btn-gradient-primary" onclick="toggleView()">
            <i class="fas fa-exchange-alt me-2"></i>
            <span id="toggleViewText">Switch to Table View</span>
        </button>
    </div>

</div>

<!-- MODAL: Create/Edit Analisa -->
<div class="modal fade" id="modalAnalisa" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 24px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 24px 24px 0 0;">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-check me-2"></i>
                    <span id="modalAnalisaTitle">Buat Analisa Baru</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="formAnalisa">
                    <input type="hidden" id="analisa-id" value="">
                    
                    <!-- Customer Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Pilih Pelanggan</label>
                        <div class="input-group">
                            <input type="text" class="form-control filter-select" id="analisa-nomen" placeholder="Masukkan NOMEN" required>
                            <button type="button" class="btn btn-modern btn-gradient-primary" onclick="searchNomen()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="nomenSearchResult" class="mt-2"></div>
                    </div>

                    <!-- Customer Info Display -->
                    <div class="alert alert-info" id="customerInfo" style="display: none;">
                        <h6 class="fw-bold">Informasi Pelanggan</h6>
                        <div class="row">
                            <div class="col-6"><strong>Nama:</strong> <span id="info-nama">-</span></div>
                            <div class="col-6"><strong>Alamat:</strong> <span id="info-alamat">-</span></div>
                            <div class="col-6"><strong>Rayon:</strong> <span id="info-rayon">-</span></div>
                            <div class="col-6"><strong>Tarif:</strong> <span id="info-tarif">-</span></div>
                        </div>
                    </div>

                    <!-- Jenis Anomali -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Jenis Anomali</label>
                        <select class="form-select filter-select" id="analisa-jenis" required>
                            <option value="">-- Pilih Jenis --</option>
                            <option value="extreme">Pemakaian Extreme</option>
                            <option value="zero">Zero Usage</option>
                            <option value="negatif">Stand Negatif</option>
                            <option value="salah_catat">Salah Catat</option>
                            <option value="rebill">Rebill</option>
                            <option value="estimasi">Estimasi</option>
                            <option value="custom">Custom/Lainnya</option>
                        </select>
                    </div>

                    <!-- Deskripsi -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Deskripsi Masalah</label>
                        <textarea class="form-control filter-select" id="analisa-deskripsi" rows="4" placeholder="Jelaskan detail masalah yang ditemukan..." required></textarea>
                    </div>

                    <!-- Priority -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Priority</label>
                        <select class="form-select filter-select" id="analisa-priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>

                    <!-- Assign To -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Assign To</label>
                        <select class="form-select filter-select" id="analisa-assigned">
                            <option value="">-- Pilih Petugas --</option>
                            <option value="team_collection">Team Collection</option>
                            <option value="team_meter">Team Meter</option>
                            <option value="team_billing">Team Billing</option>
                            <option value="supervisor">Supervisor</option>
                        </select>
                    </div>

                    <!-- Due Date -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Target Selesai</label>
                        <input type="date" class="form-control filter-select" id="analisa-due-date">
                    </div>

                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-modern btn-gradient-primary" onclick="saveAnalisa()">
                    <i class="fas fa-save me-2"></i>Simpan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: View Analisa Detail -->
<div class="modal fade" id="modalAnalisaDetail" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content" style="border-radius: 24px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 24px 24px 0 0;">
                <div>
                    <h5 class="modal-title">
                        <i class="fas fa-file-alt me-2"></i>Detail Analisa #<span id="detail-id">-</span>
                    </h5>
                    <small id="detail-created-at">-</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                
                <!-- Status & Actions Bar -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <span class="badge bg-warning p-2" id="detail-status-badge">PENDING</span>
                        <span class="badge bg-info p-2 ms-2" id="detail-jenis-badge">-</span>
                        <span class="badge bg-danger p-2 ms-2" id="detail-priority-badge">-</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-success" onclick="updateStatus('completed')">
                            <i class="fas fa-check"></i> Complete
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="updateStatus('rejected')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="editAnalisa()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>

                <!-- Customer Info -->
                <div class="kpi-card mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-user me-2"></i>Informasi Pelanggan
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>NOMEN:</strong> <span id="detail-nomen">-</span></p>
                            <p><strong>Nama:</strong> <span id="detail-nama">-</span></p>
                            <p><strong>Alamat:</strong> <span id="detail-alamat">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Rayon:</strong> <span id="detail-rayon">-</span></p>
                            <p><strong>Tarif:</strong> <span id="detail-tarif">-</span></p>
                            <p><strong>Kubikasi:</strong> <span id="detail-kubikasi">-</span> mÂ³</p>
                        </div>
                    </div>
                </div>

                <!-- Problem Description -->
                <div class="kpi-card mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>Deskripsi Masalah
                    </h6>
                    <p id="detail-deskripsi" class="text-muted">-</p>
                </div>

                <!-- Assignment Info -->
                <div class="kpi-card mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-tasks me-2"></i>Assignment
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Assigned To:</strong> <span id="detail-assigned">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Due Date:</strong> <span id="detail-due-date">-</span></p>
                        </div>
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="kpi-card mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-history me-2"></i>Activity Log
                    </h6>
                    <div id="activityLog">
                        <!-- Activity items will be inserted here -->
                    </div>
                </div>

                <!-- Add Comment Section -->
                <div class="kpi-card">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-comments me-2"></i>Comments
                    </h6>
                    <div id="commentsList" class="mb-3">
                        <!-- Comments will be inserted here -->
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control filter-select" id="newComment" placeholder="Tambah komentar...">
                        <button class="btn btn-modern btn-gradient-primary" onclick="addComment()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-modern btn-gradient-primary" onclick="printAnalisa()">
                    <i class="fas fa-print me-2"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Kanban Card Styles */
    .analisa-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 4px solid;
    }

    .analisa-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    .analisa-card.priority-low { border-left-color: #10b981; }
    .analisa-card.priority-medium { border-left-color: #f59e0b; }
    .analisa-card.priority-high { border-left-color: #ef4444; }
    .analisa-card.priority-critical { border-left-color: #dc2626; animation: pulse 2s infinite; }

    .analisa-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .analisa-card-body {
        font-size: 0.9rem;
        color: #64748b;
    }

    .analisa-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e2e8f0;
        font-size: 0.8rem;
    }

    /* Activity Log Item */
    .activity-item {
        padding: 12px;
        margin-bottom: 8px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 3px solid var(--primary);
    }

    .activity-item .activity-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--primary);
        color: white;
        margin-right: 10px;
    }

    /* Comment Item */
    .comment-item {
        padding: 10px;
        margin-bottom: 8px;
        background: #f1f5f9;
        border-radius: 8px;
    }

    .comment-item .comment-author {
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 4px;
    }

    .comment-item .comment-time {
        font-size: 0.75rem;
        color: #64748b;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .analisa-card {
            padding: 12px;
        }

        .analisa-card-body {
            font-size: 0.85rem;
        }

        #analisaKanban .col-md-4 {
            margin-bottom: 15px;
        }

        .kpi-card {
            min-height: auto !important;
        }

        .analisa-column {
            max-height: 300px !important;
        }
    }
</style>

<script>
    let currentView = 'kanban'; // or 'table'
    let currentAnalisaId = null;
    let analisaData = [];

    // ===== LOAD ANALISA DATA =====
    function loadAnalisaData() {
        showToast('Loading analisa data...', 'info');
        
        $.get('/api/analisa/list', function(data) {
            analisaData = data;
            renderKanbanView(data);
            updateStats(data);
            showToast('Analisa loaded!', 'success');
        }).fail(function() {
            showToast('Failed to load analisa', 'error');
        });
    }

    // ===== RENDER KANBAN VIEW =====
    function renderKanbanView(data) {
        // Clear columns
        $('#column-pending').empty();
        $('#column-in_progress').empty();
        $('#column-completed').empty();

        // Count by status
        let counts = {
            pending: 0,
            in_progress: 0,
            completed: 0
        };

        // Render cards
        data.forEach(function(item) {
            const card = createAnalisaCard(item);
            $(`#column-${item.status}`).append(card);
            counts[item.status] = (counts[item.status] || 0) + 1;
        });

        // Update badges
        $('#badge-pending').text(counts.pending || 0);
        $('#badge-progress').text(counts.in_progress || 0);
        $('#badge-completed').text(counts.completed || 0);
    }

    // ===== CREATE ANALISA CARD =====
    function createAnalisaCard(item) {
        const priorityClass = `priority-${item.priority || 'medium'}`;
        const jenisIcon = getJenisIcon(item.jenis_anomali);
        
        return $(`
            <div class="analisa-card ${priorityClass}" onclick="viewAnalisaDetail(${item.id})">
                <div class="analisa-card-header">
                    <strong>#${item.id}</strong>
                    <span class="badge bg-${getPriorityColor(item.priority)}">${item.priority}</span>
                </div>
                <div class="analisa-card-body">
                    <p class="mb-1"><i class="${jenisIcon} me-1"></i> ${item.jenis_anomali}</p>
                    <p class="mb-1"><strong>${item.nomen}</strong> - ${item.nama || 'No name'}</p>
                    <p class="mb-0 text-truncate" style="max-width: 100%;">${item.deskripsi || 'No description'}</p>
                </div>
                <div class="analisa-card-footer">
                    <small class="text-muted">${item.assigned_to || 'Unassigned'}</small>
                    <small class="text-muted">${formatDate(item.created_at)}</small>
                </div>
            </div>
        `);
    }

    // ===== UPDATE STATS =====
    function updateStats(data) {
        const total = data.length;
        const pending = data.filter(d => d.status === 'pending').length;
        const progress = data.filter(d => d.status === 'in_progress').length;
        const completed = data.filter(d => d.status === 'completed').length;

        $('#analisa-total').text(total);
        $('#analisa-pending').text(pending);
        $('#analisa-progress').text(progress);
        $('#analisa-completed').text(completed);
    }

    // ===== CREATE NEW ANALISA =====
    function createAnalisa() {
        $('#modalAnalisaTitle').text('Buat Analisa Baru');
        $('#analisa-id').val('');
        $('#formAnalisa')[0].reset();
        $('#customerInfo').hide();
        $('#modalAnalisa').modal('show');
    }

    // ===== SAVE ANALISA =====
    function saveAnalisa() {
        const id = $('#analisa-id').val();
        const data = {
            nomen: $('#analisa-nomen').val(),
            jenis_anomali: $('#analisa-jenis').val(),
            deskripsi: $('#analisa-deskripsi').val(),
            priority: $('#analisa-priority').val(),
            assigned_to: $('#analisa-assigned').val(),
            due_date: $('#analisa-due-date').val()
        };

        if (!data.nomen || !data.jenis_anomali || !data.deskripsi) {
            showToast('Please fill required fields', 'error');
            return;
        }

        const url = id ? `/api/analisa/update/${id}` : '/api/analisa/create';
        const method = id ? 'PUT' : 'POST';

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                showToast('Analisa saved!', 'success');
                $('#modalAnalisa').modal('hide');
                loadAnalisaData();
            },
            error: function() {
                showToast('Failed to save analisa', 'error');
            }
        });
    }

    // ===== VIEW DETAIL =====
    function viewAnalisaDetail(id) {
        currentAnalisaId = id;
        
        $.get(`/api/analisa/detail/${id}`, function(data) {
            // Fill modal with data
            $('#detail-id').text(data.id);
            $('#detail-nomen').text(data.nomen);
            $('#detail-nama').text(data.nama || '-');
            $('#detail-alamat').text(data.alamat || '-');
            $('#detail-rayon').text(data.rayon || '-');
            $('#detail-deskripsi').text(data.deskripsi);
            $('#detail-status-badge').text(data.status.toUpperCase()).removeClass().addClass(`badge bg-${getStatusColor(data.status)} p-2`);
            $('#detail-jenis-badge').text(data.jenis_anomali);
            $('#detail-priority-badge').text(data.priority);
            $('#detail-assigned').text(data.assigned_to || 'Unassigned');
            $('#detail-due-date').text(data.due_date || '-');
            $('#detail-created-at').text('Created: ' + formatDate(data.created_at));
            
            // Load comments and activity
            loadComments(id);
            loadActivity(id);
            
            $('#modalAnalisaDetail').modal('show');
        });
    }

    // ===== HELPER FUNCTIONS =====
    function getJenisIcon(jenis) {
        const icons = {
            'extreme': 'fas fa-chart-line',
            'zero': 'fas fa-circle-notch',
            'negatif': 'fas fa-minus-circle',
            'salah_catat': 'fas fa-exclamation-triangle',
            'rebill': 'fas fa-rotate-left',
            'estimasi': 'fas fa-calculator',
            'custom': 'fas fa-question-circle'
        };
        return icons[jenis] || 'fas fa-file';
    }

    function getPriorityColor(priority) {
        const colors = {
            'low': 'success',
            'medium': 'warning',
            'high': 'danger',
            'critical': 'dark'
        };
        return colors[priority] || 'secondary';
    }

    function getStatusColor(status) {
        const colors = {
            'pending': 'warning',
            'in_progress': 'info',
            'completed': 'success',
            'rejected': 'danger'
        };
        return colors[status] || 'secondary';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function toggleView() {
        if (currentView === 'kanban') {
            $('#analisaKanban').hide();
            $('#analisaTableView').show();
            $('#toggleViewText').text('Switch to Kanban View');
            currentView = 'table';
            renderTableView();
        } else {
            $('#analisaKanban').show();
            $('#analisaTableView').hide();
            $('#toggleViewText').text('Switch to Table View');
            currentView = 'kanban';
        }
    }

    function renderTableView() {
        // TODO: Implement DataTable view
        showToast('Table view coming soon!', 'info');
    }

    function searchNomen() {
        const nomen = $('#analisa-nomen').val();
        if (!nomen) return;
        
        $.get(`/api/customer/search?nomen=${nomen}`, function(data) {
            if (data) {
                $('#info-nama').text(data.nama || '-');
                $('#info-alamat').text(data.alamat || '-');
                $('#info-rayon').text(data.rayon || '-');
                $('#info-tarif').text(data.tarif || '-');
                $('#customerInfo').show();
            }
        });
    }

    function updateStatus(newStatus) {
        $.ajax({
            url: `/api/analisa/update-status/${currentAnalisaId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ status: newStatus }),
            success: function() {
                showToast('Status updated!', 'success');
                $('#modalAnalisaDetail').modal('hide');
                loadAnalisaData();
            }
        });
    }

    function addComment() {
        const comment = $('#newComment').val();
        if (!comment) return;
        
        $.ajax({
            url: `/api/analisa/comment/${currentAnalisaId}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ comment: comment }),
            success: function() {
                $('#newComment').val('');
                loadComments(currentAnalisaId);
                showToast('Comment added!', 'success');
            }
        });
    }

    function loadComments(id) {
        $.get(`/api/analisa/comments/${id}`, function(data) {
            const html = data.map(c => `
                <div class="comment-item">
                    <div class="comment-author">${c.user}</div>
                    <div>${c.comment}</div>
                    <div class="comment-time">${formatDate(c.created_at)}</div>
                </div>
            `).join('');
            $('#commentsList').html(html || '<p class="text-muted">No comments yet</p>');
        });
    }

    function loadActivity(id) {
        $.get(`/api/analisa/activity/${id}`, function(data) {
            const html = data.map(a => `
                <div class="activity-item">
                    <span class="activity-icon"><i class="fas fa-${a.icon}"></i></span>
                    <strong>${a.action}</strong> by ${a.user} - ${formatDate(a.created_at)}
                </div>
            `).join('');
            $('#activityLog').html(html || '<p class="text-muted">No activity yet</p>');
        });
    }

    function filterAnalisaByStatus() {
        const status = $('#filterStatus').val();
        if (status === 'all') {
            renderKanbanView(analisaData);
        } else {
            const filtered = analisaData.filter(d => d.status === status);
            renderKanbanView(filtered);
        }
    }

    function filterAnalisaByJenis() {
        const jenis = $('#filterJenis').val();
        if (jenis === 'all') {
            renderKanbanView(analisaData);
        } else {
            const filtered = analisaData.filter(d => d.jenis_anomali === jenis);
            renderKanbanView(filtered);
        }
    }

    function printAnalisa() {
        window.print();
    }

    // ===== AUTO-LOAD ON TAB SHOW =====
    $('button[data-bs-target="#tab-analisa"]').on('shown.bs.tab', function() {
        loadAnalisaData();
    });
</script>
