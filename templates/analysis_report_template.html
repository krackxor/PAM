{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block custom_styles %}
/* CSS Khusus untuk Laporan Analisis */
.report-container {
    padding: 20px;
    background-color: var(--background-color-light);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-medium);
}
.report-header { 
    text-align: left; 
    margin-bottom: 20px; 
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 10px;
}
.report-description {
    color: #6c757d;
    margin-bottom: 30px;
}

/* Tabel Dinamis yang Responsif */
.report-table-wrapper { 
    overflow-x: auto; 
    margin-top: 20px; 
    box-shadow: var(--shadow-light);
    border-radius: var(--border-radius);
    overflow: hidden;
    border: 1px solid #e0e0e0;
}
.dynamic-table { 
    width: 100%; 
    border-collapse: collapse; 
    font-size: 13px; 
    min-width: 1500px; /* Diperluas untuk menampung dimensi komprehensif */
}
.dynamic-table th, .dynamic-table td { 
    border: 1px solid #f0f0f0; 
    padding: 10px; 
    text-align: left; 
    white-space: nowrap; 
}
.dynamic-table th { 
    background-color: var(--primary-color); 
    color: white;
    font-weight: 600; 
    text-align: center;
}
.dynamic-table tr:nth-child(even) {
    background-color: #f8f9fa;
}
.no-results {
    text-align: center;
    padding: 40px;
    color: #dc3545;
    font-weight: bold;
}

/* Chart Styles */
.chart-container {
    margin-top: 30px;
    padding: 20px;
    background-color: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-medium);
}

/* MEDIA QUERY untuk Responsif Mobile */
@media (max-width: 768px) {
    .dynamic-table {
        min-width: 100%;
    }
    .dynamic-table thead {
        display: none;
    }
    .dynamic-table tr {
        display: block;
        margin-bottom: 15px; 
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
    }
    .dynamic-table td {
        display: flex;
        justify-content: space-between;
        padding: 10px 12px;
        border: none;
        border-bottom: 1px solid #eee;
        text-align: right;
        white-space: normal;
    }
    .dynamic-table td:before {
        content: attr(data-label); 
        font-weight: 600;
        text-align: left;
        width: 50%; 
        color: var(--primary-color);
    }
}

{% endblock %}

{% block content %}
    <h2 style="text-align: left; border-bottom: none; margin-bottom: 10px; color: var(--primary-color);">
        <i class="fas fa-file-alt" style="margin-right: 10px;"></i> {{ title }}
    </h2>
    <p class="report-description">{{ description }}</p>

    <div id="loadingStatus" style="text-align: center; padding: 30px; color: #6c757d;">
        <i class="fas fa-spinner fa-spin"></i> Memuat data laporan...
    </div>

    <div id="reportContent" style="display: none;">
        
        {% if report_type.startswith('DIST_') or report_type == 'AGING_REPORT' or report_type == 'TOP_DEBTORS' or report_type == 'ANOMALY_COMPREHENSIVE' or report_type == 'BASIC_VOLUME' %}
        <div class="chart-container">
            <h3 style="margin-top: 0; color: var(--text-color);">Grafik Laporan Distribusi / Top List</h3>
            <canvas id="distributionChart"></canvas>
        </div>
        {% elif report_type == 'MOM_COMPARISON' or report_type == 'DOD_COMPARISON' %}
        <div class="chart-container">
            <h3 style="margin-top: 0; color: var(--text-color);">Grafik Perbandingan Bulanan (MoM) / Harian (DoD)</h3>
            <canvas id="comparisonChart"></canvas>
        </div>
        {% endif %}

        <h3 style="margin-top: 30px; color: var(--primary-color);">Tabel Data Detail</h3>
        <div id="reportTableArea" class="report-table-wrapper">
            <!-- Tabel akan dirender dinamis di sini -->
        </div>
        
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

    <script>
        const loadingStatus = document.getElementById('loadingStatus');
        const reportContent = document.getElementById('reportContent');
        const reportTableArea = document.getElementById('reportTableArea');
        const distributionChartCanvas = document.getElementById('distributionChart');
        const comparisonChartCanvas = document.getElementById('comparisonChart');


        // URL API diambil dari konteks Flask/Jinja
        const API_URL = "{{ api_endpoint }}"; 
        
        // --- UTILITY FORMATTING ---
        function formatRupiah(number) {
            return 'Rp ' + (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
        }
        
        function formatNumber(number) {
            return (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
        }

        function formatPercent(number) {
            return (parseFloat(number) || 0).toFixed(2) + '%';
        }
        
        // Fungsi untuk menentukan format berdasarkan tipe data
        function formatValue(value, type, unit) {
            if (value === null || value === undefined) return 'N/A';
            
            switch (type) {
                case 'currency':
                    return formatRupiah(value);
                case 'percent':
                    return formatPercent(value);
                case 'integer':
                    return formatNumber(value) + (unit ? ` ${unit}` : '');
                case 'date':
                    // Contoh: konversi YYYY-MM-DD ke DD/MM/YYYY
                    if (String(value).match(/^\d{4}-\d{2}-\d{2}/)) {
                        return new Date(value).toLocaleDateString('id-ID');
                    }
                    return value;
                default:
                    return String(value);
            }
        }
        
        // --- FUNGSI RENDERING DINAMIS ---
        
        function renderTable(data, schema) {
            if (!data || data.length === 0) {
                reportTableArea.innerHTML = '<p class="no-results">❌ Tidak ada data yang ditemukan untuk laporan ini.</p>';
                return;
            }

            let tableHTML = '<table class="dynamic-table"><thead><tr>';
            
            // 1. RENDER HEADER DARI SCHEMA
            schema.forEach(col => {
                tableHTML += `<th data-key="${col.key}">${col.label}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // 2. RENDER BARIS DATA
            data.forEach(row => {
                tableHTML += '<tr>';
                schema.forEach(col => {
                    const value = row[col.key];
                    const formattedValue = formatValue(value, col.type, col.unit);
                    
                    // Tambahkan data-label untuk tampilan mobile
                    // Sesuaikan alignment kolom berdasarkan tipe data
                    tableHTML += `<td data-label="${col.label}" style="text-align: ${col.type === 'currency' || col.type === 'integer' || col.type === 'percent' ? 'right' : 'left'};">
                                    ${formattedValue}
                                  </td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            reportTableArea.innerHTML = tableHTML;
        }

        function renderSingleMetricChart(data, schema, title, chartElement) {
            if (!chartElement) return;
            
            // Cari metrik Piutang atau Kubikasi pertama yang ditandai sebagai chart_key
            const metric = schema.find(c => (c.type === 'currency' || c.key.includes('KUBIK')) && c.chart_key);
            
            if (!metric) {
                // Jika tidak ada metrik yang cocok, cek apakah ada TotalKubikasi (untuk laporan volume)
                const kubikMetric = schema.find(c => c.key === 'TotalKubikasi');
                if (!kubikMetric) return; // Jika tidak ada, batal
            }
            
            const mainKey = schema.find(c => c.is_main_key)?.key;
            // Batasi label dan data hanya 10 baris teratas agar chart mudah dibaca
            const chartDataSubset = data.slice(0, 10);
            const labels = chartDataSubset.map(item => item.chart_label || item[mainKey]);
            const metricData = chartDataSubset.map(item => item[metric.key || 'TotalKubikasi']); // Gunakan TotalKubikasi jika metrik tidak ditemukan

            
            const existingChart = Chart.getChart(chartElement);
            if (existingChart) {
                existingChart.destroy();
            }

            new Chart(chartElement, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: metric.label,
                        data: metricData,
                        backgroundColor: 'var(--primary-color)',
                        borderColor: 'var(--primary-color)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: title,
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (metric.type === 'currency') {
                                        return label + formatRupiah(context.parsed.y);
                                    } else {
                                        return label + formatNumber(context.parsed.y) + (metric.unit ? ` ${metric.unit}` : '');
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, ticks) {
                                    if (metric.type === 'currency') {
                                        if (Math.abs(value) >= 1000000000) return (value / 1000000000).toFixed(0) + ' Miliar';
                                        if (Math.abs(value) >= 1000000) return (value / 1000000).toFixed(0) + ' Jt';
                                        return formatRupiah(value);
                                    } else {
                                        return formatNumber(value);
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderComparisonChart(data, schema, title, latestPeriod, previousPeriod, chartElement) {
            if (!chartElement) return;

            // Cari kunci Piutang/Koleksi Bulan/Hari M dan M-1/D-1
            const latestKey = schema.find(c => c.chart_key && (c.key.includes('Piutang') || c.key.includes('Koleksi')) && c.key.includes(latestPeriod))?.key;
            const previousKey = schema.find(c => c.chart_key && (c.key.includes('Piutang') || c.key.includes('Koleksi')) && c.key.includes(previousPeriod))?.key;
            
            if (!latestKey || !previousKey) return;

            const mainKey = schema.find(c => c.is_main_key)?.key;
            
            // Batasi data hanya 10 baris teratas agar chart mudah dibaca
            const chartDataSubset = data.slice(0, 10); 
            const labels = chartDataSubset.map(item => item.chart_label || item[mainKey]);
            const latestData = chartDataSubset.map(item => item[latestKey]);
            const previousData = chartDataSubset.map(item => item[previousKey]);

            const existingChart = Chart.getChart(chartElement);
            if (existingChart) {
                existingChart.destroy();
            }

            new Chart(chartElement, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: schema.find(c => c.key === latestKey)?.label,
                            data: latestData,
                            backgroundColor: 'var(--primary-color)',
                            yAxisID: 'y'
                        },
                        {
                            label: schema.find(c => c.key === previousKey)?.label,
                            data: previousData,
                            backgroundColor: '#ffc107', 
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: title,
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    // Asumsi metrik comparison selalu currency
                                    return label + formatRupiah(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false,
                            grid: { display: false }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, ticks) {
                                    if (Math.abs(value) >= 1000000000) return (value / 1000000000).toFixed(0) + ' Miliar';
                                    if (Math.abs(value) >= 1000000) return (value / 1000000).toFixed(0) + ' Jt';
                                    return formatRupiah(value);
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- FUNGSI FETCH UTAMA ---
        async function fetchReportData() {
            loadingStatus.style.display = 'block';
            reportContent.style.display = 'none';

            if (!API_URL) {
                loadingStatus.innerHTML = '<p class="no-results">❌ Error: API endpoint tidak terdefinisi. Cek konfigurasi rute di app.py.</p>';
                return;
            }

            try {
                const response = await fetch(API_URL);
                const result = await response.json();
                
                if (response.status !== 200 && result.status !== 'success') {
                    loadingStatus.innerHTML = `<p class="no-results">❌ Gagal memuat laporan: ${result.message || 'Error Server'}</p>`;
                    return;
                }
                
                const data = result.data || [];
                const schema = result.schema || [];
                const reportType = "{{ report_type }}";

                if (data.length === 0) {
                    loadingStatus.innerHTML = '<p class="no-results">⚠️ Data kosong untuk laporan ini. Cek koleksi MongoDB Anda.</p>';
                } else {
                    // 1. Render Tabel Detail
                    renderTable(data, schema);
                    
                    // 2. Render Chart
                    if (data.length > 0) {
                        const chartTitle = result.title || "Grafik Data Laporan";

                        if (reportType === 'MOM_COMPARISON' || reportType === 'DOD_COMPARISON') {
                            renderComparisonChart(
                                data, 
                                schema, 
                                chartTitle, 
                                result.latest_month || result.latest_day, 
                                result.previous_month || result.previous_day, 
                                comparisonChartCanvas
                            );
                        } else {
                            renderSingleMetricChart(data, schema, chartTitle, distributionChartCanvas);
                        }
                    }

                    loadingStatus.style.display = 'none';
                    reportContent.style.display = 'block';
                }

            } catch (error) {
                loadingStatus.innerHTML = '<p class="no-results">❌ Gagal terhubung ke server atau memproses data.</p>';
                console.error('Report Fetch Error:', error);
            }
        }
        
        // Panggil fungsi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', fetchReportData);
    </script>
{% endblock %}
