{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block custom_styles %}
<style>
    /* Kontainer Laporan */
    .report-container {
        padding: 10px;
    }
    
    .report-header-section {
        background-color: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        margin-bottom: 25px;
        border-left: 5px solid var(--primary-color);
    }

    .report-description {
        color: #858796;
        font-size: 0.95rem;
        margin-bottom: 0;
    }

    /* Card Wrapper untuk Tabel & Chart */
    .report-card {
        background-color: #fff;
        border-radius: 12px;
        border: 1px solid #e3e6f0;
        box-shadow: 0 0.15rem 1.5rem 0 rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
        overflow: hidden;
    }

    .report-card-header {
        padding: 15px 20px;
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .report-card-header h5 {
        margin: 0;
        font-weight: 700;
        color: var(--primary-color);
        font-size: 1rem;
    }

    /* Area Tabel */
    .report-table-wrapper {
        overflow-x: auto;
    }

    .dynamic-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }

    .dynamic-table thead th {
        background-color: #f8f9fc;
        color: #4e73df;
        font-weight: 800;
        text-transform: uppercase;
        padding: 12px 15px;
        border-bottom: 2px solid #e3e6f0;
        white-space: nowrap;
    }

    .dynamic-table tbody td {
        padding: 12px 15px;
        border-bottom: 1px solid #f2f2f2;
        color: #5a5c69;
        vertical-align: middle;
    }

    .dynamic-table tbody tr:hover {
        background-color: #fbfcfe;
    }

    /* Status & Badges */
    .badge-anomali {
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
    }

    /* Media Query Mobile */
    @media (max-width: 768px) {
        .dynamic-table thead { display: none; }
        .dynamic-table tr { 
            display: block; 
            border: 1px solid #e3e6f0; 
            margin: 15px; 
            border-radius: 8px;
            background: #fff;
        }
        .dynamic-table td {
            display: flex;
            justify-content: space-between;
            text-align: right;
            border-bottom: 1px solid #eee;
            padding: 10px;
        }
        .dynamic-table td:before {
            content: attr(data-label);
            font-weight: 800;
            text-align: left;
            color: #4e73df;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .dynamic-table td:last-child { border-bottom: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <!-- Header Laporan -->
    <div class="report-header-section">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2 class="font-weight-bold text-gray-800" style="font-size: 1.6rem;">
                    <i class="fas fa-file-invoice mr-2 text-primary"></i> {{ title }}
                </h2>
                <p class="report-description">{{ description }}</p>
            </div>
            <button class="btn btn-sm btn-outline-primary shadow-sm d-none d-md-inline" onclick="window.print()">
                <i class="fas fa-print fa-sm"></i> Cetak Laporan
            </button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingStatus" class="text-center py-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <h5 class="mt-3 text-gray-600 font-weight-bold">Mengolah data dari database AB SUNTER...</h5>
    </div>

    <!-- Konten Laporan -->
    <div id="reportContent" style="display: none;">
        
        <!-- Grafik Section -->
        <div class="report-card">
            <div class="report-card-header">
                <h5><i class="fas fa-chart-bar mr-2"></i> Visualisasi Data Laporan</h5>
                <span class="badge badge-primary px-2 py-1">Top 10 Data</span>
            </div>
            <div class="card-body">
                <div style="height: 350px; position: relative;">
                    <canvas id="mainReportChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabel Detail Section -->
        <div class="report-card">
            <div class="report-card-header">
                <h5><i class="fas fa-list-ul mr-2"></i> Rincian Data Detail</h5>
                <div id="totalRowsCount" class="small font-weight-bold text-muted">0 Baris Data</div>
            </div>
            <div class="report-table-wrapper" id="reportTableArea">
                <!-- Tabel diisi via JS -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

<script>
    const loadingStatus = document.getElementById('loadingStatus');
    const reportContent = document.getElementById('reportContent');
    const reportTableArea = document.getElementById('reportTableArea');
    const API_URL = "{{ api_endpoint }}";
    const reportType = "{{ report_type }}";

    // Formatting Helpers
    const formatIDR = (v) => 'Rp ' + (parseFloat(v) || 0).toLocaleString('id-ID');
    const formatNum = (v) => (parseFloat(v) || 0).toLocaleString('id-ID');
    const formatPct = (v) => (parseFloat(v) || 0).toFixed(1) + '%';

    function formatValue(value, type, unit) {
        if (value === null || value === undefined) return '-';
        switch (type) {
            case 'currency': return formatIDR(value);
            case 'percent': return formatPct(value);
            case 'integer': return formatNum(value) + (unit ? ` ${unit}` : '');
            default: return String(value);
        }
    }

    function renderTable(data, schema) {
        if (!data || data.length === 0) {
            reportTableArea.innerHTML = '<div class="text-center py-5 text-danger font-weight-bold">❌ Data tidak ditemukan.</div>';
            return;
        }

        document.getElementById('totalRowsCount').innerText = `${data.length} Baris Data`;

        let html = '<table class="dynamic-table"><thead><tr>';
        schema.forEach(col => html += `<th>${col.label}</th>`);
        html += '</tr></thead><tbody>';

        data.forEach(row => {
            html += '<tr>';
            schema.forEach(col => {
                const val = row[col.key];
                const formatted = formatValue(val, col.type, col.unit);
                const textAlign = ['currency', 'integer', 'percent'].includes(col.type) ? 'right' : 'left';
                html += `<td data-label="${col.label}" style="text-align: ${textAlign};">${formatted}</td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table>';
        reportTableArea.innerHTML = html;
    }

    function renderChart(data, schema, title) {
        const ctx = document.getElementById('mainReportChart').getContext('2d');
        const metric = schema.find(c => c.chart_key) || schema.find(c => c.type === 'currency');
        const mainKey = schema.find(c => c.is_main_key)?.key || schema[0].key;
        
        if (!metric) return;

        const subset = data.slice(0, 10);
        const labels = subset.map(d => d.chart_label || d[mainKey]);
        const values = subset.map(d => d[metric.key]);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: metric.label,
                    data: values,
                    backgroundColor: '#4e73df',
                    hoverBackgroundColor: '#2e59d9',
                    borderRadius: 6,
                    barThickness: 35
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: (v) => v >= 1000000 ? (v/1000000).toFixed(0) + 'jt' : v
                        }
                    }
                }
            }
        });
    }

    async function initReport() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();

            if (json.status !== 'success') throw new Error(json.message);

            renderTable(json.data, json.schema);
            renderChart(json.data, json.schema, json.title);

            loadingStatus.style.display = 'none';
            reportContent.style.display = 'block';
        } catch (err) {
            loadingStatus.innerHTML = `<div class="alert alert-danger mx-auto" style="max-width:500px;">❌ Error: ${err.message}</div>`;
        }
    }

    document.addEventListener('DOMContentLoaded', initReport);
</script>
{% endblock %}
