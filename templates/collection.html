{% extends "base.html" %}

{% block title %}Penagihan - SUNTER{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Monitoring Penagihan</h1>
        <p class="page-subtitle">Analisa realisasi collection harian dan performa wilayah</p>
    </div>
</div>

<div class="filter-bar">
    <div class="filter-row">
        <div class="filter-item">
            <div class="filter-label">Bulan</div>
            <select class="form-select" id="bulan">
                <option value="1">Januari</option>
                <option value="2">Februari</option>
                <option value="3">Maret</option>
                <option value="4">April</option>
                <option value="5">Mei</option>
                <option value="6">Juni</option>
                <option value="7">Juli</option>
                <option value="8">Agustus</option>
                <option value="9">September</option>
                <option value="10">Oktober</option>
                <option value="11">November</option>
                <option value="12" selected>Desember</option>
            </select>
        </div>
        <div class="filter-item">
            <div class="filter-label">Tahun</div>
            <select class="form-select" id="tahun">
                <option value="2023">2023</option>
                <option value="2024" selected>2024</option>
                <option value="2025">2025</option>
            </select>
        </div>
    </div>
    <button class="btn btn-primary btn-block mt-3" id="loadDataBtn">
        <i class="fas fa-sync-alt"></i>
        <span>Perbarui Data</span>
    </button>
</div>

<div class="kpi-container">
    <div class="kpi-card">
        <span class="kpi-label"><i class="fas fa-bullseye text-primary"></i> Target MC</span>
        <div class="kpi-value" id="kpi-target">Rp 0</div>
        <div class="kpi-change">Periode Aktif</div>
    </div>
    
    <div class="kpi-card">
        <span class="kpi-label"><i class="fas fa-check-circle text-success"></i> Collection</span>
        <div class="kpi-value text-success" id="kpi-collection">Rp 0</div>
        <div class="kpi-change positive" id="kpi-collection-change">0% Progress</div>
    </div>
    
    <div class="kpi-card">
        <span class="kpi-label"><i class="fas fa-percent text-info"></i> Achievement</span>
        <div class="kpi-value" id="kpi-percentage">0%</div>
        <div class="kpi-change" id="kpi-percentage-change">vs Target</div>
    </div>
    
    <div class="kpi-card">
        <span class="kpi-label"><i class="fas fa-clock text-warning"></i> Tunggakan</span>
        <div class="kpi-value text-danger" id="kpi-tunggakan">Rp 0</div>
        <div class="kpi-change negative">Belum Terbayar</div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-building"></i> Monitoring Performa PCEZ</h3>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="pcezPeriod" style="width: 110px;">
                <option value="daily">Harian</option>
                <option value="monthly" selected>Bulanan</option>
            </select>
            <button class="btn btn-sm btn-success" onclick="TableHelpers.exportToCSV('pcezTable', 'performa_pcez.csv')">
                <i class="fas fa-file-excel"></i>
            </button>
        </div>
    </div>
    <div class="table-container">
        <table class="table" id="pcezTable">
            <thead class="bg-light">
                <tr>
                    <th>PCEZ</th>
                    <th class="text-right">Nomen</th>
                    <th class="text-right">Nominal MC</th>
                    <th class="text-right">Bayar (Total)</th>
                    <th class="text-center">Performance</th>
                    <th class="text-right">Selisih</th>
                </tr>
            </thead>
            <tbody id="pcezTableBody"></tbody>
            <tfoot class="bg-tertiary font-bold" id="pcezTableFooter"></tfoot>
        </table>
    </div>
</div>

<div class="tabs mt-4">
    <button class="tab-item active" data-tab="monitoring">Monitoring Harian</button>
    <button class="tab-item" data-tab="rayon">Analisa Rayon</button>
    <button class="tab-item" data-tab="top">Top 10 Pembayar</button>
</div>

<div id="tab-monitoring" class="tab-pane">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-calendar-day"></i> Realisasi Harian</h3>
        </div>
        <div class="card-body">
            <div class="chart-container mb-4" style="height: 250px;">
                <canvas id="collectionChart"></canvas>
            </div>
            <div class="table-container">
                <table class="table table-sm" id="monitoringTable" style="font-size: 11px;">
                    <thead class="bg-primary text-white">
                        <tr>
                            <th rowspan="2" class="text-center align-middle border-end">TGL</th>
                            <th colspan="3" class="text-center bg-danger">UNDUE</th>
                            <th colspan="3" class="text-center bg-success">CURRENT</th>
                            <th colspan="2" class="text-center bg-purple">TOTAL</th>
                        </tr>
                        <tr class="bg-light text-dark">
                            <th>Cust</th><th>Rp</th><th class="border-end">Komp</th>
                            <th>Cust</th><th>Rp</th><th class="border-end">Komp</th>
                            <th>Rp</th><th>Komp</th>
                        </tr>
                    </thead>
                    <tbody id="monitoringTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="tab-rayon" class="tab-pane d-none">
    <div class="card">
        <div class="table-container">
            <table class="table" id="rayonTable">
                <thead>
                    <tr>
                        <th>Rayon</th>
                        <th class="text-right">Pelanggan</th>
                        <th class="text-right">Collection</th>
                        <th class="text-right">Achievement %</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="tab-top" class="tab-pane d-none">
    <div class="card">
        <div class="table-container">
            <table class="table" id="topTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Nomen</th>
                        <th>Nama Pelanggan</th>
                        <th class="text-right">Total Bayar</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let collectionChart = null;

document.addEventListener('DOMContentLoaded', () => {
    initTabActions();
    loadData();
    
    document.getElementById('loadDataBtn').addEventListener('click', loadData);
    document.getElementById('pcezPeriod').addEventListener('change', loadPcezData);
});

function initTabActions() {
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            const target = this.getAttribute('data-tab');
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('d-none'));
            document.getElementById('tab-' + target).classList.remove('d-none');
        });
    });
}

async function loadData() {
    const bulan = document.getElementById('bulan').value;
    const tahun = document.getElementById('tahun').value;
    
    try {
        const kpi = await App.api(`/api/kpi?bulan=${bulan}&tahun=${tahun}`);
        updateKPI(kpi);
        
        const daily = await App.api(`/api/collection/daily?bulan=${bulan}&tahun=${tahun}`);
        renderMonitoring(daily);
        renderChart(daily);
        
        const rayon = await App.api(`/api/collection/by-rayon?bulan=${bulan}&tahun=${tahun}`);
        renderRayonTable(rayon);
        
        const top = await App.api(`/api/collection/top-payers?bulan=${bulan}&tahun=${tahun}&limit=10`);
        renderTopTable(top);
        
        loadPcezData();
    } catch (e) {
        App.toast("Gagal memuat data penagihan", "error");
    }
}

function updateKPI(data) {
    document.getElementById('kpi-target').textContent = App.formatRupiah(data.target_mc);
    document.getElementById('kpi-collection').textContent = App.formatRupiah(data.collection_total);
    document.getElementById('kpi-percentage').textContent = data.collection_pct.toFixed(1) + '%';
    document.getElementById('kpi-tunggakan').textContent = App.formatRupiah(data.collection_tunggakan);
}

function renderMonitoring(data) {
    const tbody = document.getElementById('monitoringTableBody');
    let kUndue = 0, kCurrent = 0, kTotal = 0;
    
    tbody.innerHTML = data.map(item => {
        kUndue += item.rp_undue || 0;
        kCurrent += item.rp_current || 0;
        kTotal += item.total || 0;
        
        return `<tr>
            <td class="text-center font-bold border-end">${item.date}</td>
            <td class="text-right bg-danger-light">${App.formatNumber(item.cust_undue)}</td>
            <td class="text-right bg-danger-light">${App.formatValue(item.rp_undue)}</td>
            <td class="text-right bg-danger-light border-end font-semibold">${App.formatValue(kUndue)}</td>
            <td class="text-right bg-success-light">${App.formatNumber(item.cust_current)}</td>
            <td class="text-right bg-success-light">${App.formatValue(item.rp_current)}</td>
            <td class="text-right bg-success-light border-end font-semibold">${App.formatValue(kCurrent)}</td>
            <td class="text-right bg-purple-light">${App.formatValue(item.total)}</td>
            <td class="text-right bg-purple-light font-bold">${App.formatValue(kTotal)}</td>
        </tr>`;
    }).join('');
}

function renderChart(data) {
    const ctx = document.getElementById('collectionChart');
    if (collectionChart) collectionChart.destroy();
    
    collectionChart = ChartHelpers.createLineChart(ctx, {
        labels: data.map(d => d.date),
        datasets: [{
            label: 'Collection Harian',
            data: data.map(d => d.total),
            color: '#2563eb'
        }]
    });
}

async function loadPcezData() {
    const bulan = document.getElementById('bulan').value;
    const tahun = document.getElementById('tahun').value;
    const period = document.getElementById('pcezPeriod').value;
    
    const tbody = document.getElementById('pcezTableBody');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4"><div class="spinner"></div></td></tr>';

    try {
        const data = await App.api(`/api/collection/pcez?bulan=${bulan}&tahun=${tahun}&period=${period}`);
        const cols = [
            { field: 'pcez', class: 'font-bold' },
            { field: 'nomen', class: 'text-right', formatter: v => App.formatNumber(v) },
            { field: 'nominal', class: 'text-right font-semibold', formatter: v => App.formatRupiah(v) },
            { field: 'bayar', class: 'text-right font-bold text-primary', formatter: v => App.formatRupiah(v) },
            { field: 'performance', class: 'text-center', formatter: v => `<span class="badge ${v >= 90 ? 'badge-success' : 'badge-warning'}">${v.toFixed(1)}%</span>` },
            { field: 'selisih', class: 'text-right', formatter: v => `<span class="${v > 0 ? 'text-danger' : 'text-success'}">${App.formatRupiah(v)}</span>` }
        ];
        TableHelpers.render('pcezTable', data, cols);
    } catch (e) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Data performa PCEZ tidak tersedia</td></tr>';
    }
}

function renderRayonTable(data) {
    const cols = [
        { field: 'rayon', class: 'font-bold' },
        { field: 'pelanggan', class: 'text-right', formatter: v => App.formatNumber(v) },
        { field: 'collection', class: 'text-right font-bold', formatter: v => App.formatRupiah(v) },
        { field: 'percentage', class: 'text-right font-bold', formatter: v => `<span class="text-primary">${v.toFixed(1)}%</span>` }
    ];
    TableHelpers.render('rayonTable', data, cols, { sortable: true });
}

function renderTopTable(data) {
    const cols = [
        { field: 'rank', formatter: (v, r, i) => i + 1 },
        { field: 'nomen', class: 'font-semibold' },
        { field: 'nama' },
        { field: 'total', class: 'text-right font-bold', formatter: v => App.formatRupiah(v) }
    ];
    TableHelpers.render('topTable', data, cols);
}
</script>
{% endblock %}
