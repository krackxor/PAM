{% extends "base.html" %}

{% block title %}Analisis Agregasi Piutang & Koleksi{% endblock %}

{% block custom_styles %}
/* Custom CSS dari file lama, relevan untuk analisis dan breakdown */
.report-table-wrapper { overflow-x: auto; margin-top: 20px; }

/* --- TABLE LAYOUT --- */
.report-table { 
    width: 100%; border-collapse: collapse; font-size: 14px; 
    box-shadow: var(--shadow-light); 
    border-radius: var(--border-radius);
    overflow: hidden; 
}
.report-table th, .report-table td { 
    border: 1px solid #f0f0f0; padding: 10px; text-align: right; white-space: nowrap; 
}
.report-table th { background-color: #e9ecef; text-align: center; font-weight: 600; }
.report-table { min-width: 1000px; }

.grand-total-row { font-weight: bold; background-color: #d0e7ff; color: var(--text-color); } 

/* Styling untuk kelompok tabel kustom (AB Sunter) */
.breakdown-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
    margin-bottom: 30px;
}
.breakdown-table-container {
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
}

/* CSS for the Analysis Menu Grid (Card Style) */
.report-grid-menu {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: 20px;
    margin-top: 20px;
    margin-bottom: 30px; 
}

.report-card-link {
    text-decoration: none;
    color: inherit;
}

.report-card-aggr {
    background-color: var(--card-bg);
    border: 1px solid #e0e0e0; 
    border-radius: var(--border-radius);
    padding: 25px 20px; 
    box-shadow: var(--shadow-light);
    transition: all 0.3s ease;
    text-align: center;
    min-height: 150px; 
    cursor: pointer;
}

.report-card-aggr:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 123, 255, 0.2); 
    border-color: var(--primary-color);
}

.report-card-aggr i {
    font-size: 3em; 
    color: var(--primary-color);
    margin-bottom: 10px;
}

.report-card-aggr h3 {
    margin: 10px 0 5px 0;
    color: var(--text-color);
    font-size: 1.1em;
}

.report-card-aggr p {
    font-size: 0.9em;
    color: #6c757d; 
}
{% endblock %}

{% block content %}
    <h2 style="text-align: left; border-bottom: none; margin-bottom: 20px; color: var(--primary-color);">
        <i class="fas fa-layer-group" style="margin-right: 10px;"></i> Analisis Agregasi & Daftar Khusus
    </h2>

    <h3 style="color: #17a2b8;">
        <i class="fas fa-list-ol"></i> Distribusi Pelanggan Berdasarkan TARIF (Rayon 34 & 35 Reguler)
    </h3>
    
    <div id="tariffChartArea" style="max-width: 450px; margin: 20px auto;">
        <canvas id="tarifBreakdownChart"></canvas>
    </div>
    <div id="tarifBreakdownArea">
        <p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat data breakdown tarif...</p>
    </div>

    <h3 style="color: var(--primary-color);">
        <i class="fas fa-chart-pie"></i> Laporan Agregasi Khusus (Pilih salah satu kartu untuk memuat)
    </h3>
    
    <div class="report-grid-menu">
        
        <a href="javascript:void(0);" onclick="fetchCustomReport();" class="report-card-link">
            <div class="report-card-aggr" style="border-left-color: #dc3545;">
                <i class="fas fa-layer-group" style="color: #dc3545;"></i>
                <h3>Grouping MC: AB Sunter</h3>
                <p>Agregasi Nomen, Kubik, dan Nominal berdasarkan Tarif, Merek, dan Metode Baca untuk R34/R35.</p>
            </div>
        </a>
        
        <a href="javascript:void(0);" onclick="fetchBasicVolumeReport();" class="report-card-link">
            <div class="report-card-aggr" style="border-left-color: var(--secondary-color);">
                <i class="fas fa-water" style="color: var(--secondary-color);"></i>
                <h3>Laporan Volume Dasar</h3>
                <p>Riwayat volume KUBIK bulanan dari seluruh data Master Cetak (MC) secara historis.</p>
            </div>
        </a>
        
        <a href="javascript:void(0);" onclick="fetchTopLists();" class="report-card-link">
            <div class="report-card-aggr" style="border-left-color: var(--primary-color);">
                <i class="fas fa-medal" style="color: var(--primary-color);"></i>
                <h3>Daftar Konsumen Top & Status Bayar</h3>
                <p>Top 500 Tunggakan, Top 500 Premium, serta Daftar Lunas dan Belum Bayar (Snapshot Terbaru).</p>
            </div>
        </a>
        
        <a href="javascript:void(0);" onclick="fetchAgingReport();" class="report-card-link">
            <div class="report-card-aggr" style="border-left-color: var(--accent-color);">
                <i class="fas fa-clock" style="color: var(--accent-color);"></i>
                <h3>Analisis Umur Piutang (Aging)</h3>
                <p>Melihat daftar piutang lama (> 1 bulan) yang masih aktif berdasarkan data Master Cetak.</p>
            </div>
        </a>
        
    </div>
    
    <hr style="margin: 40px 0; border-style: dotted;">

    <h3 style="color: #dc3545;">
        <i class="fas fa-layer-group"></i> Hasil Laporan AB Sunter
    </h3>
    <div id="customReportArea">
        <p class="no-results">Tekan kartu "Grouping MC: AB Sunter" di atas untuk memuat hasilnya.</p>
    </div>
    
    <h3 style="color: #ffc107;">
        <i class="fas fa-clock"></i> Hasil Laporan Umur Piutang (Aging)
    </h3>
    <div id="agingReportArea">
        <p class="no-results">Tekan kartu "Analisis Umur Piutang (Aging)" di atas untuk memuat hasilnya.</p>
    </div>

    <h3 style="color: #28a745;">
        <i class="fas fa-water"></i> Hasil Laporan Volume Dasar
    </h3>
    <div id="basicVolumeReportArea">
        <p class="no-results">Tekan kartu "Laporan Volume Dasar" di atas untuk memuat hasilnya.</p>
    </div>

    <h3 style="color: var(--primary-color);">
        <i class="fas fa-list-alt"></i> Hasil Daftar Konsumen Spesifik
    </h3>
    <div id="topListsArea">
        <p class="no-results">Tekan kartu "Daftar Konsumen Top" di atas untuk memuat hasilnya.</p>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Global Variables
        let tariffChartInstance = null;

        // Element Selectors
        const customReportArea = document.getElementById('customReportArea');
        const tarifBreakdownArea = document.getElementById('tarifBreakdownArea');
        const topListsArea = document.getElementById('topListsArea');
        const basicVolumeReportArea = document.getElementById('basicVolumeReportArea');
        const agingReportArea = document.getElementById('agingReportArea');
        const tariffChartArea = document.getElementById('tariffChartArea');


        // ========================
        // === UTILITY FUNCTIONS ===
        // ========================
        function formatRupiah(number) {
            return 'Rp ' + (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
        }
        
        function formatNumber(number) {
            return (parseFloat(number) || 0).toLocaleString('id-ID', { maximumFractionDigits: 0 });
        }

        function formatPercent(number) {
            return (parseFloat(number) || 0).toFixed(2) + '%';
        }
        
        const getChangeColor = (value) => value > 0 ? '#28a745' : (value < 0 ? '#dc3545' : '#6c757d');
        const getChangeIcon = (value) => value > 0 ? 'up' : (value < 0 ? 'down' : 'minus');


        // =========================================================
        // --- FUNGSI 1: BREAKDOWN TARIF (Chart & Table) ---
        // =========================================================
        async function fetchTarifBreakdown() {
            tarifBreakdownArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Breakdown Tarif...</p>';
            
            try {
                // Asumsi endpoint Flask: analyze_mc_tarif_breakdown_api
                const response = await fetch('{{ url_for("analyze_mc_tarif_breakdown_api") }}'); 
                const data = await response.json();
                
                if (response.status !== 200 || data.length === 0) {
                    tarifBreakdownArea.innerHTML = `<p style="text-align: center; color: #6c757d;">Tidak ada data pelanggan yang cocok dengan kriteria kustom (Rayon 34/35 Reguler).</p>`;
                    const existingChart = Chart.getChart("tarifBreakdownChart");
                    if (existingChart) { existingChart.destroy(); }
                    return;
                }
                
                renderTarifBreakdownTable(data);
                renderTariffBreakdownChart(data); 

            } catch (error) {
                tarifBreakdownArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data breakdown tarif dari server.</p>';
                console.error('Tarif Breakdown Error:', error);
            }
        }
        
        function renderTariffBreakdownChart(data) {
            const chartData = {};
            
            if (tariffChartInstance) {
                tariffChartInstance.destroy();
            }

            // Agregat berdasarkan TARIF di semua Rayon 34/35
            data.forEach(item => {
                const tarif = item.TARIF || 'N/A';
                const count = item.JumlahPelanggan;
                chartData[tarif] = (chartData[tarif] || 0) + count;
            });

            const labels = Object.keys(chartData);
            const counts = Object.values(chartData);
            
            const backgroundColors = labels.map((_, index) => {
                const colors = [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', 
                    '#6c757d', '#343a40', '#6f42c1', '#fd7e14'
                ];
                return colors[index % colors.length];
            });

            tariffChartInstance = new Chart(document.getElementById('tarifBreakdownChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors,
                        hoverOffset: 10,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Pelanggan Berdasarkan Tarif (Count Nomen)'
                        }
                    }
                }
            });
        }
        
        function renderTarifBreakdownTable(data) {
            let totalPelanggan = data.reduce((sum, item) => sum + item.JumlahPelanggan, 0);

            let tableHTML = `
                <div class="report-table-wrapper" style="max-width: 600px; margin-left: 0;"> 
                <h4 style="margin-top: 10px;">Detail Distribusi Tarif per Rayon (Count)</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">RAYON</th>
                            <th style="text-align: left;">TARIF</th>
                            <th>JML Pelanggan</th>
                            <th>Persentase (%)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                const percentage = (item.JumlahPelanggan / totalPelanggan) * 100;
                tableHTML += `
                    <tr>
                        <td data-label="RAYON" style="text-align: left;">${item.RAYON}</td>
                        <td data-label="TARIF" style="text-align: left;">${item.TARIF}</td>
                        <td data-label="JML Pelanggan">${formatNumber(item.JumlahPelanggan)}</td>
                        <td data-label="Persentase">${formatPercent(percentage)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                <tr class="grand-total-row">
                    <td style="text-align: left;">TOTAL</td>
                    <td>-</td> 
                    <td>${formatNumber(totalPelanggan)}</td>
                    <td>100.00%</td>
                </tr>
            `;
            
            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            tarifBreakdownArea.innerHTML = tableHTML;
        }

        // =========================================================
        // --- FUNGSI 2: LAPORAN AB SUNTER (Grouping MC Kustom) ---
        // =========================================================
        async function fetchCustomReport() {
            customReportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Menghubungkan ke MongoDB untuk Laporan AB Sunter...</p>';
            
            try {
                // Asumsi endpoint Flask: analyze_mc_grouping_api
                const response = await fetch('{{ url_for("analyze_mc_grouping_api") }}'); 
                const data = await response.json();
                
                if (response.status !== 200 || data.status !== 'success') {
                    customReportArea.innerHTML = `<p class="no-results" style="color: red;">❌ Gagal memuat report: ${data.message || 'Tidak ada data kustom ditemukan.'}</p>`;
                    return;
                }
                
                renderCustomReportTable(data);

            } catch (error) {
                customReportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data report kustom dari server.</p>';
                console.error('Custom Report Error:', error);
            }
        }
        
        function renderCustomReportTable(data) {
            const customArea = document.getElementById('customReportArea');
            const totals = data.totals;
            const breakdowns = data.breakdowns;
            
            
            // 1. RENDER RINGKASAN TOTAL
            let totalSummaryHTML = `
                <h4 style="color: #dc3545; margin-bottom: 15px;">Ringkasan Nomen, Nominal, dan Kubikasi (Reguler R34/R35)</h4>
                <div class="report-table-wrapper" style="max-width: 800px; margin-left: auto; margin-right: auto;">
                    <table class="report-table" style="min-width: 100%;">
                        <thead>
                            <tr style="background-color: #f8d7da; color: #721c24;">
                                <th style="text-align: left;">AREA</th>
                                <th>Nomen Count</th>
                                <th>Total Nominal</th>
                                <th>Total Kubik (m³)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align: left; font-weight: bold;">AB SUNTER (Total R34 + R35)</td>
                                <td>${formatNumber(totals.TOTAL_34_35.CountOfNOMEN)}</td>
                                <td>${formatRupiah(totals.TOTAL_34_35.SumOfNOMINAL)}</td>
                                <td>${formatNumber(totals.TOTAL_34_35.SumOfKUBIK)}</td>
                            </tr>
                            <tr>
                                <td style="text-align: left; font-weight: 600;">Rayon 34</td>
                                <td>${formatNumber(totals[34].CountOfNOMEN)}</td>
                                <td>${formatRupiah(totals[34].SumOfNOMINAL)}</td>
                                <td>${formatNumber(totals[34].SumOfKUBIK)}</td>
                            </tr>
                            <tr>
                                <td style="text-align: left; font-weight: 600;">Rayon 35</td>
                                <td>${formatNumber(totals[35].CountOfNOMEN)}</td>
                                <td>${formatRupiah(totals[35].SumOfNOMINAL)}</td>
                                <td>${formatNumber(totals[35].SumOfKUBIK)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h4 style="color: var(--primary-color); margin-top: 30px;">Detail Breakdown Per Dimensi</h4>
            `;

            function createSingleBreakdownTable(title, dataArray, dimensionKey) {
                let tableHTML = `
                    <div class="breakdown-table-container">
                        <h5 style="margin-top: 0; color: #17a2b8;">${title}</h5>
                        <div class="report-table-wrapper" style="margin-top: 10px;">
                            <table class="report-table" style="min-width: 100%;">
                                <thead>
                                    <tr style="background-color: #f0f8ff;">
                                        <th style="text-align: left; width: 40%;">${dimensionKey.replace(/_/g, ' ').toUpperCase()}</th>
                                        <th>Nomen Count</th>
                                        <th>Nominal</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                dataArray.forEach(item => {
                    const dimValue = item[dimensionKey] || 'N/A';
                    const nomenCount = formatNumber(item.CountOfNOMEN);
                    const nominal = formatRupiah(item.SumOfNOMINAL);
                    
                    tableHTML += `
                        <tr>
                            <td style="text-align: left;" data-label="${dimensionKey.toUpperCase()}">${dimValue}</td>
                            <td data-label="Nomen Count">${nomenCount}</td>
                            <td data-label="Nominal">${nominal}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return tableHTML;
            }

            function renderDimensionGroup(dimensionName, dimensionKey, breakdownData) {
                let groupHTML = `
                    <h5 style="color: #007bff; margin-top: 25px; border-bottom: 1px dashed #ddd; padding-bottom: 5px;">Breakdown Berdasarkan: ${dimensionName}</h5>
                    <div class="breakdown-group">
                        ${createSingleBreakdownTable(`AB SUNTER (Total)`, breakdownData.TOTAL_34_35, dimensionKey)}
                        ${createSingleBreakdownTable(`Rayon 34`, breakdownData[34], dimensionKey)}
                        ${createSingleBreakdownTable(`Rayon 35`, breakdownData[35], dimensionKey)}
                    </div>
                `;
                return groupHTML;
            }

            let breakdownHTML = '';
            breakdownHTML += renderDimensionGroup('Jenis TARIF', 'TARIF', breakdowns.TARIF);
            breakdownHTML += renderDimensionGroup('Merek Meter', 'MERK', breakdowns.MERK);
            breakdownHTML += renderDimensionGroup('Metode Baca', 'READ_METHOD', breakdowns.READ_METHOD);

            customReportArea.innerHTML = totalSummaryHTML + breakdownHTML;
        }

        // =========================================================
        // --- FUNGSI 3: ANALISIS UMUR PIUTANG (Aging) ---
        // =========================================================
        async function fetchAgingReport() {
            agingReportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Umur Piutang...</p>';
            
            try {
                // Asumsi endpoint Flask: aging_report_api
                const response = await fetch('{{ url_for("aging_report_api") }}'); 
                const result = await response.json();

                if (response.status !== 200 || result.status !== 'success' || result.data.length === 0) {
                    agingReportArea.innerHTML = `<p class="no-results" style="color: #dc3545;">❌ ${result.message || 'Tidak ada data piutang lama ditemukan.'}</p>`;
                    return;
                }
                
                renderAgingReport(result.data);

            } catch (error) {
                agingReportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data aging report dari server.</p>';
                console.error('Aging Report Error:', error);
            }
        }
        
        function renderAgingReport(data) {
            const headers = Object.keys(data[0]);
            let tableHTML = `
                <h4 style="margin-top: 20px;">Daftar Pelanggan dengan Piutang > 1 Bulan (${data.length} Data)</h4>
                <div class="report-table-wrapper">
                <table class="report-table">
                    <thead><tr>
                        ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ')}</th>`).join('')}
                    </tr></thead><tbody>
            `;
            
            data.forEach(item => {
                tableHTML += '<tr>';
                headers.forEach(h => {
                    let cellValue = item[h];
                    let align = 'right';
                    
                    if (h.includes('NOMEN') || h.includes('NAMA') || h.includes('RAYON')) {
                        align = 'left';
                    }
                    
                    if (h.includes('PiutangLama')) {
                        cellValue = formatRupiah(cellValue);
                    } else if (h.includes('Bulan_Tagihan')) {
                        align = 'center';
                    }
                    tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${align};">${cellValue}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table></div>';
            agingReportArea.innerHTML = tableHTML;
        }


        // =========================================================
        // --- FUNGSI 4: LAPORAN VOLUME DASAR (HISTORIS MC) ---
        // =========================================================
        async function fetchBasicVolumeReport() {
            basicVolumeReportArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat Laporan Volume Dasar...</p>';
            
            try {
                // Asumsi endpoint Flask: basic_volume_report_api
                const response = await fetch('{{ url_for("basic_volume_report_api") }}'); 
                const data = await response.json();
                
                if (response.status !== 200 || data.status !== 'success' || data.basic_volume_report.length === 0) {
                    basicVolumeReportArea.innerHTML = `<p class="no-results" style="color: #dc3545;">❌ Gagal memuat laporan atau tidak ada data historis yang valid.</p>`;
                    return;
                }
                
                renderBasicVolumeReport(data.basic_volume_report);

            } catch (error) {
                basicVolumeReportArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data volume dasar dari server.</p>';
                console.error('Basic Volume Error:', error);
            }
        }
        
        function renderBasicVolumeReport(data) {
            const dataArea = document.getElementById('basicVolumeReportArea');
            const headers = Object.keys(data[0]);
            
            let tableHTML = `
                <div class="report-table-wrapper">
                <h4 style="margin-top: 10px;">Riwayat Volume Kubik Bulanan per Rayon</h4>
                <table class="report-table">
                    <thead><tr>
                        ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ').toUpperCase()}</th>`).join('')}
                    </tr></thead><tbody>
            `;
            
            data.forEach(item => {
                const isTotalRow = item.RAYON === 'TOTAL';
                const rowClass = isTotalRow ? 'grand-total-row' : '';
                
                tableHTML += `<tr class="${rowClass}">`;
                headers.forEach(h => {
                    let cellValue = item[h];
                    let alignment = 'right';
                    
                    if (h === 'RAYON') {
                        alignment = 'left';
                    } else {
                        cellValue = formatNumber(cellValue); 
                    }
                    
                    tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${alignment};">${cellValue}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table></div>';
            dataArea.innerHTML = tableHTML;
        }

        // =========================================================
        // --- FUNGSI 5: DAFTAR TOP 500 DAN STATUS BAYAR ---
        // =========================================================
        async function fetchTopLists() {
            topListsArea.innerHTML = '<p class="no-results"><i class="fas fa-spinner fa-spin"></i> Memuat daftar top 500 dan status konsumen...</p>';
            
            try {
                // Asumsi endpoint Flask: report_top_lists_api
                const response = await fetch('{{ url_for("report_top_lists_api") }}'); 
                const data = await response.json();

                if (response.status !== 200 || data.status !== 'success') {
                    topListsArea.innerHTML = `<p class="no-results" style="color: red;">❌ Gagal memuat daftar: ${data.message || 'Error Server'}</p>`;
                    return;
                }
                
                renderTopLists(data);

            } catch (error) {
                topListsArea.innerHTML = '<p class="no-results" style="color: red;">Gagal mengambil data top list dari server.</p>';
                console.error('Top Lists Error:', error);
            }
        }
        
        function renderTopLists(data) {
            let html = '';
            
            const renderListTable = (title, list) => {
                if (!list || list.length === 0) {
                    return `<h4 style="margin-top: 20px; color: #2c3e50;">${title}</h4><p class="no-results" style="color: #6c757d;">Tidak ada data ditemukan.</p>`;
                }
                
                const headers = Object.keys(list[0]);
                let tableHTML = `
                    <h4 style="margin-top: 20px; color: #2c3e50; border-bottom: 1px dotted #ccc; padding-bottom: 5px;">${title} (${list.length} Data)</h4>
                    <div class="report-table-wrapper">
                    <table class="report-table">
                        <thead><tr>
                            ${headers.map(h => `<th style="text-align: center;">${h.replace(/_/g, ' ')}</th>`).join('')}
                        </tr></thead><tbody>
                `;
                
                list.forEach(item => {
                    tableHTML += '<tr>';
                    headers.forEach(h => {
                        let cellValue = item[h];
                        
                        let align = 'right';
                        if (h.includes('NOMEN') || h.includes('NAMA') || h.includes('RAYON')) {
                            align = 'left';
                        }
                        
                        if (h.includes('NOMINAL') || h.includes('KEWAJIBAN') || h.includes('ARDEBT')) {
                            cellValue = formatRupiah(cellValue);
                        } else if (h.includes('KUBIK')) {
                            cellValue = formatNumber(cellValue) + ' m³';
                        } else if (h.includes('STATUS')) {
                            align = 'center';
                        }
                        tableHTML += `<td data-label="${h.replace(/_/g, ' ')}" style="text-align: ${align};">${cellValue}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table></div>';
                return tableHTML;
            }
            
            // 1. TOP 500 BELUM BAYAR (DEBT)
            html += renderListTable("TOP 500 Konsumen Belum Bayar (Piutang & Tunggakan Total)", data.top_debt);

            // 2. TOP 500 PREMIUM (HIGH VOLUME)
            html += renderListTable("TOP 500 Konsumen Premium (Berdasarkan Volume MC Tertinggi)", data.top_premium);
            
            // 3. KONSUMEN BELUM BAYAR (MC STATUS UNPAID)
            html += renderListTable("Daftar Konsumen Belum Bayar (Snapshot MC Terbaru)", data.unpaid_list);

            // 4. KONSUMEN SUDAH BAYAR (MC STATUS PAID)
            html += renderListTable("Daftar Konsumen Sudah Bayar (Snapshot MC Terbaru)", data.paid_list);

            topListsArea.innerHTML = html;
        }

        // Initial Load: Hanya load Breakdown Tarif
        document.addEventListener('DOMContentLoaded', fetchTarifBreakdown);
    </script>
{% endblock %}
